module JU_xJU_yJU_z6

    use common, only : wp
  implicit none

contains

  !> 6th order accurate summation-by-parts finite difference operation of the elastic wave equation on a curvilinear grid
  !> Compute partial derivatives for velocities u1, u2, u3 in non-conservative form
  !> Compute partial derivatives for stress u4, u5, u6, u7, u8, u9 in conservative form

  subroutine JJU_x6(x, y, z, F, G, X_x, Ju_x)

    !=================================================================================================
    !
        use datatypes, only: block_fields, block_grid_t

    implicit none

    integer, intent(in) :: x, y, z                      ! indices in the tranformed cordinate
    type(block_fields), intent(in):: F
    type(block_grid_t), intent(in) :: G
    real(kind = wp), dimension(:), intent(out) :: Ju_x            ! metric coefficients

    real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   ! the grid
    real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            ! work array
    real(kind = wp) :: hx, hy, hz                      ! spatial steps discertizing the unit cube
    integer :: n, nx, ny, nz

    nx = G%C%nq
    ny = G%C%nr
    nz = G%C%ns

    n = size(F%F, 4)

    hx = G%hq
    hy = G%hr
    hz = G%hs

    ! work arrays:
    if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
    if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
    if (.not. allocated(Js_xU)) allocate(Js_xU(n))

    !Ju_x = 0.0_wp*Ju_x

    Jq_xU = 0.0_wp*Jq_xU

    ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
    ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
    !=========================================================================================================================
    ! Interior approximation: Standard central finite difference approximation

!print *, 'FD'
    if ((x .ge. 7) .and. (x .le. nx-6)) then
       ! q_x*du/dq 
       Jq_xU(1:3) = X_x(x, y, z, 1)*(-1.0_wp/60.0_wp*F%F(x-3, y, z, 1:3)&
            + 0.15_wp*F%F(x-2, y, z, 1:3)&
            - 0.75_wp*F%F(x-1, y, z, 1:3)&
            + 0.75_wp*F%F(x+1, y, z, 1:3)&
            - 0.15_wp*F%F(x+2, y, z, 1:3)&
            + 1.0_wp/60.0_wp*F%F(x+3, y, z, 1:3)) 
          
       !  d(J*q_x*u)/dq
       Jq_xU(4:n) = -1.0_wp/60.0_wp*F%F(x-3, y, z, 4:n)*G%J(x-3, y, z)*X_x(x-3, y, z, 1) &
            + 0.15_wp*F%F(x-2, y, z, 4:n)*G%J(x-2, y, z)*X_x(x-2, y, z, 1) &
            - 0.75_wp*F%F(x-1, y, z, 4:n)*G%J(x-1, y, z)*X_x(x-1, y, z, 1) &
            + 0.75_wp*F%F(x+1, y, z, 4:n)*G%J(x+1, y, z)*X_x(x+1, y, z, 1) &
            - 0.15_wp*F%F(x+2, y, z, 4:n)*G%J(x+2, y, z)*X_x(x+2, y, z, 1) &
            + 1.0_wp/60.0_wp*F%F(x+3, y, z, 4:n)*G%J(x+3, y, z)*X_x(x+3, y, z, 1)
    end if

    ! Special onesided treatments of boundaries

    !=========================================================================================================================
    ! Left boundary closure in x-directyion
    if (x .eq. 1) then
       Jq_xU(1:3) =  X_x(1, y, z, 1)*(0.036577936277544_wp*F%F(6, y, z, 1:3) &
            + 0.104488069284042_wp*F%F(5, y, z, 1:3) &
            - 0.450398306578272_wp*F%F(4, y, z, 1:3) &
            - 0.141512858744873_wp*F%F(3, y, z, 1:3) &
            + 2.033378678700676_wp*F%F(2, y, z, 1:3) &
            - 1.582533518939116_wp*F%F(1, y, z, 1:3))

       Jq_xU(4:n) =  0.036577936277544_wp*F%F(6, y, z, 4:n)*G%J(6, y, z)*X_x(6, y, z, 1) &
            + 0.104488069284042_wp*F%F(5, y, z, 4:n)*G%J(5, y, z)*X_x(5, y, z, 1) &
            - 0.450398306578272_wp*F%F(4, y, z, 4:n)*G%J(4, y, z)*X_x(4, y, z, 1) &
            - 0.141512858744873_wp*F%F(3, y, z, 4:n)*G%J(3, y, z)*X_x(3, y, z, 1) &
            + 2.033378678700676_wp*F%F(2, y, z, 4:n)*G%J(2, y, z)*X_x(2, y, z, 1) &
            - 1.582533518939116_wp*F%F(1, y, z, 4:n)*G%J(1, y, z)*X_x(1, y, z, 1)

    end if

    if (x .eq. 2) then
       Jq_xU(1:3) = X_x(2, y, z, 1)*(-0.014903449191300_wp*F%F(6, y, z, 1:3) &
            - 0.069112065532624_wp*F%F(5, y, z, 1:3) &
            + 0.258816087376832_wp*F%F(4, y, z, 1:3) &
            + 0.287258622978251_wp*F%F(3, y, z, 1:3) &
            - 0.462059195631158_wp*F%F(1, y, z, 1:3))

       Jq_xU(4:n) = -0.014903449191300_wp*F%F(6, y, z, 4:n)*G%J(6, y, z)*X_x(6, y, z, 1) &
            - 0.069112065532624_wp*F%F(5, y, z, 4:n)*G%J(5, y, z)*X_x(5, y, z, 1) &
            + 0.258816087376832_wp*F%F(4, y, z, 4:n)*G%J(4, y, z)*X_x(4, y, z, 1) &
            + 0.287258622978251_wp*F%F(3, y, z, 4:n)*G%J(3, y, z)*X_x(3, y, z, 1) &
            - 0.462059195631158_wp*F%F(1, y, z, 4:n)*G%J(1, y, z)*X_x(1, y, z, 1)

    end if

    if (x .eq. 3) then
       Jq_xU(1:3) =X_x(3, y, z, 1)*(-0.018129342917256_wp*F%F(6, y, z, 1:3) &
            - 0.022902190275815_wp*F%F(5, y, z, 1:3) &
            + 0.606235523609147_wp*F%F(4, y, z, 1:3) &
            - 0.636451095137907_wp*F%F(2, y, z, 1:3) &
            + 0.071247104721830_wp*F%F(1, y, z, 1:3))

       Jq_xU(4:n) = -0.018129342917256_wp*F%F(6, y, z, 4:n)*G%J(6, y, z)*X_x(6, y, z, 1) &
            - 0.022902190275815_wp*F%F(5, y, z, 4:n)*G%J(5, y, z)*X_x(5, y, z, 1) &
            + 0.606235523609147_wp*F%F(4, y, z, 4:n)*G%J(4, y, z)*X_x(4, y, z, 1) &
            - 0.636451095137907_wp*F%F(2, y, z, 4:n)*G%J(2, y, z)*X_x(2, y, z, 1) &
            + 0.071247104721830_wp*F%F(1, y, z, 4:n)*G%J(1, y, z)*X_x(1, y, z, 1)



    end if

    if (x .eq. 4) then
       Jq_xU(1:3) =   X_x(4, y, z, 1)*(0.013435342414630*F%F(7, y, z, 1:3) &
            - 0.051642265516119_wp*F%F(6, y, z, 1:3)&
            + 0.520262285050482_wp*F%F(5, y, z, 1:3)&
            - 0.306681191361148_wp*F%F(3, y, z, 1:3)&
            - 0.290087484386815_wp*F%F(2, y, z, 1:3)&
            + 0.114713313798970_wp*F%F(1, y, z, 1:3))

       Jq_xU(4:n) =  0.013435342414630*F%F(7, y, z, 4:n)*G%J(7, y, z)*X_x(7, y, z, 1) &
            - 0.051642265516119_wp*F%F(6, y, z, 4:n)*G%J(6, y, z)*X_x(6, y, z, 1) &
            + 0.520262285050482_wp*F%F(5, y, z, 4:n)*G%J(5, y, z)*X_x(5, y, z, 1) &
            - 0.306681191361148_wp*F%F(3, y, z, 4:n)*G%J(3, y, z)*X_x(3, y, z, 1) &
            - 0.290087484386815_wp*F%F(2, y, z, 4:n)*G%J(2, y, z)*X_x(2, y, z, 1) &
            + 0.114713313798970_wp*F%F(1, y, z, 4:n)*G%J(1, y, z)*X_x(1, y, z, 1)

    end if

    if (x .eq. 5) then
       Jq_xU(1:3) = X_x(5, y, z, 1)*(0.018281071473911_wp*F%F(8, y, z, 1:3)&
            - 0.164529643265203_wp*F%F(7, y, z, 1:3) &
            + 0.769199413962647_wp*F%F(6, y, z, 1:3)&
            - 0.707905442575989_wp*F%F(4, y, z, 1:3)&
            + 0.015764336127392_wp*F%F(3, y, z, 1:3)&
            + 0.105400944933782_wp*F%F(2, y, z, 1:3)&
            - 0.036210680656541_wp*F%F(1, y, z, 1:3))

       Jq_xU(4:n) = 0.018281071473911_wp*F%F(8, y, z, 4:n)*G%J(8, y, z)*X_x(8, y, z, 1) &
            - 0.164529643265203_wp*F%F(7, y, z, 4:n)*G%J(7, y, z)*X_x(7, y, z, 1) &
            + 0.769199413962647_wp*F%F(6, y, z, 4:n)*G%J(6, y, z)*X_x(6, y, z, 1) &
            - 0.707905442575989_wp*F%F(4, y, z, 4:n)*G%J(4, y, z)*X_x(4, y, z, 1) &
            + 0.015764336127392_wp*F%F(3, y, z, 4:n)*G%J(3, y, z)*X_x(3, y, z, 1) &
            + 0.105400944933782_wp*F%F(2, y, z, 4:n)*G%J(2, y, z)*X_x(2, y, z, 1) &
            - 0.036210680656541_wp*F%F(1, y, z, 4:n)*G%J(1, y, z)*X_x(1, y, z, 1)

    end if

    if (x .eq. 6) then
       Jq_xU(1:3) = X_x(6, y, z, 1)*(0.016437980868017_wp*F%F(9, y, z, 1:3)&
            - 0.147941827812150_wp*F%F(8, y, z, 1:3) &
            + 0.739709139060752_wp*F%F(7, y, z, 1:3)&
            - 0.691649024426814_wp*F%F(5, y, z, 1:3)&
            + 0.063183694641876_wp*F%F(4, y, z, 1:3)&
            + 0.011220896474665_wp*F%F(3, y, z, 1:3)&
            + 0.020437334208704_wp*F%F(2, y, z, 1:3)&
            - 0.011398193015050_wp*F%F(1, y, z, 1:3))


       Jq_xU(4:n) = 0.016437980868017_wp*F%F(9, y, z, 4:n)*G%J(9, y, z)*X_x(9, y, z, 1) &
            - 0.147941827812150_wp*F%F(8, y, z, 4:n)*G%J(8, y, z)*X_x(8, y, z, 1) &
            + 0.739709139060752_wp*F%F(7, y, z, 4:n)*G%J(7, y, z)*X_x(7, y, z, 1) &
            - 0.691649024426814_wp*F%F(5, y, z, 4:n)*G%J(5, y, z)*X_x(5, y, z, 1) &
            + 0.063183694641876_wp*F%F(4, y, z, 4:n)*G%J(4, y, z)*X_x(4, y, z, 1) &
            + 0.011220896474665_wp*F%F(3, y, z, 4:n)*G%J(3, y, z)*X_x(3, y, z, 1) &
            + 0.020437334208704_wp*F%F(2, y, z, 4:n)*G%J(2, y, z)*X_x(2, y, z, 1) &
            - 0.011398193015050_wp*F%F(1, y, z, 4:n)*G%J(1, y, z)*X_x(1, y, z, 1)

    end if



    !=========================================================================================================================
    ! Right boundary closure in x-directyion
    if (x .eq. nx-5) then
       Jq_xU(1:3) = X_x(x, y, z, 1)*(-0.016437980868017_wp*F%F(nx-8, y, z, 1:3)&
            + 0.147941827812150_wp*F%F(nx-7, y, z, 1:3)&
            - 0.739709139060752_wp*F%F(nx-6, y, z, 1:3)&
            + 0.691649024426814_wp*F%F(nx-4, y, z, 1:3)&
            - 0.063183694641876_wp*F%F(nx-3, y, z, 1:3)&
            - 0.011220896474665_wp*F%F(nx-2, y, z, 1:3)&
            - 0.020437334208704_wp*F%F(nx-1, y, z, 1:3)&
            + 0.011398193015050_wp*F%F(nx, y, z, 1:3))



       Jq_xU(4:n) = - 0.016437980868017_wp*F%F(nx-8, y, z, 4:n)*G%J(nx-8, y, z)*X_x(nx-8, y, z, 1) &
            + 0.147941827812150_wp*F%F(nx-7, y, z, 4:n)*G%J(nx-7, y, z)*X_x(nx-7, y, z, 1) &
            - 0.739709139060752_wp*F%F(nx-6, y, z, 4:n)*G%J(nx-6, y, z)*X_x(nx-6, y, z, 1) &
            + 0.691649024426814_wp*F%F(nx-4, y, z, 4:n)*G%J(nx-4, y, z)*X_x(nx-4, y, z, 1) &
            - 0.063183694641876_wp*F%F(nx-3, y, z, 4:n)*G%J(nx-3, y, z)*X_x(nx-3, y, z, 1) &
            - 0.011220896474665_wp*F%F(nx-2, y, z, 4:n)*G%J(nx-2, y, z)*X_x(nx-2, y, z, 1) &
            - 0.020437334208704_wp*F%F(nx-1, y, z, 4:n)*G%J(nx-1, y, z)*X_x(nx-1, y, z, 1) &
            + 0.011398193015050_wp*F%F(nx, y, z, 4:n)*G%J(nx, y, z)*X_x(nx, y, z, 1)

    end if

    if (x .eq. nx-4) then
       Jq_xU(1:3) = X_x(x, y, z, 1)*(-0.018281071473911_wp*F%F(nx-7, y, z, 1:3)&
            + 0.164529643265203_wp*F%F(nx-6, y, z, 1:3)&
            - 0.769199413962647_wp*F%F(nx-5, y, z, 1:3)&
            + 0.707905442575989_wp*F%F(nx-3, y, z, 1:3)&
            - 0.015764336127392_wp*F%F(nx-2, y, z, 1:3)&
            - 0.105400944933782_wp*F%F(nx-1, y, z, 1:3)&
            + 0.036210680656541_wp*F%F(nx, y, z, 1:3))


       Jq_xU(4:n) = - 0.018281071473911_wp*F%F(nx-7, y, z, 4:n)*G%J(nx-7, y, z)*X_x(nx-7, y, z, 1) &
            + 0.164529643265203_wp*F%F(nx-6, y, z, 4:n)*G%J(nx-6, y, z)*X_x(nx-6, y, z, 1) &
            - 0.769199413962647_wp*F%F(nx-5, y, z, 4:n)*G%J(nx-5, y, z)*X_x(nx-5, y, z, 1) &
            + 0.707905442575989_wp*F%F(nx-3, y, z, 4:n)*G%J(nx-3, y, z)*X_x(nx-3, y, z, 1) &
            - 0.015764336127392_wp*F%F(nx-2, y, z, 4:n)*G%J(nx-2, y, z)*X_x(nx-2, y, z, 1) &
            - 0.105400944933782_wp*F%F(nx-1, y, z, 4:n)*G%J(nx-1, y, z)*X_x(nx-1, y, z, 1) &
            + 0.036210680656541_wp*F%F(nx, y, z, 4:n)*G%J(nx, y, z)*X_x(nx, y, z, 1)

    end if

    if (x .eq. nx-3) then
       Jq_xU(1:3) = X_x(x, y, z, 1)*(-0.013435342414630*F%F(nx-6, y, z, 1:3)&
            + 0.051642265516119_wp*F%F(nx-5, y, z, 1:3)&
            - 0.520262285050482_wp*F%F(nx-4, y, z, 1:3)&
            + 0.306681191361148_wp*F%F(nx-2, y, z, 1:3)&
            + 0.290087484386815_wp*F%F(nx-1, y, z, 1:3)&
            - 0.114713313798970_wp*F%F(nx, y, z, 1:3))

       Jq_xU(4:n) = - 0.013435342414630*F%F(nx-6, y, z, 4:n)*G%J(nx-6, y, z)*X_x(nx-6, y, z, 1) &
            + 0.051642265516119_wp*F%F(nx-5, y, z, 4:n)*G%J(nx-5, y, z)*X_x(nx-5, y, z, 1) &
            - 0.520262285050482_wp*F%F(nx-4, y, z, 4:n)*G%J(nx-4, y, z)*X_x(nx-4, y, z, 1) &
            + 0.306681191361148_wp*F%F(nx-2, y, z, 4:n)*G%J(nx-2, y, z)*X_x(nx-2, y, z, 1) &
            + 0.290087484386815_wp*F%F(nx-1, y, z, 4:n)*G%J(nx-1, y, z)*X_x(nx-1, y, z, 1) &
            - 0.114713313798970_wp*F%F(nx, y, z, 4:n)*G%J(nx, y, z)*X_x(nx, y, z, 1)

    end if

    if (x .eq. nx-2) then
       Jq_xU(1:3) = X_x(x, y, z, 1)*(0.018129342917256_wp*F%F(nx-5, y, z, 1:3)&
            + 0.022902190275815_wp*F%F(nx-4, y, z, 1:3)&
            - 0.606235523609147_wp*F%F(nx-3, y, z, 1:3)&
            + 0.636451095137907_wp*F%F(nx-1, y, z, 1:3) &
            - 0.071247104721830_wp*F%F(nx, y, z, 1:3))


       Jq_xU(4:n) = 0.018129342917256_wp*F%F(nx-5, y, z, 4:n)*G%J(nx-5, y, z)*X_x(nx-5, y, z, 1) &
            + 0.022902190275815_wp*F%F(nx-4, y, z, 4:n)*G%J(nx-4, y, z)*X_x(nx-4, y, z, 1) &
            - 0.606235523609147_wp*F%F(nx-3, y, z, 4:n)*G%J(nx-3, y, z)*X_x(nx-3, y, z, 1) &
            + 0.636451095137907_wp*F%F(nx-1, y, z, 4:n)*G%J(nx-1, y, z)*X_x(nx-1, y, z, 1) &
            - 0.071247104721830_wp*F%F(nx, y, z, 4:n)*G%J(nx, y, z)*X_x(nx, y, z, 1)
    end if



    if (x .eq. nx-1) then
       Jq_xU(1:3) = X_x(x, y, z, 1)*(0.014903449191300_wp*F%F(nx-5, y, z, 1:3)&
            + 0.069112065532624_wp*F%F(nx-4, y, z, 1:3)&
            - 0.258816087376832_wp*F%F(nx-3, y, z, 1:3)&
            - 0.287258622978251_wp*F%F(nx-2, y, z, 1:3)&
            + 0.462059195631158_wp*F%F(nx, y, z, 1:3))


       Jq_xU(4:n) = 0.014903449191300_wp*F%F(nx-5, y, z, 4:n)*G%J(nx-5, y, z)*X_x(nx-5, y, z, 1) &
            + 0.069112065532624_wp*F%F(nx-4, y, z, 4:n)*G%J(nx-4, y, z)*X_x(nx-4, y, z, 1) &
            - 0.258816087376832_wp*F%F(nx-3, y, z, 4:n)*G%J(nx-3, y, z)*X_x(nx-3, y, z, 1) &
            - 0.287258622978251_wp*F%F(nx-2, y, z, 4:n)*G%J(nx-2, y, z)*X_x(nx-2, y, z, 1) &
            + 0.462059195631158_wp*F%F(nx, y, z, 4:n)*G%J(nx, y, z)*X_x(nx, y, z, 1)
    end if



    if (x .eq. nx) then
       Jq_xU(1:3) =  X_x(x, y, z, 1)*(-0.036577936277544_wp*F%F(nx-5, y, z, 1:3)&
            - 0.104488069284042_wp*F%F(nx-4, y, z, 1:3)&
            + 0.450398306578272_wp*F%F(nx-3, y, z, 1:3)&
            + 0.141512858744873_wp*F%F(nx-2, y, z, 1:3)&
            - 2.033378678700676_wp*F%F(nx-1, y, z, 1:3)&
            + 1.582533518939116_wp*F%F(nx, y, z, 1:3))


       Jq_xU(4:n) = - 0.036577936277544_wp*F%F(nx-5, y, z, 4:n)*G%J(nx-5, y, z)*X_x(nx-5, y, z, 1) &
            - 0.104488069284042_wp*F%F(nx-4, y, z, 4:n)*G%J(nx-4, y, z)*X_x(nx-4, y, z, 1) &
            + 0.450398306578272_wp*F%F(nx-3, y, z, 4:n)*G%J(nx-3, y, z)*X_x(nx-3, y, z, 1) &
            + 0.141512858744873_wp*F%F(nx-2, y, z, 4:n)*G%J(nx-2, y, z)*X_x(nx-2, y, z, 1) &
            - 2.033378678700676_wp*F%F(nx-1, y, z, 4:n)*G%J(nx-1, y, z)*X_x(nx-1, y, z, 1) &
            + 1.582533518939116_wp*F%F(nx, y, z, 4:n)*G%J(nx, y, z)*X_x(nx, y, z, 1)

    end if

    !=================================================================


    Jr_xU = 0.0_wp*Jr_xU

    !implicit none

    if (y .eq. 1) then
       Jr_xU(1:3) = X_x(x, y, z, 2)*(0.036577936277544_wp*F%F(x, 6, z, 1:3)&
            + 0.104488069284042_wp*F%F(x, 5, z, 1:3)&
            - 0.450398306578272_wp*F%F(x, 4, z, 1:3)&
            - 0.141512858744873_wp*F%F(x, 3, z, 1:3)&
            + 2.033378678700676_wp*F%F(x, 2, z, 1:3)&
            - 1.582533518939116_wp*F%F(x, 1, z, 1:3))


       Jr_xU(4:n) =  0.036577936277544_wp*F%F(x, 6, z, 4:n)*G%J(x, 6, z)*X_x(x, 6, z, 2) &
            + 0.104488069284042_wp*F%F(x, 5, z, 4:n)*G%J(x, 5, z)*X_x(x, 5, z, 2) &
            - 0.450398306578272_wp*F%F(x, 4, z, 4:n)*G%J(x, 4, z)*X_x(x, 4, z, 2) &
            - 0.141512858744873_wp*F%F(x, 3, z, 4:n)*G%J(x, 3, z)*X_x(x, 3, z, 2) &
            + 2.033378678700676_wp*F%F(x, 2, z, 4:n)*G%J(x, 2, z)*X_x(x, 2, z, 2) &
            - 1.582533518939116_wp*F%F(x, 1, z, 4:n)*G%J(x, 1, z)*X_x(x, 1, z, 2)

    end if

    if (y .eq. 2) then
       Jr_xU(1:3) =X_x(x, y, z, 2)*(-0.014903449191300_wp*F%F(x, 6, z, 1:3)&
            - 0.069112065532624_wp*F%F(x, 5, z, 1:3)&
            + 0.258816087376832_wp*F%F(x, 4, z, 1:3)&
            + 0.287258622978251_wp*F%F(x, 3, z, 1:3)&
            - 0.462059195631158_wp*F%F(x, 1, z, 1:3))



       Jr_xU(4:n) = -0.014903449191300_wp*F%F(x, 6, z, 4:n)*G%J(x, 6, z)*X_x(x, 6, z, 2) &
            - 0.069112065532624_wp*F%F(x, 5, z, 4:n)*G%J(x, 5, z)*X_x(x, 5, z, 2) &
            + 0.258816087376832_wp*F%F(x, 4, z, 4:n)*G%J(x, 4, z)*X_x(x, 4, z, 2) &
            + 0.287258622978251_wp*F%F(x, 3, z, 4:n)*G%J(x, 3, z)*X_x(x, 3, z, 2) &
            - 0.462059195631158_wp*F%F(x, 1, z, 4:n)*G%J(x, 1, z)*X_x(x, 1, z, 2)

    end if

    if (y .eq. 3) then
       Jr_xU(1:3) =  X_x(x, y, z, 2)*(-0.018129342917256_wp*F%F(x, 6, z, 1:3)&
            - 0.022902190275815_wp*F%F(x, 5, z, 1:3)&
            + 0.606235523609147_wp*F%F(x, 4, z, 1:3)&
            - 0.636451095137907_wp*F%F(x, 2, z, 1:3)&
            + 0.071247104721830_wp*F%F(x, 1, z, 1:3))

       Jr_xU(4:n) =  -0.018129342917256_wp*F%F(x, 6, z, 4:n)*G%J(x, 6, z)*X_x(x, 6, z, 2) &
            - 0.022902190275815_wp*F%F(x, 5, z, 4:n)*G%J(x, 5, z)*X_x(x, 5, z, 2) &
            + 0.606235523609147_wp*F%F(x, 4, z, 4:n)*G%J(x, 4, z)*X_x(x, 4, z, 2) &
            - 0.636451095137907_wp*F%F(x, 2, z, 4:n)*G%J(x, 2, z)*X_x(x, 2, z, 2) &
            + 0.071247104721830_wp*F%F(x, 1, z, 4:n)*G%J(x, 1, z)*X_x(x, 1, z, 2)


    end if

    if (y .eq. 4) then
       Jr_xU(1:3) =   X_x(x, y, z, 2)*(0.013435342414630*F%F(x, 7, z, 1:3)&
            - 0.051642265516119_wp*F%F(x, 6, z, 1:3)&
            + 0.520262285050482_wp*F%F(x, 5, z, 1:3)&
            - 0.306681191361148_wp*F%F(x, 3, z, 1:3)&
            - 0.290087484386815_wp*F%F(x, 2, z, 1:3)&
            + 0.114713313798970_wp*F%F(x, 1, z, 1:3))

       Jr_xU(4:n) =   0.013435342414630*F%F(x, 7, z, 4:n)*G%J(x, 7, z)*X_x(x, 7, z, 2) &
            - 0.051642265516119_wp*F%F(x, 6, z, 4:n)*G%J(x, 6, z)*X_x(x, 6, z, 2) &
            + 0.520262285050482_wp*F%F(x, 5, z, 4:n)*G%J(x, 5, z)*X_x(x, 5, z, 2) &
            - 0.306681191361148_wp*F%F(x, 3, z, 4:n)*G%J(x, 3, z)*X_x(x, 3, z, 2) &
            - 0.290087484386815_wp*F%F(x, 2, z, 4:n)*G%J(x, 2, z)*X_x(x, 2, z, 2) &
            + 0.114713313798970_wp*F%F(x, 1, z, 4:n)*G%J(x, 1, z)*X_x(x, 1, z, 2)


    end if


    if (y .eq. 5) then
       Jr_xU(1:3) = X_x(x, y, z, 2)*(0.018281071473911_wp*F%F(x, 8, z, 1:3)&
            - 0.164529643265203_wp*F%F(x, 7, z, 1:3) &
            + 0.769199413962647_wp*F%F(x, 6, z, 1:3) &
            - 0.707905442575989_wp*F%F(x, 4, z, 1:3) &
            + 0.015764336127392_wp*F%F(x, 3, z, 1:3) &
            + 0.105400944933782_wp*F%F(x, 2, z, 1:3) &
            - 0.036210680656541_wp*F%F(x, 1, z, 1:3))


       Jr_xU(4:n) = 0.018281071473911_wp*F%F(x, 8, z, 4:n)*G%J(x, 8, z)*X_x(x, 8, z, 2) &
            - 0.164529643265203_wp*F%F(x, 7, z, 4:n)*G%J(x, 7, z)*X_x(x, 7, z, 2) &
            + 0.769199413962647_wp*F%F(x, 6, z, 4:n)*G%J(x, 6, z)*X_x(x, 6, z, 2) &
            - 0.707905442575989_wp*F%F(x, 4, z, 4:n)*G%J(x, 4, z)*X_x(x, 4, z, 2) &
            + 0.015764336127392_wp*F%F(x, 3, z, 4:n)*G%J(x, 3, z)*X_x(x, 3, z, 2) &
            + 0.105400944933782_wp*F%F(x, 2, z, 4:n)*G%J(x, 2, z)*X_x(x, 2, z, 2) &
            - 0.036210680656541_wp*F%F(x, 1, z, 4:n)*G%J(x, 1, z)*X_x(x, 1, z, 2)


    end if


    if (y .eq. 6) then
       Jr_xU(1:3) = X_x(x, y, z, 2)*(0.016437980868017_wp*F%F(x, 9, z, 1:3)&
            - 0.147941827812150_wp*F%F(x, 8, z, 1:3)&
            + 0.739709139060752_wp*F%F(x, 7, z, 1:3)&
            - 0.691649024426814_wp*F%F(x, 5, z, 1:3)&
            + 0.063183694641876_wp*F%F(x, 4, z, 1:3)&
            + 0.011220896474665_wp*F%F(x, 3, z, 1:3)&
            + 0.020437334208704_wp*F%F(x, 2, z, 1:3)&
            - 0.011398193015050_wp*F%F(x, 1, z, 1:3))


       Jr_xU(4:n) = 0.016437980868017_wp*F%F(x, 9, z, 4:n)*G%J(x, 9, z)*X_x(x, 9, z, 2) &
            - 0.147941827812150_wp*F%F(x, 8, z, 4:n)*G%J(x, 8, z)*X_x(x, 8, z, 2) &
            + 0.739709139060752_wp*F%F(x, 7, z, 4:n)*G%J(x, 7, z)*X_x(x, 7, z, 2) &
            - 0.691649024426814_wp*F%F(x, 5, z, 4:n)*G%J(x, 5, z)*X_x(x, 5, z, 2) &
            + 0.063183694641876_wp*F%F(x, 4, z, 4:n)*G%J(x, 4, z)*X_x(x, 4, z, 2) &
            + 0.011220896474665_wp*F%F(x, 3, z, 4:n)*G%J(x, 3, z)*X_x(x, 3, z, 2) &
            + 0.020437334208704_wp*F%F(x, 2, z, 4:n)*G%J(x, 2, z)*X_x(x, 2, z, 2) &
            - 0.011398193015050_wp*F%F(x, 1, z, 4:n)*G%J(x, 1, z)*X_x(x, 1, z, 2)

    end if

    if (y .eq.  ny-5) then
       Jr_xU(1:3) = X_x(x, y, z, 2)*(-0.016437980868017_wp*F%F(x, ny-8, z, 1:3) &
            + 0.147941827812150_wp*F%F(x, ny-7, z, 1:3) &
            - 0.739709139060752_wp*F%F(x, ny-6, z, 1:3) &
            + 0.691649024426814_wp*F%F(x, ny-4, z, 1:3) &
            - 0.063183694641876_wp*F%F(x, ny-3, z, 1:3) &
            - 0.011220896474665_wp*F%F(x, ny-2, z, 1:3) &
            - 0.020437334208704_wp*F%F(x, ny-1, z, 1:3) &
            + 0.011398193015050_wp*F%F(x, ny, z, 1:3))


       Jr_xU(4:n) = -0.016437980868017_wp*F%F(x, ny-8, z, 4:n)*G%J(x, ny-8, z)*X_x(x, ny-8, z, 2) &
            + 0.147941827812150_wp*F%F(x, ny-7, z, 4:n)*G%J(x, ny-7, z)*X_x(x, ny-7, z, 2) &
            - 0.739709139060752_wp*F%F(x, ny-6, z, 4:n)*G%J(x, ny-6, z)*X_x(x, ny-6, z, 2) &
            + 0.691649024426814_wp*F%F(x, ny-4, z, 4:n)*G%J(x, ny-4, z)*X_x(x, ny-4, z, 2) &
            - 0.063183694641876_wp*F%F(x, ny-3, z, 4:n)*G%J(x, ny-3, z)*X_x(x, ny-3, z, 2) &
            - 0.011220896474665_wp*F%F(x, ny-2, z, 4:n)*G%J(x, ny-2, z)*X_x(x, ny-2, z, 2) &
            - 0.020437334208704_wp*F%F(x, ny-1, z, 4:n)*G%J(x, ny-1, z)*X_x(x, ny-1, z, 2) &
            + 0.011398193015050_wp*F%F(x, ny, z, 4:n)*G%J(x, ny, z)*X_x(x, ny, z, 2)

    end if

    if (y .eq.  ny-4) then
       Jr_xU(1:3) = X_x(x, y, z, 2)*(-0.018281071473911_wp*F%F(x, ny-7, z, 1:3)&
            + 0.164529643265203_wp*F%F(x, ny-6, z, 1:3)&
            - 0.769199413962647_wp*F%F(x, ny-5, z, 1:3)&
            + 0.707905442575989_wp*F%F(x, ny-3, z, 1:3)&
            - 0.015764336127392_wp*F%F(x, ny-2, z, 1:3)&
            - 0.105400944933782_wp*F%F(x, ny-1, z, 1:3)&
            + 0.036210680656541_wp*F%F(x, ny, z, 1:3))


       Jr_xU(4:n) = - 0.018281071473911_wp*F%F(x, ny-7, z, 4:n)*G%J(x, ny-7, z)*X_x(x, ny-7, z, 2) &
            + 0.164529643265203_wp*F%F(x, ny-6, z, 4:n)*G%J(x, ny-6, z)*X_x(x, ny-6, z, 2) &
            - 0.769199413962647_wp*F%F(x, ny-5, z, 4:n)*G%J(x, ny-5, z)*X_x(x, ny-5, z, 2) &
            + 0.707905442575989_wp*F%F(x, ny-3, z, 4:n)*G%J(x, ny-3, z)*X_x(x, ny-3, z, 2) &
            - 0.015764336127392_wp*F%F(x, ny-2, z, 4:n)*G%J(x, ny-2, z)*X_x(x, ny-2, z, 2) &
            - 0.105400944933782_wp*F%F(x, ny-1, z, 4:n)*G%J(x, ny-1, z)*X_x(x, ny-1, z, 2) &
            + 0.036210680656541_wp*F%F(x, ny, z, 4:n)*G%J(x, ny, z)*X_x(x, ny, z, 2)

    end if

    if (y .eq.  ny-3) then

       Jr_xU(1:3) = X_x(x, y, z, 2)*(-0.013435342414630*F%F(x, ny-6, z, 1:3)&
            + 0.051642265516119_wp*F%F(x, ny-5, z, 1:3)&
            - 0.520262285050482_wp*F%F(x, ny-4, z, 1:3)&
            + 0.306681191361148_wp*F%F(x, ny-2, z, 1:3)&
            + 0.290087484386815_wp*F%F(x, ny-1, z, 1:3)&
            - 0.114713313798970_wp*F%F(x, ny, z, 1:3))


       Jr_xU(4:n) = - 0.013435342414630*F%F(x, ny-6, z, 4:n)*G%J(x, ny-6, z)*X_x(x, ny-6, z, 2) &
            + 0.051642265516119_wp*F%F(x, ny-5, z, 4:n)*G%J(x, ny-5, z)*X_x(x, ny-5, z, 2) &
            - 0.520262285050482_wp*F%F(x, ny-4, z, 4:n)*G%J(x, ny-4, z)*X_x(x, ny-4, z, 2) &
            + 0.306681191361148_wp*F%F(x, ny-2, z, 4:n)*G%J(x, ny-2, z)*X_x(x, ny-2, z, 2) &
            + 0.290087484386815_wp*F%F(x, ny-1, z, 4:n)*G%J(x, ny-1, z)*X_x(x, ny-1, z, 2) &
            - 0.114713313798970_wp*F%F(x, ny, z, 4:n)*G%J(x, ny, z)*X_x(x, ny, z, 2)



    end if


    if (y .eq.  ny-2) then

       Jr_xU(1:3) = X_x(x, y, z, 2)*(0.018129342917256_wp*F%F(x, ny-5, z, 1:3)&
            + 0.022902190275815_wp*F%F(x, ny-4, z, 1:3)&
            - 0.606235523609147_wp*F%F(x, ny-3, z, 1:3)&
            + 0.636451095137907_wp*F%F(x, ny-1, z, 1:3)&
            - 0.071247104721830_wp*F%F(x, ny, z, 1:3))

       Jr_xU(4:n) = 0.018129342917256_wp*F%F(x, ny-5, z, 4:n)*G%J(x, ny-5, z)*X_x(x, ny-5, z, 2) &
            + 0.022902190275815_wp*F%F(x, ny-4, z, 4:n)*G%J(x, ny-4, z)*X_x(x, ny-4, z, 2) &
            - 0.606235523609147_wp*F%F(x, ny-3, z, 4:n)*G%J(x, ny-3, z)*X_x(x, ny-3, z, 2) &
            + 0.636451095137907_wp*F%F(x, ny-1, z, 4:n)*G%J(x, ny-1, z)*X_x(x, ny-1, z, 2) &
            - 0.071247104721830_wp*F%F(x, ny, z, 4:n)*G%J(x, ny, z)*X_x(x, ny, z, 2)


    end if

    if (y .eq.  ny-1) then
       Jr_xU(1:3) = X_x(x, y, z, 2)*(0.014903449191300_wp*F%F(x, ny-5, z, 1:3)&
            + 0.069112065532624_wp*F%F(x, ny-4, z, 1:3)&
            - 0.258816087376832_wp*F%F(x, ny-3, z, 1:3)&
            - 0.287258622978251_wp*F%F(x, ny-2, z, 1:3)&
            + 0.462059195631158_wp*F%F(x, ny, z, 1:3))


       Jr_xU(4:n) = 0.014903449191300_wp*F%F(x, ny-5, z, 4:n)*G%J(x, ny-5, z)*X_x(x, ny-5, z, 2) &
            + 0.069112065532624_wp*F%F(x, ny-4, z, 4:n)*G%J(x, ny-4, z)*X_x(x, ny-4, z, 2) &
            - 0.258816087376832_wp*F%F(x, ny-3, z, 4:n)*G%J(x, ny-3, z)*X_x(x, ny-3, z, 2) &
            - 0.287258622978251_wp*F%F(x, ny-2, z, 4:n)*G%J(x, ny-2, z)*X_x(x, ny-2, z, 2) &
            + 0.462059195631158_wp*F%F(x, ny, z, 4:n)*G%J(x, ny, z)*X_x(x, ny, z, 2)
    end if

    if (y .eq.  ny) then
       Jr_xU(1:3)  = X_x(x, y, z, 2)*(- 0.036577936277544_wp*F%F(x, ny-5, z, 1:3)&
            - 0.104488069284042_wp*F%F(x, ny-4, z, 1:3)&
            + 0.450398306578272_wp*F%F(x, ny-3, z, 1:3)&
            + 0.141512858744873_wp*F%F(x, ny-2, z, 1:3)&
            - 2.033378678700676_wp*F%F(x, ny-1, z, 1:3)&
            + 1.582533518939116_wp*F%F(x, ny, z, 1:3))

       Jr_xU(4:n)  =  - 0.036577936277544_wp*F%F(x, ny-5, z, 4:n)*G%J(x, ny-5, z)*X_x(x, ny-5, z, 2) &
            - 0.104488069284042_wp*F%F(x, ny-4, z, 4:n)*G%J(x, ny-4, z)*X_x(x, ny-4, z, 2) &
            + 0.450398306578272_wp*F%F(x, ny-3, z, 4:n)*G%J(x, ny-3, z)*X_x(x, ny-3, z, 2) &
            + 0.141512858744873_wp*F%F(x, ny-2, z, 4:n)*G%J(x, ny-2, z)*X_x(x, ny-2, z, 2) &
            - 2.033378678700676_wp*F%F(x, ny-1, z, 4:n)*G%J(x, ny-1, z)*X_x(x, ny-1, z, 2) &
            + 1.582533518939116_wp*F%F(x, ny, z, 4:n)*G%J(x, ny, z)*X_x(x, ny, z, 2)


    end if


    if ((y .ge. 7) .and. (y .le. ny-6)) then

       Jr_xU(1:3) = X_x(x, y, z, 2)*(-1.0_wp/60.0_wp*F%F(x, y-3, z, 1:3)&
            + 0.15_wp*F%F(x, y-2, z, 1:3)&
            - 0.75_wp*F%F(x, y-1, z, 1:3)&
            + 0.75_wp*F%F(x, y+1, z, 1:3)&
            - 0.15_wp*F%F(x, y+2, z, 1:3)&
            + 1.0_wp/60.0_wp*F%F(x, y+3, z, 1:3))

       Jr_xU(4:n) =   -1.0_wp/60.0_wp*F%F(x, y-3, z, 4:n)*G%J(x, y-3, z)*X_x(x, y-3, z, 2) &
            + 0.15_wp*F%F(x, y-2, z, 4:n)*G%J(x, y-2, z)*X_x(x, y-2, z, 2) &
            - 0.75_wp*F%F(x, y-1, z, 4:n)*G%J(x, y-1, z)*X_x(x, y-1, z, 2) &
            + 0.75_wp*F%F(x, y+1, z, 4:n)*G%J(x, y+1, z)*X_x(x, y+1, z, 2) &
            - 0.15_wp*F%F(x, y+2, z, 4:n)*G%J(x, y+2, z)*X_x(x, y+2, z, 2) &
            + 1.0_wp/60.0_wp*F%F(x, y+3, z, 4:n)*G%J(x, y+3, z)*X_x(x, y+3, z, 2)
    end if

    !======================================================================



    Js_xU = 0.0_wp*Js_xU

    if (z .eq. 1) then
        Js_xU(1:3) = X_x(x,y,z,3)*(0.036577936277544_wp*F%F(x, y, 6, 1:3)&
            + 0.104488069284042_wp*F%F(x, y, 5, 1:3)&
            - 0.450398306578272_wp*F%F(x, y, 4, 1:3)&
            - 0.141512858744873_wp*F%F(x, y, 3, 1:3)&
            + 2.033378678700676_wp*F%F(x, y, 2, 1:3)&
            - 1.582533518939116_wp*F%F(x, y, 1, 1:3))

       Js_xU(4:n) =  0.036577936277544_wp*F%F(x, y, 6, 4:n)*G%J(x, y, 6)*X_x(x, y, 6, 3) &
            + 0.104488069284042_wp*F%F(x, y, 5, 4:n)*G%J(x, y, 5)*X_x(x, y, 5, 3) &
            - 0.450398306578272_wp*F%F(x, y, 4, 4:n)*G%J(x, y, 4)*X_x(x, y, 4, 3) &
            - 0.141512858744873_wp*F%F(x, y, 3, 4:n)*G%J(x, y, 3)*X_x(x, y, 3, 3) &
            + 2.033378678700676_wp*F%F(x, y, 2, 4:n)*G%J(x, y, 2)*X_x(x, y, 2, 3) &
            - 1.582533518939116_wp*F%F(x, y, 1, 4:n)*G%J(x, y, 1)*X_x(x, y, 1, 3)
    end if




    if (z .eq.  2) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(-0.014903449191300_wp*F%F(x, y, 6, 1:3)&
            - 0.069112065532624_wp*F%F(x, y, 5, 1:3)&
            + 0.258816087376832_wp*F%F(x, y, 4, 1:3)&
            + 0.287258622978251_wp*F%F(x, y, 3, 1:3)&
            - 0.462059195631158_wp*F%F(x, y, 1, 1:3))

       Js_xU(4:n) = -0.014903449191300_wp*F%F(x, y, 6, 4:n)*G%J(x, y, 6)*X_x(x, y, 6, 3) &
            - 0.069112065532624_wp*F%F(x, y, 5, 4:n)*G%J(x, y, 5)*X_x(x, y, 5, 3) &
            + 0.258816087376832_wp*F%F(x, y, 4, 4:n)*G%J(x, y, 4)*X_x(x, y, 4, 3) &
            + 0.287258622978251_wp*F%F(x, y, 3, 4:n)*G%J(x, y, 3)*X_x(x, y, 3, 3) &
            - 0.462059195631158_wp*F%F(x, y, 1, 4:n)*G%J(x, y, 1)*X_x(x, y, 1, 3)

    end if



    if (z .eq.  3) then
       Js_xU(1:3)  = X_x(x, y, z, 3)*(-0.018129342917256_wp*F%F(x, y, 6, 1:3)&
            - 0.022902190275815_wp*F%F(x, y, 5, 1:3)&
            + 0.606235523609147_wp*F%F(x, y, 4, 1:3)&
            - 0.636451095137907_wp*F%F(x, y, 2, 1:3)&
            + 0.071247104721830_wp*F%F(x, y, 1, 1:3))


       Js_xU(4:n)  = -0.018129342917256_wp*F%F(x, y, 6, 4:n)*G%J(x, y, 6)*X_x(x, y, 6, 3) &
            - 0.022902190275815_wp*F%F(x, y, 5, 4:n)*G%J(x, y, 5)*X_x(x, y, 5, 3) &
            + 0.606235523609147_wp*F%F(x, y, 4, 4:n)*G%J(x, y, 4)*X_x(x, y, 4, 3) &
            - 0.636451095137907_wp*F%F(x, y, 2, 4:n)*G%J(x, y, 2)*X_x(x, y, 2, 3) &
            + 0.071247104721830_wp*F%F(x, y, 1, 4:n)*G%J(x, y, 1)*X_x(x, y, 1, 3)


    end if


    if (z .eq.  4) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(0.013435342414630*F%F(x, y, 7, 1:3)&
            - 0.051642265516119_wp*F%F(x, y, 6, 1:3)&
            + 0.520262285050482_wp*F%F(x, y, 5, 1:3)&
            - 0.306681191361148_wp*F%F(x, y, 3, 1:3)&
            - 0.290087484386815_wp*F%F(x, y, 2, 1:3)&
            + 0.114713313798970_wp*F%F(x, y, 1, 1:3))

       Js_xU(4:n) =   0.013435342414630*F%F(x, y, 7, 4:n)*G%J(x, y, 7)*X_x(x, y, 7, 3) &
            - 0.051642265516119_wp*F%F(x, y, 6, 4:n)*G%J(x, y, 6)*X_x(x, y, 6, 3) &
            + 0.520262285050482_wp*F%F(x, y, 5, 4:n)*G%J(x, y, 5)*X_x(x, y, 5, 3) &
            - 0.306681191361148_wp*F%F(x, y, 3, 4:n)*G%J(x, y, 3)*X_x(x, y, 3, 3) &
            - 0.290087484386815_wp*F%F(x, y, 2, 4:n)*G%J(x, y, 2)*X_x(x, y, 2, 3) &
            + 0.114713313798970_wp*F%F(x, y, 1, 4:n)*G%J(x, y, 1)*X_x(x, y, 1, 3)

    end if


    if (z .eq.  5) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(0.018281071473911_wp*F%F(x, y, 8, 1:3)&
            - 0.164529643265203_wp*F%F(x, y, 7, 1:3)&
            + 0.769199413962647_wp*F%F(x, y, 6, 1:3)&
            - 0.707905442575989_wp*F%F(x, y, 4, 1:3)&
            + 0.015764336127392_wp*F%F(x, y, 3, 1:3)&
            + 0.105400944933782_wp*F%F(x, y, 2, 1:3)&
            - 0.036210680656541_wp*F%F(x, y, 1, 1:3))

       Js_xU(4:n) =  0.018281071473911_wp*F%F(x, y, 8, 4:n)*G%J(x, y, 8)*X_x(x, y, 8, 3) &
            - 0.164529643265203_wp*F%F(x, y, 7, 4:n)*G%J(x, y, 7)*X_x(x, y, 7, 3) &
            + 0.769199413962647_wp*F%F(x, y, 6, 4:n)*G%J(x, y, 6)*X_x(x, y, 6, 3) &
            - 0.707905442575989_wp*F%F(x, y, 4, 4:n)*G%J(x, y, 4)*X_x(x, y, 4, 3) &
            + 0.015764336127392_wp*F%F(x, y, 3, 4:n)*G%J(x, y, 3)*X_x(x, y, 3, 3) &
            + 0.105400944933782_wp*F%F(x, y, 2, 4:n)*G%J(x, y, 2)*X_x(x, y, 2, 3) &
            - 0.036210680656541_wp*F%F(x, y, 1, 4:n)*G%J(x, y, 1)*X_x(x, y, 1, 3)

    end if


    if (z .eq.  6) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(0.016437980868017_wp*F%F(x, y, 9, 1:3)&
            - 0.147941827812150_wp*F%F(x, y, 8, 1:3)&
            + 0.739709139060752_wp*F%F(x, y, 7, 1:3)&
            - 0.691649024426814_wp*F%F(x, y, 5, 1:3)&
            + 0.063183694641876_wp*F%F(x, y, 4, 1:3)&
            + 0.011220896474665_wp*F%F(x, y, 3, 1:3)&
            + 0.020437334208704_wp*F%F(x, y, 2, 1:3)&
            - 0.011398193015050_wp*F%F(x, y, 1, 1:3))

       Js_xU(4:n) =  0.016437980868017_wp*F%F(x, y, 9, 4:n)*G%J(x, y, 9)*X_x(x, y, 9, 3) &
            - 0.147941827812150_wp*F%F(x, y, 8, 4:n)*G%J(x, y, 8)*X_x(x, y, 8, 3) &
            + 0.739709139060752_wp*F%F(x, y, 7, 4:n)*G%J(x, y, 7)*X_x(x, y, 7, 3) &
            - 0.691649024426814_wp*F%F(x, y, 5, 4:n)*G%J(x, y, 5)*X_x(x, y, 5, 3) &
            + 0.063183694641876_wp*F%F(x, y, 4, 4:n)*G%J(x, y, 4)*X_x(x, y, 4, 3) &
            + 0.011220896474665_wp*F%F(x, y, 3, 4:n)*G%J(x, y, 3)*X_x(x, y, 3, 3) &
            + 0.020437334208704_wp*F%F(x, y, 2, 4:n)*G%J(x, y, 2)*X_x(x, y, 2, 3) &
            - 0.011398193015050_wp*F%F(x, y, 1, 4:n)*G%J(x, y, 1)*X_x(x, y, 1, 3)

    end if



    if (z .eq.   nz-5) then
       Js_xU(1:3) =  X_x(x, y, z, 3)*(-0.016437980868017_wp*F%F(x, y, nz-8, 1:3)&
            + 0.147941827812150_wp*F%F(x, y, nz-7, 1:3)&
            - 0.739709139060752_wp*F%F(x, y, nz-6, 1:3)&
            + 0.691649024426814_wp*F%F(x, y, nz-4, 1:3)&
            - 0.063183694641876_wp*F%F(x, y, nz-3, 1:3)&
            - 0.011220896474665_wp*F%F(x, y, nz-2, 1:3)&
            - 0.020437334208704_wp*F%F(x, y, nz-1, 1:3)&
            + 0.011398193015050_wp*F%F(x, y, nz, 1:3))

       Js_xU(4:n) = -0.016437980868017_wp*F%F(x, y, nz-8, 4:n)*G%J(x, y, nz-8)*X_x(x, y, nz-8, 3) &
            + 0.147941827812150_wp*F%F(x, y, nz-7, 4:n)*G%J(x, y, nz-7)*X_x(x, y, nz-7, 3) &
            - 0.739709139060752_wp*F%F(x, y, nz-6, 4:n)*G%J(x, y, nz-6)*X_x(x, y, nz-6, 3) &
            + 0.691649024426814_wp*F%F(x, y, nz-4, 4:n)*G%J(x, y, nz-4)*X_x(x, y, nz-4, 3) &
            - 0.063183694641876_wp*F%F(x, y, nz-3, 4:n)*G%J(x, y, nz-3)*X_x(x, y, nz-3, 3) &
            - 0.011220896474665_wp*F%F(x, y, nz-2, 4:n)*G%J(x, y, nz-2)*X_x(x, y, nz-2, 3) &
            - 0.020437334208704_wp*F%F(x, y, nz-1, 4:n)*G%J(x, y, nz-1)*X_x(x, y, nz-1, 3) &
            + 0.011398193015050_wp*F%F(x, y, nz, 4:n)*G%J(x, y, nz)*X_x(x, y, nz, 3)

    end if



    if (z .eq. nz-4) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(-0.018281071473911_wp*F%F(x, y, nz-7, 1:3)&
            + 0.164529643265203_wp*F%F(x, y, nz-6, 1:3)&
            - 0.769199413962647_wp*F%F(x, y, nz-5, 1:3)&
            + 0.707905442575989_wp*F%F(x, y, nz-3, 1:3)&
            - 0.015764336127392_wp*F%F(x, y, nz-2, 1:3)&
            - 0.105400944933782_wp*F%F(x, y, nz-1, 1:3)&
            + 0.036210680656541_wp*F%F(x, y, nz, 1:3))


       Js_xU(4:n) = -0.018281071473911_wp*F%F(x, y, nz-7, 4:n)*G%J(x, y, nz-7)*X_x(x, y, nz-7, 3) &
            + 0.164529643265203_wp*F%F(x, y, nz-6, 4:n)*G%J(x, y, nz-6)*X_x(x, y, nz-6, 3) &
            - 0.769199413962647_wp*F%F(x, y, nz-5, 4:n)*G%J(x, y, nz-5)*X_x(x, y, nz-5, 3) &
            + 0.707905442575989_wp*F%F(x, y, nz-3, 4:n)*G%J(x, y, nz-3)*X_x(x, y, nz-3, 3) &
            - 0.015764336127392_wp*F%F(x, y, nz-2, 4:n)*G%J(x, y, nz-2)*X_x(x, y, nz-2, 3) &
            - 0.105400944933782_wp*F%F(x, y, nz-1, 4:n)*G%J(x, y, nz-1)*X_x(x, y, nz-1, 3) &
            + 0.036210680656541_wp*F%F(x, y, nz, 4:n)*G%J(x, y, nz)*X_x(x, y, nz, 3)

    end if



    if (z .eq.   nz-3) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(-0.013435342414630*F%F(x, y, nz-6, 1:3)&
            + 0.051642265516119_wp*F%F(x, y, nz-5, 1:3)&
            - 0.520262285050482_wp*F%F(x, y, nz-4, 1:3)&
            + 0.306681191361148_wp*F%F(x, y, nz-2, 1:3)&
            + 0.290087484386815_wp*F%F(x, y, nz-1, 1:3)&
            - 0.114713313798970_wp*F%F(x, y, nz, 1:3))

       Js_xU(4:n) =  - 0.013435342414630*F%F(x, y, nz-6, 4:n)*G%J(x, y, nz-6)*X_x(x, y, nz-6, 3) &
            + 0.051642265516119_wp*F%F(x, y, nz-5, 4:n)*G%J(x, y, nz-5)*X_x(x, y, nz-5, 3) &
            - 0.520262285050482_wp*F%F(x, y, nz-4, 4:n)*G%J(x, y, nz-4)*X_x(x, y, nz-4, 3) &
            + 0.306681191361148_wp*F%F(x, y, nz-2, 4:n)*G%J(x, y, nz-2)*X_x(x, y, nz-2, 3) &
            + 0.290087484386815_wp*F%F(x, y, nz-1, 4:n)*G%J(x, y, nz-1)*X_x(x, y, nz-1, 3) &
            - 0.114713313798970_wp*F%F(x, y, nz, 4:n)*G%J(x, y, nz)*X_x(x, y, nz, 3)

    end if


    if (z .eq.   nz-2) then

       Js_xU(1:3) = X_x(x, y, z, 3)*(0.018129342917256_wp*F%F(x, y, nz-5, 1:3)&
            + 0.022902190275815_wp*F%F(x, y, nz-4, 1:3)&
            - 0.606235523609147_wp*F%F(x, y, nz-3, 1:3)&
            + 0.636451095137907_wp*F%F(x, y, nz-1, 1:3)&
            - 0.071247104721830_wp*F%F(x, y, nz, 1:3))

       Js_xU(4:n) = 0.018129342917256_wp*F%F(x, y, nz-5, 4:n)*G%J(x, y, nz-5)*X_x(x, y, nz-5, 3) &
            + 0.022902190275815_wp*F%F(x, y, nz-4, 4:n)*G%J(x, y, nz-4)*X_x(x, y, nz-4, 3) &
            - 0.606235523609147_wp*F%F(x, y, nz-3, 4:n)*G%J(x, y, nz-3)*X_x(x, y, nz-3, 3) &
            + 0.636451095137907_wp*F%F(x, y, nz-1, 4:n)*G%J(x, y, nz-1)*X_x(x, y, nz-1, 3) &
            - 0.071247104721830_wp*F%F(x, y, nz, 4:n)*G%J(x, y, nz)*X_x(x, y, nz, 3)

    end if

    if (z .eq.   nz-1) then

       Js_xU(1:3) = X_x(x, y, z, 3)*(0.014903449191300_wp*F%F(x, y, nz-5, 1:3)&
            + 0.069112065532624_wp*F%F(x, y, nz-4, 1:3)&
            - 0.258816087376832_wp*F%F(x, y, nz-3, 1:3)&
            - 0.287258622978251_wp*F%F(x, y, nz-2, 1:3)&
            + 0.462059195631158_wp*F%F(x, y, nz, 1:3))


       Js_xU(4:n) = 0.014903449191300_wp*F%F(x, y, nz-5, 4:n)*G%J(x, y, nz-5)*X_x(x, y, nz-5, 3) &
            + 0.069112065532624_wp*F%F(x, y, nz-4, 4:n)*G%J(x, y, nz-4)*X_x(x, y, nz-4, 3) &
            - 0.258816087376832_wp*F%F(x, y, nz-3, 4:n)*G%J(x, y, nz-3)*X_x(x, y, nz-3, 3) &
            - 0.287258622978251_wp*F%F(x, y, nz-2, 4:n)*G%J(x, y, nz-2)*X_x(x, y, nz-2, 3) &
            + 0.462059195631158_wp*F%F(x, y, nz, 4:n)*G%J(x, y, nz)*X_x(x, y, nz, 3)

    end if

    if (z .eq.   nz) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(-0.036577936277544_wp*F%F(x, y, nz-5, 1:3)&
            - 0.104488069284042_wp*F%F(x, y, nz-4, 1:3)&
            + 0.450398306578272_wp*F%F(x, y, nz-3, 1:3)&
            + 0.141512858744873_wp*F%F(x, y, nz-2, 1:3)&
            - 2.033378678700676_wp*F%F(x, y, nz-1, 1:3)&
            + 1.582533518939116_wp*F%F(x, y, nz, 1:3))


       Js_xU(4:n)   = -0.036577936277544_wp*F%F(x, y, nz-5, 4:n)*G%J(x, y, nz-5)*X_x(x, y, nz-5, 3) &
            - 0.104488069284042_wp*F%F(x, y, nz-4, 4:n)*G%J(x, y, nz-4)*X_x(x, y, nz-4, 3) &
            + 0.450398306578272_wp*F%F(x, y, nz-3, 4:n)*G%J(x, y, nz-3)*X_x(x, y, nz-3, 3) &
            + 0.141512858744873_wp*F%F(x, y, nz-2, 4:n)*G%J(x, y, nz-2)*X_x(x, y, nz-2, 3) &
            - 2.033378678700676_wp*F%F(x, y, nz-1, 4:n)*G%J(x, y, nz-1)*X_x(x, y, nz-1, 3) &
            + 1.582533518939116_wp*F%F(x, y, nz, 4:n)*G%J(x, y, nz)*X_x(x, y, nz, 3)

    end if

    if ((z .ge. 7) .and. (z .le. nz-6)) then
       Js_xU(1:3) = X_x(x, y, z, 3)*(-1.0_wp/60.0_wp*F%F(x, y, z-3, 1:3)&
            + 0.15_wp*F%F(x, y, z-2, 1:3)&
            - 0.75_wp*F%F(x, y, z-1, 1:3)&
            + 0.75_wp*F%F(x, y, z+1, 1:3)&
            - 0.15_wp*F%F(x, y, z+2, 1:3)&
            + 1.0_wp/60.0_wp*F%F(x, y, z+3, 1:3))


       Js_xU(4:n) =  -1.0_wp/60.0_wp*F%F(x, y, z-3, 4:n)*G%J(x, y, z-3)*X_x(x, y, z-3, 3) &
            + 0.15_wp*F%F(x, y, z-2, 4:n)*G%J(x, y, z-2)*X_x(x, y, z-2, 3) &
            - 0.75_wp*F%F(x, y, z-1, 4:n)*G%J(x, y, z-1)*X_x(x, y, z-1, 3) &
            + 0.75_wp*F%F(x, y, z+1, 4:n)*G%J(x, y, z+1)*X_x(x, y, z+1, 3) &
            - 0.15_wp*F%F(x, y, z+2, 4:n)*G%J(x, y, z+2)*X_x(x, y, z+2, 3) &
            + 1.0_wp/60.0_wp*F%F(x, y, z+3, 4:n)*G%J(x, y, z+3)*X_x(x, y, z+3, 3)



    end if

    Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

    !print *, 'cartisian boundary'

  end subroutine JJU_x6


  subroutine JJU_x2_upwind(x, y, z, F, G, X_x, Ju_x)

    !=========================================================================================================================

     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     !input data 
     integer,               intent(in)  :: x, y, z      ! indices in the tranformed co-ordinate
     type(block_fields),    intent(in)  :: F            
     type(block_grid_t),    intent(in)  :: G

     !output data 
     real(kind = wp),       dimension(:), intent(out) :: Ju_x      ! metric coefficients
 
     !input grid and output derivatives 
     real(kind = wp),       dimension(:,:,:,:), allocatable, intent(in) :: X_x                  ! the grid
     real(kind = wp),       dimension(:),       allocatable, save       :: Jq_xU, Jr_xU, Js_xU  ! work array

     !working parameters 
     real(kind = wp)        :: hx, hy, hz       ! spatial steps discertizing the unit cube
     integer                :: n, nx, ny, nz    ! number of points
 
     !get values from input data
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n  = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jq_xU = 0.0_wp*Jq_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! x direction 

     if ((x .ge. 3) .and. (x .le. nx-2 )) then 
     !forward operator for stress
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
              -1.500000000000000_wp*F%F(x  , y, z, 1:3) &
              +2.000000000000000_wp*F%F(x+1, y, z, 1:3) &
              -0.500000000000000_wp*F%F(x+2, y, z, 1:3) &
               )
     !backward operator for stress
     Jq_xU(4:9) = (&
              +0.500000000000000_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
              -2.000000000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
              +1.500000000000000_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
               )
     end if





     if  ( x .eq. 1 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -2.000000000000000_wp*F%F(3, y, z, 1:3) &
               +5.000000000000000_wp*F%F(2, y, z, 1:3) &
               -3.000000000000000_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +1.000000000000000_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.000000000000000_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 2 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.400000000000000_wp*F%F(4, y, z, 1:3) &
               +1.600000000000000_wp*F%F(3, y, z, 1:3) &
               -1.000000000000000_wp*F%F(2, y, z, 1:3) &
               -0.200000000000000_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +1.000000000000000_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.000000000000000_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. nx ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -1.000000000000000_wp*F%F(nx-1, y, z, 1:3) &
                 +1.000000000000000_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +2.000000000000000_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -5.000000000000000_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +3.000000000000000_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-1 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -1.000000000000000_wp*F%F(nx-1, y, z, 1:3) &
                 +1.000000000000000_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.400000000000000_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -1.600000000000000_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +1.000000000000000_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.200000000000000_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jr_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jr_xU = 0.0_wp*Jr_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! y direction 

     if ((y .ge. 3) .and. (y .le. ny-2 )) then 
     !forward operator for stress
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
              -1.500000000000000_wp*F%F(x, y  , z, 1:3) &
              +2.000000000000000_wp*F%F(x, y+1, z, 1:3) &
              -0.500000000000000_wp*F%F(x, y+2, z, 1:3) &
               )
     !backward operator for stress
     Jr_xU(4:9) = (&
              +0.500000000000000_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
              -2.000000000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
              +1.500000000000000_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
               )
     end if





     if  ( y .eq. 1 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -2.000000000000000_wp*F%F(x, 3, z, 1:3) &
               +5.000000000000000_wp*F%F(x, 2, z, 1:3) &
               -3.000000000000000_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +1.000000000000000_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.000000000000000_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 2 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.400000000000000_wp*F%F(x, 4, z, 1:3) &
               +1.600000000000000_wp*F%F(x, 3, z, 1:3) &
               -1.000000000000000_wp*F%F(x, 2, z, 1:3) &
               -0.200000000000000_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +1.000000000000000_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.000000000000000_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. ny ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -1.000000000000000_wp*F%F(x, ny-1, z, 1:3) &
                 +1.000000000000000_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +2.000000000000000_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -5.000000000000000_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +3.000000000000000_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-1 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -1.000000000000000_wp*F%F(x, ny-1, z, 1:3) &
                 +1.000000000000000_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.400000000000000_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -1.600000000000000_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +1.000000000000000_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.200000000000000_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Js_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Js_xU = 0.0_wp*Js_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! z direction 


     if ((z .ge. 3) .and. (z .le. nz-2 )) then 
     !forward operator for stress
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
              -1.500000000000000_wp*F%F(x, y  , z, 1:3) &
              +2.000000000000000_wp*F%F(x, y, z+1, 1:3) &
              -0.500000000000000_wp*F%F(x, y, z+2, 1:3) &
               )
     !backward operator for stress
     Js_xU(4:9) = (&
              +0.500000000000000_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
              -2.000000000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
              +1.500000000000000_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
               )
     end if





     if  ( z .eq. 1 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -2.000000000000000_wp*F%F(x, y, 3, 1:3) &
               +5.000000000000000_wp*F%F(x, y, 2, 1:3) &
               -3.000000000000000_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +1.000000000000000_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.000000000000000_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 2 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.400000000000000_wp*F%F(x, y, 4, 1:3) &
               +1.600000000000000_wp*F%F(x, y, 3, 1:3) &
               -1.000000000000000_wp*F%F(x, y, 2, 1:3) &
               -0.200000000000000_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +1.000000000000000_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.000000000000000_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. nz ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -1.000000000000000_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.000000000000000_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +2.000000000000000_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -5.000000000000000_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +3.000000000000000_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-1 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -1.000000000000000_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.000000000000000_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.400000000000000_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -1.600000000000000_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +1.000000000000000_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.200000000000000_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if


       Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

end subroutine JJU_x2_upwind


subroutine JJU_x3_upwind(x, y, z, F, G, X_x, Ju_x)

    !=========================================================================================================================

     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     !input data 
     integer,               intent(in)  :: x, y, z      ! indices in the tranformed co-ordinate
     type(block_fields),    intent(in)  :: F            
     type(block_grid_t),    intent(in)  :: G

     !output data 
     real(kind = wp),       dimension(:), intent(out) :: Ju_x      ! metric coefficients
 
     !input grid and output derivatives 
     real(kind = wp),       dimension(:,:,:,:), allocatable, intent(in) :: X_x                  ! the grid
     real(kind = wp),       dimension(:),       allocatable, save       :: Jq_xU, Jr_xU, Js_xU  ! work array

     !working parameters 
     real(kind = wp)        :: hx, hy, hz       ! spatial steps discertizing the unit cube
     integer                :: n, nx, ny, nz    ! number of points
 
     !get values from input data
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n  = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jq_xU = 0.0_wp*Jq_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! x direction 


     if ((x .ge. 3) .and. (x .le. nx-2 )) then 
     !forward operator for stress
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
              -0.333333333333333_wp*F%F(x-1, y, z, 1:3) &
              -0.500000000000000_wp*F%F(x  , y, z, 1:3) &
              +1.000000000000000_wp*F%F(x+1, y, z, 1:3) &
              -0.166666666666667_wp*F%F(x+2, y, z, 1:3) &
               )
     !backward operator for stress
     Jq_xU(4:9) = (&
              +0.166666666666667_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
              -1.000000000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
              +0.500000000000000_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.333333333333333_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
               )
     end if





     if  ( x .eq. 1 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.400000000000000_wp*F%F(3, y, z, 1:3) &
               +1.800000000000000_wp*F%F(2, y, z, 1:3) &
               -1.400000000000000_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +1.000000000000000_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.000000000000000_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 2 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.153846153846154_wp*F%F(4, y, z, 1:3) &
               +0.923076923076923_wp*F%F(3, y, z, 1:3) &
               -0.384615384615385_wp*F%F(2, y, z, 1:3) &
               -0.384615384615385_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.307692307692308_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.384615384615385_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.692307692307692_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. nx ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -1.000000000000000_wp*F%F(nx-1, y, z, 1:3) &
                 +1.000000000000000_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.400000000000000_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -1.800000000000000_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +1.400000000000000_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-1 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.307692307692308_wp*F%F(nx-2, y, z, 1:3) &
                 -0.384615384615385_wp*F%F(nx-1, y, z, 1:3) &
                 +0.692307692307692_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.153846153846154_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.923076923076923_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.384615384615385_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.384615384615385_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jr_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jr_xU = 0.0_wp*Jr_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! y direction 


     if ((y .ge. 3) .and. (y .le. ny-2 )) then 
     !forward operator for stress
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
              -0.333333333333333_wp*F%F(x, y-1, z, 1:3) &
              -0.500000000000000_wp*F%F(x, y  , z, 1:3) &
              +1.000000000000000_wp*F%F(x, y+1, z, 1:3) &
              -0.166666666666667_wp*F%F(x, y+2, z, 1:3) &
               )
     !backward operator for stress
     Jr_xU(4:9) = (&
              +0.166666666666667_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
              -1.000000000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
              +0.500000000000000_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.333333333333333_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
               )
     end if





     if  ( y .eq. 1 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.400000000000000_wp*F%F(x, 3, z, 1:3) &
               +1.800000000000000_wp*F%F(x, 2, z, 1:3) &
               -1.400000000000000_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +1.000000000000000_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.000000000000000_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 2 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.153846153846154_wp*F%F(x, 4, z, 1:3) &
               +0.923076923076923_wp*F%F(x, 3, z, 1:3) &
               -0.384615384615385_wp*F%F(x, 2, z, 1:3) &
               -0.384615384615385_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.307692307692308_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.384615384615385_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.692307692307692_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. ny ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -1.000000000000000_wp*F%F(x, ny-1, z, 1:3) &
                 +1.000000000000000_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.400000000000000_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -1.800000000000000_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +1.400000000000000_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-1 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.307692307692308_wp*F%F(x, ny-2, z, 1:3) &
                 -0.384615384615385_wp*F%F(x, ny-1, z, 1:3) &
                 +0.692307692307692_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.153846153846154_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.923076923076923_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.384615384615385_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.384615384615385_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Js_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Js_xU = 0.0_wp*Js_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! z direction 


     if ((z .ge. 3) .and. (z .le. nz-2 )) then 
     !forward operator for stress
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
              -0.333333333333333_wp*F%F(x, y, z-1, 1:3) &
              -0.500000000000000_wp*F%F(x, y  , z, 1:3) &
              +1.000000000000000_wp*F%F(x, y, z+1, 1:3) &
              -0.166666666666667_wp*F%F(x, y, z+2, 1:3) &
               )
     !backward operator for stress
     Js_xU(4:9) = (&
              +0.166666666666667_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
              -1.000000000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
              +0.500000000000000_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.333333333333333_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
               )
     end if





     if  ( z .eq. 1 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.400000000000000_wp*F%F(x, y, 3, 1:3) &
               +1.800000000000000_wp*F%F(x, y, 2, 1:3) &
               -1.400000000000000_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +1.000000000000000_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.000000000000000_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 2 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.153846153846154_wp*F%F(x, y, 4, 1:3) &
               +0.923076923076923_wp*F%F(x, y, 3, 1:3) &
               -0.384615384615385_wp*F%F(x, y, 2, 1:3) &
               -0.384615384615385_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.307692307692308_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.384615384615385_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.692307692307692_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. nz ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -1.000000000000000_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.000000000000000_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.400000000000000_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -1.800000000000000_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +1.400000000000000_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-1 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.307692307692308_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.384615384615385_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.692307692307692_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.153846153846154_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.923076923076923_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.384615384615385_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.384615384615385_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if

     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)


end subroutine JJU_x3_upwind


subroutine JJU_x4_upwind(x, y, z, F, G, X_x, Ju_x)

    !=========================================================================================================================

     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     !input data 
     integer,               intent(in)  :: x, y, z      ! indices in the tranformed co-ordinate
     type(block_fields),    intent(in)  :: F            
     type(block_grid_t),    intent(in)  :: G

     !output data 
     real(kind = wp),       dimension(:), intent(out) :: Ju_x      ! metric coefficients
 
     !input grid and output derivatives 
     real(kind = wp),       dimension(:,:,:,:), allocatable, intent(in) :: X_x                  ! the grid
     real(kind = wp),       dimension(:),       allocatable, save       :: Jq_xU, Jr_xU, Js_xU  ! work array

     !working parameters 
     real(kind = wp)        :: hx, hy, hz       ! spatial steps discertizing the unit cube
     integer                :: n, nx, ny, nz    ! number of points
 
     !get values from input data
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n  = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jq_xU = 0.0_wp*Jq_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! x direction 

     if ((x .ge. 5) .and. (x .le. nx-4 )) then 
     !forward operator for stress
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
              -0.250000000000000_wp*F%F(x-1, y, z, 1:3) &
              -0.833333333333333_wp*F%F(x  , y, z, 1:3) &
              +1.500000000000000_wp*F%F(x+1, y, z, 1:3) &
              -0.500000000000000_wp*F%F(x+2, y, z, 1:3) &
              +0.083333333333333_wp*F%F(x+3, y, z, 1:3) &
               )
     !backward operator for stress
     Jq_xU(4:9) = (&
              -0.083333333333333_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
              +0.500000000000000_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
              -1.500000000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
              +0.833333333333333_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.250000000000000_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
               )
     end if





     if  ( x .eq. 1 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.030612244897959_wp*F%F(4, y, z, 1:3) &
               -0.591836734693878_wp*F%F(3, y, z, 1:3) &
               +2.091836734693878_wp*F%F(2, y, z, 1:3) &
               -1.530612244897959_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.091836734693878_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.224489795918367_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +1.724489795918367_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.408163265306122_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 2 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.065573770491803_wp*F%F(5, y, z, 1:3) &
               -0.234972677595628_wp*F%F(4, y, z, 1:3) &
               +0.811475409836066_wp*F%F(3, y, z, 1:3) &
               -0.180327868852459_wp*F%F(2, y, z, 1:3) &
               -0.461748633879781_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.060109289617486_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.319672131147541_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.180327868852459_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.560109289617486_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 3 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.097560975609756_wp*F%F(6, y, z, 1:3) &
               -0.585365853658537_wp*F%F(5, y, z, 1:3) &
               +1.581300813008130_wp*F%F(4, y, z, 1:3) &
               -0.707317073170732_wp*F%F(3, y, z, 1:3) &
               -0.475609756097561_wp*F%F(2, y, z, 1:3) &
               +0.089430894308943_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.264227642276423_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.707317073170732_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -1.207317073170732_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.235772357723577_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 4 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.080536912751678_wp*F%F(7, y, z, 1:3) &
               -0.483221476510067_wp*F%F(6, y, z, 1:3) &
               +1.449664429530201_wp*F%F(5, y, z, 1:3) &
               -0.785234899328859_wp*F%F(4, y, z, 1:3) &
               -0.218120805369128_wp*F%F(3, y, z, 1:3) &
               -0.073825503355705_wp*F%F(2, y, z, 1:3) &
               +0.030201342281879_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.241610738255034_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.785234899328859_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -1.305369127516778_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.288590604026846_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.010067114093960_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. nx ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.091836734693878_wp*F%F(nx-3, y, z, 1:3) &
                 +0.224489795918367_wp*F%F(nx-2, y, z, 1:3) &
                 -1.724489795918367_wp*F%F(nx-1, y, z, 1:3) &
                 +1.408163265306122_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.030612244897959_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.591836734693878_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -2.091836734693878_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +1.530612244897959_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-1 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.060109289617486_wp*F%F(nx-3, y, z, 1:3) &
                 -0.319672131147541_wp*F%F(nx-2, y, z, 1:3) &
                 -0.180327868852459_wp*F%F(nx-1, y, z, 1:3) &
                 +0.560109289617486_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.065573770491803_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.234972677595628_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.811475409836066_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.180327868852459_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.461748633879781_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-2 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.264227642276423_wp*F%F(nx-3, y, z, 1:3) &
                 -0.707317073170732_wp*F%F(nx-2, y, z, 1:3) &
                 +1.207317073170732_wp*F%F(nx-1, y, z, 1:3) &
                 -0.235772357723577_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.097560975609756_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.585365853658537_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -1.581300813008130_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.707317073170732_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.475609756097561_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.089430894308943_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-3 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.241610738255034_wp*F%F(nx-4, y, z, 1:3) &
                 -0.785234899328859_wp*F%F(nx-3, y, z, 1:3) &
                 +1.305369127516778_wp*F%F(nx-2, y, z, 1:3) &
                 -0.288590604026846_wp*F%F(nx-1, y, z, 1:3) &
                 +0.010067114093960_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.080536912751678_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.483221476510067_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -1.449664429530201_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.785234899328859_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.218120805369128_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.073825503355705_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.030201342281879_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jr_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jr_xU = 0.0_wp*Jr_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! y direction 


     if ((y .ge. 5) .and. (y .le. ny-4 )) then 
     !forward operator for stress
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
              -0.250000000000000_wp*F%F(x, y-1, z, 1:3) &
              -0.833333333333333_wp*F%F(x, y  , z, 1:3) &
              +1.500000000000000_wp*F%F(x, y+1, z, 1:3) &
              -0.500000000000000_wp*F%F(x, y+2, z, 1:3) &
              +0.083333333333333_wp*F%F(x, y+3, z, 1:3) &
               )
     !backward operator for stress
     Jr_xU(4:9) = (&
              -0.083333333333333_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
              +0.500000000000000_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
              -1.500000000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
              +0.833333333333333_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.250000000000000_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
               )
     end if





     if  ( y .eq. 1 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.030612244897959_wp*F%F(x, 4, z, 1:3) &
               -0.591836734693878_wp*F%F(x, 3, z, 1:3) &
               +2.091836734693878_wp*F%F(x, 2, z, 1:3) &
               -1.530612244897959_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.091836734693878_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.224489795918367_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +1.724489795918367_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.408163265306122_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 2 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.065573770491803_wp*F%F(x, 5, z, 1:3) &
               -0.234972677595628_wp*F%F(x, 4, z, 1:3) &
               +0.811475409836066_wp*F%F(x, 3, z, 1:3) &
               -0.180327868852459_wp*F%F(x, 2, z, 1:3) &
               -0.461748633879781_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.060109289617486_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.319672131147541_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.180327868852459_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.560109289617486_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 3 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.097560975609756_wp*F%F(x, 6, z, 1:3) &
               -0.585365853658537_wp*F%F(x, 5, z, 1:3) &
               +1.581300813008130_wp*F%F(x, 4, z, 1:3) &
               -0.707317073170732_wp*F%F(x, 3, z, 1:3) &
               -0.475609756097561_wp*F%F(x, 2, z, 1:3) &
               +0.089430894308943_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.264227642276423_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.707317073170732_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -1.207317073170732_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.235772357723577_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 4 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.080536912751678_wp*F%F(x, 7, z, 1:3) &
               -0.483221476510067_wp*F%F(x, 6, z, 1:3) &
               +1.449664429530201_wp*F%F(x, 5, z, 1:3) &
               -0.785234899328859_wp*F%F(x, 4, z, 1:3) &
               -0.218120805369128_wp*F%F(x, 3, z, 1:3) &
               -0.073825503355705_wp*F%F(x, 2, z, 1:3) &
               +0.030201342281879_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.241610738255034_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.785234899328859_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -1.305369127516778_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.288590604026846_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.010067114093960_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. ny ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.091836734693878_wp*F%F(x, ny-3, z, 1:3) &
                 +0.224489795918367_wp*F%F(x, ny-2, z, 1:3) &
                 -1.724489795918367_wp*F%F(x, ny-1, z, 1:3) &
                 +1.408163265306122_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.030612244897959_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.591836734693878_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -2.091836734693878_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +1.530612244897959_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-1 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.060109289617486_wp*F%F(x, ny-3, z, 1:3) &
                 -0.319672131147541_wp*F%F(x, ny-2, z, 1:3) &
                 -0.180327868852459_wp*F%F(x, ny-1, z, 1:3) &
                 +0.560109289617486_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.065573770491803_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.234972677595628_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.811475409836066_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.180327868852459_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.461748633879781_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-2 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.264227642276423_wp*F%F(x, ny-3, z, 1:3) &
                 -0.707317073170732_wp*F%F(x, ny-2, z, 1:3) &
                 +1.207317073170732_wp*F%F(x, ny-1, z, 1:3) &
                 -0.235772357723577_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.097560975609756_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.585365853658537_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -1.581300813008130_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.707317073170732_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.475609756097561_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.089430894308943_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-3 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.241610738255034_wp*F%F(x, ny-4, z, 1:3) &
                 -0.785234899328859_wp*F%F(x, ny-3, z, 1:3) &
                 +1.305369127516778_wp*F%F(x, ny-2, z, 1:3) &
                 -0.288590604026846_wp*F%F(x, ny-1, z, 1:3) &
                 +0.010067114093960_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.080536912751678_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.483221476510067_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -1.449664429530201_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.785234899328859_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.218120805369128_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.073825503355705_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.030201342281879_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Js_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Js_xU = 0.0_wp*Js_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! z direction 


     if ((z .ge. 5) .and. (z .le. nz-4 )) then 
     !forward operator for stress
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
              -0.250000000000000_wp*F%F(x, y, z-1, 1:3) &
              -0.833333333333333_wp*F%F(x, y  , z, 1:3) &
              +1.500000000000000_wp*F%F(x, y, z+1, 1:3) &
              -0.500000000000000_wp*F%F(x, y, z+2, 1:3) &
              +0.083333333333333_wp*F%F(x, y, z+3, 1:3) &
               )
     !backward operator for stress
     Js_xU(4:9) = (&
              -0.083333333333333_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
              +0.500000000000000_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
              -1.500000000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
              +0.833333333333333_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.250000000000000_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
               )
     end if





     if  ( z .eq. 1 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.030612244897959_wp*F%F(x, y, 4, 1:3) &
               -0.591836734693878_wp*F%F(x, y, 3, 1:3) &
               +2.091836734693878_wp*F%F(x, y, 2, 1:3) &
               -1.530612244897959_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.091836734693878_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.224489795918367_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +1.724489795918367_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.408163265306122_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 2 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.065573770491803_wp*F%F(x, y, 5, 1:3) &
               -0.234972677595628_wp*F%F(x, y, 4, 1:3) &
               +0.811475409836066_wp*F%F(x, y, 3, 1:3) &
               -0.180327868852459_wp*F%F(x, y, 2, 1:3) &
               -0.461748633879781_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.060109289617486_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.319672131147541_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.180327868852459_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.560109289617486_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 3 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.097560975609756_wp*F%F(x, y, 6, 1:3) &
               -0.585365853658537_wp*F%F(x, y, 5, 1:3) &
               +1.581300813008130_wp*F%F(x, y, 4, 1:3) &
               -0.707317073170732_wp*F%F(x, y, 3, 1:3) &
               -0.475609756097561_wp*F%F(x, y, 2, 1:3) &
               +0.089430894308943_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.264227642276423_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.707317073170732_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -1.207317073170732_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.235772357723577_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 4 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.080536912751678_wp*F%F(x, y, 7, 1:3) &
               -0.483221476510067_wp*F%F(x, y, 6, 1:3) &
               +1.449664429530201_wp*F%F(x, y, 5, 1:3) &
               -0.785234899328859_wp*F%F(x, y, 4, 1:3) &
               -0.218120805369128_wp*F%F(x, y, 3, 1:3) &
               -0.073825503355705_wp*F%F(x, y, 2, 1:3) &
               +0.030201342281879_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.241610738255034_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.785234899328859_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -1.305369127516778_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.288590604026846_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.010067114093960_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. nz ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.091836734693878_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.224489795918367_wp*F%F(x, y,  nz-2, 1:3) &
                 -1.724489795918367_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.408163265306122_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.030612244897959_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.591836734693878_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -2.091836734693878_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +1.530612244897959_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-1 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.060109289617486_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.319672131147541_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.180327868852459_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.560109289617486_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.065573770491803_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.234972677595628_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.811475409836066_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.180327868852459_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.461748633879781_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-2 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.264227642276423_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.707317073170732_wp*F%F(x, y,  nz-2, 1:3) &
                 +1.207317073170732_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.235772357723577_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.097560975609756_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.585365853658537_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -1.581300813008130_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.707317073170732_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.475609756097561_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.089430894308943_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-3 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.241610738255034_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.785234899328859_wp*F%F(x, y,  nz-3, 1:3) &
                 +1.305369127516778_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.288590604026846_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.010067114093960_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.080536912751678_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.483221476510067_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -1.449664429530201_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.785234899328859_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.218120805369128_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.073825503355705_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.030201342281879_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if

     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)



end subroutine JJU_x4_upwind



  subroutine JJU_x5_upwind(x, y, z, F, G, X_x, Ju_x)


     !=================================================================================================
     !
           use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     integer, intent(in) :: x, y, z                      ! indices in the tranformed cordinate
     type(block_fields), intent(in):: F
     type(block_grid_t), intent(in) :: G
     real(kind = wp), dimension(:), intent(out) :: Ju_x            ! metric coefficients
 
     real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   ! the grid
     real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            ! work array
     real(kind = wp) :: hx, hy, hz                      ! spatial steps discertizing the unit cube
     integer :: n, nx, ny, nz
 
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))
 
     !Ju_x = 0.0_wp*Ju_x
 
     Jq_xU = 0.0_wp*Jq_xU
     ! Jr_xU = 0.0_wp*Jr_xU
     ! Js_xU = 0.0_wp*Js_xU
 
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
     !=========================================================================================================================
     ! Interior approximation: Standard central finite difference approximation
     !print *, 'metric ',  X_x(x,y,z,1), X_x(x,y,z,2),  X_x(x,y,z,3)
    
      if ((x .ge. 5) .and. (x .le. nx-4)) then
        ! forward FD q_x*du/dq 
        Jq_xU(1:3) = X_x(x, y, z, 1)*(0.05_wp*F%F(x-2, y, z, 1:3)&
             - 0.5_wp*F%F(x-1, y, z, 1:3)&
             - 1.0_wp/3.0_wp*F%F(x, y, z, 1:3)&
             + 1.0_wp*F%F(x+1, y, z, 1:3)&
             - 0.25_wp*F%F(x+2, y, z, 1:3)&
             + 1.0_wp/30.0_wp*F%F(x+3, y, z, 1:3)) 


        ! backward FD 
        ! d(J*q_x*u)/dq
        Jq_xU(4:9) = (-1.0_wp/30.0_wp*X_x(x-3, y, z,1)*G%J(x-3,y,z) * F%F(x-3, y, z, 4:n)&
              + 0.25_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) * F%F(x-2, y, z, 4:n)&
              - 1.0_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n)&
              + 1.0_wp/3.0_wp*X_x(x, y, z, 1)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
              + 0.5_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n)&
              - 0.05_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n)) 


          !     Jq_xU(4:n) = -1.0_wp/60.0_wp*F%F(x-3, y, z, 4:n)*G%J(x-3, y, z)*X_x(x-3, y, z, 1) &
          !     + 0.15_wp*F%F(x-2, y, z, 4:n)*G%J(x-2, y, z)*X_x(x-2, y, z, 1) &
          !     - 0.75_wp*F%F(x-1, y, z, 4:n)*G%J(x-1, y, z)*X_x(x-1, y, z, 1) &
          !     + 0.75_wp*F%F(x+1, y, z, 4:n)*G%J(x+1, y, z)*X_x(x+1, y, z, 1) &
          !     - 0.15_wp*F%F(x+2, y, z, 4:n)*G%J(x+2, y, z)*X_x(x+2, y, z, 1) &
          !     + 1.0_wp/60.0_wp*F%F(x+3, y, z, 4:n)*G%J(x+3, y, z)*X_x(x+3, y, z, 1)
       
 
     end if



 

     ! Special onesided treatments of boundaries
 
     !=========================================================================================================================
     ! ! Left boundary closure in x-directyion
     if (x .eq. 1) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(- 0.041832669322709_wp*F%F(4, y, z, 1:3) &
          - 0.374501992031873_wp*F%F(3, y, z, 1:3) &
          + 1.874501992031873_wp*F%F(2, y, z, 1:3) &
          - 1.458167330677291_wp*F%F(1, y, z, 1:3)) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) =  (-0.089641434262948_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
             - 0.231075697211155_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
             + 1.731075697211155_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
             - 1.410358565737052_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))  
     end if
 
     if (x .eq. 2) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(0.026755852842809_wp*F%F(5, y, z, 1:3) &
             - 0.095875139353400_wp*F%F(4, y, z, 1:3) &
             + 0.627090301003345_wp*F%F(3, y, z, 1:3) &
             - 0.073578595317726_wp*F%F(2, y, z, 1:3) &
             - 0.484392419175028_wp*F%F(1, y, z, 1:3)) 
        
     
        Jq_xU(4:9) = (0.024526198439242_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
             + 0.426421404682274_wp*X_x(3, y, z, 1)*G%J(3,y,z)*F%F(3, y, z, 4:n) &
             + 0.073578595317726_wp*X_x(2, y, z, 1)*G%J(2,y,z)*F%F(2, y, z, 4:n) &
             - 0.524526198439242_wp*X_x(1, y, z, 1)*G%J(1,y,z)*F%F(1, y, z, 4:n)) 
     end if
 
     if (x .eq. 3) then
        Jq_xU(1:3) =X_x(x, y, z, 1)*(0.037914691943128_wp*F%F(6, y, z, 1:3) &
             - 0.284360189573460_wp*F%F(5, y, z, 1:3) &
             + 1.033965244865719_wp*F%F(4, y, z, 1:3) &
             - 0.274881516587678_wp*F%F(3, y, z, 1:3) &
             - 0.604265402843602_wp*F%F(2, y, z, 1:3) &
             + 0.091627172195893_wp*F%F(1, y, z, 1:3)) 
       
     ! Backward FD for stress fields
        Jq_xU(4:9) = (-0.056872037914692_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
             + 0.522116903633491_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
             + 0.274881516587678_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
             - 0.888625592417062_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
             + 0.148499210110585_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))        
     end if 
 
     if (x .eq. 4) then
        Jq_xU(1:3) =   X_x(x, y, z, 1)*(0.032476319350474_wp*F%F(7, y, z, 1:3) &
             - 0.243572395128552_wp*F%F(6, y, z, 1:3)&
             + 0.974289580514208_wp*F%F(5, y, z, 1:3)&
             - 0.316644113667118_wp*F%F(4, y, z, 1:3)&
             - 0.447225981055480_wp*F%F(3, y, z, 1:3)&
             - 0.029769959404601_wp*F%F(2, y, z, 1:3)&
             + 0.030446549391069_wp*F%F(1, y, z, 1:3)) 
        
       
        Jq_xU(4:9) = (-0.048714479025710_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
             + 0.487144790257104_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n)&
             + 0.316644113667118_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n)&
             - 0.885656292286874_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
             + 0.116373477672530_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
             + 0.014208389715832_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))  
        
     end if
 
 
 
     !=========================================================================================================================
     ! Right boundary closure in x-directyion

     if (x .eq. nx-3) then

         ! Forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(0.048714479025710_wp*F%F(nx-5, y, z, 1:3)&
             - 0.487144790257104_wp*F%F(nx-4, y, z, 1:3)&
             - 0.316644113667118_wp*F%F(nx-3, y, z, 1:3)&
             + 0.885656292286874_wp*F%F(nx-2, y, z, 1:3)&
             - 0.116373477672530_wp*F%F(nx-1, y, z, 1:3)&
             - 0.014208389715832_wp*F%F(nx,   y, z, 1:3))  
        
        


         ! Backward FD for stress fields
        Jq_xU(4:9) = (-0.032476319350474_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z)*F%F(nx-6, y, z, 4:n) &
             + 0.243572395128552_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n)&
             - 0.974289580514208_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n)&
             + 0.316644113667118_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n) &
             + 0.447225981055480_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
             + 0.029769959404601_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n)&
             - 0.030446549391069_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
        
        
     end if
 
     if (x .eq. nx-2) then
        Jq_xU(1:3) = X_x(x, y, z, 1)*(0.056872037914692_wp*F%F(nx-4, y, z, 1:3)&
             - 0.522116903633491_wp*F%F(nx-3, y, z, 1:3)&
             - 0.274881516587678_wp*F%F(nx-2, y, z, 1:3)&
             + 0.888625592417062_wp*F%F(nx-1, y, z, 1:3)&
             - 0.148499210110585_wp*F%F(nx,   y, z, 1:3))
        


        ! Backward FD for stress fields
         Jq_xU(4:9) = (-0.037914691943128_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n) &
               + 0.284360189573460_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n)&
               - 1.033965244865719_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n)&
               + 0.274881516587678_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
               + 0.604265402843602_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
               - 0.091627172195893_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
        
       
              
     end if
 
     if (x .eq. nx-1) then
        Jq_xU(1:3) = X_x(x, y, z, 1)*(-0.024526198439242_wp*F%F(nx-3, y, z, 1:3)&
             - 0.426421404682274_wp*F%F(nx-2, y, z, 1:3)&
             - 0.073578595317726_wp*F%F(nx-1, y, z, 1:3) &
             + 0.524526198439242_wp*F%F(nx,   y, z, 1:3)) 
       

          ! Backward FD for stress fields
        Jq_xU(4:9) = (-0.026755852842809_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n) &
             + 0.095875139353400_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y,z, 4:n)&
             - 0.627090301003345_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n)&
             + 0.073578595317726_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
             + 0.484392419175028_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
       
            


     end if

 
 
 
     if (x .eq. nx) then
        Jq_xU(1:3) =  X_x(x, y, z, 1)*(0.089641434262948_wp*F%F(nx-3, y, z, 1:3)&
             + 0.231075697211155_wp*F%F(nx-2, y, z, 1:3)&
             - 1.731075697211155_wp*F%F(nx-1, y, z, 1:3)&
             + 1.410358565737052_wp*F%F(nx,   y, z, 1:3)) 
       

     ! Backward FD for stress fields
        Jq_xU(4:9) = (0.041832669322709_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y,z, 4:n)&
             + 0.374501992031873_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n)&
             - 1.874501992031873_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
             + 1.458167330677291_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
       
            
 
     end if
 
     !=================================================================
 
 
     Jr_xU = 0.0_wp*Jr_xU
 
     !implicit none



     if ((y .ge. 5) .and. (y .le. ny-4)) then
        ! forward FD                                                                                                                                                                                         
        Jr_xU(1:3) = X_x(x, y, z, 2)*(0.05_wp*F%F(x, y-2, z, 1:3)&
             - 0.5_wp*F%F(x, y-1, z, 1:3)&
             - 1.0_wp/3.0_wp*F%F(x, y, z, 1:3)&
             + 1.0_wp*F%F(x, y+1, z, 1:3)&
             - 0.25_wp*F%F(x, y+2, z, 1:3)&
             + 1.0_wp/30.0_wp*F%F(x, y+3, z, 1:3))

        ! backward FD                                                                                                                                                                                        
        Jr_xU(4:9) =  (-1.0_wp/30.0_wp*X_x(x, y-3, z,2)*G%J(x,y-3,z) *F%F(x, y-3, z, 4:n)&
              + 0.25_wp*X_x(x, y-2, z,2)*G%J(x,y-2,z) *F%F(x, y-2, z, 4:n)&
              - 1.0_wp*X_x(x, y-1, z,2)*G%J(x,y-1,z) *F%F(x, y-1, z, 4:n)&
              + 1.0_wp/3.0_wp*X_x(x, y, z,2)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
              + 0.5_wp*X_x(x, y+1, z,2)*G%J(x,y+1,z) *F%F(x, y+1, z, 4:n)&
              - 0.05_wp*X_x(x, y+2, z,2)*G%J(x,y+2,z) *F%F(x, y+2, z, 4:n))


          !     Jq_xU(4:9) = (-1.0_wp/30.0_wp*X_x(x-3, y, z,1)*G%J(x-3,y,z) * F%F(x-3, y, z, 4:n)&
          !     + 0.25_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) * F%F(x-2, y, z, 4:n)&
          !     - 1.0_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n)&
          !     + 1.0_wp/3.0_wp*X_x(x, y, z, 1)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
          !     + 0.5_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n)&
          !     - 0.05_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n)) 
     end if



     if (y .eq. 1) then

        ! Use forward FD for velocity fields                                                                                                                                                                 
        Jr_xU(1:3) = X_x(x, y, z, 2)*(- 0.041832669322709_wp*F%F(x, 4, z, 1:3) &
          - 0.374501992031873_wp*F%F(x, 3, z, 1:3) &
          + 1.874501992031873_wp*F%F(x, 2, z, 1:3) &
          - 1.458167330677291_wp*F%F(x, 1, z, 1:3))

        ! Use backward FD for velocity fields                                                                                                                                                                 
        Jr_xU(4:9) =  (-0.089641434262948_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             - 0.231075697211155_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             + 1.731075697211155_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             - 1.410358565737052_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))
     end if

     if (y .eq. 2) then

        ! Use forward FD for velocity fields                                                                                                                                                                  
        Jr_xU(1:3) = X_x(x, y, z, 2)*(0.026755852842809_wp*F%F(x, 5, z, 1:3) &
             - 0.095875139353400_wp*F%F(x, 4, z, 1:3) &
             + 0.627090301003345_wp*F%F(x, 3, z, 1:3) &
             - 0.073578595317726_wp*F%F(x, 2, z, 1:3) &
             - 0.484392419175028_wp*F%F(x, 1, z, 1:3))


        Jr_xU(4:9) = (0.024526198439242_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             + 0.426421404682274_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             + 0.073578595317726_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             - 0.524526198439242_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))
     end if

     if (y .eq. 3) then
        Jr_xU(1:3) =X_x(x, y, z, 2)*(0.037914691943128_wp*F%F(x, 6, z, 1:3) &
             - 0.284360189573460_wp*F%F(x, 5, z, 1:3) &
             + 1.033965244865719_wp*F%F(x, 4, z, 1:3) &
             - 0.274881516587678_wp*F%F(x, 3, z, 1:3) &
             - 0.604265402843602_wp*F%F(x, 2, z, 1:3) &
             + 0.091627172195893_wp*F%F(x, 1, z, 1:3))

     ! Backward FD for stress fields                                                                                                                                                                          
        Jr_xU(4:9) = (-0.056872037914692_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
             + 0.522116903633491_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             + 0.274881516587678_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             - 0.888625592417062_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             + 0.148499210110585_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))
     end if

     if (y .eq. 4) then
        Jr_xU(1:3) =   X_x(x, y, z, 2)*(0.032476319350474_wp*F%F(x, 7, z, 1:3) &
             - 0.243572395128552_wp*F%F(x, 6, z, 1:3)&
             + 0.974289580514208_wp*F%F(x, 5, z, 1:3)&
             - 0.316644113667118_wp*F%F(x, 4, z, 1:3)&
             - 0.447225981055480_wp*F%F(x, 3, z, 1:3)&
             - 0.029769959404601_wp*F%F(x, 2, z, 1:3)&
             + 0.030446549391069_wp*F%F(x, 1, z, 1:3))

        Jr_xU(4:9) = (-0.048714479025710_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
             + 0.487144790257104_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n)&
             + 0.316644113667118_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n)&
             - 0.885656292286874_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             + 0.116373477672530_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             + 0.014208389715832_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))


     end if


     !=========================================================================================================================                                                                               
     ! Right boundary closure in y-direction                                                                                                                                                                 

     if (y .eq. ny-3) then
        ! Forward FD for velocity fields                                                                                                                                                                     
        Jr_xU(1:3) = X_x(x, y, z, 2)*(0.048714479025710_wp*F%F(x, ny-5, z, 1:3)&
             - 0.487144790257104_wp*F%F(x, ny-4, z, 1:3)&
             - 0.316644113667118_wp*F%F(x, ny-3, z, 1:3)&
             + 0.885656292286874_wp*F%F(x, ny-2, z, 1:3)&
             - 0.116373477672530_wp*F%F(x, ny-1, z, 1:3)&
             - 0.014208389715832_wp*F%F(x,   ny, z, 1:3))

        ! Backward FD for stress fields                                                                                                                                                                      
        Jr_xU(4:9) = (-0.032476319350474_wp*X_x(x, ny-6, z, 2)*G%J(x,ny-6,z) *F%F(x, ny-6, z, 4:n) &
             + 0.243572395128552_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5, z, 4:n)&
             - 0.974289580514208_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n)&
             + 0.316644113667118_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3, z, 4:n) &
             + 0.447225981055480_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n) &
             + 0.029769959404601_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n)&
             - 0.030446549391069_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))


     end if

     if (y .eq. ny-2) then
        ! Forward FD for velocity fields  
        Jr_xU(1:3) = X_x(x, y, z, 2)*(0.056872037914692_wp*F%F(x, ny-4, z, 1:3)&
             - 0.522116903633491_wp*F%F(x, ny-3, z, 1:3)&
             - 0.274881516587678_wp*F%F(x, ny-2, z, 1:3)&
             + 0.888625592417062_wp*F%F(x, ny-1, z, 1:3)&
             - 0.148499210110585_wp*F%F(x,   ny, z, 1:3))
       
        ! Backward FD for stress fields                                                                                                                                                                      
         Jr_xU(4:9) =(-0.037914691943128_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5, z, 4:n) &
               + 0.284360189573460_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n)&
               - 1.033965244865719_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3, z, 4:n)&
               + 0.274881516587678_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n) &
               + 0.604265402843602_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n) &
               - 0.091627172195893_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))

     end if

     if (y .eq. ny-1) then
        Jr_xU(1:3) = X_x(x, y, z, 2)*(-0.024526198439242_wp*F%F(x, ny-3, z, 1:3)&
             - 0.426421404682274_wp*F%F(x, ny-2, z, 1:3)&
             - 0.073578595317726_wp*F%F(x, ny-1, z, 1:3) &
             + 0.524526198439242_wp*F%F(x,   ny, z, 1:3))
        
          ! Backward FD for stress fields                                                                                                                                                                    
        Jr_xU(4:9) = (-0.026755852842809_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n) &
             + 0.095875139353400_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3,z, 4:n)&
             - 0.627090301003345_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n)&
             + 0.073578595317726_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n) &
             + 0.484392419175028_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))
     end if

      if (y .eq. ny) then
        Jr_xU(1:3) =  X_x(x, y, z, 2)*(0.089641434262948_wp*F%F(x, ny-3, z, 1:3)&
             + 0.231075697211155_wp*F%F(x, ny-2, z, 1:3)&
             - 1.731075697211155_wp*F%F(x, ny-1, z, 1:3)&
             + 1.410358565737052_wp*F%F(x,   ny, z, 1:3))


     ! Backward FD for stress fields                                                                                                                                                                          
        Jr_xU(4:9) = (0.041832669322709_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3,z, 4:n)&
             + 0.374501992031873_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n)&
             - 1.874501992031873_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n) &
             + 1.458167330677291_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))


     end if

     !=================================================================    
     !======================================================================
 
 
 
     Js_xU = 0.0_wp*Js_xU

     if ((z .ge. 5) .and. (z .le. nz-4)) then

          Js_xU(1:3) = X_x(x, y, z, 3)*(0.05_wp*F%F(x, y, z-2, 1:3)&
               - 0.5_wp*F%F(x, y, z-1, 1:3)&
               - 1.0_wp/3.0_wp*F%F(x, y, z, 1:3)&
               + 1.0_wp*F%F(x, y, z+1, 1:3)&
               - 0.25_wp*F%F(x, y, z+2, 1:3)&
               + 1.0_wp/30.0_wp*F%F(x, y, z+3, 1:3)) 
             
  
          Js_xU(4:9) =  (-1.0_wp/30.0_wp*X_x(x, y, z-3,3)*G%J(x,y,z-3) *F%F(x, y, z-3, 4:n)&
               + 0.25_wp*X_x(x, y, z-2,3)*G%J(x,y,z-2) *F%F(x, y, z-2, 4:n)&
               - 1.0_wp*X_x(x, y, z-1,3)*G%J(x,y,z-1) *F%F(x, y, z-1, 4:n)&
               + 1.0_wp/3.0_wp*X_x(x, y, z,3)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
               + 0.5_wp*X_x(x, y, z+1,3)*G%J(x,y,z+1) *F%F(x, y, z+1, 4:n)&
               - 0.05_wp*X_x(x, y, z+2,3)*G%J(x,y,z+2) *F%F(x, y, z+2, 4:n)) 

          !     Jq_xU(4:9) = (-1.0_wp/30.0_wp*X_x(x-3, y, z,1)*G%J(x-3,y,z) * F%F(x-3, y, z, 4:n)&
          !     + 0.25_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) * F%F(x-2, y, z, 4:n)&
          !     - 1.0_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n)&
          !     + 1.0_wp/3.0_wp*X_x(x, y, z, 1)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
          !     + 0.5_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n)&
          !     - 0.05_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n)) 
             
   
   
       end if
 
     if (z .eq.  1) then

        Js_xU(1:3) =  X_x(x, y, z, 3)*(- 0.041832669322709_wp*F%F(x, y, 4, 1:3)&
             - 0.374501992031873_wp*F%F(x, y, 3, 1:3)&
             + 1.874501992031873_wp*F%F(x, y, 2, 1:3)&
             - 1.458167330677291_wp*F%F(x, y, 1, 1:3)) 
             

       ! Backward FD for stress fields
         Js_xU(4:9) =  (-0.089641434262948_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n) &
             - 0.231075697211155_wp*X_x(x, y, 3,3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             + 1.731075697211155_wp*X_x(x, y, 2,3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) &
             - 1.410358565737052_wp*X_x(x, y, 1,3)*G%J(x,y,1) *F%F(x, y, 1, 4:n)) 
             
     end if
 
 
 
 
     if (z .eq.  2) then
        Js_xU(1:3) = X_x(x, y, z, 3)*(0.026755852842809_wp*F%F(x, y, 5, 1:3)&
             - 0.095875139353400_wp*F%F(x, y, 4, 1:3)&
             + 0.627090301003345_wp*F%F(x, y, 3, 1:3)&
             - 0.073578595317726_wp*F%F(x, y, 2, 1:3)& 
             - 0.484392419175028_wp*F%F(x, y, 1, 1:3))  
             

        Js_xU(4:9) = (0.024526198439242_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n) &
             + 0.426421404682274_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             + 0.073578595317726_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) &
             - 0.524526198439242_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n)) 
             
     end if
 
 
 
     if (z .eq.  3) then
        Js_xU(1:3)  = X_x(x, y, z, 3)*(0.037914691943128_wp*F%F(x, y, 6, 1:3)&
             - 0.284360189573460_wp*F%F(x, y, 5, 1:3)&
             + 1.033965244865719_wp*F%F(x, y, 4, 1:3)&
             - 0.274881516587678_wp*F%F(x, y, 3, 1:3)&
             - 0.604265402843602_wp*F%F(x, y, 2, 1:3)&
             + 0.091627172195893_wp*F%F(x, y, 1, 1:3)) 
             
             

           ! Backward FD for stress fields
         Js_xU(4:9) = (-0.056872037914692_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x,y, 5, 4:n) &
             + 0.522116903633491_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n) &
             + 0.274881516587678_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             - 0.888625592417062_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) &
             + 0.148499210110585_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n)) 
             
 
     end if
 
 
     if (z .eq.  4) then
        Js_xU(1:3) = X_x(x, y, z, 3)*(0.032476319350474*F%F(x, y, 7, 1:3)&
             - 0.243572395128552_wp*F%F(x, y, 6, 1:3)&
             + 0.974289580514208_wp*F%F(x, y, 5, 1:3)&
             - 0.316644113667118_wp*F%F(x, y, 4, 1:3)&
             - 0.447225981055480_wp*F%F(x, y, 3, 1:3)&
             - 0.029769959404601_wp*F%F(x, y, 2, 1:3)&
             + 0.030446549391069_wp*F%F(x, y, 1, 1:3))  
             
             



        Js_xU(4:9) = (-0.048714479025710_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x, y, 6, 4:n) &
             + 0.487144790257104_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x, y, 5, 4:n)&
             + 0.316644113667118_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n)&
             - 0.885656292286874_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             + 0.116373477672530_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) & 
             + 0.014208389715832_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n))  
             
             

 
     end if
 
 
 
     if (z .eq.   nz-3) then
        Js_xU(1:3) =  X_x(x, y, z, 3)*(0.048714479025710_wp*F%F(x, y, nz-5, 1:3)&
             - 0.487144790257104_wp*F%F(x, y, nz-4, 1:3)&
             - 0.316644113667118_wp*F%F(x, y, nz-3, 1:3)&
             + 0.885656292286874_wp*F%F(x, y, nz-2, 1:3)&
             - 0.116373477672530_wp*F%F(x, y, nz-1, 1:3)&
             - 0.014208389715832_wp*F%F(x, y, nz,   1:3)) 
             
             

     
             ! Backward FD for stress fields
        Js_xU(4:9) = (-0.032476319350474_wp*X_x(x, y, nz-6, 3)*G%J(x,y,nz-6) *F%F(x, y, nz-6,4:n) &
             + 0.243572395128552_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n)&
             - 0.974289580514208_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n)&
             + 0.316644113667118_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n) &
             + 0.447225981055480_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
             + 0.029769959404601_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n)&
             - 0.030446549391069_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n)) 
             
             

     end if
 
 
 
     if (z .eq. nz-2) then
          
        Js_xU(1:3) = X_x(x, y, z, 3)*(0.056872037914692_wp*F%F(x, y, nz-4, 1:3)&
             - 0.522116903633491_wp*F%F(x, y, nz-3, 1:3)&
             - 0.274881516587678_wp*F%F(x, y, nz-2, 1:3)&
             + 0.888625592417062_wp*F%F(x, y, nz-1, 1:3)&
             - 0.148499210110585_wp*F%F(x, y, nz,   1:3)) 
             

               ! Backward FD for stress fields
        Js_xU(4:9) = (-0.037914691943128_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n) &
             + 0.284360189573460_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n)&
             - 1.033965244865719_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n)&
             + 0.274881516587678_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
             + 0.604265402843602_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             - 0.091627172195893_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n)) 
             
             
 

     end if
 
 
 
     if (z .eq.   nz-1) then
        Js_xU(1:3) = X_x(x, y, z, 3)*(-0.024526198439242_wp*F%F(x, y, nz-3, 1:3)&
             - 0.426421404682274_wp*F%F(x, y, nz-2, 1:3)&
             - 0.073578595317726_wp*F%F(x, y, nz-1, 1:3)&
             + 0.524526198439242_wp*F%F(x, y, nz,   1:3)) 
             

                 ! Backward FD for stress fields
        Js_xU(4:9) = -0.026755852842809_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n) &
             + 0.095875139353400_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n)&
             - 0.627090301003345_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n)&
             + 0.073578595317726_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             + 0.484392419175028_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n)
             
 

 
     end if
 
 
     if (z .eq.   nz) then
 
        Js_xU(1:3) = X_x(x, y, z, 3)*(0.089641434262948_wp*F%F(x, y, nz-3, 1:3)&
             + 0.231075697211155_wp*F%F(x, y, nz-2, 1:3)&
             - 1.731075697211155_wp*F%F(x, y, nz-1, 1:3)&
             + 1.410358565737052_wp*F%F(x, y, nz,   1:3)) 
             

        ! Backward FD for stress fields
        Js_xU(4:9) = 0.041832669322709_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n)&
             + 0.374501992031873_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n)&
             - 1.874501992031873_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             + 1.458167330677291_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n) 
             


 
     end if

 

     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)
 
   end subroutine JJU_x5_upwind


   subroutine JJU_x6_upwind(x, y, z, F, G, X_x, Ju_x)


     !=================================================================================================
     !
           use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     integer, intent(in) :: x, y, z                      ! indices in the tranformed cordinate
     type(block_fields), intent(in):: F
     type(block_grid_t), intent(in) :: G
     real(kind = wp), dimension(:), intent(out) :: Ju_x            ! metric coefficients
 
     real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   ! the grid
     real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            ! work array
     real(kind = wp) :: hx, hy, hz                      ! spatial steps discertizing the unit cube
     integer :: n, nx, ny, nz
 
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))
 
     !Ju_x = 0.0_wp*Ju_x
 
     Jq_xU = 0.0_wp*Jq_xU
     ! Jr_xU = 0.0_wp*Jr_xU
     ! Js_xU = 0.0_wp*Js_xU
 
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
     !=========================================================================================================================
     ! Interior approximation: Standard central finite difference approximation
     !print *, 'metric ',  X_x(x,y,z,1), X_x(x,y,z,2),  X_x(x,y,z,3)
    
      if ((x .ge. 7) .and. (x .le. nx-6)) then
        ! forward FD q_x*du/dq 
        Jq_xU(1:3) = X_x(x, y, z, 1)*(1.0_wp/30.0_wp*F%F(x-2, y, z, 1:3)&
             - 2.0_wp/5.0_wp*F%F(x-1, y, z, 1:3)&
             - 7.0_wp/12.0_wp*F%F(x, y, z, 1:3)&
             + 4.0_wp/3.0_wp*F%F(x+1, y, z, 1:3)&
             - 1.0_wp/2.0_wp*F%F(x+2, y, z, 1:3)&
             + 2.0_wp/15.0_wp*F%F(x+3, y, z, 1:3)&
             - 1.0_wp/60.0_wp*F%F(x+4, y, z, 1:3)) 


        ! backward FD 
        ! d(J*q_x*u)/dq
        Jq_xU(4:9) = (1.0_wp/60.0_wp*X_x(x-4, y, z,1)*G%J(x-4,y,z) * F%F(x-4, y, z, 4:n)&
              - 2.0_wp/15.0_wp*X_x(x-3, y, z,1)*G%J(x-3,y,z) * F%F(x-3, y, z, 4:n)&
              + 1.0_wp/2.0_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) * F%F(x-2, y, z, 4:n)&
              - 4.0_wp/3.0_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n)&
              + 7.0_wp/12.0_wp*X_x(x, y, z, 1)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
              + 2.0_wp/5.0_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n)&
              - 1.0_wp/30.0_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n)) 

       
 
     end if

     !print *, 'order 6, upwind'

 

     ! Special onesided treatments of boundaries
 
     !=========================================================================================================================
     ! ! Left boundary closure in x-directyion
     if (x .eq. 1) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*( 0.054021710000147_wp*F%F(6, y, z, 1:3)&
          + 0.023993033880123_wp*F%F(5, y, z, 1:3) &
          - 0.302855902188632_wp*F%F(4, y, z, 1:3) &
          - 0.275607596716317_wp*F%F(3, y, z, 1:3) &
          + 2.093702214477299_wp*F%F(2, y, z, 1:3) &
          - 1.593253459452621_wp*F%F(1, y, z, 1:3)) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) =  (0.052048915548040_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
             + 0.044953974933765_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
             - 0.366971721882124_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
             - 0.189297839436616_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
             + 2.039450367044345_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
             - 1.580183696207410_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))  
     end if
 
     if (x .eq. 2) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*( - 0.039560344515975_wp*F%F(6, y, z, 1:3) &
             + 0.030739159126096_wp*F%F(5, y, z, 1:3) &
             + 0.105980141988699_wp*F%F(4, y, z, 1:3) &
             + 0.393228064437077_wp*F%F(3, y, z, 1:3) &
             - 0.029551468764759_wp*F%F(2, y, z, 1:3) &
             - 0.460835552271137_wp*F%F(1, y, z, 1:3)) 
        
     
        Jq_xU(4:9) = (- 0.029492540133095_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
             - 0.021790841692085_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
             + 0.215422101432619_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
             + 0.279404147185598_wp*X_x(3, y, z, 1)*G%J(3,y,z)*F%F(3, y, z, 4:n) &
             + 0.029551468764759_wp*X_x(2, y, z, 1)*G%J(2,y,z)*F%F(2, y, z, 4:n) &
             - 0.473094335557797_wp*X_x(1, y, z, 1)*G%J(1,y,z)*F%F(1, y, z, 4:n)) 
     end if
 
     if (x .eq. 3) then
        Jq_xU(1:3) =X_x(x, y, z, 1)*(- 0.026915887850467_wp*F%F(7, y, z, 1:3) &
             + 0.197069524204597_wp*F%F(6, y, z, 1:3) &
             - 0.589452745232692_wp*F%F(5, y, z, 1:3) &
             + 1.258766829227482_wp*F%F(4, y, z, 1:3) &
             - 0.306540940575249_wp*F%F(3, y, z, 1:3) &
             - 0.629259919521358_wp*F%F(2, y, z, 1:3) &
             + 0.096333139747688_wp*F%F(1, y, z, 1:3)) 
       
     ! Backward FD for stress fields
        Jq_xU(4:9) = (0.008748664712219_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
             - 0.061405392278187_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
             + 0.491468255323896_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
             + 0.306540940575249_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
             - 0.885608401570530_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
             + 0.140255933237354_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))        
     end if 
 
     if (x .eq. 4) then
        Jq_xU(1:3) =   X_x(x, y, z, 1)*(- 0.013345690454124_wp*F%F(8, y, z, 1:3)&
             + 0.106765523632994_wp*F%F(7, y, z, 1:3) &
             - 0.330443502642251_wp*F%F(6, y, z, 1:3) &
             + 0.946962507015985_wp*F%F(5, y, z, 1:3) &
             - 0.318292975073623_wp*F%F(4, y, z, 1:3) &
             - 0.243684445410829_wp*F%F(3, y, z, 1:3) &
             - 0.240558007429252_wp*F%F(2, y, z, 1:3) &
             + 0.092596590361100_wp*F%F(1, y, z, 1:3)) 
        
       
        Jq_xU(4:9) = ( 0.020661154127888_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
             + 0.327107204245208_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n)&
             + 0.318292975073623_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n)&
             - 0.624133691970994_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
             - 0.118346128899150_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
             + 0.076418487423426_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))  
        
     end if
 


     if (x .eq. 5) then
          Jq_xU(1:3) =   X_x(x, y, z, 1)*(- 0.018365004463716_wp*F%F(9, y, z, 1:3)&
               + 0.146920035709731_wp*F%F(8, y, z, 1:3) &
               - 0.550950133911491_wp*F%F(7, y, z, 1:3) &
               + 1.406282074938901_wp*F%F(6, y, z, 1:3) &
               - 0.593528379527062_wp*F%F(5, y, z, 1:3) &
               - 0.450132219590077_wp*F%F(4, y, z, 1:3) &
               + 0.041897570295664_wp*F%F(3, y, z, 1:3) &
               + 0.033485250803205_wp*F%F(2, y, z, 1:3) &
               - 0.015609194255155_wp*F%F(1, y, z, 1:3)) 
          
         
          Jq_xU(4:9) = (- 0.036730008927433_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               + 0.399693508760138_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               + 0.593528379527062_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               - 1.303115093827634_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               + 0.402190050630647_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               - 0.047235828122731_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               - 0.008331008040049_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))  
          
       end if


     
       if (x .eq. 6) then
          Jq_xU(1:3) =   X_x(x, y, z, 1)*(- 0.016424481602299_wp*F%F(10, y, z, 1:3) &
               + 0.131395852818395_wp*F%F(9, y, z, 1:3) &
               - 0.492734448068983_wp*F%F(8, y, z, 1:3) &
               + 1.313958528183954_wp*F%F(7, y, z, 1:3) &
               - 0.572337434946968_wp*F%F(6, y, z, 1:3) &
               - 0.357460227911152_wp*F%F(5, y, z, 1:3) &
               - 0.025427590054054_wp*F%F(4, y, z, 1:3) &
               - 0.005338567444210_wp*F%F(3, y, z, 1:3) &
               + 0.040531470682718_wp*F%F(2, y, z, 1:3) &
               - 0.016163101657400_wp*F%F(1, y, z, 1:3)) 
          
         
          Jq_xU(4:9) = (- 0.032848963204599_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               + 0.394187558455186_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               + 0.572337434946968_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               - 1.257688453771463_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               + 0.406675342006739_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               - 0.120254802392339_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               + 0.054367610816546_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               - 0.016775726857039_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n))  
          
       end if
 
 
     !=========================================================================================================================
     ! Right boundary closure in x-directyion


     if (x .eq. nx-5) then

          ! Forward FD for velocity fields
         Jq_xU(1:3) = X_x(x, y, z, 1)*( 0.032848963204599_wp*F%F(nx-7, y, z, 1:3)&
              - 0.394187558455186_wp*F%F(nx-6, y, z, 1:3)&
              - 0.572337434946968_wp*F%F(nx-5, y, z, 1:3)&
              + 1.257688453771463_wp*F%F(nx-4, y, z, 1:3)&
              - 0.406675342006739_wp*F%F(nx-3, y, z, 1:3)&
              + 0.120254802392339_wp*F%F(nx-2, y, z, 1:3)&
              - 0.054367610816546_wp*F%F(nx-1, y, z, 1:3)&
              + 0.016775726857039_wp*F%F(nx,   y, z, 1:3))  
         
         
 
 
          ! Backward FD for stress fields
         Jq_xU(4:9) = ( 0.016424481602299_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z)*F%F(nx-9, y, z, 4:n) &
              - 0.131395852818395_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z)*F%F(nx-8, y, z, 4:n) &
              + 0.492734448068983_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z)*F%F(nx-7, y, z, 4:n) &
              - 1.313958528183954_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z)*F%F(nx-6, y, z, 4:n) &
              + 0.572337434946968_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n) &
              + 0.357460227911152_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n) &
              + 0.025427590054054_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n) &
              + 0.005338567444210_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
              - 0.040531470682718_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
              + 0.016163101657400_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
         
         
      end if

     if (x .eq. nx-4) then

         ! Forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(0.036730008927433_wp*F%F(nx-6, y, z, 1:3)&
             - 0.399693508760138_wp*F%F(nx-5, y, z, 1:3)&
             - 0.593528379527062_wp*F%F(nx-4, y, z, 1:3)&
             + 1.303115093827634_wp*F%F(nx-3, y, z, 1:3)&
             - 0.402190050630647_wp*F%F(nx-2, y, z, 1:3)&
             + 0.047235828122731_wp*F%F(nx-1, y, z, 1:3)&
             + 0.008331008040049_wp*F%F(nx,   y, z, 1:3))  
        
        

         ! Backward FD for stress fields
        Jq_xU(4:9) = (0.018365004463716_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z)*F%F(nx-8, y, z, 4:n) &
             - 0.146920035709731_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z)*F%F(nx-7, y, z, 4:n) &
             + 0.550950133911491_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z)*F%F(nx-6, y, z, 4:n) &
             - 1.406282074938901_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n)&
             + 0.593528379527062_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n)&
             + 0.450132219590077_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n) &
             - 0.041897570295664_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
             - 0.033485250803205_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n)&
             + 0.015609194255155_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
        
        
     end if



     if (x .eq. nx-3) then

          ! Forward FD for velocity fields
         Jq_xU(1:3) = X_x(x, y, z, 1)*(  - 0.020661154127888_wp*F%F(nx-5, y, z, 1:3)&
              - 0.327107204245208_wp*F%F(nx-4, y, z, 1:3)&
              - 0.318292975073623_wp*F%F(nx-3, y, z, 1:3)&
              + 0.624133691970994_wp*F%F(nx-2, y, z, 1:3)&
              + 0.118346128899150_wp*F%F(nx-1, y, z, 1:3)&
              - 0.076418487423426_wp*F%F(nx,   y, z, 1:3))  
         
         
 
 
          ! Backward FD for stress fields
         Jq_xU(4:9) = (0.013345690454124_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z)*F%F(nx-7, y, z, 4:n) &
              - 0.106765523632994_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z)*F%F(nx-6, y, z, 4:n) &
              + 0.330443502642251_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n)&
              - 0.946962507015985_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n)&
              + 0.318292975073623_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n) &
              + 0.243684445410829_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
              + 0.240558007429252_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n)&
              - 0.092596590361100_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
         
         
      end if
 
     if (x .eq. nx-2) then
        Jq_xU(1:3) = X_x(x, y, z, 1)*(- 0.008748664712219_wp*F%F(nx-5, y, z, 1:3)&
             + 0.061405392278187_wp*F%F(nx-4, y, z, 1:3)&
             - 0.491468255323896_wp*F%F(nx-3, y, z, 1:3)&
             - 0.306540940575249_wp*F%F(nx-2, y, z, 1:3)&
             + 0.885608401570530_wp*F%F(nx-1, y, z, 1:3)&
             - 0.140255933237354_wp*F%F(nx,   y, z, 1:3))
        


        ! Backward FD for stress fields
         Jq_xU(4:9) = ( 0.026915887850467_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z)*F%F(nx-6, y, z, 4:n) &
               - 0.197069524204597_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n) &
               + 0.589452745232692_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n) &
               - 1.258766829227482_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n) &
               + 0.306540940575249_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
               + 0.629259919521358_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
               - 0.096333139747688_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
        
       
              
     end if
 
     if (x .eq. nx-1) then
        Jq_xU(1:3) = X_x(x, y, z, 1)*( 0.029492540133095_wp*F%F(nx-5, y, z, 1:3)&
             + 0.021790841692085_wp*F%F(nx-4, y, z, 1:3)&
             - 0.215422101432619_wp*F%F(nx-3, y, z, 1:3)&
             - 0.279404147185598_wp*F%F(nx-2, y, z, 1:3)&
             - 0.029551468764759_wp*F%F(nx-1, y, z, 1:3) &
             + 0.473094335557797_wp*F%F(nx,   y, z, 1:3)) 
       

          ! Backward FD for stress fields
        Jq_xU(4:9) = ( 0.039560344515975_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z)*F%F(nx-5, y, z, 4:n) &
             - 0.030739159126096_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z)*F%F(nx-4, y, z, 4:n) &
             - 0.105980141988699_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z)*F%F(nx-3, y, z, 4:n) &
             - 0.393228064437077_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
             + 0.029551468764759_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
             + 0.460835552271137_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
       
            


     end if

 
 
 
     if (x .eq. nx) then
        Jq_xU(1:3) =  X_x(x, y, z, 1)*( - 0.052048915548040_wp*F%F(nx-5, y, z, 1:3)&
             - 0.044953974933765_wp*F%F(nx-4, y, z, 1:3)&
             + 0.366971721882124_wp*F%F(nx-3, y, z, 1:3)&
             + 0.189297839436616_wp*F%F(nx-2, y, z, 1:3)&
             - 2.039450367044345_wp*F%F(nx-1, y, z, 1:3)&
             + 1.580183696207410_wp*F%F(nx,   y, z, 1:3)) 
       

     ! Backward FD for stress fields
        Jq_xU(4:9) = (- 0.054021710000147_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y,z, 4:n)&
             - 0.023993033880123_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y,z, 4:n) &
             + 0.302855902188632_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y,z, 4:n) &
             + 0.275607596716317_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z)*F%F(nx-2, y, z, 4:n) &
             - 2.093702214477299_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z)*F%F(nx-1, y, z, 4:n) &
             + 1.593253459452621_wp*X_x(nx, y, z, 1)*G%J(nx,y,z)*F%F(nx,   y, z, 4:n)) 
       
            
 
     end if
 
     !=================================================================
 
 
     Jr_xU = 0.0_wp*Jr_xU
 
     !implicit none



     if ((y .ge. 7) .and. (y .le. ny-6)) then
          ! forward FD q_x*du/dq 
          Jr_xU(1:3) = X_x(x, y, z, 2)*(1.0_wp/30.0_wp*F%F(x, y-2, z, 1:3)&
               - 2.0_wp/5.0_wp*F%F(x, y-1, z, 1:3)&
               - 7.0_wp/12.0_wp*F%F(x, y, z, 1:3)&
               + 4.0_wp/3.0_wp*F%F(x, y+1, z, 1:3)&
               - 1.0_wp/2.0_wp*F%F(x, y+2, z, 1:3)&
               + 2.0_wp/15.0_wp*F%F(x, y+3, z, 1:3)&
               - 1.0_wp/60.0_wp*F%F(x, y+4, z, 1:3)) 
  
  
          ! backward FD 
          ! d(J*q_x*u)/dq
          Jr_xU(4:9) = (1.0_wp/60.0_wp*X_x(x, y-4, z,2)*G%J(x,y-4,z) * F%F(x, y-4, z, 4:n)&
                - 2.0_wp/15.0_wp*X_x(x, y-3, z,2)*G%J(x,y-3,z) * F%F(x, y-3, z, 4:n)&
                + 1.0_wp/2.0_wp*X_x(x, y-2, z, 2)*G%J(x,y-2,z) * F%F(x, y-2, z, 4:n)&
                - 4.0_wp/3.0_wp*X_x(x, y-1, z, 2)*G%J(x,y-1,z) * F%F(x, y-1, z, 4:n)&
                + 7.0_wp/12.0_wp*X_x(x, y, z, 2)*G%J(x,y,z) * F%F(x, y, z, 4:n)&
                + 2.0_wp/5.0_wp*X_x(x, y+1, z, 2)*G%J(x,y+1,z) * F%F(x, y+1, z, 4:n)&
                - 1.0_wp/30.0_wp*X_x(x, y+2, z, 2)*G%J(x,y+2,z) * F%F(x, y+2, z, 4:n)) 
  
         
   
       end if



     if (y .eq. 1) then

        ! Use forward FD for velocity fields                                                                                                                                                                 
        Jr_xU(1:3) = X_x(x, y, z, 2)*(0.054021710000147_wp*F%F(x, 6, z, 1:3) &
           + 0.023993033880123_wp*F%F(x, 5, z, 1:3) &
           - 0.302855902188632_wp*F%F(x, 4, z, 1:3) &
           - 0.275607596716317_wp*F%F(x, 3, z, 1:3) &
           + 2.093702214477299_wp*F%F(x, 2, z, 1:3) &
           - 1.593253459452621_wp*F%F(x, 1, z, 1:3))

        ! Use backward FD for velocity fields                                                                                                                                                                 
        Jr_xU(4:9) =  (0.052048915548040_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
             + 0.044953974933765_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
             - 0.366971721882124_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             - 0.189297839436616_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             + 2.039450367044345_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             - 1.580183696207410_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))  
     end if
     
     if (y .eq. 2) then
        
        ! Use forward FD for velocity fields                                                                                                                                                                  
        Jr_xU(1:3) = X_x(x, y, z, 2)*( - 0.039560344515975_wp*F%F(x, 6, z, 1:3) &
             + 0.030739159126096_wp*F%F(x, 5, z, 1:3) &
             + 0.105980141988699_wp*F%F(x, 4, z, 1:3) &
             + 0.393228064437077_wp*F%F(x, 3, z, 1:3) &
             - 0.029551468764759_wp*F%F(x, 2, z, 1:3) &
             - 0.460835552271137_wp*F%F(x, 1, z, 1:3))
        

        Jr_xU(4:9) = (- 0.029492540133095_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
             - 0.021790841692085_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
             + 0.215422101432619_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             + 0.279404147185598_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             + 0.029551468764759_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             - 0.473094335557797_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n)) 
     end if
     
     if (y .eq. 3) then
        Jr_xU(1:3) =X_x(x, y, z, 2)*( - 0.026915887850467_wp*F%F(x, 7, z, 1:3) &
             + 0.197069524204597_wp*F%F(x, 6, z, 1:3) &
             - 0.589452745232692_wp*F%F(x, 5, z, 1:3) &
             + 1.258766829227482_wp*F%F(x, 4, z, 1:3) &
             - 0.306540940575249_wp*F%F(x, 3, z, 1:3) &
             - 0.629259919521358_wp*F%F(x, 2, z, 1:3) &
             + 0.096333139747688_wp*F%F(x, 1, z, 1:3))
        
        ! Backward FD for stress fields                                                                                                                                                                          
        Jr_xU(4:9) = (0.008748664712219_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
             - 0.061405392278187_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
             + 0.491468255323896_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             + 0.306540940575249_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             - 0.885608401570530_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             + 0.140255933237354_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))   
     end if
     
     if (y .eq. 4) then
        Jr_xU(1:3) =   X_x(x, y, z, 2)*(- 0.013345690454124_wp*F%F(x, 8, z, 1:3) &
             + 0.106765523632994_wp*F%F(x, 7, z, 1:3) &
             - 0.330443502642251_wp*F%F(x, 6, z, 1:3)&
             + 0.946962507015985_wp*F%F(x, 5, z, 1:3)&
             - 0.318292975073623_wp*F%F(x, 4, z, 1:3)&
             - 0.243684445410829_wp*F%F(x, 3, z, 1:3)&
             - 0.240558007429252_wp*F%F(x, 2, z, 1:3)&
             + 0.092596590361100_wp*F%F(x, 1, z, 1:3))
        
        Jr_xU(4:9) = ( 0.020661154127888_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
             + 0.327107204245208_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
             + 0.318292975073623_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
             - 0.624133691970994_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
             - 0.118346128899150_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
             + 0.076418487423426_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))  


     end if



     if (y .eq. 5) then
          Jr_xU(1:3) =   X_x(x, y, z, 2)*(- 0.018365004463716_wp*F%F(x, 9, z, 1:3) &
               + 0.146920035709731_wp*F%F(x, 8, z, 1:3) &
               - 0.550950133911491_wp*F%F(x, 7, z, 1:3) &
               + 1.406282074938901_wp*F%F(x, 6, z, 1:3) &
               - 0.593528379527062_wp*F%F(x, 5, z, 1:3) &
               - 0.450132219590077_wp*F%F(x, 4, z, 1:3) &
               + 0.041897570295664_wp*F%F(x, 3, z, 1:3) &
               + 0.033485250803205_wp*F%F(x, 2, z, 1:3) &
               - 0.015609194255155_wp*F%F(x, 1, z, 1:3))
  
          Jr_xU(4:9) = (- 0.036730008927433_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               + 0.399693508760138_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               + 0.593528379527062_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               - 1.303115093827634_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               + 0.402190050630647_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               - 0.047235828122731_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               - 0.008331008040049_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))  
  
  
       end if



     if (y .eq. 6) then
          Jr_xU(1:3) =   X_x(x, y, z, 2)*(- 0.016424481602299_wp*F%F(x, 10, z, 1:3) &
               + 0.131395852818395_wp*F%F(x, 9, z, 1:3) &
               - 0.492734448068983_wp*F%F(x, 8, z, 1:3) &
               + 1.313958528183954_wp*F%F(x, 7, z, 1:3) &
               - 0.572337434946968_wp*F%F(x, 6, z, 1:3) &
               - 0.357460227911152_wp*F%F(x, 5, z, 1:3) &
               - 0.025427590054054_wp*F%F(x, 4, z, 1:3) &
               - 0.005338567444210_wp*F%F(x, 3, z, 1:3) &
               + 0.040531470682718_wp*F%F(x, 2, z, 1:3) &
               - 0.016163101657400_wp*F%F(x, 1, z, 1:3))
  
          Jr_xU(4:9) = (- 0.032848963204599_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               + 0.394187558455186_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               + 0.572337434946968_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               - 1.257688453771463_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               + 0.406675342006739_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               - 0.120254802392339_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               + 0.054367610816546_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               - 0.016775726857039_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n))  
  
  
       end if
  
     !=========================================================================================================================                                                                               
     ! Right boundary closure in y-direction   
       
       
     if (y .eq. ny-5) then
          ! Forward FD for velocity fields                                                                                                                                                                     
          Jr_xU(1:3) = X_x(x, y, z, 2)*( 0.032848963204599_wp*F%F(x, ny-7, z, 1:3)&
               - 0.394187558455186_wp*F%F(x, ny-6, z, 1:3)&
               - 0.572337434946968_wp*F%F(x, ny-5, z, 1:3)&
               + 1.257688453771463_wp*F%F(x, ny-4, z, 1:3)&
               - 0.406675342006739_wp*F%F(x, ny-3, z, 1:3)&
               + 0.120254802392339_wp*F%F(x, ny-2, z, 1:3)&
               - 0.054367610816546_wp*F%F(x, ny-1, z, 1:3)&
               + 0.016775726857039_wp*F%F(x,   ny, z, 1:3))
  
          ! Backward FD for stress fields                                                                                                                                                                      
          Jr_xU(4:9) = ( 0.016424481602299_wp*X_x(x, ny-9, z, 2)*G%J(x,ny-9,z)*F%F(x, ny-9, z, 4:n) &
               - 0.131395852818395_wp*X_x(x, ny-8, z, 2)*G%J(x,ny-8,z)*F%F(x, ny-8, z, 4:n) &
               + 0.492734448068983_wp*X_x(x, ny-7, z, 2)*G%J(x,ny-7,z)*F%F(x, ny-7, z, 4:n) &
               - 1.313958528183954_wp*X_x(x, ny-6, z, 2)*G%J(x,ny-6,z)*F%F(x, ny-6, z, 4:n) &
               + 0.572337434946968_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z)*F%F(x, ny-5, z, 4:n) &
               + 0.357460227911152_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z)*F%F(x, ny-4, z, 4:n) &
               + 0.025427590054054_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z)*F%F(x, ny-3, z, 4:n) &
               + 0.005338567444210_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z)*F%F(x, ny-2, z, 4:n) &
               - 0.040531470682718_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z)*F%F(x, ny-1, z, 4:n)&
               + 0.016163101657400_wp*X_x(x, ny, z, 2)*G%J(x,ny,z)*F%F(x, ny, z, 4:n)) 
  
  
       end if

     if (y .eq. ny-4) then
          ! Forward FD for velocity fields                                                                                                                                                                     
          Jr_xU(1:3) = X_x(x, y, z, 2)*( 0.036730008927433_wp*F%F(x, ny-6, z, 1:3)&
               - 0.399693508760138_wp*F%F(x, ny-5, z, 1:3)&
               - 0.593528379527062_wp*F%F(x, ny-4, z, 1:3)&
               + 1.303115093827634_wp*F%F(x, ny-3, z, 1:3)&
               - 0.402190050630647_wp*F%F(x, ny-2, z, 1:3)&
               + 0.047235828122731_wp*F%F(x, ny-1, z, 1:3)&
               + 0.008331008040049_wp*F%F(x,   ny, z, 1:3))
  
          ! Backward FD for stress fields                                                                                                                                                                      
          Jr_xU(4:9) = (0.018365004463716_wp*X_x(x, ny-8, z, 2)*G%J(x,ny-8,z) *F%F(x, ny-8, z, 4:n) &
               - 0.146920035709731_wp*X_x(x, ny-7, z, 2)*G%J(x,ny-7,z) *F%F(x, ny-7, z, 4:n) &
               + 0.550950133911491_wp*X_x(x, ny-6, z, 2)*G%J(x,ny-6,z) *F%F(x, ny-6, z, 4:n) &
               - 1.406282074938901_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5, z, 4:n) &
               + 0.593528379527062_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n) &
               + 0.450132219590077_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3, z, 4:n) &
               - 0.041897570295664_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n) &
               - 0.033485250803205_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n)&
               + 0.015609194255155_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))
  
  
       end if

     if (y .eq. ny-3) then
        ! Forward FD for velocity fields                                                                                                                                                                     
        Jr_xU(1:3) = X_x(x, y, z, 2)*(- 0.020661154127888_wp*F%F(x, ny-5, z, 1:3)&
             - 0.327107204245208_wp*F%F(x, ny-4, z, 1:3)&
             - 0.318292975073623_wp*F%F(x, ny-3, z, 1:3)&
             + 0.624133691970994_wp*F%F(x, ny-2, z, 1:3)&
             + 0.118346128899150_wp*F%F(x, ny-1, z, 1:3)&
             - 0.076418487423426_wp*F%F(x, ny, z, 1:3))

        ! Backward FD for stress fields                                                                                                                                                                      
        Jr_xU(4:9) = (0.013345690454124_wp*X_x(x, ny-7, z, 2)*G%J(x,ny-7,z) *F%F(x, ny-7, z, 4:n) &
             - 0.106765523632994_wp*X_x(x, ny-6, z, 2)*G%J(x,ny-6,z) *F%F(x, ny-6, z, 4:n) &
             + 0.330443502642251_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5, z, 4:n)&
             - 0.946962507015985_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n)&
             + 0.318292975073623_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3, z, 4:n) &
             + 0.243684445410829_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n) &
             + 0.240558007429252_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n)&
             - 0.092596590361100_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))


     end if

     if (y .eq. ny-2) then
        ! Forward FD for velocity fields  
        Jr_xU(1:3) = X_x(x, y, z, 2)*(- 0.008748664712219_wp*F%F(x, ny-5, z, 1:3)&
             + 0.061405392278187_wp*F%F(x, ny-4, z, 1:3)&
             - 0.491468255323896_wp*F%F(x, ny-3, z, 1:3)&
             - 0.306540940575249_wp*F%F(x, ny-2, z, 1:3)&
             + 0.885608401570530_wp*F%F(x, ny-1, z, 1:3)&
             - 0.140255933237354_wp*F%F(x,   ny, z, 1:3))
       
        ! Backward FD for stress fields                                                                                                                                                                      
         Jr_xU(4:9) =( 0.026915887850467_wp*X_x(x, ny-6, z, 2)*G%J(x,ny-6,z) *F%F(x, ny-6, z, 4:n) &
               - 0.197069524204597_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5, z, 4:n) &
               + 0.589452745232692_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n)&
               - 1.258766829227482_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3, z, 4:n)&
               + 0.306540940575249_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n) &
               + 0.629259919521358_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n) &
               - 0.096333139747688_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))

     end if

     if (y .eq. ny-1) then
        Jr_xU(1:3) = X_x(x, y, z, 2)* (0.029492540133095_wp*F%F(x, ny-5, z, 1:3)&
             + 0.021790841692085_wp*F%F(x, ny-4, z, 1:3) &
             - 0.215422101432619_wp*F%F(x, ny-3, z, 1:3) &
             - 0.279404147185598_wp*F%F(x, ny-2, z, 1:3) &
             - 0.029551468764759_wp*F%F(x, ny-1, z, 1:3) &
             + 0.473094335557797_wp*F%F(x,   ny, z, 1:3))
        
          ! Backward FD for stress fields                                                                                                                                                                    
        Jr_xU(4:9) = (0.039560344515975_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5, z, 4:n) &
             - 0.030739159126096_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4, z, 4:n) &
             - 0.105980141988699_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3, z, 4:n) &
             - 0.393228064437077_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2,z, 4:n)&
             + 0.029551468764759_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n)&
             + 0.460835552271137_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x, ny, z, 4:n))
     end if

      if (y .eq. ny) then
        Jr_xU(1:3) =  X_x(x, y, z, 2)*( - 0.052048915548040_wp*F%F(x, ny-5, z, 1:3)&
             - 0.044953974933765_wp*F%F(x, ny-4, z, 1:3)&
             + 0.366971721882124_wp*F%F(x, ny-3, z, 1:3)&
             + 0.189297839436616_wp*F%F(x, ny-2, z, 1:3)&
             - 2.039450367044345_wp*F%F(x, ny-1, z, 1:3)&
             + 1.580183696207410_wp*F%F(x,   ny, z, 1:3))


     ! Backward FD for stress fields                                                                                                                                                                          
        Jr_xU(4:9) = (- 0.054021710000147_wp*X_x(x, ny-5, z, 2)*G%J(x,ny-5,z) *F%F(x, ny-5,z, 4:n)&
             - 0.023993033880123_wp*X_x(x, ny-4, z, 2)*G%J(x,ny-4,z) *F%F(x, ny-4,z, 4:n)&
             + 0.302855902188632_wp*X_x(x, ny-3, z, 2)*G%J(x,ny-3,z) *F%F(x, ny-3,z, 4:n)&
             + 0.275607596716317_wp*X_x(x, ny-2, z, 2)*G%J(x,ny-2,z) *F%F(x, ny-2, z, 4:n)&
             - 2.093702214477299_wp*X_x(x, ny-1, z, 2)*G%J(x,ny-1,z) *F%F(x, ny-1, z, 4:n) &
             + 1.593253459452621_wp*X_x(x, ny, z, 2)*G%J(x,ny,z) *F%F(x,   ny, z, 4:n))


     end if

     !=================================================================    
     !======================================================================
 
 
 
     Js_xU = 0.0_wp*Js_xU



     
       if ((z .ge. 7) .and. (z .le. nz-6)) then
          ! forward FD q_x*du/dq 
          Js_xU(1:3) = X_x(x, y, z, 3)*(1.0_wp/30.0_wp*F%F(x, y, z-2, 1:3)&
               - 2.0_wp/5.0_wp*F%F(x, y, z-1, 1:3)&
               - 7.0_wp/12.0_wp*F%F(x, y, z, 1:3)&
               + 4.0_wp/3.0_wp*F%F(x, y, z+1, 1:3)&
               - 1.0_wp/2.0_wp*F%F(x, y, z+2, 1:3)&
               + 2.0_wp/15.0_wp*F%F(x, y, z+3, 1:3)&
               - 1.0_wp/60.0_wp*F%F(x, y, z+4, 1:3))
          
          !
  
          ! backward FD 
          ! d(J*q_x*u)/dq
          Js_xU(4:9) = (1.0_wp/60.0_wp*X_x(x, y, z-4,3)*G%J(x,y,z-4) * F%F(x, y, z-4, 4:n)&
                - 2.0_wp/15.0_wp*X_x(x, y, z-3,3)*G%J(x,y,z-3) * F%F(x, y, z-3, 4:n)&
                + 1.0_wp/2.0_wp*X_x(x, y, z-2, 3)*G%J(x,y,z-2) * F%F(x, y, z-2, 4:n)&
                - 4.0_wp/3.0_wp*X_x(x, y, z-1, 3)*G%J(x,y,z-1) *F%F(x, y, z-1, 4:n)&
                + 7.0_wp/12.0_wp*X_x(x, y, z, 3)*G%J(x,y,z) *F%F(x, y, z, 4:n)&
                + 2.0_wp/5.0_wp*X_x(x, y, z+1, 3)*G%J(x,y,z+1) *F%F(x, y, z+1, 4:n)&
                - 1.0_wp/30.0_wp*X_x(x, y, z+2, 3)*G%J(x,y,z+2) *F%F(x, y, z+2, 4:n)) 
  
         
   
       end if

 
     if (z .eq.  1) then

        Js_xU(1:3) =  X_x(x, y, z, 3)*(0.054021710000147_wp*F%F(x, y, 6, 1:3)&
             + 0.023993033880123_wp*F%F(x, y, 5, 1:3)&
             - 0.302855902188632_wp*F%F(x, y, 4, 1:3)&
             - 0.275607596716317_wp*F%F(x, y, 3, 1:3)&
             + 2.093702214477299_wp*F%F(x, y, 2, 1:3)&
             - 1.593253459452621_wp*F%F(x, y, 1, 1:3)) 
             

       ! Backward FD for stress fields
         Js_xU(4:9) =  ( 0.052048915548040_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x, y, 6, 4:n) &
             + 0.044953974933765_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x, y, 5, 4:n) &
             - 0.366971721882124_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n) &
             - 0.189297839436616_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             + 2.039450367044345_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) &
             - 1.580183696207410_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n)) 
             
     end if
 
 
 
 
     if (z .eq.  2) then
        Js_xU(1:3) = X_x(x, y, z, 3)*(-0.039560344515975_wp*F%F(x, y, 6, 1:3)&
             + 0.030739159126096_wp*F%F(x, y, 5, 1:3)&
             + 0.105980141988699_wp*F%F(x, y, 4, 1:3)&
             + 0.393228064437077_wp*F%F(x, y, 3, 1:3)&
             - 0.029551468764759_wp*F%F(x, y, 2, 1:3)& 
             - 0.460835552271137_wp*F%F(x, y, 1, 1:3))  
             

        Js_xU(4:9) = ( -0.029492540133095_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x, y, 6, 4:n) &
             - 0.021790841692085_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x, y, 5, 4:n) &
             + 0.215422101432619_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n) &
             + 0.279404147185598_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             + 0.029551468764759_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) &
             - 0.473094335557797_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n)) 
             
     end if
 
 
 
     if (z .eq.  3) then
        Js_xU(1:3)  = X_x(x, y, z, 3)*( -0.026915887850467_wp*F%F(x, y, 7, 1:3)&
             + 0.197069524204597_wp*F%F(x, y, 6, 1:3)&
             - 0.589452745232692_wp*F%F(x, y, 5, 1:3)&
             + 1.258766829227482_wp*F%F(x, y, 4, 1:3)&
             - 0.306540940575249_wp*F%F(x, y, 3, 1:3)&
             - 0.629259919521358_wp*F%F(x, y, 2, 1:3)&
             + 0.096333139747688_wp*F%F(x, y, 1, 1:3)) 
             
             

           ! Backward FD for stress fields
         Js_xU(4:9) = ( 0.008748664712219_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x,y, 6, 4:n) &
             - 0.061405392278187_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x,y, 5, 4:n) &
             + 0.491468255323896_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n) &
             + 0.306540940575249_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             - 0.885608401570530_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) &
             + 0.140255933237354_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n)) 
             
 
     end if
 
 
     if (z .eq.  4) then
        Js_xU(1:3) = X_x(x, y, z, 3)*(-0.013345690454124_wp*F%F(x, y, 8, 1:3)&
             + 0.106765523632994_wp*F%F(x, y, 7, 1:3)&
             - 0.330443502642251_wp*F%F(x, y, 6, 1:3)&
             + 0.946962507015985_wp*F%F(x, y, 5, 1:3)&
             - 0.318292975073623_wp*F%F(x, y, 4, 1:3)&
             - 0.243684445410829_wp*F%F(x, y, 3, 1:3)&
             - 0.240558007429252_wp*F%F(x, y, 2, 1:3)&
             + 0.092596590361100_wp*F%F(x, y, 1, 1:3))  
             
             



        Js_xU(4:9) = ( 0.020661154127888_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x, y, 6, 4:n) &
             + 0.327107204245208_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x, y, 5, 4:n)&
             + 0.318292975073623_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n)&
             - 0.624133691970994_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
             - 0.118346128899150_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) & 
             + 0.076418487423426_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n))  
             
             

 
     end if


     if (z .eq.  5) then
          Js_xU(1:3) = X_x(x, y, z, 3)*( -0.018365004463716_wp*F%F(x, y, 9, 1:3)&
               + 0.146920035709731_wp*F%F(x, y, 8, 1:3)&
               - 0.550950133911491_wp*F%F(x, y, 7, 1:3)&
               + 1.406282074938901_wp*F%F(x, y, 6, 1:3)&
               - 0.593528379527062_wp*F%F(x, y, 5, 1:3)&
               - 0.450132219590077_wp*F%F(x, y, 4, 1:3)&
               + 0.041897570295664_wp*F%F(x, y, 3, 1:3)&
               + 0.033485250803205_wp*F%F(x, y, 2, 1:3)&
               - 0.015609194255155_wp*F%F(x, y, 1, 1:3))  
               
               
  
  
  
          Js_xU(4:9) = (-0.036730008927433_wp*X_x(x, y, 7, 3)*G%J(x,y,7) *F%F(x, y, 7, 4:n) &
               + 0.399693508760138_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x, y, 6, 4:n) &
               + 0.593528379527062_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x, y, 5, 4:n)&
               - 1.303115093827634_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n)&
               + 0.402190050630647_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
               - 0.047235828122731_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) & 
               - 0.008331008040049_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n))  
               
               
  
   
       end if


       if (z .eq.  6) then
          Js_xU(1:3) = X_x(x, y, z, 3)*(-0.016424481602299_wp*F%F(x, y, 10, 1:3)&
               + 0.131395852818395_wp*F%F(x, y, 9, 1:3)&
               - 0.492734448068983_wp*F%F(x, y, 8, 1:3)&
               + 1.313958528183954_wp*F%F(x, y, 7, 1:3)&
               - 0.572337434946968_wp*F%F(x, y, 6, 1:3)&
               - 0.357460227911152_wp*F%F(x, y, 5, 1:3)&
               - 0.025427590054054_wp*F%F(x, y, 4, 1:3)&
               - 0.005338567444210_wp*F%F(x, y, 3, 1:3)&
               + 0.040531470682718_wp*F%F(x, y, 2, 1:3)&
               - 0.016163101657400_wp*F%F(x, y, 1, 1:3))  
               
               
  
  
  
          Js_xU(4:9) = (-0.032848963204599_wp*X_x(x, y, 8, 3)*G%J(x,y,8) *F%F(x, y, 8, 4:n) &
               + 0.394187558455186_wp*X_x(x, y, 7, 3)*G%J(x,y,7) *F%F(x, y, 7, 4:n) &
               + 0.572337434946968_wp*X_x(x, y, 6, 3)*G%J(x,y,6) *F%F(x, y, 6, 4:n) &
               - 1.257688453771463_wp*X_x(x, y, 5, 3)*G%J(x,y,5) *F%F(x, y, 5, 4:n)&
               + 0.406675342006739_wp*X_x(x, y, 4, 3)*G%J(x,y,4) *F%F(x, y, 4, 4:n)&
               - 0.120254802392339_wp*X_x(x, y, 3, 3)*G%J(x,y,3) *F%F(x, y, 3, 4:n) &
               + 0.054367610816546_wp*X_x(x, y, 2, 3)*G%J(x,y,2) *F%F(x, y, 2, 4:n) & 
               - 0.016775726857039_wp*X_x(x, y, 1, 3)*G%J(x,y,1) *F%F(x, y, 1, 4:n))  
               
            !             + 0.394187558455186*u_old[6] - 0.032848963204599*u_old[7]         
  
   
       end if




      
     if (z .eq.   nz-5) then
          Js_xU(1:3) =  X_x(x, y, z, 3)*( 0.032848963204599_wp*F%F(x, y, nz-7, 1:3)&
               - 0.394187558455186_wp*F%F(x, y, nz-6, 1:3)&
               - 0.572337434946968_wp*F%F(x, y, nz-5, 1:3)&
               + 1.257688453771463_wp*F%F(x, y, nz-4, 1:3)&
               - 0.406675342006739_wp*F%F(x, y, nz-3, 1:3)&
               + 0.120254802392339_wp*F%F(x, y, nz-2, 1:3)&
               - 0.054367610816546_wp*F%F(x, y, nz-1, 1:3)&
               + 0.016775726857039_wp*F%F(x, y, nz,   1:3)) 
               
           
  
       
               ! Backward FD for stress fields
          Js_xU(4:9) = (0.016424481602299_wp*X_x(x, y, nz-9, 3)*G%J(x,y,nz-9) *F%F(x, y, nz-9,4:n) &
               - 0.131395852818395_wp*X_x(x, y, nz-8, 3)*G%J(x,y,nz-8) *F%F(x, y, nz-8, 4:n) &
               + 0.492734448068983_wp*X_x(x, y, nz-7, 3)*G%J(x,y,nz-7) *F%F(x, y, nz-7, 4:n) &
               - 1.313958528183954_wp*X_x(x, y, nz-6, 3)*G%J(x,y,nz-6) *F%F(x, y, nz-6, 4:n) &
               + 0.572337434946968_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n) &
               + 0.357460227911152_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n) &
               + 0.025427590054054_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n) &
               + 0.005338567444210_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
               - 0.040531470682718_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
               + 0.016163101657400_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n)) 
               
               
          
                   
       end if



     if (z .eq.   nz-4) then
          Js_xU(1:3) =  X_x(x, y, z, 3)*( 0.036730008927433_wp*F%F(x, y, nz-6, 1:3)&
               - 0.399693508760138_wp*F%F(x, y, nz-5, 1:3)&
               - 0.593528379527062_wp*F%F(x, y, nz-4, 1:3)&
               + 1.303115093827634_wp*F%F(x, y, nz-3, 1:3)&
               - 0.402190050630647_wp*F%F(x, y, nz-2, 1:3)&
               + 0.047235828122731_wp*F%F(x, y, nz-1, 1:3)&
               + 0.008331008040049_wp*F%F(x, y, nz,   1:3)) 

          
               
  
       
               ! Backward FD for stress fields
          Js_xU(4:9) = ( 0.018365004463716_wp*X_x(x, y, nz-8, 3)*G%J(x,y,nz-8) *F%F(x, y, nz-8,4:n) &
               - 0.146920035709731_wp*X_x(x, y, nz-7, 3)*G%J(x,y,nz-7) *F%F(x, y, nz-7, 4:n) &
               + 0.550950133911491_wp*X_x(x, y, nz-6, 3)*G%J(x,y,nz-6) *F%F(x, y, nz-6, 4:n) &
               - 1.406282074938901_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n) &
               + 0.593528379527062_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n) &
               + 0.450132219590077_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n) &
               - 0.041897570295664_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
               - 0.033485250803205_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
               + 0.015609194255155_wp*X_x(x, y, nz, 3)*G%J(x,y, nz) *F%F(x, y, nz,   4:n)) 
               
               
          
       end if



     
 
 
 
     if (z .eq.   nz-3) then
        Js_xU(1:3) =  X_x(x, y, z, 3)*(- 0.020661154127888_wp*F%F(x, y, nz-5, 1:3)&
             - 0.327107204245208_wp*F%F(x, y, nz-4, 1:3)&
             - 0.318292975073623_wp*F%F(x, y, nz-3, 1:3)&
             + 0.624133691970994_wp*F%F(x, y, nz-2, 1:3)&
             + 0.118346128899150_wp*F%F(x, y, nz-1, 1:3)&
             - 0.076418487423426_wp*F%F(x, y, nz,   1:3)) 

        
             

     
             ! Backward FD for stress fields
        Js_xU(4:9) = ( 0.013345690454124_wp*X_x(x, y, nz-7, 3)*G%J(x,y,nz-7) *F%F(x, y, nz-7,4:n) &
             - 0.106765523632994_wp*X_x(x, y, nz-6, 3)*G%J(x,y,nz-6) *F%F(x, y, nz-6, 4:n) &
             + 0.330443502642251_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n) &
             - 0.946962507015985_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n) &
             + 0.318292975073623_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n) &
             + 0.243684445410829_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
             + 0.240558007429252_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             - 0.092596590361100_wp*X_x(x, y, nz, 3)*G%J(x,y, nz) *F%F(x, y, nz,   4:n)) 
             
         

     end if
 
 
 
     if (z .eq. nz-2) then
          
        Js_xU(1:3) = X_x(x, y, z, 3)*(- 0.008748664712219_wp*F%F(x, y, nz-5, 1:3)&
             + 0.061405392278187_wp*F%F(x, y, nz-4, 1:3)&
             - 0.491468255323896_wp*F%F(x, y, nz-3, 1:3)&
             - 0.306540940575249_wp*F%F(x, y, nz-2, 1:3)&
             + 0.885608401570530_wp*F%F(x, y, nz-1, 1:3)&
             - 0.140255933237354_wp*F%F(x, y, nz,   1:3)) 
             
        
        
               ! Backward FD for stress fields
        Js_xU(4:9) = (0.026915887850467_wp*X_x(x, y, nz-6, 3)*G%J(x,y,nz-6) *F%F(x, y, nz-6, 4:n) &
             - 0.197069524204597_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n) &
             + 0.589452745232692_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n) &
             - 1.258766829227482_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n) &
             + 0.306540940575249_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
             + 0.629259919521358_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             - 0.096333139747688_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n)) 

        
             
 

     end if
 
 
 
     if (z .eq.   nz-1) then
        Js_xU(1:3) = X_x(x, y, z, 3)*( 0.029492540133095_wp*F%F(x, y, nz-5, 1:3)&
             + 0.021790841692085_wp*F%F(x, y, nz-4, 1:3)&
             - 0.215422101432619_wp*F%F(x, y, nz-3, 1:3)&
             - 0.279404147185598_wp*F%F(x, y, nz-2, 1:3)&
             - 0.029551468764759_wp*F%F(x, y, nz-1, 1:3)&
             + 0.473094335557797_wp*F%F(x, y, nz,   1:3)) 
             

                           
                 ! Backward FD for stress fields
        Js_xU(4:9) = (0.039560344515975_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n) &
             - 0.030739159126096_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n) &
             - 0.105980141988699_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n) &
             - 0.393228064437077_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n) &
             + 0.029551468764759_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             + 0.460835552271137_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n))
             
        

 
     end if
 
 
     if (z .eq.   nz) then
 
        Js_xU(1:3) = X_x(x, y, z, 3)*( - 0.052048915548040_wp*F%F(x, y, nz-5, 1:3)&
             - 0.044953974933765_wp*F%F(x, y, nz-4, 1:3)&
             + 0.366971721882124_wp*F%F(x, y, nz-3, 1:3)&
             + 0.189297839436616_wp*F%F(x, y, nz-2, 1:3)&
             - 2.039450367044345_wp*F%F(x, y, nz-1, 1:3)&
             + 1.580183696207410_wp*F%F(x, y, nz,   1:3)) 

        
        ! Backward FD for stress fields
        Js_xU(4:9) = (- 0.054021710000147_wp*X_x(x, y, nz-5, 3)*G%J(x,y,nz-5) *F%F(x, y, nz-5, 4:n)&
             - 0.023993033880123_wp*X_x(x, y, nz-4, 3)*G%J(x,y,nz-4) *F%F(x, y, nz-4, 4:n)&
             + 0.302855902188632_wp*X_x(x, y, nz-3, 3)*G%J(x,y,nz-3) *F%F(x, y, nz-3, 4:n)&
             + 0.275607596716317_wp*X_x(x, y, nz-2, 3)*G%J(x,y,nz-2) *F%F(x, y, nz-2, 4:n)&
             - 2.093702214477299_wp*X_x(x, y, nz-1, 3)*G%J(x,y,nz-1) *F%F(x, y, nz-1, 4:n) &
             + 1.593253459452621_wp*X_x(x, y, nz, 3)*G%J(x,y,nz) *F%F(x, y, nz,   4:n) )
             

        
 
     end if

 

     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

     !print *, Ju_x(1:n)
   end subroutine JJU_x6_upwind


subroutine JJU_x6_upwind2(x, y, z, F, G, X_x, Ju_x)


  !=================================================================================================
  !
        use datatypes, only: block_fields, block_grid_t
        use metrics, only : Dfx6, Dfy6, Dfz6, Dbx6, Dby6, Dbz6

  implicit none
  
  integer, intent(in) :: x, y, z                      ! indices in the tranformed cordinate
  type(block_fields), intent(in):: F
  type(block_grid_t), intent(in) :: G
  real(kind = wp), dimension(:), intent(out) :: Ju_x            ! metric coefficients

  real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   ! the grid
  real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU, Ufx, Ubx             ! work array
  real(kind = wp) :: hx, hy, hz                      ! spatial steps discertizing the unit cube
  integer :: n, nx, ny, nz
  integer :: mbx, mby, mbz, pbx, pby, pbz

  nx = G%C%nq
  ny = G%C%nr
  nz = G%C%ns

  n = size(F%F, 4)

  hx = G%hq
  hy = G%hr
  hz = G%hs

  mbx = G%C%mbq
  mby = G%C%mbr
  mbz = G%C%mbs
  pbx = G%C%pbq
  pby = G%C%pbr
  pbz = G%C%pbs



  ! work arrays:
  if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
  if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
  if (.not. allocated(Js_xU)) allocate(Js_xU(n))

 if (.not. allocated(Ufx)) allocate(Ufx(n))
 if (.not. allocated(Ubx)) allocate(Ubx(n))

  !Ju_x = 0.0_wp*Ju_x
  Ufx = 0.0_wp*Ufx
  Ubx = 0.0_wp*Ubx

  
  ! Jr_xU = 0.0_wp*Jr_xU
  ! Js_xU = 0.0_wp*Js_xU

  ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
  ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
  !=========================================================================================================================
  ! Interior approximation: Standard central finite difference approximation
  !print *, 'metric ',  X_x(x,y,z,1), X_x(x,y,z,2),  X_x(x,y,z,3)
 
   
  !=================================================================
Jq_xU = 0.0_wp*Jq_xU
Ufx = Dfx6(hx, F%F, x, y, z, mbx, pbx, mby, pby, mbz, pbz, nx, 1, 9)
Ubx = Dbx6(hx, F%F, x, y, z, mbx, pbx, mby, pby, mbz, pbz, nx, 1, 9)

Jq_xU(1:3) = X_x(x, y, z, 1)*Ufx(1:3)
Jq_xU(4:9) = X_x(x, y, z, 1)*G%J(x,y,z)*Ubx(4:9)



Ufx = 0.0_wp*Ufx
Ubx = 0.0_wp*Ubx
Jr_xU = 0.0_wp*Jr_xU

Ufx = Dfy6(hy, F%F, x, y, z, mbx, pbx, mby, pby, mbz, pbz, ny, 1, 9)
Ubx = Dby6(hy, F%F, x, y, z, mbx, pbx, mby, pby, mbz, pbz, ny, 1, 9)

Jr_xU(1:3) = X_x(x, y, z, 2)*Ufx(1:3)
Jr_xU(4:9) = X_x(x, y, z, 2)*G%J(x,y,z)*Ubx(4:9)

  !implicit none

Js_xU = 0.0_wp*Js_xU
Ufx = 0.0_wp*Ufx
Ubx = 0.0_wp*Ubx

Ufx = Dfz6(hz, F%F, x, y, z, mbx, pbx, mby, pby, mbz, pbz, nz, 1, 9)
Ubx = Dbz6(hz, F%F, x, y, z, mbx, pbx, mby, pby, mbz, pbz, nz, 1, 9)

Js_xU(1:3) = X_x(x, y, z, 3)*Ufx(1:3)
Js_xU(4:9) = X_x(x, y, z, 3)*G%J(x,y,z)*Ubx(4:9)

!print *, Jq_xU, Jr_xU, Js_xU


Ju_x(1:n) = Jq_xU(1:n) + Jr_xU(1:n) + Js_xU(1:n)

end subroutine JJU_x6_upwind2

subroutine JJU_x7_upwind(x, y, z, F, G, X_x, Ju_x)

    !=========================================================================================================================

     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     !input data 
     integer,               intent(in)  :: x, y, z      ! indices in the tranformed co-ordinate
     type(block_fields),    intent(in)  :: F            
     type(block_grid_t),    intent(in)  :: G

     !output data 
     real(kind = wp),       dimension(:), intent(out) :: Ju_x      ! metric coefficients
 
     !input grid and output derivatives 
     real(kind = wp),       dimension(:,:,:,:), allocatable, intent(in) :: X_x                  ! the grid
     real(kind = wp),       dimension(:),       allocatable, save       :: Jq_xU, Jr_xU, Js_xU  ! work array

     !working parameters 
     real(kind = wp)        :: hx, hy, hz       ! spatial steps discertizing the unit cube
     integer                :: n, nx, ny, nz    ! number of points
 
     !get values from input data
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n  = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jq_xU = 0.0_wp*Jq_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! x direction 
    
     ! cycle through interior points
     if ((x .ge. 7) .and. (x .le. nx-6)) then 


        ! forward FD q_x*du/dq for velocity fields
        ! non-conservative form 
        ! weights are [-1/105, 1/10, -3/5, -1/4, 1, -3/10, 1/15, -1/140]
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&        
                    -1.0_wp/105.0_wp   *F%F(x-3, y, z, 1:3)&
                    +1.0_wp/10.0_wp    *F%F(x-2, y, z, 1:3)&
                    -3.0_wp/5.0_wp     *F%F(x-1, y, z, 1:3)&
                    -1.0_wp/4.0_wp     *F%F(x  , y, z, 1:3)&
                    +1.0_wp            *F%F(x+1, y, z, 1:3)&
                    -3.0_wp/10.0_wp    *F%F(x+2, y, z, 1:3)&
                    +1.0_wp/15.0_wp    *F%F(x+3, y, z, 1:3)&
                    -1.0_wp/140.0_wp   *F%F(x+4, y, z, 1:3)&    
                     )


        ! backward FD d(J*q_x*u)/dq for stress fields 
        ! conservative form 
        ! weights are [1/140, -1/15, 3/10, -1, 1/4, 3/5, -1/10, 1/105]
        Jq_xU(4:9) = (&
                    +1.0_wp/140.0_wp *X_x(x-4, y, z, 1)*G%J(x-4, y, z) * F%F(x-4, y, z, 4:n)&
                    -1.0_wp/15.0_wp  *X_x(x-3, y, z, 1)*G%J(x-3, y, z) * F%F(x-3, y, z, 4:n)&
                    +3.0_wp/10.0_wp  *X_x(x-2, y, z, 1)*G%J(x-2, y, z) * F%F(x-2, y, z, 4:n)&
                    -1.0_wp          *X_x(x-1, y, z, 1)*G%J(x-1, y, z) * F%F(x-1, y, z, 4:n)&
                    +1.0_wp/4.0_wp   *X_x(x  , y, z, 1)*G%J(x  , y, z) * F%F(x  , y, z, 4:n)&
                    +3.0_wp/5.0_wp   *X_x(x+1, y, z, 1)*G%J(x+1, y, z) * F%F(x+1, y, z, 4:n)&
                    -1.0_wp/10.0_wp  *X_x(x+2, y, z, 1)*G%J(x+2, y, z) * F%F(x+2, y, z, 4:n)&
                    +1.0_wp/105.0_wp *X_x(x+3, y, z, 1)*G%J(x+3, y, z) * F%F(x+3, y, z, 4:n)&
                      ) 

      end if

     !=========================================================================================================================
     ! boundary approximations 
     ! x direction 
     ! LHS 
     ! need 6 points 

     if (x .eq. 1) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.053609043198748_wp*F%F(6, y, z, 1:3) &
                    +0.031776313568303_wp*F%F(5, y, z, 1:3) &
                    -0.329862352927359_wp*F%F(4, y, z, 1:3) &
                    -0.237161254615221_wp*F%F(3, y, z, 1:3) &
                    +2.068759097745568_wp*F%F(2, y, z, 1:3) &
                    -1.587120846970038_wp*F%F(1, y, z, 1:3) &
                     ) 
                    
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.052764835595357_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                    +0.040746019354332_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                    -0.357299100037565_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                    -0.200227171966867_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                    +2.045543388652316_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                    -1.581527971597573_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &                  
                     )  
     
     end if

     if (x .eq. 2) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.034163235251410_wp*F%F(6, y, z, 1:3) &
                    +0.006283775981431_wp*F%F(5, y, z, 1:3) &
                    +0.149830581921711_wp*F%F(4, y, z, 1:3) &
                    +0.354437950860383_wp*F%F(3, y, z, 1:3) &
                    -0.012686575154571_wp*F%F(2, y, z, 1:3) &
                    -0.463702498357543_wp*F%F(1, y, z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    -0.029841082672069_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                    -0.016267583768385_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                    +0.196814495127562_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                    +0.305572843948314_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                    +0.012686575154571_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                    -0.468965247789993_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &      
                    ) 

     end if

     if (x .eq. 3) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.011447347501192_wp*F%F(7, y, z, 1:3) &
                    +0.102425925355228_wp*F%F(6, y, z, 1:3) &
                    -0.360626660648614_wp*F%F(5, y, z, 1:3) &
                    +0.980527672399361_wp*F%F(4, y, z, 1:3) &
                    -0.130372094340790_wp*F%F(3, y, z, 1:3) &
                    -0.681777727691031_wp*F%F(2, y, z, 1:3) &
                    +0.101270232427039_wp*F%F(1, y, z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.022332921092875_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                    -0.136047721252784_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                    +0.654195007415722_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                    +0.130372094340790_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                    -0.790802931381985_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                    +0.119950629785382_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                     ) 
                     
     end if

     if (x .eq. 4) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.005741474176657_wp*F%F(8, y, z, 1:3) &
                    +0.053587092315462_wp*F%F(7, y, z, 1:3) &
                    -0.181292965616422_wp*F%F(6, y, z, 1:3) &
                    +0.728101537236212_wp*F%F(5, y, z, 1:3) &
                    -0.136933409573551_wp*F%F(4, y, z, 1:3) &
                    -0.328114765554538_wp*F%F(3, y, z, 1:3) &
                    -0.220243795689184_wp*F%F(2, y, z, 1:3) &
                    +0.090637781058677_wp*F%F(1, y, z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.007655298902209_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
                    -0.030243581766320_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                    +0.461432440844702_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                    +0.136933409573551_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                    -0.491788539658795_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                    -0.167666797363522_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                    +0.083677769468176_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                     ) 
                     
     end if

     if (x .eq. 5) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.007850120840981_wp*F%F(9, y, z, 1:3) &
                    +0.073267794515818_wp*F%F(8, y, z, 1:3) &
                    -0.329705075321183_wp*F%F(7, y, z, 1:3) &
                    +1.044838434095626_wp*F%F(6, y, z, 1:3) &
                    -0.253703695582764_wp*F%F(5, y, z, 1:3) &
                    -0.630900759826953_wp*F%F(4, y, z, 1:3) &
                    +0.093295940554189_wp*F%F(3, y, z, 1:3) &
                    +0.024889867269617_wp*F%F(2, y, z, 1:3) &
                    -0.014132384863370_wp*F%F(1, y, z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.010466827787974_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
                    -0.109901691773728_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
                    +0.614572168859249_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                    +0.253703695582764_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                    -0.995508274694755_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                    +0.247302955053649_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                    -0.009614356523787_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                    -0.011021324291367_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                     ) 
                     
     end if

      if (x .eq. 6) then

        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.007042368322384_wp*F%F(10, y, z, 1:3) &
                    +0.065728771008917_wp*F%F(9, y, z, 1:3) &
                    -0.295779469540127_wp*F%F(8, y, z, 1:3) &
                    +0.985931565133756_wp*F%F(7, y, z, 1:3) &
                    -0.245402632435032_wp*F%F(6, y, z, 1:3) &
                    -0.551334643308827_wp*F%F(5, y, z, 1:3) &
                    +0.037096124729170_wp*F%F(4, y, z, 1:3) &
                    -0.013739135291768_wp*F%F(3, y, z, 1:3) &
                    +0.040959674614960_wp*F%F(2, y, z, 1:3) &
                    -0.016417886588667_wp*F%F(1, y, z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.009389824429845_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
                    -0.098593156513376_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
                    +0.591558939080254_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
                    +0.245402632435032_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                    -0.937327875498694_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                    +0.222370039269531_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                    -0.063012072625329_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                    +0.046892232935029_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                    -0.016680563512292_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                     ) 
                     
     end if

     !=========================================================================================================================
     ! boundary approximations 
     ! x direction 
     ! RHS 
     ! need 6 points 

     if (x .eq. nx-5) then
        
        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.009389824429845_wp*F%F(nx-8, y, z, 1:3) &
                    +0.098593156513376_wp*F%F(nx-7, y, z, 1:3) &
                    -0.591558939080254_wp*F%F(nx-6, y, z, 1:3) &
                    -0.245402632435032_wp*F%F(nx-5, y, z, 1:3) &
                    +0.937327875498694_wp*F%F(nx-4, y, z, 1:3) &
                    -0.222370039269531_wp*F%F(nx-3, y, z, 1:3) &
                    +0.063012072625329_wp*F%F(nx-2, y, z, 1:3) &
                    -0.046892232935029_wp*F%F(nx-1, y, z, 1:3) &
                    +0.016680563512292_wp*F%F(nx  , y, z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.007042368322384_wp*X_x(nx-9, y, z, 1)*G%J(nx-9, y, z) *F%F(nx-9, y, z, 4:n) &
                    -0.065728771008917_wp*X_x(nx-8, y, z, 1)*G%J(nx-8, y, z) *F%F(nx-8, y, z, 4:n) &
                    +0.295779469540127_wp*X_x(nx-7, y, z, 1)*G%J(nx-7, y, z) *F%F(nx-7, y, z, 4:n) &
                    -0.985931565133756_wp*X_x(nx-6, y, z, 1)*G%J(nx-6, y, z) *F%F(nx-6, y, z, 4:n) &
                    +0.245402632435032_wp*X_x(nx-5, y, z, 1)*G%J(nx-5, y, z) *F%F(nx-5, y, z, 4:n) &
                    +0.551334643308827_wp*X_x(nx-4, y, z, 1)*G%J(nx-4, y, z) *F%F(nx-4, y, z, 4:n) &
                    -0.037096124729170_wp*X_x(nx-3, y, z, 1)*G%J(nx-3, y, z) *F%F(nx-3, y, z, 4:n) &
                    +0.013739135291768_wp*X_x(nx-2, y, z, 1)*G%J(nx-2, y, z) *F%F(nx-2, y, z, 4:n) &
                    -0.040959674614960_wp*X_x(nx-1, y, z, 1)*G%J(nx-1, y, z) *F%F(nx-1, y, z, 4:n) &
                    +0.016417886588667_wp*X_x(nx  , y, z, 1)*G%J(nx  , y, z) *F%F(nx  , y, z, 4:n) &
                     ) 

     end if 


     if (x .eq. nx-4) then
        
        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.010466827787974_wp*F%F(nx-7, y, z, 1:3) &
                    +0.109901691773728_wp*F%F(nx-6, y, z, 1:3) &
                    -0.614572168859249_wp*F%F(nx-5, y, z, 1:3) &
                    -0.253703695582764_wp*F%F(nx-4, y, z, 1:3) &
                    +0.995508274694755_wp*F%F(nx-3, y, z, 1:3) &
                    -0.247302955053649_wp*F%F(nx-2, y, z, 1:3) &
                    +0.009614356523787_wp*F%F(nx-1, y, z, 1:3) &
                    +0.011021324291367_wp*F%F(nx  , y, z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.007850120840981_wp*X_x(nx-8, y, z, 1)*G%J(nx-8, y, z) *F%F(nx-8, y, z, 4:n) &
                    -0.073267794515818_wp*X_x(nx-7, y, z, 1)*G%J(nx-7, y, z) *F%F(nx-7, y, z, 4:n) &
                    +0.329705075321183_wp*X_x(nx-6, y, z, 1)*G%J(nx-6, y, z) *F%F(nx-6, y, z, 4:n) &
                    -1.044838434095626_wp*X_x(nx-5, y, z, 1)*G%J(nx-5, y, z) *F%F(nx-5, y, z, 4:n) &
                    +0.253703695582764_wp*X_x(nx-4, y, z, 1)*G%J(nx-4, y, z) *F%F(nx-4, y, z, 4:n) &
                    +0.630900759826953_wp*X_x(nx-3, y, z, 1)*G%J(nx-3, y, z) *F%F(nx-3, y, z, 4:n) &
                    -0.093295940554189_wp*X_x(nx-2, y, z, 1)*G%J(nx-2, y, z) *F%F(nx-2, y, z, 4:n) &
                    -0.024889867269617_wp*X_x(nx-1, y, z, 1)*G%J(nx-1, y, z) *F%F(nx-1, y, z, 4:n) &
                    +0.014132384863370_wp*X_x(nx  , y, z, 1)*G%J(nx  , y, z) *F%F(nx  , y, z, 4:n) &
                     ) 
        
     end if 

     if (x .eq. nx-3) then
        
        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.007655298902209_wp*F%F(nx-6, y, z, 1:3) &
                    +0.030243581766320_wp*F%F(nx-5, y, z, 1:3) &
                    -0.461432440844702_wp*F%F(nx-4, y, z, 1:3) &
                    -0.136933409573551_wp*F%F(nx-3, y, z, 1:3) &
                    +0.491788539658795_wp*F%F(nx-2, y, z, 1:3) &
                    +0.167666797363522_wp*F%F(nx-1, y, z, 1:3) &
                    -0.083677769468176_wp*F%F(nx  , y, z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.005741474176657_wp*X_x(nx-7, y, z, 1)*G%J(nx-7, y, z) *F%F(nx-7, y, z, 4:n) &
                    -0.053587092315462_wp*X_x(nx-6, y, z, 1)*G%J(nx-6, y, z) *F%F(nx-6, y, z, 4:n) &
                    +0.181292965616422_wp*X_x(nx-5, y, z, 1)*G%J(nx-5, y, z) *F%F(nx-5, y, z, 4:n) &
                    -0.728101537236212_wp*X_x(nx-4, y, z, 1)*G%J(nx-4, y, z) *F%F(nx-4, y, z, 4:n) &
                    +0.136933409573551_wp*X_x(nx-3, y, z, 1)*G%J(nx-3, y, z) *F%F(nx-3, y, z, 4:n) &
                    +0.328114765554538_wp*X_x(nx-2, y, z, 1)*G%J(nx-2, y, z) *F%F(nx-2, y, z, 4:n) &
                    +0.220243795689184_wp*X_x(nx-1, y, z, 1)*G%J(nx-1, y, z) *F%F(nx-1, y, z, 4:n) &
                    -0.090637781058677_wp*X_x(nx  , y, z, 1)*G%J(nx  , y, z) *F%F(nx  , y, z, 4:n) &
                     ) 
        
     end if 

     if (x .eq. nx-2) then
        
        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.022332921092875_wp*F%F(nx-5, y, z, 1:3) &
                    +0.136047721252784_wp*F%F(nx-4, y, z, 1:3) &
                    -0.654195007415722_wp*F%F(nx-3, y, z, 1:3) &
                    -0.130372094340790_wp*F%F(nx-2, y, z, 1:3) &
                    +0.790802931381985_wp*F%F(nx-1, y, z, 1:3) &
                    -0.119950629785382_wp*F%F(nx  , y, z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.011447347501192_wp*X_x(nx-6, y, z, 1)*G%J(nx-6, y, z) *F%F(nx-6, y, z, 4:n) &
                    -0.102425925355228_wp*X_x(nx-5, y, z, 1)*G%J(nx-5, y, z) *F%F(nx-5, y, z, 4:n) &
                    +0.360626660648614_wp*X_x(nx-4, y, z, 1)*G%J(nx-4, y, z) *F%F(nx-4, y, z, 4:n) &
                    -0.980527672399361_wp*X_x(nx-3, y, z, 1)*G%J(nx-3, y, z) *F%F(nx-3, y, z, 4:n) &
                    +0.130372094340790_wp*X_x(nx-2, y, z, 1)*G%J(nx-2, y, z) *F%F(nx-2, y, z, 4:n) &
                    +0.681777727691031_wp*X_x(nx-1, y, z, 1)*G%J(nx-1, y, z) *F%F(nx-1, y, z, 4:n) &
                    -0.101270232427039_wp*X_x(nx  , y, z, 1)*G%J(nx  , y, z) *F%F(nx  , y, z, 4:n) &
                     ) 
        
     end if 

     if (x .eq. nx-1) then
        
        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.029841082672069_wp*F%F(nx-5, y, z, 1:3) &
                    +0.016267583768385_wp*F%F(nx-4, y, z, 1:3) &
                    -0.196814495127562_wp*F%F(nx-3, y, z, 1:3) &
                    -0.305572843948314_wp*F%F(nx-2, y, z, 1:3) &
                    -0.012686575154571_wp*F%F(nx-1, y, z, 1:3) &
                    +0.468965247789993_wp*F%F(nx  , y, z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    +0.034163235251410_wp*X_x(nx-5, y, z, 1)*G%J(nx-5, y, z) *F%F(nx-5, y, z, 4:n) &
                    -0.006283775981431_wp*X_x(nx-4, y, z, 1)*G%J(nx-4, y, z) *F%F(nx-4, y, z, 4:n) &
                    -0.149830581921711_wp*X_x(nx-3, y, z, 1)*G%J(nx-3, y, z) *F%F(nx-3, y, z, 4:n) &
                    -0.354437950860383_wp*X_x(nx-2, y, z, 1)*G%J(nx-2, y, z) *F%F(nx-2, y, z, 4:n) &
                    +0.012686575154571_wp*X_x(nx-1, y, z, 1)*G%J(nx-1, y, z) *F%F(nx-1, y, z, 4:n) &
                    +0.463702498357543_wp*X_x(nx  , y, z, 1)*G%J(nx  , y, z) *F%F(nx  , y, z, 4:n) &
                     ) 
        
     end if 

     if (x .eq. nx) then
        
        ! Use forward FD for velocity fields
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.052764835595357_wp*F%F(nx-5, y, z, 1:3) &
                    -0.040746019354332_wp*F%F(nx-4, y, z, 1:3) &
                    +0.357299100037565_wp*F%F(nx-3, y, z, 1:3) &
                    +0.200227171966867_wp*F%F(nx-2, y, z, 1:3) &
                    -2.045543388652316_wp*F%F(nx-1, y, z, 1:3) &
                    +1.581527971597573_wp*F%F(nx  , y, z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jq_xU(4:9) = (&
                    -0.053609043198748_wp*X_x(nx-5, y, z, 1)*G%J(nx-5, y, z) *F%F(nx-5, y, z, 4:n) &
                    -0.031776313568303_wp*X_x(nx-4, y, z, 1)*G%J(nx-4, y, z) *F%F(nx-4, y, z, 4:n) &
                    +0.329862352927359_wp*X_x(nx-3, y, z, 1)*G%J(nx-3, y, z) *F%F(nx-3, y, z, 4:n) &
                    +0.237161254615221_wp*X_x(nx-2, y, z, 1)*G%J(nx-2, y, z) *F%F(nx-2, y, z, 4:n) &
                    -2.068759097745568_wp*X_x(nx-1, y, z, 1)*G%J(nx-1, y, z) *F%F(nx-1, y, z, 4:n) &
                    +1.587120846970038_wp*X_x(nx  , y, z, 1)*G%J(nx  , y, z) *F%F(nx  , y, z, 4:n) &
                     ) 
        
     end if 

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jr_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jr_xU = 0.0_wp*Jr_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! y direction 
    
     ! cycle through interior points
     if ((y .ge. 7) .and. (y .le. ny-6)) then


        ! forward FD q_x*du/dq for velocity fields
        ! non-conservative form 
        ! weights are [-1/105, 1/10, -3/5, -1/4, 1, -3/10, 1/15, -1/140]
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&        
                    -1.0_wp/105.0_wp   *F%F(x ,y-3, z, 1:3)&
                    +1.0_wp/10.0_wp    *F%F(x ,y-2, z, 1:3)&
                    -3.0_wp/5.0_wp     *F%F(x ,y-1, z, 1:3)&
                    -1.0_wp/4.0_wp     *F%F(x ,y  , z, 1:3)&
                    +1.0_wp            *F%F(x ,y+1, z, 1:3)&
                    -3.0_wp/10.0_wp    *F%F(x ,y+2, z, 1:3)&
                    +1.0_wp/15.0_wp    *F%F(x ,y+3, z, 1:3)&
                    -1.0_wp/140.0_wp   *F%F(x ,y+4, z, 1:3)&    
                     )


        ! backward FD d(J*q_x*u)/dq for stress fields 
        ! conservative form 
        ! weights are [1/140, -1/15, 3/10, -1, 1/4, 3/5, -1/10, 1/105]
        Jr_xU(4:9) = (&
                    +1.0_wp/140.0_wp *X_x(x ,y-4, z, 2)*G%J(x ,y-4, z) * F%F(x ,y-4, z, 4:n)&
                    -1.0_wp/15.0_wp  *X_x(x ,y-3, z, 2)*G%J(x ,y-3, z) * F%F(x ,y-3, z, 4:n)&
                    +3.0_wp/10.0_wp  *X_x(x ,y-2, z, 2)*G%J(x ,y-2, z) * F%F(x ,y-2, z, 4:n)&
                    -1.0_wp          *X_x(x ,y-1, z, 2)*G%J(x ,y-1, z) * F%F(x ,y-1, z, 4:n)&
                    +1.0_wp/4.0_wp   *X_x(x ,y  , z, 2)*G%J(x ,y  , z) * F%F(x ,y  , z, 4:n)&
                    +3.0_wp/5.0_wp   *X_x(x ,y+1, z, 2)*G%J(x ,y+1, z) * F%F(x ,y+1, z, 4:n)&
                    -1.0_wp/10.0_wp  *X_x(x ,y+2, z, 2)*G%J(x ,y+2, z) * F%F(x ,y+2, z, 4:n)&
                    +1.0_wp/105.0_wp *X_x(x ,y+3, z, 2)*G%J(x ,y+3, z) * F%F(x ,y+3, z, 4:n)&
                      ) 

      end if

     !=========================================================================================================================
     ! boundary approximations 
     ! y direction 
     ! LHS 
     ! need 6 points 

     if (y .eq. 1) then

        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.053609043198748_wp*F%F(x ,6 , z, 1:3) &
                    +0.031776313568303_wp*F%F(x ,5 , z, 1:3) &
                    -0.329862352927359_wp*F%F(x ,4 , z, 1:3) &
                    -0.237161254615221_wp*F%F(x ,3 , z, 1:3) &
                    +2.068759097745568_wp*F%F(x ,2 , z, 1:3) &
                    -1.587120846970038_wp*F%F(x ,1 , z, 1:3) &
                     ) 
                    
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.052764835595357_wp*X_x(x ,6 , z, 2)*G%J(x,6,z) *F%F(x ,6 , z, 4:n) &
                    +0.040746019354332_wp*X_x(x ,5 , z, 2)*G%J(x,5,z) *F%F(x ,5 , z, 4:n) &
                    -0.357299100037565_wp*X_x(x ,4 , z, 2)*G%J(x,4,z) *F%F(x ,4 , z, 4:n) &
                    -0.200227171966867_wp*X_x(x ,3 , z, 2)*G%J(x,3,z) *F%F(x ,3 , z, 4:n) &
                    +2.045543388652316_wp*X_x(x ,2 , z, 2)*G%J(x,2,z) *F%F(x ,2 , z, 4:n) &
                    -1.581527971597573_wp*X_x(x ,1 , z, 2)*G%J(x,1,z) *F%F(x ,1 , z, 4:n) &                  
                     )  
     
     end if

     if (y .eq. 2) then

        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.034163235251410_wp*F%F(x ,6 , z, 1:3) &
                    +0.006283775981431_wp*F%F(x ,5 , z, 1:3) &
                    +0.149830581921711_wp*F%F(x ,4 , z, 1:3) &
                    +0.354437950860383_wp*F%F(x ,3 , z, 1:3) &
                    -0.012686575154571_wp*F%F(x ,2 , z, 1:3) &
                    -0.463702498357543_wp*F%F(x ,1 , z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    -0.029841082672069_wp*X_x(x ,6 , z, 2)*G%J(x,6,z) *F%F(x ,6 , z, 4:n) &
                    -0.016267583768385_wp*X_x(x ,5 , z, 2)*G%J(x,5,z) *F%F(x ,5 , z, 4:n) &
                    +0.196814495127562_wp*X_x(x ,4 , z, 2)*G%J(x,4,z) *F%F(x ,4 , z, 4:n) &
                    +0.305572843948314_wp*X_x(x ,3 , z, 2)*G%J(x,3,z) *F%F(x ,3 , z, 4:n) &
                    +0.012686575154571_wp*X_x(x ,2 , z, 2)*G%J(x,2,z) *F%F(x ,2 , z, 4:n) &
                    -0.468965247789993_wp*X_x(x ,1 , z, 2)*G%J(x,1,z) *F%F(x ,1 , z, 4:n) &      
                    ) 

     end if

     if (y .eq. 3) then

        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.011447347501192_wp*F%F(x ,7 , z, 1:3) &
                    +0.102425925355228_wp*F%F(x ,6 , z, 1:3) &
                    -0.360626660648614_wp*F%F(x ,5 , z, 1:3) &
                    +0.980527672399361_wp*F%F(x ,4 , z, 1:3) &
                    -0.130372094340790_wp*F%F(x ,3 , z, 1:3) &
                    -0.681777727691031_wp*F%F(x ,2 , z, 1:3) &
                    +0.101270232427039_wp*F%F(x ,1 , z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.022332921092875_wp*X_x(x ,6 , z, 2)*G%J(x,6,z) *F%F(x ,6 , z, 4:n) &
                    -0.136047721252784_wp*X_x(x ,5 , z, 2)*G%J(x,5,z) *F%F(x ,5 , z, 4:n) &
                    +0.654195007415722_wp*X_x(x ,4 , z, 2)*G%J(x,4,z) *F%F(x ,4 , z, 4:n) &
                    +0.130372094340790_wp*X_x(x ,3 , z, 2)*G%J(x,3,z) *F%F(x ,3 , z, 4:n) &
                    -0.790802931381985_wp*X_x(x ,2 , z, 2)*G%J(x,2,z) *F%F(x ,2 , z, 4:n) &
                    +0.119950629785382_wp*X_x(x ,1 , z, 2)*G%J(x,1,z) *F%F(x ,1 , z, 4:n) &
                     ) 
                     
     end if

     if (y .eq. 4) then

        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.005741474176657_wp*F%F(x ,8 , z, 1:3) &
                    +0.053587092315462_wp*F%F(x ,7 , z, 1:3) &
                    -0.181292965616422_wp*F%F(x ,6 , z, 1:3) &
                    +0.728101537236212_wp*F%F(x ,5 , z, 1:3) &
                    -0.136933409573551_wp*F%F(x ,4 , z, 1:3) &
                    -0.328114765554538_wp*F%F(x ,3 , z, 1:3) &
                    -0.220243795689184_wp*F%F(x ,2 , z, 1:3) &
                    +0.090637781058677_wp*F%F(x ,1 , z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.007655298902209_wp*X_x(x ,7 , z, 2)*G%J(x,7,z) *F%F(x ,7 , z, 4:n) &
                    -0.030243581766320_wp*X_x(x ,6 , z, 2)*G%J(x,6,z) *F%F(x ,6 , z, 4:n) &
                    +0.461432440844702_wp*X_x(x ,5 , z, 2)*G%J(x,5,z) *F%F(x ,5 , z, 4:n) &
                    +0.136933409573551_wp*X_x(x ,4 , z, 2)*G%J(x,4,z) *F%F(x ,4 , z, 4:n) &
                    -0.491788539658795_wp*X_x(x ,3 , z, 2)*G%J(x,3,z) *F%F(x ,3 , z, 4:n) &
                    -0.167666797363522_wp*X_x(x ,2 , z, 2)*G%J(x,2,z) *F%F(x ,2 , z, 4:n) &
                    +0.083677769468176_wp*X_x(x ,1 , z, 2)*G%J(x,1,z) *F%F(x ,1 , z, 4:n) &
                     ) 
                     
     end if

     if (y .eq. 5) then

        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.007850120840981_wp*F%F(x ,9 , z, 1:3) &
                    +0.073267794515818_wp*F%F(x ,8 , z, 1:3) &
                    -0.329705075321183_wp*F%F(x ,7 , z, 1:3) &
                    +1.044838434095626_wp*F%F(x ,6 , z, 1:3) &
                    -0.253703695582764_wp*F%F(x ,5 , z, 1:3) &
                    -0.630900759826953_wp*F%F(x ,4 , z, 1:3) &
                    +0.093295940554189_wp*F%F(x ,3 , z, 1:3) &
                    +0.024889867269617_wp*F%F(x ,2 , z, 1:3) &
                    -0.014132384863370_wp*F%F(x ,1 , z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.010466827787974_wp*X_x(x ,8 , z, 2)*G%J(x,8,z) *F%F(x ,8 , z, 4:n) &
                    -0.109901691773728_wp*X_x(x ,7 , z, 2)*G%J(x,7,z) *F%F(x ,7 , z, 4:n) &
                    +0.614572168859249_wp*X_x(x ,6 , z, 2)*G%J(x,6,z) *F%F(x ,6 , z, 4:n) &
                    +0.253703695582764_wp*X_x(x ,5 , z, 2)*G%J(x,5,z) *F%F(x ,5 , z, 4:n) &
                    -0.995508274694755_wp*X_x(x ,4 , z, 2)*G%J(x,4,z) *F%F(x ,4 , z, 4:n) &
                    +0.247302955053649_wp*X_x(x ,3 , z, 2)*G%J(x,3,z) *F%F(x ,3 , z, 4:n) &
                    -0.009614356523787_wp*X_x(x ,2 , z, 2)*G%J(x,2,z) *F%F(x ,2 , z, 4:n) &
                    -0.011021324291367_wp*X_x(x ,1 , z, 2)*G%J(x,1,z) *F%F(x ,1 , z, 4:n) &
                     ) 
                     
     end if

      if (y .eq. 6) then

        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.007042368322384_wp*F%F(x ,10 , z, 1:3) &
                    +0.065728771008917_wp*F%F(x ,9 , z, 1:3) &
                    -0.295779469540127_wp*F%F(x ,8 , z, 1:3) &
                    +0.985931565133756_wp*F%F(x ,7 , z, 1:3) &
                    -0.245402632435032_wp*F%F(x ,6 , z, 1:3) &
                    -0.551334643308827_wp*F%F(x ,5 , z, 1:3) &
                    +0.037096124729170_wp*F%F(x ,4 , z, 1:3) &
                    -0.013739135291768_wp*F%F(x ,3 , z, 1:3) &
                    +0.040959674614960_wp*F%F(x ,2 , z, 1:3) &
                    -0.016417886588667_wp*F%F(x ,1 , z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.009389824429845_wp*X_x(x ,9 , z, 2)*G%J(x,9,z) *F%F(x ,9 , z, 4:n) &
                    -0.098593156513376_wp*X_x(x ,8 , z, 2)*G%J(x,8,z) *F%F(x ,8 , z, 4:n) &
                    +0.591558939080254_wp*X_x(x ,7 , z, 2)*G%J(x,7,z) *F%F(x ,7 , z, 4:n) &
                    +0.245402632435032_wp*X_x(x ,6 , z, 2)*G%J(x,6,z) *F%F(x ,6 , z, 4:n) &
                    -0.937327875498694_wp*X_x(x ,5 , z, 2)*G%J(x,5,z) *F%F(x ,5 , z, 4:n) &
                    +0.222370039269531_wp*X_x(x ,4 , z, 2)*G%J(x,4,z) *F%F(x ,4 , z, 4:n) &
                    -0.063012072625329_wp*X_x(x ,3 , z, 2)*G%J(x,3,z) *F%F(x ,3 , z, 4:n) &
                    +0.046892232935029_wp*X_x(x ,2 , z, 2)*G%J(x,2,z) *F%F(x ,2 , z, 4:n) &
                    -0.016680563512292_wp*X_x(x ,1 , z, 2)*G%J(x,1,z) *F%F(x ,1 , z, 4:n) &
                     ) 
                     
     end if

     !=========================================================================================================================
     ! boundary approximations 
     ! y direction 
     ! RHS 
     ! need 6 points 

     if (y .eq. ny-5) then
        
        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.009389824429845_wp*F%F(x, ny-8, z, 1:3) &
                    +0.098593156513376_wp*F%F(x, ny-7, z, 1:3) &
                    -0.591558939080254_wp*F%F(x, ny-6, z, 1:3) &
                    -0.245402632435032_wp*F%F(x, ny-5, z, 1:3) &
                    +0.937327875498694_wp*F%F(x, ny-4, z, 1:3) &
                    -0.222370039269531_wp*F%F(x, ny-3, z, 1:3) &
                    +0.063012072625329_wp*F%F(x, ny-2, z, 1:3) &
                    -0.046892232935029_wp*F%F(x, ny-1, z, 1:3) &
                    +0.016680563512292_wp*F%F(x, ny  , z, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.007042368322384_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9, z) *F%F(x, ny-9, z, 4:n) &
                    -0.065728771008917_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8, z) *F%F(x, ny-8, z, 4:n) &
                    +0.295779469540127_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7, z) *F%F(x, ny-7, z, 4:n) &
                    -0.985931565133756_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6, z) *F%F(x, ny-6, z, 4:n) &
                    +0.245402632435032_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5, z) *F%F(x, ny-5, z, 4:n) &
                    +0.551334643308827_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4, z) *F%F(x, ny-4, z, 4:n) &
                    -0.037096124729170_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3, z) *F%F(x, ny-3, z, 4:n) &
                    +0.013739135291768_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2, z) *F%F(x, ny-2, z, 4:n) &
                    -0.040959674614960_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1, z) *F%F(x, ny-1, z, 4:n) &
                    +0.016417886588667_wp*X_x(x, ny  , z, 2)*G%J(x, ny  , z) *F%F(x, ny  , z, 4:n) &
                     ) 

     end if 


     if (y .eq. ny-4) then
        
        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.010466827787974_wp*F%F(x, ny-7, z, 1:3) &
                    +0.109901691773728_wp*F%F(x, ny-6, z, 1:3) &
                    -0.614572168859249_wp*F%F(x, ny-5, z, 1:3) &
                    -0.253703695582764_wp*F%F(x, ny-4, z, 1:3) &
                    +0.995508274694755_wp*F%F(x, ny-3, z, 1:3) &
                    -0.247302955053649_wp*F%F(x, ny-2, z, 1:3) &
                    +0.009614356523787_wp*F%F(x, ny-1, z, 1:3) &
                    +0.011021324291367_wp*F%F(x, ny  , z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.007850120840981_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8, z) *F%F(x, ny-8, z, 4:n) &
                    -0.073267794515818_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7, z) *F%F(x, ny-7, z, 4:n) &
                    +0.329705075321183_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6, z) *F%F(x, ny-6, z, 4:n) &
                    -1.044838434095626_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5, z) *F%F(x, ny-5, z, 4:n) &
                    +0.253703695582764_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4, z) *F%F(x, ny-4, z, 4:n) &
                    +0.630900759826953_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3, z) *F%F(x, ny-3, z, 4:n) &
                    -0.093295940554189_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2, z) *F%F(x, ny-2, z, 4:n) &
                    -0.024889867269617_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1, z) *F%F(x, ny-1, z, 4:n) &
                    +0.014132384863370_wp*X_x(x, ny  , z, 2)*G%J(x, ny  , z) *F%F(x, ny  , z, 4:n) &
                     ) 
        
     end if 

     if (y .eq. ny-3) then
        
        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.007655298902209_wp*F%F(x, ny-6, z, 1:3) &
                    +0.030243581766320_wp*F%F(x, ny-5, z, 1:3) &
                    -0.461432440844702_wp*F%F(x, ny-4, z, 1:3) &
                    -0.136933409573551_wp*F%F(x, ny-3, z, 1:3) &
                    +0.491788539658795_wp*F%F(x, ny-2, z, 1:3) &
                    +0.167666797363522_wp*F%F(x, ny-1, z, 1:3) &
                    -0.083677769468176_wp*F%F(x, ny  , z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.005741474176657_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7, z) *F%F(x, ny-7, z, 4:n) &
                    -0.053587092315462_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6, z) *F%F(x, ny-6, z, 4:n) &
                    +0.181292965616422_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5, z) *F%F(x, ny-5, z, 4:n) &
                    -0.728101537236212_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4, z) *F%F(x, ny-4, z, 4:n) &
                    +0.136933409573551_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3, z) *F%F(x, ny-3, z, 4:n) &
                    +0.328114765554538_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2, z) *F%F(x, ny-2, z, 4:n) &
                    +0.220243795689184_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1, z) *F%F(x, ny-1, z, 4:n) &
                    -0.090637781058677_wp*X_x(x, ny  , z, 2)*G%J(x, ny  , z) *F%F(x, ny  , z, 4:n) &
                     ) 
        
     end if 

     if (y .eq. ny-2) then
        
        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.022332921092875_wp*F%F(x, ny-5, z, 1:3) &
                    +0.136047721252784_wp*F%F(x, ny-4, z, 1:3) &
                    -0.654195007415722_wp*F%F(x, ny-3, z, 1:3) &
                    -0.130372094340790_wp*F%F(x, ny-2, z, 1:3) &
                    +0.790802931381985_wp*F%F(x, ny-1, z, 1:3) &
                    -0.119950629785382_wp*F%F(x, ny  , z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.011447347501192_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6, z) *F%F(x, ny-6, z, 4:n) &
                    -0.102425925355228_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5, z) *F%F(x, ny-5, z, 4:n) &
                    +0.360626660648614_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4, z) *F%F(x, ny-4, z, 4:n) &
                    -0.980527672399361_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3, z) *F%F(x, ny-3, z, 4:n) &
                    +0.130372094340790_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2, z) *F%F(x, ny-2, z, 4:n) &
                    +0.681777727691031_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1, z) *F%F(x, ny-1, z, 4:n) &
                    -0.101270232427039_wp*X_x(x, ny  , z, 2)*G%J(x, ny  , z) *F%F(x, ny  , z, 4:n) &
                     ) 
        
     end if 

     if (y .eq. ny-1) then
        
        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.029841082672069_wp*F%F(x, ny-5, z, 1:3) &
                    +0.016267583768385_wp*F%F(x, ny-4, z, 1:3) &
                    -0.196814495127562_wp*F%F(x, ny-3, z, 1:3) &
                    -0.305572843948314_wp*F%F(x, ny-2, z, 1:3) &
                    -0.012686575154571_wp*F%F(x, ny-1, z, 1:3) &
                    +0.468965247789993_wp*F%F(x, ny  , z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    +0.034163235251410_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5, z) *F%F(x, ny-5, z, 4:n) &
                    -0.006283775981431_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4, z) *F%F(x, ny-4, z, 4:n) &
                    -0.149830581921711_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3, z) *F%F(x, ny-3, z, 4:n) &
                    -0.354437950860383_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2, z) *F%F(x, ny-2, z, 4:n) &
                    +0.012686575154571_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1, z) *F%F(x, ny-1, z, 4:n) &
                    +0.463702498357543_wp*X_x(x, ny  , z, 2)*G%J(x, ny  , z) *F%F(x, ny  , z, 4:n) &
                     ) 
        
     end if 

     if (y .eq. ny) then
        
        ! Use forward FD for velocity fields
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.052764835595357_wp*F%F(x, ny-5, z, 1:3) &
                    -0.040746019354332_wp*F%F(x, ny-4, z, 1:3) &
                    +0.357299100037565_wp*F%F(x, ny-3, z, 1:3) &
                    +0.200227171966867_wp*F%F(x, ny-2, z, 1:3) &
                    -2.045543388652316_wp*F%F(x, ny-1, z, 1:3) &
                    +1.581527971597573_wp*F%F(x, ny  , z, 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Jr_xU(4:9) = (&
                    -0.053609043198748_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5, z) *F%F(x, ny-5, z, 4:n) &
                    -0.031776313568303_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4, z) *F%F(x, ny-4, z, 4:n) &
                    +0.329862352927359_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3, z) *F%F(x, ny-3, z, 4:n) &
                    +0.237161254615221_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2, z) *F%F(x, ny-2, z, 4:n) &
                    -2.068759097745568_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1, z) *F%F(x, ny-1, z, 4:n) &
                    +1.587120846970038_wp*X_x(x, ny  , z, 2)*G%J(x, ny  , z) *F%F(x, ny  , z, 4:n) &
                     ) 
        
     end if 


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Js_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Js_xU = 0.0_wp*Js_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! z direction 
    
     ! cycle through interior points
     if ((z .ge. 7) .and. (z .le. nz-6)) then


        ! forward FD q_x*du/dq for velocity fields
        ! non-conservative form 
        ! weights are [-1/105, 1/10, -3/5, -1/4, 1, -3/10, 1/15, -1/140]
        Js_xU(1:3) = X_x(x, y, z, 3)*(&        
                    -1.0_wp/105.0_wp   *F%F(x , y, z-3, 1:3)&
                    +1.0_wp/10.0_wp    *F%F(x , y, z-2, 1:3)&
                    -3.0_wp/5.0_wp     *F%F(x , y, z-1, 1:3)&
                    -1.0_wp/4.0_wp     *F%F(x , y, z  , 1:3)&
                    +1.0_wp            *F%F(x , y, z+1, 1:3)&
                    -3.0_wp/10.0_wp    *F%F(x , y, z+2, 1:3)&
                    +1.0_wp/15.0_wp    *F%F(x , y, z+3, 1:3)&
                    -1.0_wp/140.0_wp   *F%F(x , y, z+4, 1:3)&    
                     )


        ! backward FD d(J*q_x*u)/dq for stress fields 
        ! conservative form 
        ! weights are [1/140, -1/15, 3/10, -1, 1/4, 3/5, -1/10, 1/105]
        Js_xU(4:9) = (&
                    +1.0_wp/140.0_wp *X_x(x , y, z-4, 3)*G%J(x , y, z-4) * F%F(x , y, z-4, 4:n)&
                    -1.0_wp/15.0_wp  *X_x(x , y, z-3, 3)*G%J(x , y, z-3) * F%F(x , y, z-3, 4:n)&
                    +3.0_wp/10.0_wp  *X_x(x , y, z-2, 3)*G%J(x , y, z-2) * F%F(x , y, z-2, 4:n)&
                    -1.0_wp          *X_x(x , y, z-1, 3)*G%J(x , y, z-1) * F%F(x , y, z-1, 4:n)&
                    +1.0_wp/4.0_wp   *X_x(x , y, z  , 3)*G%J(x , y, z  ) * F%F(x , y, z  , 4:n)&
                    +3.0_wp/5.0_wp   *X_x(x , y, z+1, 3)*G%J(x , y, z+1) * F%F(x , y, z+1, 4:n)&
                    -1.0_wp/10.0_wp  *X_x(x , y, z+2, 3)*G%J(x , y, z+2) * F%F(x , y, z+2, 4:n)&
                    +1.0_wp/105.0_wp *X_x(x , y, z+3, 3)*G%J(x , y, z+3) * F%F(x , y, z+3, 4:n)&
                      ) 

      end if

     !=========================================================================================================================
     ! boundary approximations 
     ! z direction 
     ! LHS 
     ! need 6 points 

     if (z .eq. 1) then

        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.053609043198748_wp*F%F(x ,y , 6, 1:3) &
                    +0.031776313568303_wp*F%F(x ,y , 5, 1:3) &
                    -0.329862352927359_wp*F%F(x ,y , 4, 1:3) &
                    -0.237161254615221_wp*F%F(x ,y , 3, 1:3) &
                    +2.068759097745568_wp*F%F(x ,y , 2, 1:3) &
                    -1.587120846970038_wp*F%F(x ,y , 1, 1:3) &
                     ) 
                    
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.052764835595357_wp*X_x(x ,y , 6, 3)*G%J(x,y,6) *F%F(x ,y , 6, 4:n) &
                    +0.040746019354332_wp*X_x(x ,y , 5, 3)*G%J(x,y,5) *F%F(x ,y , 5, 4:n) &
                    -0.357299100037565_wp*X_x(x ,y , 4, 3)*G%J(x,y,4) *F%F(x ,y , 4, 4:n) &
                    -0.200227171966867_wp*X_x(x ,y , 3, 3)*G%J(x,y,3) *F%F(x ,y , 3, 4:n) &
                    +2.045543388652316_wp*X_x(x ,y , 2, 3)*G%J(x,y,2) *F%F(x ,y , 2, 4:n) &
                    -1.581527971597573_wp*X_x(x ,y , 1, 3)*G%J(x,y,1) *F%F(x ,y , 1, 4:n) &                  
                     )  
     
     end if

     if (z .eq. 2) then

        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.034163235251410_wp*F%F(x ,y , 6, 1:3) &
                    +0.006283775981431_wp*F%F(x ,y , 5, 1:3) &
                    +0.149830581921711_wp*F%F(x ,y , 4, 1:3) &
                    +0.354437950860383_wp*F%F(x ,y , 3, 1:3) &
                    -0.012686575154571_wp*F%F(x ,y , 2, 1:3) &
                    -0.463702498357543_wp*F%F(x ,y , 1, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    -0.029841082672069_wp*X_x(x ,y , 6, 3)*G%J(x,y,6) *F%F(x ,y , 6, 4:n) &
                    -0.016267583768385_wp*X_x(x ,y , 5, 3)*G%J(x,y,5) *F%F(x ,y , 5, 4:n) &
                    +0.196814495127562_wp*X_x(x ,y , 4, 3)*G%J(x,y,4) *F%F(x ,y , 4, 4:n) &
                    +0.305572843948314_wp*X_x(x ,y , 3, 3)*G%J(x,y,3) *F%F(x ,y , 3, 4:n) &
                    +0.012686575154571_wp*X_x(x ,y , 2, 3)*G%J(x,y,2) *F%F(x ,y , 2, 4:n) &
                    -0.468965247789993_wp*X_x(x ,y , 1, 3)*G%J(x,y,1) *F%F(x ,y , 1, 4:n) &      
                    ) 

     end if

     if (z .eq. 3) then

        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.011447347501192_wp*F%F(x ,y , 7, 1:3) &
                    +0.102425925355228_wp*F%F(x ,y , 6, 1:3) &
                    -0.360626660648614_wp*F%F(x ,y , 5, 1:3) &
                    +0.980527672399361_wp*F%F(x ,y , 4, 1:3) &
                    -0.130372094340790_wp*F%F(x ,y , 3, 1:3) &
                    -0.681777727691031_wp*F%F(x ,y , 2, 1:3) &
                    +0.101270232427039_wp*F%F(x ,y , 1, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.022332921092875_wp*X_x(x ,y , 6, 3)*G%J(x,y,6) *F%F(x ,y , 6, 4:n) &
                    -0.136047721252784_wp*X_x(x ,y , 5, 3)*G%J(x,y,5) *F%F(x ,y , 5, 4:n) &
                    +0.654195007415722_wp*X_x(x ,y , 4, 3)*G%J(x,y,4) *F%F(x ,y , 4, 4:n) &
                    +0.130372094340790_wp*X_x(x ,y , 3, 3)*G%J(x,y,3) *F%F(x ,y , 3, 4:n) &
                    -0.790802931381985_wp*X_x(x ,y , 2, 3)*G%J(x,y,2) *F%F(x ,y , 2, 4:n) &
                    +0.119950629785382_wp*X_x(x ,y , 1, 3)*G%J(x,y,1) *F%F(x ,y , 1, 4:n) &
                     ) 
                     
     end if

     if (z .eq. 4) then

        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.005741474176657_wp*F%F(x ,y , 8, 1:3) &
                    +0.053587092315462_wp*F%F(x ,y , 7, 1:3) &
                    -0.181292965616422_wp*F%F(x ,y , 6, 1:3) &
                    +0.728101537236212_wp*F%F(x ,y , 5, 1:3) &
                    -0.136933409573551_wp*F%F(x ,y , 4, 1:3) &
                    -0.328114765554538_wp*F%F(x ,y , 3, 1:3) &
                    -0.220243795689184_wp*F%F(x ,y , 2, 1:3) &
                    +0.090637781058677_wp*F%F(x ,y , 1, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.007655298902209_wp*X_x(x ,y , 7, 3)*G%J(x,y,7) *F%F(x ,y , 7, 4:n) &
                    -0.030243581766320_wp*X_x(x ,y , 6, 3)*G%J(x,y,6) *F%F(x ,y , 6, 4:n) &
                    +0.461432440844702_wp*X_x(x ,y , 5, 3)*G%J(x,y,5) *F%F(x ,y , 5, 4:n) &
                    +0.136933409573551_wp*X_x(x ,y , 4, 3)*G%J(x,y,4) *F%F(x ,y , 4, 4:n) &
                    -0.491788539658795_wp*X_x(x ,y , 3, 3)*G%J(x,y,3) *F%F(x ,y , 3, 4:n) &
                    -0.167666797363522_wp*X_x(x ,y , 2, 3)*G%J(x,y,2) *F%F(x ,y , 2, 4:n) &
                    +0.083677769468176_wp*X_x(x ,y , 1, 3)*G%J(x,y,1) *F%F(x ,y , 1, 4:n) &
                     ) 
                     
     end if

     if (z .eq. 5) then

        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.007850120840981_wp*F%F(x ,y , 9, 1:3) &
                    +0.073267794515818_wp*F%F(x ,y , 8, 1:3) &
                    -0.329705075321183_wp*F%F(x ,y , 7, 1:3) &
                    +1.044838434095626_wp*F%F(x ,y , 6, 1:3) &
                    -0.253703695582764_wp*F%F(x ,y , 5, 1:3) &
                    -0.630900759826953_wp*F%F(x ,y , 4, 1:3) &
                    +0.093295940554189_wp*F%F(x ,y , 3, 1:3) &
                    +0.024889867269617_wp*F%F(x ,y , 2, 1:3) &
                    -0.014132384863370_wp*F%F(x ,y , 1, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.010466827787974_wp*X_x(x ,y , 8, 3)*G%J(x,y,8) *F%F(x ,y , 8, 4:n) &
                    -0.109901691773728_wp*X_x(x ,y , 7, 3)*G%J(x,y,7) *F%F(x ,y , 7, 4:n) &
                    +0.614572168859249_wp*X_x(x ,y , 6, 3)*G%J(x,y,6) *F%F(x ,y , 6, 4:n) &
                    +0.253703695582764_wp*X_x(x ,y , 5, 3)*G%J(x,y,5) *F%F(x ,y , 5, 4:n) &
                    -0.995508274694755_wp*X_x(x ,y , 4, 3)*G%J(x,y,4) *F%F(x ,y , 4, 4:n) &
                    +0.247302955053649_wp*X_x(x ,y , 3, 3)*G%J(x,y,3) *F%F(x ,y , 3, 4:n) &
                    -0.009614356523787_wp*X_x(x ,y , 2, 3)*G%J(x,y,2) *F%F(x ,y , 2, 4:n) &
                    -0.011021324291367_wp*X_x(x ,y , 1, 3)*G%J(x,y,1) *F%F(x ,y , 1, 4:n) &
                     ) 
                     
     end if

      if (z .eq. 6) then

        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.007042368322384_wp*F%F(x ,y , 10, 1:3) &
                    +0.065728771008917_wp*F%F(x ,y , 9, 1:3) &
                    -0.295779469540127_wp*F%F(x ,y , 8, 1:3) &
                    +0.985931565133756_wp*F%F(x ,y , 7, 1:3) &
                    -0.245402632435032_wp*F%F(x ,y , 6, 1:3) &
                    -0.551334643308827_wp*F%F(x ,y , 5, 1:3) &
                    +0.037096124729170_wp*F%F(x ,y , 4, 1:3) &
                    -0.013739135291768_wp*F%F(x ,y , 3, 1:3) &
                    +0.040959674614960_wp*F%F(x ,y , 2, 1:3) &
                    -0.016417886588667_wp*F%F(x ,y , 1, 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.009389824429845_wp*X_x(x ,y , 9, 3)*G%J(x,y,9) *F%F(x ,y , 9, 4:n) &
                    -0.098593156513376_wp*X_x(x ,y , 8, 3)*G%J(x,y,8) *F%F(x ,y , 8, 4:n) &
                    +0.591558939080254_wp*X_x(x ,y , 7, 3)*G%J(x,y,7) *F%F(x ,y , 7, 4:n) &
                    +0.245402632435032_wp*X_x(x ,y , 6, 3)*G%J(x,y,6) *F%F(x ,y , 6, 4:n) &
                    -0.937327875498694_wp*X_x(x ,y , 5, 3)*G%J(x,y,5) *F%F(x ,y , 5, 4:n) &
                    +0.222370039269531_wp*X_x(x ,y , 4, 3)*G%J(x,y,4) *F%F(x ,y , 4, 4:n) &
                    -0.063012072625329_wp*X_x(x ,y , 3, 3)*G%J(x,y,3) *F%F(x ,y , 3, 4:n) &
                    +0.046892232935029_wp*X_x(x ,y , 2, 3)*G%J(x,y,2) *F%F(x ,y , 2, 4:n) &
                    -0.016680563512292_wp*X_x(x ,y , 1, 3)*G%J(x,y,1) *F%F(x ,y , 1, 4:n) &
                     ) 
                     
     end if

     !=========================================================================================================================
     ! boundary approximations 
     ! z direction 
     ! RHS 
     ! need 6 points 

     if (z .eq. nz-5) then
        
        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.009389824429845_wp*F%F(x , y, nz-8 , 1:3) &
                    +0.098593156513376_wp*F%F(x , y, nz-7 , 1:3) &
                    -0.591558939080254_wp*F%F(x , y, nz-6 , 1:3) &
                    -0.245402632435032_wp*F%F(x , y, nz-5 , 1:3) &
                    +0.937327875498694_wp*F%F(x , y, nz-4 , 1:3) &
                    -0.222370039269531_wp*F%F(x , y, nz-3 , 1:3) &
                    +0.063012072625329_wp*F%F(x , y, nz-2 , 1:3) &
                    -0.046892232935029_wp*F%F(x , y, nz-1 , 1:3) &
                    +0.016680563512292_wp*F%F(x , y, nz   , 1:3) &
                     ) 
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.007042368322384_wp*X_x(x , y, nz-9 , 3)*G%J(x , y, nz-9 ) *F%F(x , y, nz-9 , 4:n) &
                    -0.065728771008917_wp*X_x(x , y, nz-8 , 3)*G%J(x , y, nz-8 ) *F%F(x , y, nz-8 , 4:n) &
                    +0.295779469540127_wp*X_x(x , y, nz-7 , 3)*G%J(x , y, nz-7 ) *F%F(x , y, nz-7 , 4:n) &
                    -0.985931565133756_wp*X_x(x , y, nz-6 , 3)*G%J(x , y, nz-6 ) *F%F(x , y, nz-6 , 4:n) &
                    +0.245402632435032_wp*X_x(x , y, nz-5 , 3)*G%J(x , y, nz-5 ) *F%F(x , y, nz-5 , 4:n) &
                    +0.551334643308827_wp*X_x(x , y, nz-4 , 3)*G%J(x , y, nz-4 ) *F%F(x , y, nz-4 , 4:n) &
                    -0.037096124729170_wp*X_x(x , y, nz-3 , 3)*G%J(x , y, nz-3 ) *F%F(x , y, nz-3 , 4:n) &
                    +0.013739135291768_wp*X_x(x , y, nz-2 , 3)*G%J(x , y, nz-2 ) *F%F(x , y, nz-2 , 4:n) &
                    -0.040959674614960_wp*X_x(x , y, nz-1 , 3)*G%J(x , y, nz-1 ) *F%F(x , y, nz-1 , 4:n) &
                    +0.016417886588667_wp*X_x(x , y, nz   , 3)*G%J(x , y, nz   ) *F%F(x , y, nz   , 4:n) &
                     ) 

     end if 


     if (z .eq. nz-4) then
        
        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.010466827787974_wp*F%F(x , y, nz-7 , 1:3) &
                    +0.109901691773728_wp*F%F(x , y, nz-6 , 1:3) &
                    -0.614572168859249_wp*F%F(x , y, nz-5 , 1:3) &
                    -0.253703695582764_wp*F%F(x , y, nz-4 , 1:3) &
                    +0.995508274694755_wp*F%F(x , y, nz-3 , 1:3) &
                    -0.247302955053649_wp*F%F(x , y, nz-2 , 1:3) &
                    +0.009614356523787_wp*F%F(x , y, nz-1 , 1:3) &
                    +0.011021324291367_wp*F%F(x , y, nz   , 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.007850120840981_wp*X_x(x , y, nz-8 , 3)*G%J(x , y, nz-8 ) *F%F(x , y, nz-8 , 4:n) &
                    -0.073267794515818_wp*X_x(x , y, nz-7 , 3)*G%J(x , y, nz-7 ) *F%F(x , y, nz-7 , 4:n) &
                    +0.329705075321183_wp*X_x(x , y, nz-6 , 3)*G%J(x , y, nz-6 ) *F%F(x , y, nz-6 , 4:n) &
                    -1.044838434095626_wp*X_x(x , y, nz-5 , 3)*G%J(x , y, nz-5 ) *F%F(x , y, nz-5 , 4:n) &
                    +0.253703695582764_wp*X_x(x , y, nz-4 , 3)*G%J(x , y, nz-4 ) *F%F(x , y, nz-4 , 4:n) &
                    +0.630900759826953_wp*X_x(x , y, nz-3 , 3)*G%J(x , y, nz-3 ) *F%F(x , y, nz-3 , 4:n) &
                    -0.093295940554189_wp*X_x(x , y, nz-2 , 3)*G%J(x , y, nz-2 ) *F%F(x , y, nz-2 , 4:n) &
                    -0.024889867269617_wp*X_x(x , y, nz-1 , 3)*G%J(x , y, nz-1 ) *F%F(x , y, nz-1 , 4:n) &
                    +0.014132384863370_wp*X_x(x , y, nz   , 3)*G%J(x , y, nz   ) *F%F(x , y, nz   , 4:n) &
                     ) 
        
     end if 

     if (z .eq. nz-3) then
        
        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.007655298902209_wp*F%F(x , y, nz-6 , 1:3) &
                    +0.030243581766320_wp*F%F(x , y, nz-5 , 1:3) &
                    -0.461432440844702_wp*F%F(x , y, nz-4 , 1:3) &
                    -0.136933409573551_wp*F%F(x , y, nz-3 , 1:3) &
                    +0.491788539658795_wp*F%F(x , y, nz-2 , 1:3) &
                    +0.167666797363522_wp*F%F(x , y, nz-1 , 1:3) &
                    -0.083677769468176_wp*F%F(x , y, nz   , 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.005741474176657_wp*X_x(x , y, nz-7 , 3)*G%J(x , y, nz-7 ) *F%F(x , y, nz-7 , 4:n) &
                    -0.053587092315462_wp*X_x(x , y, nz-6 , 3)*G%J(x , y, nz-6 ) *F%F(x , y, nz-6 , 4:n) &
                    +0.181292965616422_wp*X_x(x , y, nz-5 , 3)*G%J(x , y, nz-5 ) *F%F(x , y, nz-5 , 4:n) &
                    -0.728101537236212_wp*X_x(x , y, nz-4 , 3)*G%J(x , y, nz-4 ) *F%F(x , y, nz-4 , 4:n) &
                    +0.136933409573551_wp*X_x(x , y, nz-3 , 3)*G%J(x , y, nz-3 ) *F%F(x , y, nz-3 , 4:n) &
                    +0.328114765554538_wp*X_x(x , y, nz-2 , 3)*G%J(x , y, nz-2 ) *F%F(x , y, nz-2 , 4:n) &
                    +0.220243795689184_wp*X_x(x , y, nz-1 , 3)*G%J(x , y, nz-1 ) *F%F(x , y, nz-1 , 4:n) &
                    -0.090637781058677_wp*X_x(x , y, nz   , 3)*G%J(x , y, nz   ) *F%F(x , y, nz   , 4:n) &
                     ) 
        
     end if 

     if (z .eq. nz-2) then
        
        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.022332921092875_wp*F%F(x , y, nz-5 , 1:3) &
                    +0.136047721252784_wp*F%F(x , y, nz-4 , 1:3) &
                    -0.654195007415722_wp*F%F(x , y, nz-3 , 1:3) &
                    -0.130372094340790_wp*F%F(x , y, nz-2 , 1:3) &
                    +0.790802931381985_wp*F%F(x , y, nz-1 , 1:3) &
                    -0.119950629785382_wp*F%F(x , y, nz   , 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.011447347501192_wp*X_x(x , y, nz-6 , 3)*G%J(x , y, nz-6 ) *F%F(x , y, nz-6 , 4:n) &
                    -0.102425925355228_wp*X_x(x , y, nz-5 , 3)*G%J(x , y, nz-5 ) *F%F(x , y, nz-5 , 4:n) &
                    +0.360626660648614_wp*X_x(x , y, nz-4 , 3)*G%J(x , y, nz-4 ) *F%F(x , y, nz-4 , 4:n) &
                    -0.980527672399361_wp*X_x(x , y, nz-3 , 3)*G%J(x , y, nz-3 ) *F%F(x , y, nz-3 , 4:n) &
                    +0.130372094340790_wp*X_x(x , y, nz-2 , 3)*G%J(x , y, nz-2 ) *F%F(x , y, nz-2 , 4:n) &
                    +0.681777727691031_wp*X_x(x , y, nz-1 , 3)*G%J(x , y, nz-1 ) *F%F(x , y, nz-1 , 4:n) &
                    -0.101270232427039_wp*X_x(x , y, nz   , 3)*G%J(x , y, nz   ) *F%F(x , y, nz   , 4:n) &
                     ) 
        
     end if 

     if (z .eq. nz-1) then
        
        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.029841082672069_wp*F%F(x , y, nz-5 , 1:3) &
                    +0.016267583768385_wp*F%F(x , y, nz-4 , 1:3) &
                    -0.196814495127562_wp*F%F(x , y, nz-3 , 1:3) &
                    -0.305572843948314_wp*F%F(x , y, nz-2 , 1:3) &
                    -0.012686575154571_wp*F%F(x , y, nz-1 , 1:3) &
                    +0.468965247789993_wp*F%F(x , y, nz   , 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    +0.034163235251410_wp*X_x(x , y, nz-5 , 3)*G%J(x , y, nz-5 ) *F%F(x , y, nz-5 , 4:n) &
                    -0.006283775981431_wp*X_x(x , y, nz-4 , 3)*G%J(x , y, nz-4 ) *F%F(x , y, nz-4 , 4:n) &
                    -0.149830581921711_wp*X_x(x , y, nz-3 , 3)*G%J(x , y, nz-3 ) *F%F(x , y, nz-3 , 4:n) &
                    -0.354437950860383_wp*X_x(x , y, nz-2 , 3)*G%J(x , y, nz-2 ) *F%F(x , y, nz-2 , 4:n) &
                    +0.012686575154571_wp*X_x(x , y, nz-1 , 3)*G%J(x , y, nz-1 ) *F%F(x , y, nz-1 , 4:n) &
                    +0.463702498357543_wp*X_x(x , y, nz   , 3)*G%J(x , y, nz   ) *F%F(x , y, nz   , 4:n) &
                     ) 
        
     end if 

     if (z .eq. nz) then
        
        ! Use forward FD for velocity fields
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.052764835595357_wp*F%F(x , y, nz-5 , 1:3) &
                    -0.040746019354332_wp*F%F(x , y, nz-4 , 1:3) &
                    +0.357299100037565_wp*F%F(x , y, nz-3 , 1:3) &
                    +0.200227171966867_wp*F%F(x , y, nz-2 , 1:3) &
                    -2.045543388652316_wp*F%F(x , y, nz-1 , 1:3) &
                    +1.581527971597573_wp*F%F(x , y, nz   , 1:3) &
                    )
        
        ! Use backward FD for stress fields
        Js_xU(4:9) = (&
                    -0.053609043198748_wp*X_x(x , y, nz-5 , 3)*G%J(x , y, nz-5 ) *F%F(x , y, nz-5 , 4:n) &
                    -0.031776313568303_wp*X_x(x , y, nz-4 , 3)*G%J(x , y, nz-4 ) *F%F(x , y, nz-4 , 4:n) &
                    +0.329862352927359_wp*X_x(x , y, nz-3 , 3)*G%J(x , y, nz-3 ) *F%F(x , y, nz-3 , 4:n) &
                    +0.237161254615221_wp*X_x(x , y, nz-2 , 3)*G%J(x , y, nz-2 ) *F%F(x , y, nz-2 , 4:n) &
                    -2.068759097745568_wp*X_x(x , y, nz-1 , 3)*G%J(x , y, nz-1 ) *F%F(x , y, nz-1 , 4:n) &
                    +1.587120846970038_wp*X_x(x , y, nz   , 3)*G%J(x , y, nz   ) *F%F(x , y, nz   , 4:n) &
                     ) 
        
     end if 


     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

end subroutine JJU_x7_upwind



subroutine JJU_x8_upwind(x, y, z, F, G, X_x, Ju_x)

    !=========================================================================================================================

     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     !input data 
     integer,               intent(in)  :: x, y, z      ! indices in the tranformed co-ordinate
     type(block_fields),    intent(in)  :: F            
     type(block_grid_t),    intent(in)  :: G

     !output data 
     real(kind = wp),       dimension(:), intent(out) :: Ju_x      ! metric coefficients
 
     !input grid and output derivatives 
     real(kind = wp),       dimension(:,:,:,:), allocatable, intent(in) :: X_x                  ! the grid
     real(kind = wp),       dimension(:),       allocatable, save       :: Jq_xU, Jr_xU, Js_xU  ! work array

     !working parameters 
     real(kind = wp)        :: hx, hy, hz       ! spatial steps discertizing the unit cube
     integer                :: n, nx, ny, nz    ! number of points
 
     !get values from input data
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n  = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jq_xU = 0.0_wp*Jq_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! x direction 

     if ((x .ge. 9) .and. (x .le. nx-8 )) then 
     !forward operator for stress
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
              -0.005952380952381_wp*F%F(x-3, y, z, 1:3) &
              +0.071428571428571_wp*F%F(x-2, y, z, 1:3) &
              -0.500000000000000_wp*F%F(x-1, y, z, 1:3) &
              -0.450000000000000_wp*F%F(x  , y, z, 1:3) &
              +1.250000000000000_wp*F%F(x+1, y, z, 1:3) &
              -0.500000000000000_wp*F%F(x+2, y, z, 1:3) &
              +0.166666666666667_wp*F%F(x+3, y, z, 1:3) &
              -0.035714285714286_wp*F%F(x+4, y, z, 1:3) &
              +0.003571428571429_wp*F%F(x+5, y, z, 1:3) &
               )
     !backward operator for stress
     Jq_xU(4:9) = (&
              -0.003571428571429_wp*X_x(x-5, y, z, 1)*G%J(x-5,y,z) *F%F(x-5, y, z, 4:n) &
              +0.035714285714286_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
              -0.166666666666667_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
              +0.500000000000000_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
              -1.250000000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
              +0.450000000000000_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.500000000000000_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
              -0.071428571428571_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
              +0.005952380952381_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
               )
     end if





     if  ( x .eq. 1 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.049639573693422_wp*F%F(8, y, z, 1:3) &
               +0.019433767820507_wp*F%F(7, y, z, 1:3) &
               +0.260826325112378_wp*F%F(6, y, z, 1:3) &
               -0.108253063599706_wp*F%F(5, y, z, 1:3) &
               -0.493207940531973_wp*F%F(4, y, z, 1:3) &
               -0.228196517675356_wp*F%F(3, y, z, 1:3) &
               +2.295771894714481_wp*F%F(2, y, z, 1:3) &
               -1.696734892146909_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.049461966901710_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.018810529442315_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.259482649002711_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.098402345088438_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.512925523626483_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.209092485315854_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +2.286528268509431_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.694939126021973_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 2 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.030428699543875_wp*F%F(8, y, z, 1:3) &
               -0.021545282287796_wp*F%F(7, y, z, 1:3) &
               -0.156944675821618_wp*F%F(6, y, z, 1:3) &
               +0.126231462722744_wp*F%F(5, y, z, 1:3) &
               +0.263755402378838_wp*F%F(4, y, z, 1:3) &
               +0.204968318638770_wp*F%F(3, y, z, 1:3) &
               -0.005134519277289_wp*F%F(2, y, z, 1:3) &
               -0.441759405897525_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.030306625605372_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.022274564890085_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -0.149681276480670_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.105126292899953_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.294400328153917_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.180533358583704_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.005134519277289_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.443545283149479_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 3 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.112837585333185_wp*F%F(8, y, z, 1:3) &
               +0.186503815809607_wp*F%F(7, y, z, 1:3) &
               +0.602920868695480_wp*F%F(6, y, z, 1:3) &
               -1.946179427293353_wp*F%F(5, y, z, 1:3) &
               +2.308081526021288_wp*F%F(4, y, z, 1:3) &
               -0.204344646405764_wp*F%F(3, y, z, 1:3) &
               -1.074601717081672_wp*F%F(2, y, z, 1:3) &
               +0.240457165587598_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.123842677049796_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.277126692632703_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.292913149339697_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -1.370305772779481_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +1.677384775143114_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.204344646405764_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -1.220047690269070_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.262426876577070_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 4 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.001984237863576_wp*F%F(9, y, z, 1:3) &
               -0.033254332880890_wp*F%F(8, y, z, 1:3) &
               +0.049345164217640_wp*F%F(7, y, z, 1:3) &
               +0.015285715739915_wp*F%F(6, y, z, 1:3) &
               +0.458398958416641_wp*F%F(5, y, z, 1:3) &
               -0.087238611614301_wp*F%F(4, y, z, 1:3) &
               -0.238930206002139_wp*F%F(3, y, z, 1:3) &
               -0.249612723567178_wp*F%F(2, y, z, 1:3) &
               +0.084021797826736_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.014960937814116_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.022191521996399_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.171246462861905_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.250273339130500_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.087238611614301_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.328767974202548_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.223629860592133_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.080791880998488_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 5 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.008691249400632_wp*F%F(10, y, z, 1:3) &
               -0.086912494006324_wp*F%F(9, y, z, 1:3) &
               +0.425587317882206_wp*F%F(8, y, z, 1:3) &
               -1.174381510584465_wp*F%F(7, y, z, 1:3) &
               +2.101043245958894_wp*F%F(6, y, z, 1:3) &
               -0.712939207608398_wp*F%F(5, y, z, 1:3) &
               -1.096233495308929_wp*F%F(4, y, z, 1:3) &
               +0.854957108983171_wp*F%F(3, y, z, 1:3) &
               -0.390416585624192_wp*F%F(2, y, z, 1:3) &
               +0.070604370907403_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.047977268721897_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.242784652631690_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.666591901986778_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.712939207608398_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -2.007853869600632_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +1.214254489599245_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.468796676027212_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.077672330343217_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 6 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.002791146637928_wp*F%F(11, y, z, 1:3) &
               -0.027911466379282_wp*F%F(10, y, z, 1:3) &
               +0.130253509769982_wp*F%F(9, y, z, 1:3) &
               -0.350661416959264_wp*F%F(8, y, z, 1:3) &
               +0.951460710488470_wp*F%F(7, y, z, 1:3) &
               -0.311012762300325_wp*F%F(6, y, z, 1:3) &
               -0.214072299658686_wp*F%F(5, y, z, 1:3) &
               -0.240885429034550_wp*F%F(4, y, z, 1:3) &
               -0.058690275735617_wp*F%F(3, y, z, 1:3) &
               +0.178519157369677_wp*F%F(2, y, z, 1:3) &
               -0.059790874198334_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.004651911063214_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               -0.020189497234971_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.394489326192198_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.311012762300325_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.674738408918884_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.021501794154305_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.120805747745583_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.187181937113895_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.060100488615888_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 7 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.038696281663546_wp*F%F(11, y, z, 1:3) &
               +0.180582647763215_wp*F%F(10, y, z, 1:3) &
               -0.541747943289644_wp*F%F(9, y, z, 1:3) &
               +1.316461058090407_wp*F%F(8, y, z, 1:3) &
               -0.478764053742065_wp*F%F(7, y, z, 1:3) &
               -0.546917523864917_wp*F%F(6, y, z, 1:3) &
               +0.108095658848985_wp*F%F(5, y, z, 1:3) &
               +0.043277542550661_wp*F%F(4, y, z, 1:3) &
               -0.076982537519922_wp*F%F(3, y, z, 1:3) &
               +0.036830970389828_wp*F%F(2, y, z, 1:3) &
               -0.006009165729356_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.006449380277258_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               -0.077392563327092_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.507029127426337_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.478764053742065_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -1.319099152461176_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.522873014215084_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.096232130650833_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.051808567633002_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.035625102348712_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.006208263937353_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 8 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.165117062638594_wp*F%F(11, y, z, 1:3) &
               -0.495351187915784_wp*F%F(10, y, z, 1:3) &
               +1.238377969789459_wp*F%F(9, y, z, 1:3) &
               -0.445516907480747_wp*F%F(8, y, z, 1:3) &
               -0.463605785106338_wp*F%F(7, y, z, 1:3) &
               +0.025593402323480_wp*F%F(6, y, z, 1:3) &
               -0.019531629671282_wp*F%F(5, y, z, 1:3) &
               +0.026677815103997_wp*F%F(4, y, z, 1:3) &
               +0.031455756378546_wp*F%F(3, y, z, 1:3) &
               -0.045820249916614_wp*F%F(2, y, z, 1:3) &
               +0.014447758794131_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.005897037951378_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
               -0.070764455416541_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               +0.495351187915784_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.445516907480747_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -1.203715781568373_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.444519178417905_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.173257338466948_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.059297950103511_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.028660488283509_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.046004812145460_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.014499637444488_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. nx ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.049461966901710_wp*F%F(nx-7, y, z, 1:3) &
                 -0.018810529442315_wp*F%F(nx-6, y, z, 1:3) &
                 -0.259482649002711_wp*F%F(nx-5, y, z, 1:3) &
                 +0.098402345088438_wp*F%F(nx-4, y, z, 1:3) &
                 +0.512925523626483_wp*F%F(nx-3, y, z, 1:3) &
                 +0.209092485315854_wp*F%F(nx-2, y, z, 1:3) &
                 -2.286528268509431_wp*F%F(nx-1, y, z, 1:3) &
                 +1.694939126021973_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.049639573693422_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.019433767820507_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.260826325112378_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.108253063599706_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.493207940531973_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.228196517675356_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -2.295771894714481_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +1.696734892146909_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if

     if  ( x .eq. nx-1 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.030306625605372_wp*F%F(nx-7, y, z, 1:3) &
                 +0.022274564890085_wp*F%F(nx-6, y, z, 1:3) &
                 +0.149681276480670_wp*F%F(nx-5, y, z, 1:3) &
                 -0.105126292899953_wp*F%F(nx-4, y, z, 1:3) &
                 -0.294400328153917_wp*F%F(nx-3, y, z, 1:3) &
                 -0.180533358583704_wp*F%F(nx-2, y, z, 1:3) &
                 -0.005134519277289_wp*F%F(nx-1, y, z, 1:3) &
                 +0.443545283149479_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.030428699543875_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.021545282287796_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.156944675821618_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.126231462722744_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.263755402378838_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.204968318638770_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.005134519277289_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.441759405897525_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-2 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.123842677049796_wp*F%F(nx-7, y, z, 1:3) &
                 -0.277126692632703_wp*F%F(nx-6, y, z, 1:3) &
                 -0.292913149339697_wp*F%F(nx-5, y, z, 1:3) &
                 +1.370305772779481_wp*F%F(nx-4, y, z, 1:3) &
                 -1.677384775143114_wp*F%F(nx-3, y, z, 1:3) &
                 -0.204344646405764_wp*F%F(nx-2, y, z, 1:3) &
                 +1.220047690269070_wp*F%F(nx-1, y, z, 1:3) &
                 -0.262426876577070_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.112837585333185_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.186503815809607_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.602920868695480_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +1.946179427293353_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -2.308081526021288_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.204344646405764_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +1.074601717081672_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.240457165587598_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-3 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.014960937814116_wp*F%F(nx-7, y, z, 1:3) &
                 +0.022191521996399_wp*F%F(nx-6, y, z, 1:3) &
                 -0.171246462861905_wp*F%F(nx-5, y, z, 1:3) &
                 -0.250273339130500_wp*F%F(nx-4, y, z, 1:3) &
                 -0.087238611614301_wp*F%F(nx-3, y, z, 1:3) &
                 +0.328767974202548_wp*F%F(nx-2, y, z, 1:3) &
                 +0.223629860592133_wp*F%F(nx-1, y, z, 1:3) &
                 -0.080791880998488_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.001984237863576_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.033254332880890_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.049345164217640_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.015285715739915_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.458398958416641_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.087238611614301_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.238930206002139_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.249612723567178_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.084021797826736_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-4 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.047977268721897_wp*F%F(nx-7, y, z, 1:3) &
                 +0.242784652631690_wp*F%F(nx-6, y, z, 1:3) &
                 -0.666591901986778_wp*F%F(nx-5, y, z, 1:3) &
                 -0.712939207608398_wp*F%F(nx-4, y, z, 1:3) &
                 +2.007853869600632_wp*F%F(nx-3, y, z, 1:3) &
                 -1.214254489599245_wp*F%F(nx-2, y, z, 1:3) &
                 +0.468796676027212_wp*F%F(nx-1, y, z, 1:3) &
                 -0.077672330343217_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.008691249400632_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 +0.086912494006324_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 -0.425587317882206_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +1.174381510584465_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -2.101043245958894_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.712939207608398_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +1.096233495308929_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.854957108983171_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.390416585624192_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.070604370907403_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-5 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.004651911063214_wp*F%F(nx-8, y, z, 1:3) &
                 +0.020189497234971_wp*F%F(nx-7, y, z, 1:3) &
                 -0.394489326192198_wp*F%F(nx-6, y, z, 1:3) &
                 -0.311012762300325_wp*F%F(nx-5, y, z, 1:3) &
                 +0.674738408918884_wp*F%F(nx-4, y, z, 1:3) &
                 +0.021501794154305_wp*F%F(nx-3, y, z, 1:3) &
                 +0.120805747745583_wp*F%F(nx-2, y, z, 1:3) &
                 -0.187181937113895_wp*F%F(nx-1, y, z, 1:3) &
                 +0.060100488615888_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.002791146637928_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 +0.027911466379282_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 -0.130253509769982_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.350661416959264_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.951460710488470_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.311012762300325_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.214072299658686_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.240885429034550_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.058690275735617_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -0.178519157369677_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.059790874198334_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-6 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.006449380277258_wp*F%F(nx-9, y, z, 1:3) &
                 +0.077392563327092_wp*F%F(nx-8, y, z, 1:3) &
                 -0.507029127426337_wp*F%F(nx-7, y, z, 1:3) &
                 -0.478764053742065_wp*F%F(nx-6, y, z, 1:3) &
                 +1.319099152461176_wp*F%F(nx-5, y, z, 1:3) &
                 -0.522873014215084_wp*F%F(nx-4, y, z, 1:3) &
                 +0.096232130650833_wp*F%F(nx-3, y, z, 1:3) &
                 +0.051808567633002_wp*F%F(nx-2, y, z, 1:3) &
                 -0.035625102348712_wp*F%F(nx-1, y, z, 1:3) &
                 +0.006208263937353_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.003869628166355_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
                 +0.038696281663546_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 -0.180582647763215_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 +0.541747943289644_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 -1.316461058090407_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.478764053742065_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.546917523864917_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.108095658848985_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.043277542550661_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.076982537519922_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -0.036830970389828_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.006009165729356_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-7 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.005897037951378_wp*F%F(nx-10, y, z, 1:3) &
                 +0.070764455416541_wp*F%F(nx-9, y, z, 1:3) &
                 -0.495351187915784_wp*F%F(nx-8, y, z, 1:3) &
                 -0.445516907480747_wp*F%F(nx-7, y, z, 1:3) &
                 +1.203715781568373_wp*F%F(nx-6, y, z, 1:3) &
                 -0.444519178417905_wp*F%F(nx-5, y, z, 1:3) &
                 +0.173257338466948_wp*F%F(nx-4, y, z, 1:3) &
                 -0.059297950103511_wp*F%F(nx-3, y, z, 1:3) &
                 -0.028660488283509_wp*F%F(nx-2, y, z, 1:3) &
                 +0.046004812145460_wp*F%F(nx-1, y, z, 1:3) &
                 -0.014499637444488_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.003538222770827_wp*X_x(nx-12, y, z, 1)*G%J(nx-12,y,z) *F%F(nx-12, y, z, 4:n) &
                 +0.035382227708270_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
                 -0.165117062638594_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 +0.495351187915784_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 -1.238377969789459_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.445516907480747_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.463605785106338_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.025593402323480_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.019531629671282_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.026677815103997_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.031455756378546_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.045820249916614_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.014447758794131_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jr_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jr_xU = 0.0_wp*Jr_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! y direction 


     if ((y .ge. 9) .and. (y .le. ny-8 )) then 
     !forward operator for stress
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
              -0.005952380952381_wp*F%F(x, y-3, z, 1:3) &
              +0.071428571428571_wp*F%F(x, y-2, z, 1:3) &
              -0.500000000000000_wp*F%F(x, y-1, z, 1:3) &
              -0.450000000000000_wp*F%F(x, y  , z, 1:3) &
              +1.250000000000000_wp*F%F(x, y+1, z, 1:3) &
              -0.500000000000000_wp*F%F(x, y+2, z, 1:3) &
              +0.166666666666667_wp*F%F(x, y+3, z, 1:3) &
              -0.035714285714286_wp*F%F(x, y+4, z, 1:3) &
              +0.003571428571429_wp*F%F(x, y+5, z, 1:3) &
               )
     !backward operator for stress
     Jr_xU(4:9) = (&
              -0.003571428571429_wp*X_x(x, y-5, z, 2)*G%J(x, y-5,z) *F%F(x, y-5, z, 4:n) &
              +0.035714285714286_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
              -0.166666666666667_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
              +0.500000000000000_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
              -1.250000000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
              +0.450000000000000_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.500000000000000_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
              -0.071428571428571_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
              +0.005952380952381_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
               )
     end if





     if  ( y .eq. 1 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.049639573693422_wp*F%F(x, 8, z, 1:3) &
               +0.019433767820507_wp*F%F(x, 7, z, 1:3) &
               +0.260826325112378_wp*F%F(x, 6, z, 1:3) &
               -0.108253063599706_wp*F%F(x, 5, z, 1:3) &
               -0.493207940531973_wp*F%F(x, 4, z, 1:3) &
               -0.228196517675356_wp*F%F(x, 3, z, 1:3) &
               +2.295771894714481_wp*F%F(x, 2, z, 1:3) &
               -1.696734892146909_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.049461966901710_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.018810529442315_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.259482649002711_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.098402345088438_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.512925523626483_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.209092485315854_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +2.286528268509431_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.694939126021973_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 2 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.030428699543875_wp*F%F(x, 8, z, 1:3) &
               -0.021545282287796_wp*F%F(x, 7, z, 1:3) &
               -0.156944675821618_wp*F%F(x, 6, z, 1:3) &
               +0.126231462722744_wp*F%F(x, 5, z, 1:3) &
               +0.263755402378838_wp*F%F(x, 4, z, 1:3) &
               +0.204968318638770_wp*F%F(x, 3, z, 1:3) &
               -0.005134519277289_wp*F%F(x, 2, z, 1:3) &
               -0.441759405897525_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.030306625605372_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.022274564890085_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -0.149681276480670_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.105126292899953_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.294400328153917_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.180533358583704_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.005134519277289_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.443545283149479_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 3 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.112837585333185_wp*F%F(x, 8, z, 1:3) &
               +0.186503815809607_wp*F%F(x, 7, z, 1:3) &
               +0.602920868695480_wp*F%F(x, 6, z, 1:3) &
               -1.946179427293353_wp*F%F(x, 5, z, 1:3) &
               +2.308081526021288_wp*F%F(x, 4, z, 1:3) &
               -0.204344646405764_wp*F%F(x, 3, z, 1:3) &
               -1.074601717081672_wp*F%F(x, 2, z, 1:3) &
               +0.240457165587598_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.123842677049796_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.277126692632703_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.292913149339697_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -1.370305772779481_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +1.677384775143114_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.204344646405764_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -1.220047690269070_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.262426876577070_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 4 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.001984237863576_wp*F%F(x, 9, z, 1:3) &
               -0.033254332880890_wp*F%F(x, 8, z, 1:3) &
               +0.049345164217640_wp*F%F(x, 7, z, 1:3) &
               +0.015285715739915_wp*F%F(x, 6, z, 1:3) &
               +0.458398958416641_wp*F%F(x, 5, z, 1:3) &
               -0.087238611614301_wp*F%F(x, 4, z, 1:3) &
               -0.238930206002139_wp*F%F(x, 3, z, 1:3) &
               -0.249612723567178_wp*F%F(x, 2, z, 1:3) &
               +0.084021797826736_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.014960937814116_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.022191521996399_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.171246462861905_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.250273339130500_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.087238611614301_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.328767974202548_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.223629860592133_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.080791880998488_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 5 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.008691249400632_wp*F%F(x, 10, z, 1:3) &
               -0.086912494006324_wp*F%F(x, 9, z, 1:3) &
               +0.425587317882206_wp*F%F(x, 8, z, 1:3) &
               -1.174381510584465_wp*F%F(x, 7, z, 1:3) &
               +2.101043245958894_wp*F%F(x, 6, z, 1:3) &
               -0.712939207608398_wp*F%F(x, 5, z, 1:3) &
               -1.096233495308929_wp*F%F(x, 4, z, 1:3) &
               +0.854957108983171_wp*F%F(x, 3, z, 1:3) &
               -0.390416585624192_wp*F%F(x, 2, z, 1:3) &
               +0.070604370907403_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.047977268721897_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.242784652631690_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.666591901986778_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.712939207608398_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -2.007853869600632_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +1.214254489599245_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.468796676027212_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.077672330343217_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 6 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.002791146637928_wp*F%F(x, 11, z, 1:3) &
               -0.027911466379282_wp*F%F(x, 10, z, 1:3) &
               +0.130253509769982_wp*F%F(x, 9, z, 1:3) &
               -0.350661416959264_wp*F%F(x, 8, z, 1:3) &
               +0.951460710488470_wp*F%F(x, 7, z, 1:3) &
               -0.311012762300325_wp*F%F(x, 6, z, 1:3) &
               -0.214072299658686_wp*F%F(x, 5, z, 1:3) &
               -0.240885429034550_wp*F%F(x, 4, z, 1:3) &
               -0.058690275735617_wp*F%F(x, 3, z, 1:3) &
               +0.178519157369677_wp*F%F(x, 2, z, 1:3) &
               -0.059790874198334_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.004651911063214_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               -0.020189497234971_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.394489326192198_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.311012762300325_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.674738408918884_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.021501794154305_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.120805747745583_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.187181937113895_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.060100488615888_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 7 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.038696281663546_wp*F%F(x, 11, z, 1:3) &
               +0.180582647763215_wp*F%F(x, 10, z, 1:3) &
               -0.541747943289644_wp*F%F(x, 9, z, 1:3) &
               +1.316461058090407_wp*F%F(x, 8, z, 1:3) &
               -0.478764053742065_wp*F%F(x, 7, z, 1:3) &
               -0.546917523864917_wp*F%F(x, 6, z, 1:3) &
               +0.108095658848985_wp*F%F(x, 5, z, 1:3) &
               +0.043277542550661_wp*F%F(x, 4, z, 1:3) &
               -0.076982537519922_wp*F%F(x, 3, z, 1:3) &
               +0.036830970389828_wp*F%F(x, 2, z, 1:3) &
               -0.006009165729356_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.006449380277258_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               -0.077392563327092_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.507029127426337_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.478764053742065_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -1.319099152461176_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.522873014215084_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.096232130650833_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.051808567633002_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.035625102348712_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.006208263937353_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 8 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.165117062638594_wp*F%F(x, 11, z, 1:3) &
               -0.495351187915784_wp*F%F(x, 10, z, 1:3) &
               +1.238377969789459_wp*F%F(x, 9, z, 1:3) &
               -0.445516907480747_wp*F%F(x, 8, z, 1:3) &
               -0.463605785106338_wp*F%F(x, 7, z, 1:3) &
               +0.025593402323480_wp*F%F(x, 6, z, 1:3) &
               -0.019531629671282_wp*F%F(x, 5, z, 1:3) &
               +0.026677815103997_wp*F%F(x, 4, z, 1:3) &
               +0.031455756378546_wp*F%F(x, 3, z, 1:3) &
               -0.045820249916614_wp*F%F(x, 2, z, 1:3) &
               +0.014447758794131_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.005897037951378_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
               -0.070764455416541_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               +0.495351187915784_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.445516907480747_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -1.203715781568373_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.444519178417905_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.173257338466948_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.059297950103511_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.028660488283509_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.046004812145460_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.014499637444488_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. ny ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.049461966901710_wp*F%F(x, ny-7, z, 1:3) &
                 -0.018810529442315_wp*F%F(x, ny-6, z, 1:3) &
                 -0.259482649002711_wp*F%F(x, ny-5, z, 1:3) &
                 +0.098402345088438_wp*F%F(x, ny-4, z, 1:3) &
                 +0.512925523626483_wp*F%F(x, ny-3, z, 1:3) &
                 +0.209092485315854_wp*F%F(x, ny-2, z, 1:3) &
                 -2.286528268509431_wp*F%F(x, ny-1, z, 1:3) &
                 +1.694939126021973_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.049639573693422_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.019433767820507_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.260826325112378_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.108253063599706_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.493207940531973_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.228196517675356_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -2.295771894714481_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +1.696734892146909_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-1 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.030306625605372_wp*F%F(x, ny-7, z, 1:3) &
                 +0.022274564890085_wp*F%F(x, ny-6, z, 1:3) &
                 +0.149681276480670_wp*F%F(x, ny-5, z, 1:3) &
                 -0.105126292899953_wp*F%F(x, ny-4, z, 1:3) &
                 -0.294400328153917_wp*F%F(x, ny-3, z, 1:3) &
                 -0.180533358583704_wp*F%F(x, ny-2, z, 1:3) &
                 -0.005134519277289_wp*F%F(x, ny-1, z, 1:3) &
                 +0.443545283149479_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.030428699543875_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.021545282287796_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.156944675821618_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.126231462722744_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.263755402378838_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.204968318638770_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.005134519277289_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.441759405897525_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-2 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.123842677049796_wp*F%F(x, ny-7, z, 1:3) &
                 -0.277126692632703_wp*F%F(x, ny-6, z, 1:3) &
                 -0.292913149339697_wp*F%F(x, ny-5, z, 1:3) &
                 +1.370305772779481_wp*F%F(x, ny-4, z, 1:3) &
                 -1.677384775143114_wp*F%F(x, ny-3, z, 1:3) &
                 -0.204344646405764_wp*F%F(x, ny-2, z, 1:3) &
                 +1.220047690269070_wp*F%F(x, ny-1, z, 1:3) &
                 -0.262426876577070_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.112837585333185_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.186503815809607_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.602920868695480_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +1.946179427293353_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -2.308081526021288_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.204344646405764_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +1.074601717081672_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.240457165587598_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-3 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.014960937814116_wp*F%F(x, ny-7, z, 1:3) &
                 +0.022191521996399_wp*F%F(x, ny-6, z, 1:3) &
                 -0.171246462861905_wp*F%F(x, ny-5, z, 1:3) &
                 -0.250273339130500_wp*F%F(x, ny-4, z, 1:3) &
                 -0.087238611614301_wp*F%F(x, ny-3, z, 1:3) &
                 +0.328767974202548_wp*F%F(x, ny-2, z, 1:3) &
                 +0.223629860592133_wp*F%F(x, ny-1, z, 1:3) &
                 -0.080791880998488_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.001984237863576_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.033254332880890_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.049345164217640_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.015285715739915_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.458398958416641_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.087238611614301_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.238930206002139_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.249612723567178_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.084021797826736_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-4 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.047977268721897_wp*F%F(x, ny-7, z, 1:3) &
                 +0.242784652631690_wp*F%F(x, ny-6, z, 1:3) &
                 -0.666591901986778_wp*F%F(x, ny-5, z, 1:3) &
                 -0.712939207608398_wp*F%F(x, ny-4, z, 1:3) &
                 +2.007853869600632_wp*F%F(x, ny-3, z, 1:3) &
                 -1.214254489599245_wp*F%F(x, ny-2, z, 1:3) &
                 +0.468796676027212_wp*F%F(x, ny-1, z, 1:3) &
                 -0.077672330343217_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.008691249400632_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 +0.086912494006324_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 -0.425587317882206_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +1.174381510584465_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -2.101043245958894_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.712939207608398_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +1.096233495308929_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.854957108983171_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.390416585624192_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.070604370907403_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-5 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.004651911063214_wp*F%F(x, ny-8, z, 1:3) &
                 +0.020189497234971_wp*F%F(x, ny-7, z, 1:3) &
                 -0.394489326192198_wp*F%F(x, ny-6, z, 1:3) &
                 -0.311012762300325_wp*F%F(x, ny-5, z, 1:3) &
                 +0.674738408918884_wp*F%F(x, ny-4, z, 1:3) &
                 +0.021501794154305_wp*F%F(x, ny-3, z, 1:3) &
                 +0.120805747745583_wp*F%F(x, ny-2, z, 1:3) &
                 -0.187181937113895_wp*F%F(x, ny-1, z, 1:3) &
                 +0.060100488615888_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.002791146637928_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 +0.027911466379282_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 -0.130253509769982_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.350661416959264_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.951460710488470_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.311012762300325_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.214072299658686_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.240885429034550_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.058690275735617_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -0.178519157369677_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.059790874198334_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-6 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.006449380277258_wp*F%F(x, ny-9, z, 1:3) &
                 +0.077392563327092_wp*F%F(x, ny-8, z, 1:3) &
                 -0.507029127426337_wp*F%F(x, ny-7, z, 1:3) &
                 -0.478764053742065_wp*F%F(x, ny-6, z, 1:3) &
                 +1.319099152461176_wp*F%F(x, ny-5, z, 1:3) &
                 -0.522873014215084_wp*F%F(x, ny-4, z, 1:3) &
                 +0.096232130650833_wp*F%F(x, ny-3, z, 1:3) &
                 +0.051808567633002_wp*F%F(x, ny-2, z, 1:3) &
                 -0.035625102348712_wp*F%F(x, ny-1, z, 1:3) &
                 +0.006208263937353_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.003869628166355_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
                 +0.038696281663546_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 -0.180582647763215_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 +0.541747943289644_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 -1.316461058090407_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.478764053742065_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.546917523864917_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.108095658848985_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.043277542550661_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.076982537519922_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -0.036830970389828_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.006009165729356_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-7 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.005897037951378_wp*F%F(x, ny-10, z, 1:3) &
                 +0.070764455416541_wp*F%F(x, ny-9, z, 1:3) &
                 -0.495351187915784_wp*F%F(x, ny-8, z, 1:3) &
                 -0.445516907480747_wp*F%F(x, ny-7, z, 1:3) &
                 +1.203715781568373_wp*F%F(x, ny-6, z, 1:3) &
                 -0.444519178417905_wp*F%F(x, ny-5, z, 1:3) &
                 +0.173257338466948_wp*F%F(x, ny-4, z, 1:3) &
                 -0.059297950103511_wp*F%F(x, ny-3, z, 1:3) &
                 -0.028660488283509_wp*F%F(x, ny-2, z, 1:3) &
                 +0.046004812145460_wp*F%F(x, ny-1, z, 1:3) &
                 -0.014499637444488_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.035382227708270_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
                 -0.165117062638594_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 +0.495351187915784_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 -1.238377969789459_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.445516907480747_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.463605785106338_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.025593402323480_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.019531629671282_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.026677815103997_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.031455756378546_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.045820249916614_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.014447758794131_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if


     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Js_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Js_xU = 0.0_wp*Js_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! z direction 


     if ((z .ge. 9) .and. (z .le. nz-8 )) then 
     !forward operator for stress
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
              -0.005952380952381_wp*F%F(x, y, z-3, 1:3) &
              +0.071428571428571_wp*F%F(x, y, z-2, 1:3) &
              -0.500000000000000_wp*F%F(x, y, z-1, 1:3) &
              -0.450000000000000_wp*F%F(x, y  , z, 1:3) &
              +1.250000000000000_wp*F%F(x, y, z+1, 1:3) &
              -0.500000000000000_wp*F%F(x, y, z+2, 1:3) &
              +0.166666666666667_wp*F%F(x, y, z+3, 1:3) &
              -0.035714285714286_wp*F%F(x, y, z+4, 1:3) &
              +0.003571428571429_wp*F%F(x, y, z+5, 1:3) &
               )
     !backward operator for stress
     Js_xU(4:9) = (&
              -0.003571428571429_wp*X_x(x, y, z-5, 3)*G%J(x, y, z-5) *F%F(x, y, z-5, 4:n) &
              +0.035714285714286_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
              -0.166666666666667_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
              +0.500000000000000_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
              -1.250000000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
              +0.450000000000000_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.500000000000000_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
              -0.071428571428571_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
              +0.005952380952381_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
               )
     end if





     if  ( z .eq. 1 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.049639573693422_wp*F%F(x, y, 8, 1:3) &
               +0.019433767820507_wp*F%F(x, y, 7, 1:3) &
               +0.260826325112378_wp*F%F(x, y, 6, 1:3) &
               -0.108253063599706_wp*F%F(x, y, 5, 1:3) &
               -0.493207940531973_wp*F%F(x, y, 4, 1:3) &
               -0.228196517675356_wp*F%F(x, y, 3, 1:3) &
               +2.295771894714481_wp*F%F(x, y, 2, 1:3) &
               -1.696734892146909_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.049461966901710_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.018810529442315_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.259482649002711_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.098402345088438_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.512925523626483_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.209092485315854_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +2.286528268509431_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.694939126021973_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 2 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.030428699543875_wp*F%F(x, y, 8, 1:3) &
               -0.021545282287796_wp*F%F(x, y, 7, 1:3) &
               -0.156944675821618_wp*F%F(x, y, 6, 1:3) &
               +0.126231462722744_wp*F%F(x, y, 5, 1:3) &
               +0.263755402378838_wp*F%F(x, y, 4, 1:3) &
               +0.204968318638770_wp*F%F(x, y, 3, 1:3) &
               -0.005134519277289_wp*F%F(x, y, 2, 1:3) &
               -0.441759405897525_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.030306625605372_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.022274564890085_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -0.149681276480670_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.105126292899953_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.294400328153917_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.180533358583704_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.005134519277289_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.443545283149479_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 3 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.112837585333185_wp*F%F(x, y, 8, 1:3) &
               +0.186503815809607_wp*F%F(x, y, 7, 1:3) &
               +0.602920868695480_wp*F%F(x, y, 6, 1:3) &
               -1.946179427293353_wp*F%F(x, y, 5, 1:3) &
               +2.308081526021288_wp*F%F(x, y, 4, 1:3) &
               -0.204344646405764_wp*F%F(x, y, 3, 1:3) &
               -1.074601717081672_wp*F%F(x, y, 2, 1:3) &
               +0.240457165587598_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.123842677049796_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.277126692632703_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.292913149339697_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -1.370305772779481_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +1.677384775143114_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.204344646405764_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -1.220047690269070_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.262426876577070_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 4 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.001984237863576_wp*F%F(x, y, 9, 1:3) &
               -0.033254332880890_wp*F%F(x, y, 8, 1:3) &
               +0.049345164217640_wp*F%F(x, y, 7, 1:3) &
               +0.015285715739915_wp*F%F(x, y, 6, 1:3) &
               +0.458398958416641_wp*F%F(x, y, 5, 1:3) &
               -0.087238611614301_wp*F%F(x, y, 4, 1:3) &
               -0.238930206002139_wp*F%F(x, y, 3, 1:3) &
               -0.249612723567178_wp*F%F(x, y, 2, 1:3) &
               +0.084021797826736_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.014960937814116_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.022191521996399_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.171246462861905_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.250273339130500_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.087238611614301_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.328767974202548_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.223629860592133_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.080791880998488_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 5 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.008691249400632_wp*F%F(x, y, 10, 1:3) &
               -0.086912494006324_wp*F%F(x, y, 9, 1:3) &
               +0.425587317882206_wp*F%F(x, y, 8, 1:3) &
               -1.174381510584465_wp*F%F(x, y, 7, 1:3) &
               +2.101043245958894_wp*F%F(x, y, 6, 1:3) &
               -0.712939207608398_wp*F%F(x, y, 5, 1:3) &
               -1.096233495308929_wp*F%F(x, y, 4, 1:3) &
               +0.854957108983171_wp*F%F(x, y, 3, 1:3) &
               -0.390416585624192_wp*F%F(x, y, 2, 1:3) &
               +0.070604370907403_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.047977268721897_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.242784652631690_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.666591901986778_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.712939207608398_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -2.007853869600632_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +1.214254489599245_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.468796676027212_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.077672330343217_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 6 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.002791146637928_wp*F%F(x, y, 11, 1:3) &
               -0.027911466379282_wp*F%F(x, y, 10, 1:3) &
               +0.130253509769982_wp*F%F(x, y, 9, 1:3) &
               -0.350661416959264_wp*F%F(x, y, 8, 1:3) &
               +0.951460710488470_wp*F%F(x, y, 7, 1:3) &
               -0.311012762300325_wp*F%F(x, y, 6, 1:3) &
               -0.214072299658686_wp*F%F(x, y, 5, 1:3) &
               -0.240885429034550_wp*F%F(x, y, 4, 1:3) &
               -0.058690275735617_wp*F%F(x, y, 3, 1:3) &
               +0.178519157369677_wp*F%F(x, y, 2, 1:3) &
               -0.059790874198334_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.004651911063214_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               -0.020189497234971_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.394489326192198_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.311012762300325_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.674738408918884_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.021501794154305_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.120805747745583_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.187181937113895_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.060100488615888_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 7 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.038696281663546_wp*F%F(x, y, 11, 1:3) &
               +0.180582647763215_wp*F%F(x, y, 10, 1:3) &
               -0.541747943289644_wp*F%F(x, y, 9, 1:3) &
               +1.316461058090407_wp*F%F(x, y, 8, 1:3) &
               -0.478764053742065_wp*F%F(x, y, 7, 1:3) &
               -0.546917523864917_wp*F%F(x, y, 6, 1:3) &
               +0.108095658848985_wp*F%F(x, y, 5, 1:3) &
               +0.043277542550661_wp*F%F(x, y, 4, 1:3) &
               -0.076982537519922_wp*F%F(x, y, 3, 1:3) &
               +0.036830970389828_wp*F%F(x, y, 2, 1:3) &
               -0.006009165729356_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.006449380277258_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               -0.077392563327092_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.507029127426337_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.478764053742065_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -1.319099152461176_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.522873014215084_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.096232130650833_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.051808567633002_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.035625102348712_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.006208263937353_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 8 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.165117062638594_wp*F%F(x, y, 11, 1:3) &
               -0.495351187915784_wp*F%F(x, y, 10, 1:3) &
               +1.238377969789459_wp*F%F(x, y, 9, 1:3) &
               -0.445516907480747_wp*F%F(x, y, 8, 1:3) &
               -0.463605785106338_wp*F%F(x, y, 7, 1:3) &
               +0.025593402323480_wp*F%F(x, y, 6, 1:3) &
               -0.019531629671282_wp*F%F(x, y, 5, 1:3) &
               +0.026677815103997_wp*F%F(x, y, 4, 1:3) &
               +0.031455756378546_wp*F%F(x, y, 3, 1:3) &
               -0.045820249916614_wp*F%F(x, y, 2, 1:3) &
               +0.014447758794131_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.005897037951378_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
               -0.070764455416541_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               +0.495351187915784_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.445516907480747_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -1.203715781568373_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.444519178417905_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.173257338466948_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.059297950103511_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.028660488283509_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.046004812145460_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.014499637444488_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. nz ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.049461966901710_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.018810529442315_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.259482649002711_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.098402345088438_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.512925523626483_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.209092485315854_wp*F%F(x, y,  nz-2, 1:3) &
                 -2.286528268509431_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.694939126021973_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.049639573693422_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.019433767820507_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.260826325112378_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.108253063599706_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.493207940531973_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.228196517675356_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -2.295771894714481_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +1.696734892146909_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-1 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.030306625605372_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.022274564890085_wp*F%F(x, y,  nz-6, 1:3) &
                 +0.149681276480670_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.105126292899953_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.294400328153917_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.180533358583704_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.005134519277289_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.443545283149479_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.030428699543875_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.021545282287796_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.156944675821618_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.126231462722744_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.263755402378838_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.204968318638770_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.005134519277289_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.441759405897525_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-2 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.123842677049796_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.277126692632703_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.292913149339697_wp*F%F(x, y,  nz-5, 1:3) &
                 +1.370305772779481_wp*F%F(x, y,  nz-4, 1:3) &
                 -1.677384775143114_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.204344646405764_wp*F%F(x, y,  nz-2, 1:3) &
                 +1.220047690269070_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.262426876577070_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.112837585333185_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.186503815809607_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.602920868695480_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +1.946179427293353_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -2.308081526021288_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.204344646405764_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +1.074601717081672_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.240457165587598_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-3 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.014960937814116_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.022191521996399_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.171246462861905_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.250273339130500_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.087238611614301_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.328767974202548_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.223629860592133_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.080791880998488_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.001984237863576_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.033254332880890_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.049345164217640_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.015285715739915_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.458398958416641_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.087238611614301_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.238930206002139_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.249612723567178_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.084021797826736_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-4 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.047977268721897_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.242784652631690_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.666591901986778_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.712939207608398_wp*F%F(x, y,  nz-4, 1:3) &
                 +2.007853869600632_wp*F%F(x, y,  nz-3, 1:3) &
                 -1.214254489599245_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.468796676027212_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.077672330343217_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.008691249400632_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 +0.086912494006324_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 -0.425587317882206_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +1.174381510584465_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -2.101043245958894_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.712939207608398_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +1.096233495308929_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.854957108983171_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.390416585624192_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.070604370907403_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-5 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.004651911063214_wp*F%F(x, y,  nz-8, 1:3) &
                 +0.020189497234971_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.394489326192198_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.311012762300325_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.674738408918884_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.021501794154305_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.120805747745583_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.187181937113895_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.060100488615888_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.002791146637928_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 +0.027911466379282_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 -0.130253509769982_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.350661416959264_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.951460710488470_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.311012762300325_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.214072299658686_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.240885429034550_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.058690275735617_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -0.178519157369677_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.059790874198334_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-6 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.006449380277258_wp*F%F(x, y,  nz-9, 1:3) &
                 +0.077392563327092_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.507029127426337_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.478764053742065_wp*F%F(x, y,  nz-6, 1:3) &
                 +1.319099152461176_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.522873014215084_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.096232130650833_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.051808567633002_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.035625102348712_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.006208263937353_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.003869628166355_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
                 +0.038696281663546_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 -0.180582647763215_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 +0.541747943289644_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 -1.316461058090407_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.478764053742065_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.546917523864917_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.108095658848985_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.043277542550661_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.076982537519922_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -0.036830970389828_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.006009165729356_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-7 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.005897037951378_wp*F%F(x, y,  nz-10, 1:3) &
                 +0.070764455416541_wp*F%F(x, y,  nz-9, 1:3) &
                 -0.495351187915784_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.445516907480747_wp*F%F(x, y,  nz-7, 1:3) &
                 +1.203715781568373_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.444519178417905_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.173257338466948_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.059297950103511_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.028660488283509_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.046004812145460_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.014499637444488_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.035382227708270_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
                 -0.165117062638594_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 +0.495351187915784_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 -1.238377969789459_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.445516907480747_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.463605785106338_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.025593402323480_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.019531629671282_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.026677815103997_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.031455756378546_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.045820249916614_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.014447758794131_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if

     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

end subroutine JJU_x8_upwind


subroutine JJU_x9_upwind(x, y, z, F, G, X_x, Ju_x)

    !=========================================================================================================================

     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     !input data 
     integer,               intent(in)  :: x, y, z      ! indices in the tranformed co-ordinate
     type(block_fields),    intent(in)  :: F            
     type(block_grid_t),    intent(in)  :: G

     !output data 
     real(kind = wp),       dimension(:), intent(out) :: Ju_x      ! metric coefficients
 
     !input grid and output derivatives 
     real(kind = wp),       dimension(:,:,:,:), allocatable, intent(in) :: X_x                  ! the grid
     real(kind = wp),       dimension(:),       allocatable, save       :: Jq_xU, Jr_xU, Js_xU  ! work array

     !working parameters 
     real(kind = wp)        :: hx, hy, hz       ! spatial steps discertizing the unit cube
     integer                :: n, nx, ny, nz    ! number of points
 
     !get values from input data
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n  = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jq_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jq_xU = 0.0_wp*Jq_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! x direction 

     if ((x .ge. 9) .and. (x .le. nx-8 )) then 
     !forward operator for stress
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
              +0.001984126984127_wp*F%F(x-4, y, z, 1:3) &
              -0.023809523809524_wp*F%F(x-3, y, z, 1:3) &
              +0.142857142857143_wp*F%F(x-2, y, z, 1:3) &
              -0.666666666666667_wp*F%F(x-1, y, z, 1:3) &
              -0.200000000000000_wp*F%F(x  , y, z, 1:3) &
              +1.000000000000000_wp*F%F(x+1, y, z, 1:3) &
              -0.333333333333333_wp*F%F(x+2, y, z, 1:3) &
              +0.095238095238095_wp*F%F(x+3, y, z, 1:3) &
              -0.017857142857143_wp*F%F(x+4, y, z, 1:3) &
              +0.001587301587302_wp*F%F(x+5, y, z, 1:3) &
               )
     !backward operator for stress
     Jq_xU(4:9) = (&
              -0.001587301587302_wp*X_x(x-5, y, z, 1)*G%J(x-5,y,z) *F%F(x-5, y, z, 4:n) &
              +0.017857142857143_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
              -0.095238095238095_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
              +0.333333333333333_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
              -1.000000000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
              +0.200000000000000_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.666666666666667_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
              -0.142857142857143_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
              +0.023809523809524_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
              -0.001984126984127_wp*X_x(x+4, y, z, 1)*G%J(x+4,y,z) *F%F(x+4, y, z, 4:n) &
               )
     end if





     if  ( x .eq. 1 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.049623962457557_wp*F%F(8, y, z, 1:3) &
               +0.019530696044150_wp*F%F(7, y, z, 1:3) &
               +0.259445638052514_wp*F%F(6, y, z, 1:3) &
               -0.103349944910322_wp*F%F(5, y, z, 1:3) &
               -0.501498502419021_wp*F%F(4, y, z, 1:3) &
               -0.220718432859696_wp*F%F(3, y, z, 1:3) &
               +2.292287523293173_wp*F%F(2, y, z, 1:3) &
               -1.696073014743241_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.049545033693571_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.019253727835982_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.258848506076251_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.098972268645985_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.510261030289877_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.212228567991700_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +2.288179639894823_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.695274973185923_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 2 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.030407829416822_wp*F%F(8, y, z, 1:3) &
               -0.022197966398293_wp*F%F(7, y, z, 1:3) &
               -0.152949167517260_wp*F%F(6, y, z, 1:3) &
               +0.116774637305272_wp*F%F(5, y, z, 1:3) &
               +0.275411757661946_wp*F%F(4, y, z, 1:3) &
               +0.197013656576266_wp*F%F(3, y, z, 1:3) &
               -0.002282305301155_wp*F%F(2, y, z, 1:3) &
               -0.442178441743599_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.030353567278161_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.022522134145916_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -0.149720570266962_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.107393342121242_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.289033495700664_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.186152262187531_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.002282305301155_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.442972268175876_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 3 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.118864122426389_wp*F%F(8, y, z, 1:3) &
               +0.232049050808764_wp*F%F(7, y, z, 1:3) &
               +0.462528161511674_wp*F%F(6, y, z, 1:3) &
               -1.716465618099542_wp*F%F(5, y, z, 1:3) &
               +2.093177459363103_wp*F%F(4, y, z, 1:3) &
               -0.090609475786085_wp*F%F(3, y, z, 1:3) &
               -1.105337209545202_wp*F%F(2, y, z, 1:3) &
               +0.243521754173677_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.123743944868323_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.272232591251818_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.325066097129082_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -1.461114617364703_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +1.813517076856277_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.090609475786085_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -1.169830131760244_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.253263452970008_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 4 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.000882369837045_wp*F%F(9, y, z, 1:3) &
               -0.024112005314665_wp*F%F(8, y, z, 1:3) &
               +0.017626108186029_wp*F%F(7, y, z, 1:3) &
               +0.075693795507220_wp*F%F(6, y, z, 1:3) &
               +0.389293697093610_wp*F%F(5, y, z, 1:3) &
               -0.038794098695110_wp*F%F(4, y, z, 1:3) &
               -0.259063708168245_wp*F%F(3, y, z, 1:3) &
               -0.245165624098592_wp*F%F(2, y, z, 1:3) &
               +0.083639465652710_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.015977123746092_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.014185508413032_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.145047909522278_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.296742409697332_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.038794098695110_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.299013624628674_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.233611316527859_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.082203155400937_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 5 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.003853474315189_wp*F%F(10, y, z, 1:3) &
               -0.043351586045874_wp*F%F(9, y, z, 1:3) &
               +0.257141021278065_wp*F%F(8, y, z, 1:3) &
               -0.810058000730354_wp*F%F(7, y, z, 1:3) &
               +1.619887918435668_wp*F%F(6, y, z, 1:3) &
               -0.316098733124618_wp*F%F(5, y, z, 1:3) &
               -1.295929672557022_wp*F%F(4, y, z, 1:3) &
               +0.911530130115692_wp*F%F(3, y, z, 1:3) &
               -0.397823627274231_wp*F%F(2, y, z, 1:3) &
               +0.070849075587485_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.004816842893986_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.089718530158371_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.397012142908074_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.983889438173168_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.316098733124618_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -1.700118476215130_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +1.070833259492914_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.432575324213020_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.073982825281139_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 6 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.001241086959473_wp*F%F(11, y, z, 1:3) &
               -0.013962228294068_wp*F%F(10, y, z, 1:3) &
               +0.074465217568362_wp*F%F(9, y, z, 1:3) &
               -0.222305530651498_wp*F%F(8, y, z, 1:3) &
               +0.766116635438948_wp*F%F(7, y, z, 1:3) &
               -0.138292226669620_wp*F%F(6, y, z, 1:3) &
               -0.316880884989061_wp*F%F(5, y, z, 1:3) &
               -0.204015438254036_wp*F%F(4, y, z, 1:3) &
               -0.065314283014049_wp*F%F(3, y, z, 1:3) &
               +0.178625900526335_wp*F%F(2, y, z, 1:3) &
               -0.059678248620787_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.001551358699341_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               +0.018616304392090_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               -0.075360764486806_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.518458589653630_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.138292226669620_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.521716665777072_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.106466221501421_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.092934007913304_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.182477816734261_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.059815919071658_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 7 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.019343982275181_wp*F%F(11, y, z, 1:3) &
               +0.103167905467630_wp*F%F(10, y, z, 1:3) &
               -0.361087669136706_wp*F%F(9, y, z, 1:3) &
               +1.046491747060222_wp*F%F(8, y, z, 1:3) &
               -0.212738289547735_wp*F%F(7, y, z, 1:3) &
               -0.718298938926253_wp*F%F(6, y, z, 1:3) &
               +0.177151439103489_wp*F%F(5, y, z, 1:3) &
               +0.027643155389112_wp*F%F(4, y, z, 1:3) &
               -0.075782295210177_wp*F%F(3, y, z, 1:3) &
               +0.037227480969559_wp*F%F(2, y, z, 1:3) &
               -0.006150017985090_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.002149331363909_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
               +0.025791976366908_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               -0.154751858201445_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.686821543984437_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.212738289547735_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -1.061417010560458_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.361457308422692_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.034347817033054_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.064596268913903_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.036691654809508_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.006238487058510_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 8 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.094355256824580_wp*F%F(11, y, z, 1:3) &
               -0.330243398886029_wp*F%F(10, y, z, 1:3) &
               +0.990730196658088_wp*F%F(9, y, z, 1:3) &
               -0.198013074867399_wp*F%F(8, y, z, 1:3) &
               -0.628152940408769_wp*F%F(7, y, z, 1:3) &
               +0.095490008890679_wp*F%F(6, y, z, 1:3) &
               -0.036613776999671_wp*F%F(5, y, z, 1:3) &
               +0.028474938570530_wp*F%F(4, y, z, 1:3) &
               +0.031504535587514_wp*F%F(3, y, z, 1:3) &
               -0.045886542517376_wp*F%F(2, y, z, 1:3) &
               +0.014473820188720_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.023588814206145_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
               -0.141532885236870_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               +0.660486797772058_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.198013074867399_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.957099953818986_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.281684471261904_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.104938232870329_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.042973183475236_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.030262159324609_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.045968572478135_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.014496878014146_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. nx ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.049545033693571_wp*F%F(nx-7, y, z, 1:3) &
                 -0.019253727835982_wp*F%F(nx-6, y, z, 1:3) &
                 -0.258848506076251_wp*F%F(nx-5, y, z, 1:3) &
                 +0.098972268645985_wp*F%F(nx-4, y, z, 1:3) &
                 +0.510261030289877_wp*F%F(nx-3, y, z, 1:3) &
                 +0.212228567991700_wp*F%F(nx-2, y, z, 1:3) &
                 -2.288179639894823_wp*F%F(nx-1, y, z, 1:3) &
                 +1.695274973185923_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.049623962457557_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.019530696044150_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.259445638052514_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.103349944910322_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.501498502419021_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.220718432859696_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -2.292287523293173_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +1.696073014743241_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-1 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.030353567278161_wp*F%F(nx-7, y, z, 1:3) &
                 +0.022522134145916_wp*F%F(nx-6, y, z, 1:3) &
                 +0.149720570266962_wp*F%F(nx-5, y, z, 1:3) &
                 -0.107393342121242_wp*F%F(nx-4, y, z, 1:3) &
                 -0.289033495700664_wp*F%F(nx-3, y, z, 1:3) &
                 -0.186152262187531_wp*F%F(nx-2, y, z, 1:3) &
                 -0.002282305301155_wp*F%F(nx-1, y, z, 1:3) &
                 +0.442972268175876_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.030407829416822_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.022197966398293_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.152949167517260_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.116774637305272_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.275411757661946_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.197013656576266_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.002282305301155_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.442178441743599_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-2 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.123743944868323_wp*F%F(nx-7, y, z, 1:3) &
                 -0.272232591251818_wp*F%F(nx-6, y, z, 1:3) &
                 -0.325066097129082_wp*F%F(nx-5, y, z, 1:3) &
                 +1.461114617364703_wp*F%F(nx-4, y, z, 1:3) &
                 -1.813517076856277_wp*F%F(nx-3, y, z, 1:3) &
                 -0.090609475786085_wp*F%F(nx-2, y, z, 1:3) &
                 +1.169830131760244_wp*F%F(nx-1, y, z, 1:3) &
                 -0.253263452970008_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.118864122426389_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.232049050808764_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.462528161511674_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +1.716465618099542_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -2.093177459363103_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.090609475786085_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +1.105337209545202_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.243521754173677_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-3 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.015977123746092_wp*F%F(nx-7, y, z, 1:3) &
                 +0.014185508413032_wp*F%F(nx-6, y, z, 1:3) &
                 -0.145047909522278_wp*F%F(nx-5, y, z, 1:3) &
                 -0.296742409697332_wp*F%F(nx-4, y, z, 1:3) &
                 -0.038794098695110_wp*F%F(nx-3, y, z, 1:3) &
                 +0.299013624628674_wp*F%F(nx-2, y, z, 1:3) &
                 +0.233611316527859_wp*F%F(nx-1, y, z, 1:3) &
                 -0.082203155400937_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.000882369837045_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.024112005314665_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.017626108186029_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.075693795507220_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.389293697093610_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.038794098695110_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.259063708168245_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.245165624098592_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.083639465652710_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-4 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.004816842893986_wp*F%F(nx-8, y, z, 1:3) &
                 -0.089718530158371_wp*F%F(nx-7, y, z, 1:3) &
                 +0.397012142908074_wp*F%F(nx-6, y, z, 1:3) &
                 -0.983889438173168_wp*F%F(nx-5, y, z, 1:3) &
                 -0.316098733124618_wp*F%F(nx-4, y, z, 1:3) &
                 +1.700118476215130_wp*F%F(nx-3, y, z, 1:3) &
                 -1.070833259492914_wp*F%F(nx-2, y, z, 1:3) &
                 +0.432575324213020_wp*F%F(nx-1, y, z, 1:3) &
                 -0.073982825281139_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.003853474315189_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 +0.043351586045874_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 -0.257141021278065_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.810058000730354_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -1.619887918435668_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.316098733124618_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +1.295929672557022_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.911530130115692_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.397823627274231_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.070849075587485_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-5 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.001551358699341_wp*F%F(nx-9, y, z, 1:3) &
                 -0.018616304392090_wp*F%F(nx-8, y, z, 1:3) &
                 +0.075360764486806_wp*F%F(nx-7, y, z, 1:3) &
                 -0.518458589653630_wp*F%F(nx-6, y, z, 1:3) &
                 -0.138292226669620_wp*F%F(nx-5, y, z, 1:3) &
                 +0.521716665777072_wp*F%F(nx-4, y, z, 1:3) &
                 +0.106466221501421_wp*F%F(nx-3, y, z, 1:3) &
                 +0.092934007913304_wp*F%F(nx-2, y, z, 1:3) &
                 -0.182477816734261_wp*F%F(nx-1, y, z, 1:3) &
                 +0.059815919071658_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.001241086959473_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 +0.013962228294068_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 -0.074465217568362_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.222305530651498_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.766116635438948_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.138292226669620_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.316880884989061_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.204015438254036_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.065314283014049_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -0.178625900526335_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.059678248620787_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-6 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.002149331363909_wp*F%F(nx-10, y, z, 1:3) &
                 -0.025791976366908_wp*F%F(nx-9, y, z, 1:3) &
                 +0.154751858201445_wp*F%F(nx-8, y, z, 1:3) &
                 -0.686821543984437_wp*F%F(nx-7, y, z, 1:3) &
                 -0.212738289547735_wp*F%F(nx-6, y, z, 1:3) &
                 +1.061417010560458_wp*F%F(nx-5, y, z, 1:3) &
                 -0.361457308422692_wp*F%F(nx-4, y, z, 1:3) &
                 +0.034347817033054_wp*F%F(nx-3, y, z, 1:3) &
                 +0.064596268913903_wp*F%F(nx-2, y, z, 1:3) &
                 -0.036691654809508_wp*F%F(nx-1, y, z, 1:3) &
                 +0.006238487058510_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.001719465091127_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
                 +0.019343982275181_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 -0.103167905467630_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 +0.361087669136706_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 -1.046491747060222_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.212738289547735_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.718298938926253_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.177151439103489_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.027643155389112_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.075782295210177_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -0.037227480969559_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.006150017985090_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-7 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.001965734517179_wp*F%F(nx-11, y, z, 1:3) &
                 -0.023588814206145_wp*F%F(nx-10, y, z, 1:3) &
                 +0.141532885236870_wp*F%F(nx-9, y, z, 1:3) &
                 -0.660486797772058_wp*F%F(nx-8, y, z, 1:3) &
                 -0.198013074867399_wp*F%F(nx-7, y, z, 1:3) &
                 +0.957099953818986_wp*F%F(nx-6, y, z, 1:3) &
                 -0.281684471261904_wp*F%F(nx-5, y, z, 1:3) &
                 +0.104938232870329_wp*F%F(nx-4, y, z, 1:3) &
                 -0.042973183475236_wp*F%F(nx-3, y, z, 1:3) &
                 -0.030262159324609_wp*F%F(nx-2, y, z, 1:3) &
                 +0.045968572478135_wp*F%F(nx-1, y, z, 1:3) &
                 -0.014496878014146_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.001572587613743_wp*X_x(nx-12, y, z, 1)*G%J(nx-12,y,z) *F%F(nx-12, y, z, 4:n) &
                 +0.017691610654609_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
                 -0.094355256824580_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 +0.330243398886029_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 -0.990730196658088_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.198013074867399_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.628152940408769_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.095490008890679_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.036613776999671_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.028474938570530_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.031504535587514_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.045886542517376_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.014473820188720_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if



     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Jr_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Jr_xU = 0.0_wp*Jr_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! y direction 


     if ((y .ge. 9) .and. (y .le. ny-8 )) then 
     !forward operator for stress
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
              +0.001984126984127_wp*F%F(x, y-4, z, 1:3) &
              -0.023809523809524_wp*F%F(x, y-3, z, 1:3) &
              +0.142857142857143_wp*F%F(x, y-2, z, 1:3) &
              -0.666666666666667_wp*F%F(x, y-1, z, 1:3) &
              -0.200000000000000_wp*F%F(x, y  , z, 1:3) &
              +1.000000000000000_wp*F%F(x, y+1, z, 1:3) &
              -0.333333333333333_wp*F%F(x, y+2, z, 1:3) &
              +0.095238095238095_wp*F%F(x, y+3, z, 1:3) &
              -0.017857142857143_wp*F%F(x, y+4, z, 1:3) &
              +0.001587301587302_wp*F%F(x, y+5, z, 1:3) &
               )
     !backward operator for stress
     Jr_xU(4:9) = (&
              -0.001587301587302_wp*X_x(x, y-5, z, 2)*G%J(x, y-5,z) *F%F(x, y-5, z, 4:n) &
              +0.017857142857143_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
              -0.095238095238095_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
              +0.333333333333333_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
              -1.000000000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
              +0.200000000000000_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.666666666666667_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
              -0.142857142857143_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
              +0.023809523809524_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
              -0.001984126984127_wp*X_x(x, y+4, z, 2)*G%J(x, y+4,z) *F%F(x, y+4, z, 4:n) &
               )
     end if





     if  ( y .eq. 1 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.049623962457557_wp*F%F(x, 8, z, 1:3) &
               +0.019530696044150_wp*F%F(x, 7, z, 1:3) &
               +0.259445638052514_wp*F%F(x, 6, z, 1:3) &
               -0.103349944910322_wp*F%F(x, 5, z, 1:3) &
               -0.501498502419021_wp*F%F(x, 4, z, 1:3) &
               -0.220718432859696_wp*F%F(x, 3, z, 1:3) &
               +2.292287523293173_wp*F%F(x, 2, z, 1:3) &
               -1.696073014743241_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.049545033693571_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.019253727835982_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.258848506076251_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.098972268645985_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.510261030289877_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.212228567991700_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +2.288179639894823_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.695274973185923_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 2 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.030407829416822_wp*F%F(x, 8, z, 1:3) &
               -0.022197966398293_wp*F%F(x, 7, z, 1:3) &
               -0.152949167517260_wp*F%F(x, 6, z, 1:3) &
               +0.116774637305272_wp*F%F(x, 5, z, 1:3) &
               +0.275411757661946_wp*F%F(x, 4, z, 1:3) &
               +0.197013656576266_wp*F%F(x, 3, z, 1:3) &
               -0.002282305301155_wp*F%F(x, 2, z, 1:3) &
               -0.442178441743599_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.030353567278161_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.022522134145916_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -0.149720570266962_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.107393342121242_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.289033495700664_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.186152262187531_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.002282305301155_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.442972268175876_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 3 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.118864122426389_wp*F%F(x, 8, z, 1:3) &
               +0.232049050808764_wp*F%F(x, 7, z, 1:3) &
               +0.462528161511674_wp*F%F(x, 6, z, 1:3) &
               -1.716465618099542_wp*F%F(x, 5, z, 1:3) &
               +2.093177459363103_wp*F%F(x, 4, z, 1:3) &
               -0.090609475786085_wp*F%F(x, 3, z, 1:3) &
               -1.105337209545202_wp*F%F(x, 2, z, 1:3) &
               +0.243521754173677_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.123743944868323_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.272232591251818_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.325066097129082_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -1.461114617364703_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +1.813517076856277_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.090609475786085_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -1.169830131760244_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.253263452970008_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 4 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.000882369837045_wp*F%F(x, 9, z, 1:3) &
               -0.024112005314665_wp*F%F(x, 8, z, 1:3) &
               +0.017626108186029_wp*F%F(x, 7, z, 1:3) &
               +0.075693795507220_wp*F%F(x, 6, z, 1:3) &
               +0.389293697093610_wp*F%F(x, 5, z, 1:3) &
               -0.038794098695110_wp*F%F(x, 4, z, 1:3) &
               -0.259063708168245_wp*F%F(x, 3, z, 1:3) &
               -0.245165624098592_wp*F%F(x, 2, z, 1:3) &
               +0.083639465652710_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.015977123746092_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.014185508413032_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.145047909522278_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.296742409697332_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.038794098695110_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.299013624628674_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.233611316527859_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.082203155400937_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 5 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.003853474315189_wp*F%F(x, 10, z, 1:3) &
               -0.043351586045874_wp*F%F(x, 9, z, 1:3) &
               +0.257141021278065_wp*F%F(x, 8, z, 1:3) &
               -0.810058000730354_wp*F%F(x, 7, z, 1:3) &
               +1.619887918435668_wp*F%F(x, 6, z, 1:3) &
               -0.316098733124618_wp*F%F(x, 5, z, 1:3) &
               -1.295929672557022_wp*F%F(x, 4, z, 1:3) &
               +0.911530130115692_wp*F%F(x, 3, z, 1:3) &
               -0.397823627274231_wp*F%F(x, 2, z, 1:3) &
               +0.070849075587485_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.004816842893986_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.089718530158371_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.397012142908074_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.983889438173168_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.316098733124618_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -1.700118476215130_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +1.070833259492914_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.432575324213020_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.073982825281139_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 6 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.001241086959473_wp*F%F(x, 11, z, 1:3) &
               -0.013962228294068_wp*F%F(x, 10, z, 1:3) &
               +0.074465217568362_wp*F%F(x, 9, z, 1:3) &
               -0.222305530651498_wp*F%F(x, 8, z, 1:3) &
               +0.766116635438948_wp*F%F(x, 7, z, 1:3) &
               -0.138292226669620_wp*F%F(x, 6, z, 1:3) &
               -0.316880884989061_wp*F%F(x, 5, z, 1:3) &
               -0.204015438254036_wp*F%F(x, 4, z, 1:3) &
               -0.065314283014049_wp*F%F(x, 3, z, 1:3) &
               +0.178625900526335_wp*F%F(x, 2, z, 1:3) &
               -0.059678248620787_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.001551358699341_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               +0.018616304392090_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               -0.075360764486806_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.518458589653630_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.138292226669620_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.521716665777072_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.106466221501421_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.092934007913304_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.182477816734261_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.059815919071658_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 7 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.019343982275181_wp*F%F(x, 11, z, 1:3) &
               +0.103167905467630_wp*F%F(x, 10, z, 1:3) &
               -0.361087669136706_wp*F%F(x, 9, z, 1:3) &
               +1.046491747060222_wp*F%F(x, 8, z, 1:3) &
               -0.212738289547735_wp*F%F(x, 7, z, 1:3) &
               -0.718298938926253_wp*F%F(x, 6, z, 1:3) &
               +0.177151439103489_wp*F%F(x, 5, z, 1:3) &
               +0.027643155389112_wp*F%F(x, 4, z, 1:3) &
               -0.075782295210177_wp*F%F(x, 3, z, 1:3) &
               +0.037227480969559_wp*F%F(x, 2, z, 1:3) &
               -0.006150017985090_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.002149331363909_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
               +0.025791976366908_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               -0.154751858201445_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.686821543984437_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.212738289547735_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -1.061417010560458_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.361457308422692_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.034347817033054_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.064596268913903_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.036691654809508_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.006238487058510_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 8 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.094355256824580_wp*F%F(x, 11, z, 1:3) &
               -0.330243398886029_wp*F%F(x, 10, z, 1:3) &
               +0.990730196658088_wp*F%F(x, 9, z, 1:3) &
               -0.198013074867399_wp*F%F(x, 8, z, 1:3) &
               -0.628152940408769_wp*F%F(x, 7, z, 1:3) &
               +0.095490008890679_wp*F%F(x, 6, z, 1:3) &
               -0.036613776999671_wp*F%F(x, 5, z, 1:3) &
               +0.028474938570530_wp*F%F(x, 4, z, 1:3) &
               +0.031504535587514_wp*F%F(x, 3, z, 1:3) &
               -0.045886542517376_wp*F%F(x, 2, z, 1:3) &
               +0.014473820188720_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.023588814206145_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
               -0.141532885236870_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               +0.660486797772058_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.198013074867399_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.957099953818986_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.281684471261904_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.104938232870329_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.042973183475236_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.030262159324609_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.045968572478135_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.014496878014146_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. ny ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.049545033693571_wp*F%F(x, ny-7, z, 1:3) &
                 -0.019253727835982_wp*F%F(x, ny-6, z, 1:3) &
                 -0.258848506076251_wp*F%F(x, ny-5, z, 1:3) &
                 +0.098972268645985_wp*F%F(x, ny-4, z, 1:3) &
                 +0.510261030289877_wp*F%F(x, ny-3, z, 1:3) &
                 +0.212228567991700_wp*F%F(x, ny-2, z, 1:3) &
                 -2.288179639894823_wp*F%F(x, ny-1, z, 1:3) &
                 +1.695274973185923_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.049623962457557_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.019530696044150_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.259445638052514_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.103349944910322_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.501498502419021_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.220718432859696_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -2.292287523293173_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +1.696073014743241_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-1 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.030353567278161_wp*F%F(x, ny-7, z, 1:3) &
                 +0.022522134145916_wp*F%F(x, ny-6, z, 1:3) &
                 +0.149720570266962_wp*F%F(x, ny-5, z, 1:3) &
                 -0.107393342121242_wp*F%F(x, ny-4, z, 1:3) &
                 -0.289033495700664_wp*F%F(x, ny-3, z, 1:3) &
                 -0.186152262187531_wp*F%F(x, ny-2, z, 1:3) &
                 -0.002282305301155_wp*F%F(x, ny-1, z, 1:3) &
                 +0.442972268175876_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.030407829416822_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.022197966398293_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.152949167517260_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.116774637305272_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.275411757661946_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.197013656576266_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.002282305301155_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.442178441743599_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-2 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.123743944868323_wp*F%F(x, ny-7, z, 1:3) &
                 -0.272232591251818_wp*F%F(x, ny-6, z, 1:3) &
                 -0.325066097129082_wp*F%F(x, ny-5, z, 1:3) &
                 +1.461114617364703_wp*F%F(x, ny-4, z, 1:3) &
                 -1.813517076856277_wp*F%F(x, ny-3, z, 1:3) &
                 -0.090609475786085_wp*F%F(x, ny-2, z, 1:3) &
                 +1.169830131760244_wp*F%F(x, ny-1, z, 1:3) &
                 -0.253263452970008_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.118864122426389_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.232049050808764_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.462528161511674_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +1.716465618099542_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -2.093177459363103_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.090609475786085_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +1.105337209545202_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.243521754173677_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-3 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.015977123746092_wp*F%F(x, ny-7, z, 1:3) &
                 +0.014185508413032_wp*F%F(x, ny-6, z, 1:3) &
                 -0.145047909522278_wp*F%F(x, ny-5, z, 1:3) &
                 -0.296742409697332_wp*F%F(x, ny-4, z, 1:3) &
                 -0.038794098695110_wp*F%F(x, ny-3, z, 1:3) &
                 +0.299013624628674_wp*F%F(x, ny-2, z, 1:3) &
                 +0.233611316527859_wp*F%F(x, ny-1, z, 1:3) &
                 -0.082203155400937_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.000882369837045_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.024112005314665_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.017626108186029_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.075693795507220_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.389293697093610_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.038794098695110_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.259063708168245_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.245165624098592_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.083639465652710_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-4 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.004816842893986_wp*F%F(x, ny-8, z, 1:3) &
                 -0.089718530158371_wp*F%F(x, ny-7, z, 1:3) &
                 +0.397012142908074_wp*F%F(x, ny-6, z, 1:3) &
                 -0.983889438173168_wp*F%F(x, ny-5, z, 1:3) &
                 -0.316098733124618_wp*F%F(x, ny-4, z, 1:3) &
                 +1.700118476215130_wp*F%F(x, ny-3, z, 1:3) &
                 -1.070833259492914_wp*F%F(x, ny-2, z, 1:3) &
                 +0.432575324213020_wp*F%F(x, ny-1, z, 1:3) &
                 -0.073982825281139_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.003853474315189_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 +0.043351586045874_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 -0.257141021278065_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.810058000730354_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -1.619887918435668_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.316098733124618_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +1.295929672557022_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.911530130115692_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.397823627274231_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.070849075587485_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-5 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.001551358699341_wp*F%F(x, ny-9, z, 1:3) &
                 -0.018616304392090_wp*F%F(x, ny-8, z, 1:3) &
                 +0.075360764486806_wp*F%F(x, ny-7, z, 1:3) &
                 -0.518458589653630_wp*F%F(x, ny-6, z, 1:3) &
                 -0.138292226669620_wp*F%F(x, ny-5, z, 1:3) &
                 +0.521716665777072_wp*F%F(x, ny-4, z, 1:3) &
                 +0.106466221501421_wp*F%F(x, ny-3, z, 1:3) &
                 +0.092934007913304_wp*F%F(x, ny-2, z, 1:3) &
                 -0.182477816734261_wp*F%F(x, ny-1, z, 1:3) &
                 +0.059815919071658_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.001241086959473_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 +0.013962228294068_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 -0.074465217568362_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.222305530651498_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.766116635438948_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.138292226669620_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.316880884989061_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.204015438254036_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.065314283014049_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -0.178625900526335_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.059678248620787_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-6 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.002149331363909_wp*F%F(x, ny-10, z, 1:3) &
                 -0.025791976366908_wp*F%F(x, ny-9, z, 1:3) &
                 +0.154751858201445_wp*F%F(x, ny-8, z, 1:3) &
                 -0.686821543984437_wp*F%F(x, ny-7, z, 1:3) &
                 -0.212738289547735_wp*F%F(x, ny-6, z, 1:3) &
                 +1.061417010560458_wp*F%F(x, ny-5, z, 1:3) &
                 -0.361457308422692_wp*F%F(x, ny-4, z, 1:3) &
                 +0.034347817033054_wp*F%F(x, ny-3, z, 1:3) &
                 +0.064596268913903_wp*F%F(x, ny-2, z, 1:3) &
                 -0.036691654809508_wp*F%F(x, ny-1, z, 1:3) &
                 +0.006238487058510_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.001719465091127_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
                 +0.019343982275181_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 -0.103167905467630_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 +0.361087669136706_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 -1.046491747060222_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.212738289547735_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.718298938926253_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.177151439103489_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.027643155389112_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.075782295210177_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -0.037227480969559_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.006150017985090_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-7 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.001965734517179_wp*F%F(x, ny-11, z, 1:3) &
                 -0.023588814206145_wp*F%F(x, ny-10, z, 1:3) &
                 +0.141532885236870_wp*F%F(x, ny-9, z, 1:3) &
                 -0.660486797772058_wp*F%F(x, ny-8, z, 1:3) &
                 -0.198013074867399_wp*F%F(x, ny-7, z, 1:3) &
                 +0.957099953818986_wp*F%F(x, ny-6, z, 1:3) &
                 -0.281684471261904_wp*F%F(x, ny-5, z, 1:3) &
                 +0.104938232870329_wp*F%F(x, ny-4, z, 1:3) &
                 -0.042973183475236_wp*F%F(x, ny-3, z, 1:3) &
                 -0.030262159324609_wp*F%F(x, ny-2, z, 1:3) &
                 +0.045968572478135_wp*F%F(x, ny-1, z, 1:3) &
                 -0.014496878014146_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.017691610654609_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
                 -0.094355256824580_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 +0.330243398886029_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 -0.990730196658088_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.198013074867399_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.628152940408769_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.095490008890679_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.036613776999671_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.028474938570530_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.031504535587514_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.045886542517376_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.014473820188720_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if

     !=========================================================================================================================
     !=========================================================================================================================
     ! Compute: (Js_xU)_q or (Jq_yU)_q or (Jq_zU)_q for stresses
     ! Compute: q_xU_q or q_yU_q or q_zU_q for displacements
      Js_xU = 0.0_wp*Js_xU
     !=========================================================================================================================
     ! Interior approximation 
     ! z direction 


     if ((z .ge. 9) .and. (z .le. nz-8 )) then 
     !forward operator for stress
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
              +0.001984126984127_wp*F%F(x, y, z-4, 1:3) &
              -0.023809523809524_wp*F%F(x, y, z-3, 1:3) &
              +0.142857142857143_wp*F%F(x, y, z-2, 1:3) &
              -0.666666666666667_wp*F%F(x, y, z-1, 1:3) &
              -0.200000000000000_wp*F%F(x, y  , z, 1:3) &
              +1.000000000000000_wp*F%F(x, y, z+1, 1:3) &
              -0.333333333333333_wp*F%F(x, y, z+2, 1:3) &
              +0.095238095238095_wp*F%F(x, y, z+3, 1:3) &
              -0.017857142857143_wp*F%F(x, y, z+4, 1:3) &
              +0.001587301587302_wp*F%F(x, y, z+5, 1:3) &
               )
     !backward operator for stress
     Js_xU(4:9) = (&
              -0.001587301587302_wp*X_x(x, y, z-5, 3)*G%J(x, y, z-5) *F%F(x, y, z-5, 4:n) &
              +0.017857142857143_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
              -0.095238095238095_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
              +0.333333333333333_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
              -1.000000000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
              +0.200000000000000_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.666666666666667_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
              -0.142857142857143_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
              +0.023809523809524_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
              -0.001984126984127_wp*X_x(x, y, z+4, 3)*G%J(x, y, z+4) *F%F(x, y, z+4, 4:n) &
               )
     end if





     if  ( z .eq. 1 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.049623962457557_wp*F%F(x, y, 8, 1:3) &
               +0.019530696044150_wp*F%F(x, y, 7, 1:3) &
               +0.259445638052514_wp*F%F(x, y, 6, 1:3) &
               -0.103349944910322_wp*F%F(x, y, 5, 1:3) &
               -0.501498502419021_wp*F%F(x, y, 4, 1:3) &
               -0.220718432859696_wp*F%F(x, y, 3, 1:3) &
               +2.292287523293173_wp*F%F(x, y, 2, 1:3) &
               -1.696073014743241_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.049545033693571_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.019253727835982_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.258848506076251_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.098972268645985_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.510261030289877_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.212228567991700_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +2.288179639894823_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.695274973185923_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 2 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.030407829416822_wp*F%F(x, y, 8, 1:3) &
               -0.022197966398293_wp*F%F(x, y, 7, 1:3) &
               -0.152949167517260_wp*F%F(x, y, 6, 1:3) &
               +0.116774637305272_wp*F%F(x, y, 5, 1:3) &
               +0.275411757661946_wp*F%F(x, y, 4, 1:3) &
               +0.197013656576266_wp*F%F(x, y, 3, 1:3) &
               -0.002282305301155_wp*F%F(x, y, 2, 1:3) &
               -0.442178441743599_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.030353567278161_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.022522134145916_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -0.149720570266962_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.107393342121242_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.289033495700664_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.186152262187531_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.002282305301155_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.442972268175876_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 3 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.118864122426389_wp*F%F(x, y, 8, 1:3) &
               +0.232049050808764_wp*F%F(x, y, 7, 1:3) &
               +0.462528161511674_wp*F%F(x, y, 6, 1:3) &
               -1.716465618099542_wp*F%F(x, y, 5, 1:3) &
               +2.093177459363103_wp*F%F(x, y, 4, 1:3) &
               -0.090609475786085_wp*F%F(x, y, 3, 1:3) &
               -1.105337209545202_wp*F%F(x, y, 2, 1:3) &
               +0.243521754173677_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.123743944868323_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.272232591251818_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.325066097129082_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -1.461114617364703_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +1.813517076856277_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.090609475786085_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -1.169830131760244_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.253263452970008_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 4 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.000882369837045_wp*F%F(x, y, 9, 1:3) &
               -0.024112005314665_wp*F%F(x, y, 8, 1:3) &
               +0.017626108186029_wp*F%F(x, y, 7, 1:3) &
               +0.075693795507220_wp*F%F(x, y, 6, 1:3) &
               +0.389293697093610_wp*F%F(x, y, 5, 1:3) &
               -0.038794098695110_wp*F%F(x, y, 4, 1:3) &
               -0.259063708168245_wp*F%F(x, y, 3, 1:3) &
               -0.245165624098592_wp*F%F(x, y, 2, 1:3) &
               +0.083639465652710_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.015977123746092_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.014185508413032_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.145047909522278_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.296742409697332_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.038794098695110_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.299013624628674_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.233611316527859_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.082203155400937_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 5 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.003853474315189_wp*F%F(x, y, 10, 1:3) &
               -0.043351586045874_wp*F%F(x, y, 9, 1:3) &
               +0.257141021278065_wp*F%F(x, y, 8, 1:3) &
               -0.810058000730354_wp*F%F(x, y, 7, 1:3) &
               +1.619887918435668_wp*F%F(x, y, 6, 1:3) &
               -0.316098733124618_wp*F%F(x, y, 5, 1:3) &
               -1.295929672557022_wp*F%F(x, y, 4, 1:3) &
               +0.911530130115692_wp*F%F(x, y, 3, 1:3) &
               -0.397823627274231_wp*F%F(x, y, 2, 1:3) &
               +0.070849075587485_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.004816842893986_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.089718530158371_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.397012142908074_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.983889438173168_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.316098733124618_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -1.700118476215130_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +1.070833259492914_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.432575324213020_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.073982825281139_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 6 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.001241086959473_wp*F%F(x, y, 11, 1:3) &
               -0.013962228294068_wp*F%F(x, y, 10, 1:3) &
               +0.074465217568362_wp*F%F(x, y, 9, 1:3) &
               -0.222305530651498_wp*F%F(x, y, 8, 1:3) &
               +0.766116635438948_wp*F%F(x, y, 7, 1:3) &
               -0.138292226669620_wp*F%F(x, y, 6, 1:3) &
               -0.316880884989061_wp*F%F(x, y, 5, 1:3) &
               -0.204015438254036_wp*F%F(x, y, 4, 1:3) &
               -0.065314283014049_wp*F%F(x, y, 3, 1:3) &
               +0.178625900526335_wp*F%F(x, y, 2, 1:3) &
               -0.059678248620787_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.001551358699341_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               +0.018616304392090_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               -0.075360764486806_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.518458589653630_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.138292226669620_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.521716665777072_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.106466221501421_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.092934007913304_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.182477816734261_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.059815919071658_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 7 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.019343982275181_wp*F%F(x, y, 11, 1:3) &
               +0.103167905467630_wp*F%F(x, y, 10, 1:3) &
               -0.361087669136706_wp*F%F(x, y, 9, 1:3) &
               +1.046491747060222_wp*F%F(x, y, 8, 1:3) &
               -0.212738289547735_wp*F%F(x, y, 7, 1:3) &
               -0.718298938926253_wp*F%F(x, y, 6, 1:3) &
               +0.177151439103489_wp*F%F(x, y, 5, 1:3) &
               +0.027643155389112_wp*F%F(x, y, 4, 1:3) &
               -0.075782295210177_wp*F%F(x, y, 3, 1:3) &
               +0.037227480969559_wp*F%F(x, y, 2, 1:3) &
               -0.006150017985090_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.002149331363909_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
               +0.025791976366908_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               -0.154751858201445_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.686821543984437_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.212738289547735_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -1.061417010560458_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.361457308422692_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.034347817033054_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.064596268913903_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.036691654809508_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.006238487058510_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 8 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.094355256824580_wp*F%F(x, y, 11, 1:3) &
               -0.330243398886029_wp*F%F(x, y, 10, 1:3) &
               +0.990730196658088_wp*F%F(x, y, 9, 1:3) &
               -0.198013074867399_wp*F%F(x, y, 8, 1:3) &
               -0.628152940408769_wp*F%F(x, y, 7, 1:3) &
               +0.095490008890679_wp*F%F(x, y, 6, 1:3) &
               -0.036613776999671_wp*F%F(x, y, 5, 1:3) &
               +0.028474938570530_wp*F%F(x, y, 4, 1:3) &
               +0.031504535587514_wp*F%F(x, y, 3, 1:3) &
               -0.045886542517376_wp*F%F(x, y, 2, 1:3) &
               +0.014473820188720_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.023588814206145_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
               -0.141532885236870_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               +0.660486797772058_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.198013074867399_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.957099953818986_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.281684471261904_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.104938232870329_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.042973183475236_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.030262159324609_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.045968572478135_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.014496878014146_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. nz ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.049545033693571_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.019253727835982_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.258848506076251_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.098972268645985_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.510261030289877_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.212228567991700_wp*F%F(x, y,  nz-2, 1:3) &
                 -2.288179639894823_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.695274973185923_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.049623962457557_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.019530696044150_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.259445638052514_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.103349944910322_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.501498502419021_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.220718432859696_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -2.292287523293173_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +1.696073014743241_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-1 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.030353567278161_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.022522134145916_wp*F%F(x, y,  nz-6, 1:3) &
                 +0.149720570266962_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.107393342121242_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.289033495700664_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.186152262187531_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.002282305301155_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.442972268175876_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.030407829416822_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.022197966398293_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.152949167517260_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.116774637305272_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.275411757661946_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.197013656576266_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.002282305301155_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.442178441743599_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-2 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.123743944868323_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.272232591251818_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.325066097129082_wp*F%F(x, y,  nz-5, 1:3) &
                 +1.461114617364703_wp*F%F(x, y,  nz-4, 1:3) &
                 -1.813517076856277_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.090609475786085_wp*F%F(x, y,  nz-2, 1:3) &
                 +1.169830131760244_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.253263452970008_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.118864122426389_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.232049050808764_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.462528161511674_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +1.716465618099542_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -2.093177459363103_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.090609475786085_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +1.105337209545202_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.243521754173677_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-3 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.015977123746092_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.014185508413032_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.145047909522278_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.296742409697332_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.038794098695110_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.299013624628674_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.233611316527859_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.082203155400937_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.000882369837045_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.024112005314665_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.017626108186029_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.075693795507220_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.389293697093610_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.038794098695110_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.259063708168245_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.245165624098592_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.083639465652710_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-4 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.004816842893986_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.089718530158371_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.397012142908074_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.983889438173168_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.316098733124618_wp*F%F(x, y,  nz-4, 1:3) &
                 +1.700118476215130_wp*F%F(x, y,  nz-3, 1:3) &
                 -1.070833259492914_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.432575324213020_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.073982825281139_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.003853474315189_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 +0.043351586045874_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 -0.257141021278065_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.810058000730354_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -1.619887918435668_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.316098733124618_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +1.295929672557022_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.911530130115692_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.397823627274231_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.070849075587485_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-5 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.001551358699341_wp*F%F(x, y,  nz-9, 1:3) &
                 -0.018616304392090_wp*F%F(x, y,  nz-8, 1:3) &
                 +0.075360764486806_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.518458589653630_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.138292226669620_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.521716665777072_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.106466221501421_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.092934007913304_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.182477816734261_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.059815919071658_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.001241086959473_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 +0.013962228294068_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 -0.074465217568362_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.222305530651498_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.766116635438948_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.138292226669620_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.316880884989061_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.204015438254036_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.065314283014049_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -0.178625900526335_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.059678248620787_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-6 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.002149331363909_wp*F%F(x, y,  nz-10, 1:3) &
                 -0.025791976366908_wp*F%F(x, y,  nz-9, 1:3) &
                 +0.154751858201445_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.686821543984437_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.212738289547735_wp*F%F(x, y,  nz-6, 1:3) &
                 +1.061417010560458_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.361457308422692_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.034347817033054_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.064596268913903_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.036691654809508_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.006238487058510_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.001719465091127_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
                 +0.019343982275181_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 -0.103167905467630_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 +0.361087669136706_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 -1.046491747060222_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.212738289547735_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.718298938926253_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.177151439103489_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.027643155389112_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.075782295210177_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -0.037227480969559_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.006150017985090_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-7 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.001965734517179_wp*F%F(x, y,  nz-11, 1:3) &
                 -0.023588814206145_wp*F%F(x, y,  nz-10, 1:3) &
                 +0.141532885236870_wp*F%F(x, y,  nz-9, 1:3) &
                 -0.660486797772058_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.198013074867399_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.957099953818986_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.281684471261904_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.104938232870329_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.042973183475236_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.030262159324609_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.045968572478135_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.014496878014146_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.017691610654609_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
                 -0.094355256824580_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 +0.330243398886029_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 -0.990730196658088_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.198013074867399_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.628152940408769_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.095490008890679_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.036613776999671_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.028474938570530_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.031504535587514_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.045886542517376_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.014473820188720_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if

       Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

end subroutine JJU_x9_upwind


!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!============================================================================================

  subroutine JJU_x3_upwind_drp(x, y, z, F, G, X_x, Ju_x)

!=================================================================================================
!
   use datatypes, only: block_fields, block_grid_t

implicit none

integer, intent(in) :: x, y, z                      
type(block_fields), intent(in):: F
type(block_grid_t), intent(in) :: G
real(kind = wp), dimension(:), intent(out) :: Ju_x            

real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   
real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            
real(kind = wp) :: hx, hy, hz                      
integer :: n, nx, ny, nz

nx = G%C%nq
ny = G%C%nr
nz = G%C%ns

n = size(F%F, 4)

hx = G%hq
hy = G%hr
hz = G%hs

! work arrays:
if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
if (.not. allocated(Js_xU)) allocate(Js_xU(n))

!=================================================================================================
Jq_xU = 0.0_wp*Jq_xU


if ((x .ge. 5) .and. (x .le. nx-4 )) then 
!forward operator for stress
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
         -0.104166666666667_wp*F%F(x-2, y, z, 1:3) &
         +0.080555555555556_wp*F%F(x-1, y, z, 1:3) &
         -1.113888888888889_wp*F%F(x  , y, z, 1:3) &
         +1.400000000000000_wp*F%F(x+1, y, z, 1:3) &
         -0.259722222222222_wp*F%F(x+2, y, z, 1:3) &
         -0.002777777777778_wp*F%F(x+3, y, z, 1:3) &
          )
!backward operator for stress
Jq_xU(4:9) = (&
         +0.002777777777778_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
         +0.259722222222222_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
         -1.400000000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
         +1.113888888888889_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         -0.080555555555556_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
         +0.104166666666667_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
          )
end if





if  ( x .eq. 1 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.056872525923901_wp*F%F(4, y, z, 1:3) &
          -0.433046993057226_wp*F%F(3, y, z, 1:3) &
          +1.695476408342749_wp*F%F(2, y, z, 1:3) &
          -1.319301941209424_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.011735664195658_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.160117945181090_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +1.285028897775207_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -1.136646616789774_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 2 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.002626304982703_wp*F%F(5, y, z, 1:3) &
          -0.259188263314684_wp*F%F(4, y, z, 1:3) &
          +1.031556151963056_wp*F%F(3, y, z, 1:3) &
          -0.275042294051248_wp*F%F(2, y, z, 1:3) &
          -0.494699289614420_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.030377336927185_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.408044858365154_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.275042294051248_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.652709815489217_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 3 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.002572511404897_wp*F%F(6, y, z, 1:3) &
          -0.240529816357831_wp*F%F(5, y, z, 1:3) &
          +1.209846640294344_wp*F%F(4, y, z, 1:3) &
          -0.627435531654277_wp*F%F(3, y, z, 1:3) &
          -0.399687035118670_wp*F%F(2, y, z, 1:3) &
          +0.060378254241331_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.096469177683622_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.123226472234553_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.627435531654277_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -1.010427190746701_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.163296009174249_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 4 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.002907578212093_wp*F%F(7, y, z, 1:3) &
          -0.271858562830714_wp*F%F(6, y, z, 1:3) &
          +1.465419418894970_wp*F%F(5, y, z, 1:3) &
          -1.080005641093114_wp*F%F(4, y, z, 1:3) &
          -0.139276585961995_wp*F%F(3, y, z, 1:3) &
          +0.033630703049579_wp*F%F(2, y, z, 1:3) &
          -0.005001753846633_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.109034182953495_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.084319768150703_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +1.080005641093114_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -1.367427846810808_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.286946928177611_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.024239137262709_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. nx ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.011735664195658_wp*F%F(nx-3, y, z, 1:3) &
            +0.160117945181090_wp*F%F(nx-2, y, z, 1:3) &
            -1.285028897775207_wp*F%F(nx-1, y, z, 1:3) &
            +1.136646616789774_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.056872525923901_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.433046993057226_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -1.695476408342749_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +1.319301941209424_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-1 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.030377336927185_wp*F%F(nx-3, y, z, 1:3) &
            -0.408044858365154_wp*F%F(nx-2, y, z, 1:3) &
            -0.275042294051248_wp*F%F(nx-1, y, z, 1:3) &
            +0.652709815489217_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.002626304982703_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.259188263314684_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -1.031556151963056_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.275042294051248_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.494699289614420_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-2 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.096469177683622_wp*F%F(nx-4, y, z, 1:3) &
            -0.123226472234553_wp*F%F(nx-3, y, z, 1:3) &
            -0.627435531654277_wp*F%F(nx-2, y, z, 1:3) &
            +1.010427190746701_wp*F%F(nx-1, y, z, 1:3) &
            -0.163296009174249_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.002572511404897_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.240529816357831_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -1.209846640294344_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.627435531654277_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.399687035118670_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.060378254241331_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-3 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.109034182953495_wp*F%F(nx-5, y, z, 1:3) &
            +0.084319768150703_wp*F%F(nx-4, y, z, 1:3) &
            -1.080005641093114_wp*F%F(nx-3, y, z, 1:3) &
            +1.367427846810808_wp*F%F(nx-2, y, z, 1:3) &
            -0.286946928177611_wp*F%F(nx-1, y, z, 1:3) &
            +0.024239137262709_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.002907578212093_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.271858562830714_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -1.465419418894970_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +1.080005641093114_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.139276585961995_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.033630703049579_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.005001753846633_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if


!=================================================================================================
Jr_xU = 0.0_wp*Jr_xU


if ((y .ge. 5) .and. (y .le. ny-4 )) then 
!forward operator for stress
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
         -0.104166666666667_wp*F%F(x, y-2, z, 1:3) &
         +0.080555555555556_wp*F%F(x, y-1, z, 1:3) &
         -1.113888888888889_wp*F%F(x, y  , z, 1:3) &
         +1.400000000000000_wp*F%F(x, y+1, z, 1:3) &
         -0.259722222222222_wp*F%F(x, y+2, z, 1:3) &
         -0.002777777777778_wp*F%F(x, y+3, z, 1:3) &
          )
!backward operator for stress
Jr_xU(4:9) = (&
         +0.002777777777778_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
         +0.259722222222222_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
         -1.400000000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
         +1.113888888888889_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         -0.080555555555556_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
         +0.104166666666667_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
          )
end if





if  ( y .eq. 1 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.056872525923901_wp*F%F(x, 4, z, 1:3) &
          -0.433046993057226_wp*F%F(x, 3, z, 1:3) &
          +1.695476408342749_wp*F%F(x, 2, z, 1:3) &
          -1.319301941209424_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.011735664195658_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.160117945181090_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +1.285028897775207_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -1.136646616789774_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 2 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.002626304982703_wp*F%F(x, 5, z, 1:3) &
          -0.259188263314684_wp*F%F(x, 4, z, 1:3) &
          +1.031556151963056_wp*F%F(x, 3, z, 1:3) &
          -0.275042294051248_wp*F%F(x, 2, z, 1:3) &
          -0.494699289614420_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.030377336927185_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.408044858365154_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.275042294051248_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.652709815489217_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 3 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.002572511404897_wp*F%F(x, 6, z, 1:3) &
          -0.240529816357831_wp*F%F(x, 5, z, 1:3) &
          +1.209846640294344_wp*F%F(x, 4, z, 1:3) &
          -0.627435531654277_wp*F%F(x, 3, z, 1:3) &
          -0.399687035118670_wp*F%F(x, 2, z, 1:3) &
          +0.060378254241331_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.096469177683622_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.123226472234553_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.627435531654277_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -1.010427190746701_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.163296009174249_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 4 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.002907578212093_wp*F%F(x, 7, z, 1:3) &
          -0.271858562830714_wp*F%F(x, 6, z, 1:3) &
          +1.465419418894970_wp*F%F(x, 5, z, 1:3) &
          -1.080005641093114_wp*F%F(x, 4, z, 1:3) &
          -0.139276585961995_wp*F%F(x, 3, z, 1:3) &
          +0.033630703049579_wp*F%F(x, 2, z, 1:3) &
          -0.005001753846633_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.109034182953495_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.084319768150703_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +1.080005641093114_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -1.367427846810808_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.286946928177611_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.024239137262709_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. ny ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.011735664195658_wp*F%F(x, ny-3, z, 1:3) &
            +0.160117945181090_wp*F%F(x, ny-2, z, 1:3) &
            -1.285028897775207_wp*F%F(x, ny-1, z, 1:3) &
            +1.136646616789774_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.056872525923901_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.433046993057226_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -1.695476408342749_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +1.319301941209424_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-1 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.030377336927185_wp*F%F(x, ny-3, z, 1:3) &
            -0.408044858365154_wp*F%F(x, ny-2, z, 1:3) &
            -0.275042294051248_wp*F%F(x, ny-1, z, 1:3) &
            +0.652709815489217_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.002626304982703_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.259188263314684_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -1.031556151963056_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.275042294051248_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.494699289614420_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-2 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.096469177683622_wp*F%F(x, ny-4, z, 1:3) &
            -0.123226472234553_wp*F%F(x, ny-3, z, 1:3) &
            -0.627435531654277_wp*F%F(x, ny-2, z, 1:3) &
            +1.010427190746701_wp*F%F(x, ny-1, z, 1:3) &
            -0.163296009174249_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.002572511404897_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.240529816357831_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -1.209846640294344_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.627435531654277_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.399687035118670_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.060378254241331_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-3 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.109034182953495_wp*F%F(x, ny-5, z, 1:3) &
            +0.084319768150703_wp*F%F(x, ny-4, z, 1:3) &
            -1.080005641093114_wp*F%F(x, ny-3, z, 1:3) &
            +1.367427846810808_wp*F%F(x, ny-2, z, 1:3) &
            -0.286946928177611_wp*F%F(x, ny-1, z, 1:3) &
            +0.024239137262709_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.002907578212093_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.271858562830714_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -1.465419418894970_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +1.080005641093114_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.139276585961995_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.033630703049579_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.005001753846633_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if


!=================================================================================================
Js_xU = 0.0_wp*Js_xU


if ((z .ge. 5) .and. (z .le. nz-4 )) then 
!forward operator for stress
Js_xU(1:3) = X_x(x, y, z, 3)*(&
         -0.104166666666667_wp*F%F(x, y, z-2, 1:3) &
         +0.080555555555556_wp*F%F(x, y, z-1, 1:3) &
         -1.113888888888889_wp*F%F(x, y  , z, 1:3) &
         +1.400000000000000_wp*F%F(x, y, z+1, 1:3) &
         -0.259722222222222_wp*F%F(x, y, z+2, 1:3) &
         -0.002777777777778_wp*F%F(x, y, z+3, 1:3) &
          )
!backward operator for stress
Js_xU(4:9) = (&
         +0.002777777777778_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
         +0.259722222222222_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
         -1.400000000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
         +1.113888888888889_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         -0.080555555555556_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
         +0.104166666666667_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
          )
end if





if  ( z .eq. 1 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.056872525923901_wp*F%F(x, y, 4, 1:3) &
          -0.433046993057226_wp*F%F(x, y, 3, 1:3) &
          +1.695476408342749_wp*F%F(x, y, 2, 1:3) &
          -1.319301941209424_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.011735664195658_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.160117945181090_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +1.285028897775207_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -1.136646616789774_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 2 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.002626304982703_wp*F%F(x, y, 5, 1:3) &
          -0.259188263314684_wp*F%F(x, y, 4, 1:3) &
          +1.031556151963056_wp*F%F(x, y, 3, 1:3) &
          -0.275042294051248_wp*F%F(x, y, 2, 1:3) &
          -0.494699289614420_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.030377336927185_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.408044858365154_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.275042294051248_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.652709815489217_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 3 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.002572511404897_wp*F%F(x, y, 6, 1:3) &
          -0.240529816357831_wp*F%F(x, y, 5, 1:3) &
          +1.209846640294344_wp*F%F(x, y, 4, 1:3) &
          -0.627435531654277_wp*F%F(x, y, 3, 1:3) &
          -0.399687035118670_wp*F%F(x, y, 2, 1:3) &
          +0.060378254241331_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.096469177683622_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.123226472234553_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.627435531654277_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -1.010427190746701_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.163296009174249_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 4 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.002907578212093_wp*F%F(x, y, 7, 1:3) &
          -0.271858562830714_wp*F%F(x, y, 6, 1:3) &
          +1.465419418894970_wp*F%F(x, y, 5, 1:3) &
          -1.080005641093114_wp*F%F(x, y, 4, 1:3) &
          -0.139276585961995_wp*F%F(x, y, 3, 1:3) &
          +0.033630703049579_wp*F%F(x, y, 2, 1:3) &
          -0.005001753846633_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.109034182953495_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.084319768150703_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +1.080005641093114_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -1.367427846810808_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.286946928177611_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.024239137262709_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. nz ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.011735664195658_wp*F%F(x, y,  nz-3, 1:3) &
            +0.160117945181090_wp*F%F(x, y,  nz-2, 1:3) &
            -1.285028897775207_wp*F%F(x, y,  nz-1, 1:3) &
            +1.136646616789774_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.056872525923901_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.433046993057226_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -1.695476408342749_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +1.319301941209424_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-1 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.030377336927185_wp*F%F(x, y,  nz-3, 1:3) &
            -0.408044858365154_wp*F%F(x, y,  nz-2, 1:3) &
            -0.275042294051248_wp*F%F(x, y,  nz-1, 1:3) &
            +0.652709815489217_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.002626304982703_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.259188263314684_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -1.031556151963056_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.275042294051248_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.494699289614420_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-2 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.096469177683622_wp*F%F(x, y,  nz-4, 1:3) &
            -0.123226472234553_wp*F%F(x, y,  nz-3, 1:3) &
            -0.627435531654277_wp*F%F(x, y,  nz-2, 1:3) &
            +1.010427190746701_wp*F%F(x, y,  nz-1, 1:3) &
            -0.163296009174249_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.002572511404897_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.240529816357831_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -1.209846640294344_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.627435531654277_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.399687035118670_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.060378254241331_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-3 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.109034182953495_wp*F%F(x, y,  nz-5, 1:3) &
            +0.084319768150703_wp*F%F(x, y,  nz-4, 1:3) &
            -1.080005641093114_wp*F%F(x, y,  nz-3, 1:3) &
            +1.367427846810808_wp*F%F(x, y,  nz-2, 1:3) &
            -0.286946928177611_wp*F%F(x, y,  nz-1, 1:3) &
            +0.024239137262709_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.002907578212093_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.271858562830714_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -1.465419418894970_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +1.080005641093114_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.139276585961995_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.033630703049579_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.005001753846633_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if


!=================================================================================================


Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

    end subroutine JJU_x3_upwind_drp



   subroutine JJU_x4_upwind_drp(x, y, z, F, G, X_x, Ju_x)


!=============================================================================================
!
use datatypes, only: block_fields, block_grid_t

implicit none

integer, intent(in) :: x, y, z                      
type(block_fields), intent(in):: F
type(block_grid_t), intent(in) :: G
real(kind = wp), dimension(:), intent(out) :: Ju_x            

real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x  
real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            
real(kind = wp) :: hx, hy, hz                      
integer :: n, nx, ny, nz

nx = G%C%nq
ny = G%C%nr
nz = G%C%ns

n = size(F%F, 4)

hx = G%hq
hy = G%hr
hz = G%hs

! work arrays:
if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
if (.not. allocated(Js_xU)) allocate(Js_xU(n))

!=================================================================================================
Jq_xU = 0.0_wp*Jq_xU


if ((x .ge. 7) .and. (x .le. nx-6 )) then 
!forward operator for stress
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
         +0.030769230769231_wp*F%F(x-3, y, z, 1:3) &
         -0.154895104895105_wp*F%F(x-2, y, z, 1:3) &
         +0.039860139860140_wp*F%F(x-1, y, z, 1:3) &
         -1.036130536130536_wp*F%F(x  , y, z, 1:3) &
         +1.433566433566434_wp*F%F(x+1, y, z, 1:3) &
         -0.305244755244755_wp*F%F(x+2, y, z, 1:3) &
         -0.031002331002331_wp*F%F(x+3, y, z, 1:3) &
         +0.023076923076923_wp*F%F(x+4, y, z, 1:3) &
          )
!backward operator for stress
Jq_xU(4:9) = (&
         -0.023076923076923_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
         +0.031002331002331_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
         +0.305244755244755_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
         -1.433566433566434_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
         +1.036130536130536_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         -0.039860139860140_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
         +0.154895104895105_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
         -0.030769230769231_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
          )
end if





if  ( x .eq. 1 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.083605380684408_wp*F%F(6, y, z, 1:3) &
          -0.080170162229368_wp*F%F(5, y, z, 1:3) &
          -0.108480538283818_wp*F%F(4, y, z, 1:3) &
          -0.529591218616420_wp*F%F(3, y, z, 1:3) &
          +2.287277797579725_wp*F%F(2, y, z, 1:3) &
          -1.652641259134527_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.051367988538755_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.069195069390028_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.116686544755228_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.751550165218299_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +2.133100361304578_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -1.516063821692780_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 2 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.012826390178158_wp*F%F(6, y, z, 1:3) &
          +0.016543588463787_wp*F%F(5, y, z, 1:3) &
          +0.012069260886192_wp*F%F(4, y, z, 1:3) &
          +0.492794588340281_wp*F%F(3, y, z, 1:3) &
          -0.023839362303497_wp*F%F(2, y, z, 1:3) &
          -0.484741685208605_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.010541277690041_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.003871162613547_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.055083034651834_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.536609351373804_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.023839362303497_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.519778119329056_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 3 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.036596036410772_wp*F%F(7, y, z, 1:3) &
          -0.191046615066391_wp*F%F(6, y, z, 1:3) &
          -0.093040209981079_wp*F%F(5, y, z, 1:3) &
          +1.183314867676973_wp*F%F(4, y, z, 1:3) &
          -0.130177738642109_wp*F%F(3, y, z, 1:3) &
          -1.181771428955059_wp*F%F(2, y, z, 1:3) &
          +0.376125088556894_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.035404132011385_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.316060685455593_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.970715017992531_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.130177738642109_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -1.085278449496368_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.265042246305935_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 4 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.018536036080008_wp*F%F(8, y, z, 1:3) &
          -0.024901947461020_wp*F%F(7, y, z, 1:3) &
          -0.051698171178260_wp*F%F(6, y, z, 1:3) &
          +0.646438203986408_wp*F%F(5, y, z, 1:3) &
          -0.128568030423532_wp*F%F(4, y, z, 1:3) &
          -0.491670966630110_wp*F%F(3, y, z, 1:3) &
          +0.061443496682551_wp*F%F(2, y, z, 1:3) &
          -0.029578621056045_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.024714714773344_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.048895491535142_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.432569223319861_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.128568030423532_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.599353624941027_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.013462903703635_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.027498498139470_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 5 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.025581609537913_wp*F%F(9, y, z, 1:3) &
          -0.034367212813561_wp*F%F(8, y, z, 1:3) &
          -0.338374926160583_wp*F%F(7, y, z, 1:3) &
          +1.407698379940242_wp*F%F(6, y, z, 1:3) &
          -0.654316700492022_wp*F%F(5, y, z, 1:3) &
          -0.596989395215000_wp*F%F(4, y, z, 1:3) &
          +0.220934883626644_wp*F%F(3, y, z, 1:3) &
          -0.005959508986299_wp*F%F(2, y, z, 1:3) &
          -0.024207129437336_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.034108812717218_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.171706864019631_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.032619513655146_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.654316700492022_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.892150277081438_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.065037598507823_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.025468231112416_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.028046644236449_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 6 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.022668265398350_wp*F%F(10, y, z, 1:3) &
          -0.030453326242227_wp*F%F(9, y, z, 1:3) &
          -0.299839328678169_wp*F%F(8, y, z, 1:3) &
          +1.408180123230807_wp*F%F(7, y, z, 1:3) &
          -0.991469519492543_wp*F%F(6, y, z, 1:3) &
          -0.028904662609445_wp*F%F(5, y, z, 1:3) &
          -0.059795739181626_wp*F%F(4, y, z, 1:3) &
          -0.021929977651789_wp*F%F(3, y, z, 1:3) &
          -0.014379796536031_wp*F%F(2, y, z, 1:3) &
          +0.015923961762675_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.030224353864466_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.152152145022255_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -0.039154276597149_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.991469519492543_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -1.247383610871689_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.063223218805777_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.118337825582297_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.017497013784953_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.025917481354520_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. nx ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.051367988538755_wp*F%F(nx-5, y, z, 1:3) &
            -0.069195069390028_wp*F%F(nx-4, y, z, 1:3) &
            -0.116686544755228_wp*F%F(nx-3, y, z, 1:3) &
            +0.751550165218299_wp*F%F(nx-2, y, z, 1:3) &
            -2.133100361304578_wp*F%F(nx-1, y, z, 1:3) &
            +1.516063821692780_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.083605380684408_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.080170162229368_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.108480538283818_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.529591218616420_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -2.287277797579725_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +1.652641259134527_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-1 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.010541277690041_wp*F%F(nx-5, y, z, 1:3) &
            -0.003871162613547_wp*F%F(nx-4, y, z, 1:3) &
            +0.055083034651834_wp*F%F(nx-3, y, z, 1:3) &
            -0.536609351373804_wp*F%F(nx-2, y, z, 1:3) &
            -0.023839362303497_wp*F%F(nx-1, y, z, 1:3) &
            +0.519778119329056_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.012826390178158_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.016543588463787_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -0.012069260886192_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.492794588340281_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.023839362303497_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.484741685208605_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-2 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.035404132011385_wp*F%F(nx-5, y, z, 1:3) &
            +0.316060685455593_wp*F%F(nx-4, y, z, 1:3) &
            -0.970715017992531_wp*F%F(nx-3, y, z, 1:3) &
            -0.130177738642109_wp*F%F(nx-2, y, z, 1:3) &
            +1.085278449496368_wp*F%F(nx-1, y, z, 1:3) &
            -0.265042246305935_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.036596036410772_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.191046615066391_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.093040209981079_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -1.183314867676973_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.130177738642109_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +1.181771428955059_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.376125088556894_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-3 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.024714714773344_wp*F%F(nx-6, y, z, 1:3) &
            -0.048895491535142_wp*F%F(nx-5, y, z, 1:3) &
            -0.432569223319861_wp*F%F(nx-4, y, z, 1:3) &
            -0.128568030423532_wp*F%F(nx-3, y, z, 1:3) &
            +0.599353624941027_wp*F%F(nx-2, y, z, 1:3) &
            +0.013462903703635_wp*F%F(nx-1, y, z, 1:3) &
            -0.027498498139470_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.018536036080008_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.024901947461020_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.051698171178260_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.646438203986408_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.128568030423532_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.491670966630110_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.061443496682551_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.029578621056045_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-4 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.034108812717218_wp*F%F(nx-7, y, z, 1:3) &
            -0.171706864019631_wp*F%F(nx-6, y, z, 1:3) &
            -0.032619513655146_wp*F%F(nx-5, y, z, 1:3) &
            -0.654316700492022_wp*F%F(nx-4, y, z, 1:3) &
            +0.892150277081438_wp*F%F(nx-3, y, z, 1:3) &
            -0.065037598507823_wp*F%F(nx-2, y, z, 1:3) &
            +0.025468231112416_wp*F%F(nx-1, y, z, 1:3) &
            -0.028046644236449_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.025581609537913_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.034367212813561_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.338374926160583_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -1.407698379940242_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.654316700492022_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.596989395215000_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.220934883626644_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.005959508986299_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.024207129437336_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-5 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.030224353864466_wp*F%F(nx-8, y, z, 1:3) &
            -0.152152145022255_wp*F%F(nx-7, y, z, 1:3) &
            +0.039154276597149_wp*F%F(nx-6, y, z, 1:3) &
            -0.991469519492543_wp*F%F(nx-5, y, z, 1:3) &
            +1.247383610871689_wp*F%F(nx-4, y, z, 1:3) &
            -0.063223218805777_wp*F%F(nx-3, y, z, 1:3) &
            -0.118337825582297_wp*F%F(nx-2, y, z, 1:3) &
            -0.017497013784953_wp*F%F(nx-1, y, z, 1:3) &
            +0.025917481354520_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.022668265398350_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            +0.030453326242227_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.299839328678169_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -1.408180123230807_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.991469519492543_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.028904662609445_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.059795739181626_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.021929977651789_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.014379796536031_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.015923961762675_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if


!=================================================================================================
Jr_xU = 0.0_wp*Jr_xU


if ((y .ge. 7) .and. (y .le. ny-6 )) then 
!forward operator for stress
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
         +0.030769230769231_wp*F%F(x, y-3, z, 1:3) &
         -0.154895104895105_wp*F%F(x, y-2, z, 1:3) &
         +0.039860139860140_wp*F%F(x, y-1, z, 1:3) &
         -1.036130536130536_wp*F%F(x, y  , z, 1:3) &
         +1.433566433566434_wp*F%F(x, y+1, z, 1:3) &
         -0.305244755244755_wp*F%F(x, y+2, z, 1:3) &
         -0.031002331002331_wp*F%F(x, y+3, z, 1:3) &
         +0.023076923076923_wp*F%F(x, y+4, z, 1:3) &
          )
!backward operator for stress
Jr_xU(4:9) = (&
         -0.023076923076923_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
         +0.031002331002331_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
         +0.305244755244755_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
         -1.433566433566434_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
         +1.036130536130536_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         -0.039860139860140_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
         +0.154895104895105_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
         -0.030769230769231_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
          )
end if





if  ( y .eq. 1 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.083605380684408_wp*F%F(x, 6, z, 1:3) &
          -0.080170162229368_wp*F%F(x, 5, z, 1:3) &
          -0.108480538283818_wp*F%F(x, 4, z, 1:3) &
          -0.529591218616420_wp*F%F(x, 3, z, 1:3) &
          +2.287277797579725_wp*F%F(x, 2, z, 1:3) &
          -1.652641259134527_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.051367988538755_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.069195069390028_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.116686544755228_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.751550165218299_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +2.133100361304578_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -1.516063821692780_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 2 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.012826390178158_wp*F%F(x, 6, z, 1:3) &
          +0.016543588463787_wp*F%F(x, 5, z, 1:3) &
          +0.012069260886192_wp*F%F(x, 4, z, 1:3) &
          +0.492794588340281_wp*F%F(x, 3, z, 1:3) &
          -0.023839362303497_wp*F%F(x, 2, z, 1:3) &
          -0.484741685208605_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.010541277690041_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.003871162613547_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.055083034651834_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.536609351373804_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.023839362303497_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.519778119329056_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 3 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.036596036410772_wp*F%F(x, 7, z, 1:3) &
          -0.191046615066391_wp*F%F(x, 6, z, 1:3) &
          -0.093040209981079_wp*F%F(x, 5, z, 1:3) &
          +1.183314867676973_wp*F%F(x, 4, z, 1:3) &
          -0.130177738642109_wp*F%F(x, 3, z, 1:3) &
          -1.181771428955059_wp*F%F(x, 2, z, 1:3) &
          +0.376125088556894_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.035404132011385_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.316060685455593_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.970715017992531_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.130177738642109_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -1.085278449496368_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.265042246305935_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 4 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.018536036080008_wp*F%F(x, 8, z, 1:3) &
          -0.024901947461020_wp*F%F(x, 7, z, 1:3) &
          -0.051698171178260_wp*F%F(x, 6, z, 1:3) &
          +0.646438203986408_wp*F%F(x, 5, z, 1:3) &
          -0.128568030423532_wp*F%F(x, 4, z, 1:3) &
          -0.491670966630110_wp*F%F(x, 3, z, 1:3) &
          +0.061443496682551_wp*F%F(x, 2, z, 1:3) &
          -0.029578621056045_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.024714714773344_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.048895491535142_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.432569223319861_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.128568030423532_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.599353624941027_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.013462903703635_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.027498498139470_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 5 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.025581609537913_wp*F%F(x, 9, z, 1:3) &
          -0.034367212813561_wp*F%F(x, 8, z, 1:3) &
          -0.338374926160583_wp*F%F(x, 7, z, 1:3) &
          +1.407698379940242_wp*F%F(x, 6, z, 1:3) &
          -0.654316700492022_wp*F%F(x, 5, z, 1:3) &
          -0.596989395215000_wp*F%F(x, 4, z, 1:3) &
          +0.220934883626644_wp*F%F(x, 3, z, 1:3) &
          -0.005959508986299_wp*F%F(x, 2, z, 1:3) &
          -0.024207129437336_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.034108812717218_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.171706864019631_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.032619513655146_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.654316700492022_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.892150277081438_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.065037598507823_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.025468231112416_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.028046644236449_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 6 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.022668265398350_wp*F%F(x, 10, z, 1:3) &
          -0.030453326242227_wp*F%F(x, 9, z, 1:3) &
          -0.299839328678169_wp*F%F(x, 8, z, 1:3) &
          +1.408180123230807_wp*F%F(x, 7, z, 1:3) &
          -0.991469519492543_wp*F%F(x, 6, z, 1:3) &
          -0.028904662609445_wp*F%F(x, 5, z, 1:3) &
          -0.059795739181626_wp*F%F(x, 4, z, 1:3) &
          -0.021929977651789_wp*F%F(x, 3, z, 1:3) &
          -0.014379796536031_wp*F%F(x, 2, z, 1:3) &
          +0.015923961762675_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.030224353864466_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.152152145022255_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -0.039154276597149_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.991469519492543_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -1.247383610871689_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.063223218805777_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.118337825582297_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.017497013784953_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.025917481354520_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. ny ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.051367988538755_wp*F%F(x, ny-5, z, 1:3) &
            -0.069195069390028_wp*F%F(x, ny-4, z, 1:3) &
            -0.116686544755228_wp*F%F(x, ny-3, z, 1:3) &
            +0.751550165218299_wp*F%F(x, ny-2, z, 1:3) &
            -2.133100361304578_wp*F%F(x, ny-1, z, 1:3) &
            +1.516063821692780_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.083605380684408_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.080170162229368_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.108480538283818_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.529591218616420_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -2.287277797579725_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +1.652641259134527_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-1 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.010541277690041_wp*F%F(x, ny-5, z, 1:3) &
            -0.003871162613547_wp*F%F(x, ny-4, z, 1:3) &
            +0.055083034651834_wp*F%F(x, ny-3, z, 1:3) &
            -0.536609351373804_wp*F%F(x, ny-2, z, 1:3) &
            -0.023839362303497_wp*F%F(x, ny-1, z, 1:3) &
            +0.519778119329056_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.012826390178158_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.016543588463787_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -0.012069260886192_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.492794588340281_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.023839362303497_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.484741685208605_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-2 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.035404132011385_wp*F%F(x, ny-5, z, 1:3) &
            +0.316060685455593_wp*F%F(x, ny-4, z, 1:3) &
            -0.970715017992531_wp*F%F(x, ny-3, z, 1:3) &
            -0.130177738642109_wp*F%F(x, ny-2, z, 1:3) &
            +1.085278449496368_wp*F%F(x, ny-1, z, 1:3) &
            -0.265042246305935_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.036596036410772_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.191046615066391_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.093040209981079_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -1.183314867676973_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.130177738642109_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +1.181771428955059_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.376125088556894_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-3 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.024714714773344_wp*F%F(x, ny-6, z, 1:3) &
            -0.048895491535142_wp*F%F(x, ny-5, z, 1:3) &
            -0.432569223319861_wp*F%F(x, ny-4, z, 1:3) &
            -0.128568030423532_wp*F%F(x, ny-3, z, 1:3) &
            +0.599353624941027_wp*F%F(x, ny-2, z, 1:3) &
            +0.013462903703635_wp*F%F(x, ny-1, z, 1:3) &
            -0.027498498139470_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.018536036080008_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.024901947461020_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.051698171178260_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.646438203986408_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.128568030423532_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.491670966630110_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.061443496682551_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.029578621056045_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-4 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.034108812717218_wp*F%F(x, ny-7, z, 1:3) &
            -0.171706864019631_wp*F%F(x, ny-6, z, 1:3) &
            -0.032619513655146_wp*F%F(x, ny-5, z, 1:3) &
            -0.654316700492022_wp*F%F(x, ny-4, z, 1:3) &
            +0.892150277081438_wp*F%F(x, ny-3, z, 1:3) &
            -0.065037598507823_wp*F%F(x, ny-2, z, 1:3) &
            +0.025468231112416_wp*F%F(x, ny-1, z, 1:3) &
            -0.028046644236449_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.025581609537913_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.034367212813561_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.338374926160583_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -1.407698379940242_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.654316700492022_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.596989395215000_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.220934883626644_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.005959508986299_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.024207129437336_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-5 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.030224353864466_wp*F%F(x, ny-8, z, 1:3) &
            -0.152152145022255_wp*F%F(x, ny-7, z, 1:3) &
            +0.039154276597149_wp*F%F(x, ny-6, z, 1:3) &
            -0.991469519492543_wp*F%F(x, ny-5, z, 1:3) &
            +1.247383610871689_wp*F%F(x, ny-4, z, 1:3) &
            -0.063223218805777_wp*F%F(x, ny-3, z, 1:3) &
            -0.118337825582297_wp*F%F(x, ny-2, z, 1:3) &
            -0.017497013784953_wp*F%F(x, ny-1, z, 1:3) &
            +0.025917481354520_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.022668265398350_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            +0.030453326242227_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.299839328678169_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -1.408180123230807_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.991469519492543_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.028904662609445_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.059795739181626_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.021929977651789_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.014379796536031_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.015923961762675_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if


!=================================================================================================
Js_xU = 0.0_wp*Js_xU

if ((z .ge. 7) .and. (z .le. nz-6 )) then 
!forward operator for stress
Js_xU(1:3) = X_x(x, y, z, 3)*(&
         +0.030769230769231_wp*F%F(x, y, z-3, 1:3) &
         -0.154895104895105_wp*F%F(x, y, z-2, 1:3) &
         +0.039860139860140_wp*F%F(x, y, z-1, 1:3) &
         -1.036130536130536_wp*F%F(x, y  , z, 1:3) &
         +1.433566433566434_wp*F%F(x, y, z+1, 1:3) &
         -0.305244755244755_wp*F%F(x, y, z+2, 1:3) &
         -0.031002331002331_wp*F%F(x, y, z+3, 1:3) &
         +0.023076923076923_wp*F%F(x, y, z+4, 1:3) &
          )
!backward operator for stress
Js_xU(4:9) = (&
         -0.023076923076923_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
         +0.031002331002331_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
         +0.305244755244755_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
         -1.433566433566434_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
         +1.036130536130536_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         -0.039860139860140_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
         +0.154895104895105_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
         -0.030769230769231_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
          )
end if





if  ( z .eq. 1 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.083605380684408_wp*F%F(x, y, 6, 1:3) &
          -0.080170162229368_wp*F%F(x, y, 5, 1:3) &
          -0.108480538283818_wp*F%F(x, y, 4, 1:3) &
          -0.529591218616420_wp*F%F(x, y, 3, 1:3) &
          +2.287277797579725_wp*F%F(x, y, 2, 1:3) &
          -1.652641259134527_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.051367988538755_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.069195069390028_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.116686544755228_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.751550165218299_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +2.133100361304578_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -1.516063821692780_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 2 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.012826390178158_wp*F%F(x, y, 6, 1:3) &
          +0.016543588463787_wp*F%F(x, y, 5, 1:3) &
          +0.012069260886192_wp*F%F(x, y, 4, 1:3) &
          +0.492794588340281_wp*F%F(x, y, 3, 1:3) &
          -0.023839362303497_wp*F%F(x, y, 2, 1:3) &
          -0.484741685208605_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.010541277690041_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.003871162613547_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.055083034651834_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.536609351373804_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.023839362303497_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.519778119329056_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 3 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.036596036410772_wp*F%F(x, y, 7, 1:3) &
          -0.191046615066391_wp*F%F(x, y, 6, 1:3) &
          -0.093040209981079_wp*F%F(x, y, 5, 1:3) &
          +1.183314867676973_wp*F%F(x, y, 4, 1:3) &
          -0.130177738642109_wp*F%F(x, y, 3, 1:3) &
          -1.181771428955059_wp*F%F(x, y, 2, 1:3) &
          +0.376125088556894_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.035404132011385_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.316060685455593_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.970715017992531_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.130177738642109_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -1.085278449496368_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.265042246305935_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 4 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.018536036080008_wp*F%F(x, y, 8, 1:3) &
          -0.024901947461020_wp*F%F(x, y, 7, 1:3) &
          -0.051698171178260_wp*F%F(x, y, 6, 1:3) &
          +0.646438203986408_wp*F%F(x, y, 5, 1:3) &
          -0.128568030423532_wp*F%F(x, y, 4, 1:3) &
          -0.491670966630110_wp*F%F(x, y, 3, 1:3) &
          +0.061443496682551_wp*F%F(x, y, 2, 1:3) &
          -0.029578621056045_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.024714714773344_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.048895491535142_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.432569223319861_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.128568030423532_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.599353624941027_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.013462903703635_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.027498498139470_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 5 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.025581609537913_wp*F%F(x, y, 9, 1:3) &
          -0.034367212813561_wp*F%F(x, y, 8, 1:3) &
          -0.338374926160583_wp*F%F(x, y, 7, 1:3) &
          +1.407698379940242_wp*F%F(x, y, 6, 1:3) &
          -0.654316700492022_wp*F%F(x, y, 5, 1:3) &
          -0.596989395215000_wp*F%F(x, y, 4, 1:3) &
          +0.220934883626644_wp*F%F(x, y, 3, 1:3) &
          -0.005959508986299_wp*F%F(x, y, 2, 1:3) &
          -0.024207129437336_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.034108812717218_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.171706864019631_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.032619513655146_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.654316700492022_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.892150277081438_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.065037598507823_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.025468231112416_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.028046644236449_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 6 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.022668265398350_wp*F%F(x, y, 10, 1:3) &
          -0.030453326242227_wp*F%F(x, y, 9, 1:3) &
          -0.299839328678169_wp*F%F(x, y, 8, 1:3) &
          +1.408180123230807_wp*F%F(x, y, 7, 1:3) &
          -0.991469519492543_wp*F%F(x, y, 6, 1:3) &
          -0.028904662609445_wp*F%F(x, y, 5, 1:3) &
          -0.059795739181626_wp*F%F(x, y, 4, 1:3) &
          -0.021929977651789_wp*F%F(x, y, 3, 1:3) &
          -0.014379796536031_wp*F%F(x, y, 2, 1:3) &
          +0.015923961762675_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.030224353864466_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.152152145022255_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -0.039154276597149_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.991469519492543_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -1.247383610871689_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.063223218805777_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.118337825582297_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.017497013784953_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.025917481354520_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. nz ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.051367988538755_wp*F%F(x, y,  nz-5, 1:3) &
            -0.069195069390028_wp*F%F(x, y,  nz-4, 1:3) &
            -0.116686544755228_wp*F%F(x, y,  nz-3, 1:3) &
            +0.751550165218299_wp*F%F(x, y,  nz-2, 1:3) &
            -2.133100361304578_wp*F%F(x, y,  nz-1, 1:3) &
            +1.516063821692780_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.083605380684408_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.080170162229368_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.108480538283818_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.529591218616420_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -2.287277797579725_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +1.652641259134527_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-1 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.010541277690041_wp*F%F(x, y,  nz-5, 1:3) &
            -0.003871162613547_wp*F%F(x, y,  nz-4, 1:3) &
            +0.055083034651834_wp*F%F(x, y,  nz-3, 1:3) &
            -0.536609351373804_wp*F%F(x, y,  nz-2, 1:3) &
            -0.023839362303497_wp*F%F(x, y,  nz-1, 1:3) &
            +0.519778119329056_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.012826390178158_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.016543588463787_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -0.012069260886192_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.492794588340281_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.023839362303497_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.484741685208605_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-2 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.035404132011385_wp*F%F(x, y,  nz-5, 1:3) &
            +0.316060685455593_wp*F%F(x, y,  nz-4, 1:3) &
            -0.970715017992531_wp*F%F(x, y,  nz-3, 1:3) &
            -0.130177738642109_wp*F%F(x, y,  nz-2, 1:3) &
            +1.085278449496368_wp*F%F(x, y,  nz-1, 1:3) &
            -0.265042246305935_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.036596036410772_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.191046615066391_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.093040209981079_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -1.183314867676973_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.130177738642109_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +1.181771428955059_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.376125088556894_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-3 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.024714714773344_wp*F%F(x, y,  nz-6, 1:3) &
            -0.048895491535142_wp*F%F(x, y,  nz-5, 1:3) &
            -0.432569223319861_wp*F%F(x, y,  nz-4, 1:3) &
            -0.128568030423532_wp*F%F(x, y,  nz-3, 1:3) &
            +0.599353624941027_wp*F%F(x, y,  nz-2, 1:3) &
            +0.013462903703635_wp*F%F(x, y,  nz-1, 1:3) &
            -0.027498498139470_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.018536036080008_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.024901947461020_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.051698171178260_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.646438203986408_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.128568030423532_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.491670966630110_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.061443496682551_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.029578621056045_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-4 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.034108812717218_wp*F%F(x, y,  nz-7, 1:3) &
            -0.171706864019631_wp*F%F(x, y,  nz-6, 1:3) &
            -0.032619513655146_wp*F%F(x, y,  nz-5, 1:3) &
            -0.654316700492022_wp*F%F(x, y,  nz-4, 1:3) &
            +0.892150277081438_wp*F%F(x, y,  nz-3, 1:3) &
            -0.065037598507823_wp*F%F(x, y,  nz-2, 1:3) &
            +0.025468231112416_wp*F%F(x, y,  nz-1, 1:3) &
            -0.028046644236449_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.025581609537913_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.034367212813561_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.338374926160583_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -1.407698379940242_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.654316700492022_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.596989395215000_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.220934883626644_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.005959508986299_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.024207129437336_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-5 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.030224353864466_wp*F%F(x, y,  nz-8, 1:3) &
            -0.152152145022255_wp*F%F(x, y,  nz-7, 1:3) &
            +0.039154276597149_wp*F%F(x, y,  nz-6, 1:3) &
            -0.991469519492543_wp*F%F(x, y,  nz-5, 1:3) &
            +1.247383610871689_wp*F%F(x, y,  nz-4, 1:3) &
            -0.063223218805777_wp*F%F(x, y,  nz-3, 1:3) &
            -0.118337825582297_wp*F%F(x, y,  nz-2, 1:3) &
            -0.017497013784953_wp*F%F(x, y,  nz-1, 1:3) &
            +0.025917481354520_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.022668265398350_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            +0.030453326242227_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.299839328678169_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -1.408180123230807_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.991469519492543_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.028904662609445_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.059795739181626_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.021929977651789_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.014379796536031_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.015923961762675_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if


!=================================================================================================


Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)


    end subroutine JJU_x4_upwind_drp


    subroutine JJU_x5_upwind_drp(x, y, z, F, G, X_x, Ju_x)


!=============================================================================================
!
use datatypes, only: block_fields, block_grid_t

implicit none

integer, intent(in) :: x, y, z                      
type(block_fields), intent(in):: F
type(block_grid_t), intent(in) :: G
real(kind = wp), dimension(:), intent(out) :: Ju_x            

real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x  
real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            
real(kind = wp) :: hx, hy, hz                      
integer :: n, nx, ny, nz

nx = G%C%nq
ny = G%C%nr
nz = G%C%ns

n = size(F%F, 4)

hx = G%hq
hy = G%hr
hz = G%hs

! work arrays:
if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
if (.not. allocated(Js_xU)) allocate(Js_xU(n))

!=================================================================================================
Jq_xU = 0.0_wp*Jq_xU


if ((x .ge. 7) .and. (x .le. nx-6 )) then 
!forward operator for stress
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
         +0.024761904761905_wp*F%F(x-3, y, z, 1:3) &
         -0.103809523809524_wp*F%F(x-2, y, z, 1:3) &
         -0.097142857142857_wp*F%F(x-1, y, z, 1:3) &
         -0.907142857142857_wp*F%F(x  , y, z, 1:3) &
         +1.476190476190476_wp*F%F(x+1, y, z, 1:3) &
         -0.477142857142857_wp*F%F(x+2, y, z, 1:3) &
         +0.089523809523810_wp*F%F(x+3, y, z, 1:3) &
         -0.005238095238095_wp*F%F(x+4, y, z, 1:3) &
          )
!backward operator for stress
Jq_xU(4:9) = (&
         +0.005238095238095_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
         -0.089523809523810_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
         +0.477142857142857_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
         -1.476190476190476_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
         +0.907142857142857_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.097142857142857_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
         +0.103809523809524_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
         -0.024761904761905_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
          )
end if





if  ( x .eq. 1 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.072885147772435_wp*F%F(6, y, z, 1:3) &
          -0.090178034086616_wp*F%F(5, y, z, 1:3) &
          -0.038005614651649_wp*F%F(4, y, z, 1:3) &
          -0.573766429249709_wp*F%F(3, y, z, 1:3) &
          +2.257836099938654_wp*F%F(2, y, z, 1:3) &
          -1.628771169723114_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.041644766251343_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.052812574719352_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.106532278810429_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.720024622233964_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +2.117425940415952_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -1.515101405460425_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 2 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.019148214561691_wp*F%F(6, y, z, 1:3) &
          +0.040805723142778_wp*F%F(5, y, z, 1:3) &
          -0.020859228219757_wp*F%F(4, y, z, 1:3) &
          +0.509225491419513_wp*F%F(3, y, z, 1:3) &
          -0.023355117942411_wp*F%F(2, y, z, 1:3) &
          -0.486668653838431_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.004020265164097_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.021405556971630_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.069397771764030_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.539557321821336_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.023355117942411_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.518940490135445_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 3 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.008286103598608_wp*F%F(7, y, z, 1:3) &
          -0.021628503553831_wp*F%F(6, y, z, 1:3) &
          -0.291072632936714_wp*F%F(5, y, z, 1:3) &
          +1.223557424782510_wp*F%F(4, y, z, 1:3) &
          -0.083659887209816_wp*F%F(3, y, z, 1:3) &
          -1.181202828820238_wp*F%F(2, y, z, 1:3) &
          +0.362292531336697_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.028539075417234_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.336917827047784_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +1.050818773634850_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.083659887209816_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -1.114800164219214_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.288700255005099_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 4 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.004209850692383_wp*F%F(8, y, z, 1:3) &
          +0.071950175469823_wp*F%F(7, y, z, 1:3) &
          -0.224870941726773_wp*F%F(6, y, z, 1:3) &
          +0.789524116270268_wp*F%F(5, y, z, 1:3) &
          -0.148466808677722_wp*F%F(4, y, z, 1:3) &
          -0.533880621828011_wp*F%F(3, y, z, 1:3) &
          +0.077187815269725_wp*F%F(2, y, z, 1:3) &
          -0.027233884084927_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.019901112363994_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.053449194883925_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.406711133400168_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.148466808677722_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.621642489813528_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.023200719757549_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.009715745458156_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 5 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.005783810176449_wp*F%F(9, y, z, 1:3) &
          +0.098850573924765_wp*F%F(8, y, z, 1:3) &
          -0.526852526981992_wp*F%F(7, y, z, 1:3) &
          +1.519540438454323_wp*F%F(6, y, z, 1:3) &
          -0.710898955238036_wp*F%F(5, y, z, 1:3) &
          -0.558770408767943_wp*F%F(4, y, z, 1:3) &
          +0.235173110439205_wp*F%F(3, y, z, 1:3) &
          -0.032709740063860_wp*F%F(2, y, z, 1:3) &
          -0.018548681590012_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.027341648106850_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.114624601678717_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.114036250796460_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.710898955238036_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -1.084707737140850_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.203172557092824_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.062355051021897_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.031672071463559_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 6 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.005155833793284_wp*F%F(10, y, z, 1:3) &
          +0.088117886648847_wp*F%F(9, y, z, 1:3) &
          -0.469649587351832_wp*F%F(8, y, z, 1:3) &
          +1.453007705379920_wp*F%F(7, y, z, 1:3) &
          -0.889009978410866_wp*F%F(6, y, z, 1:3) &
          -0.101654780772340_wp*F%F(5, y, z, 1:3) &
          -0.065459605421383_wp*F%F(4, y, z, 1:3) &
          -0.017757770912974_wp*F%F(3, y, z, 1:3) &
          -0.005476336634130_wp*F%F(2, y, z, 1:3) &
          +0.013038301268042_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.024373032477341_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.102179251539620_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.095617281257259_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.889009978410866_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -1.354556547299028_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.275401026117162_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.013457829508641_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.026083371270839_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.022819158328019_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. nx ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.041644766251343_wp*F%F(nx-5, y, z, 1:3) &
            -0.052812574719352_wp*F%F(nx-4, y, z, 1:3) &
            -0.106532278810429_wp*F%F(nx-3, y, z, 1:3) &
            +0.720024622233964_wp*F%F(nx-2, y, z, 1:3) &
            -2.117425940415952_wp*F%F(nx-1, y, z, 1:3) &
            +1.515101405460425_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.072885147772435_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.090178034086616_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.038005614651649_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.573766429249709_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -2.257836099938654_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +1.628771169723114_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-1 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.004020265164097_wp*F%F(nx-5, y, z, 1:3) &
            -0.021405556971630_wp*F%F(nx-4, y, z, 1:3) &
            +0.069397771764030_wp*F%F(nx-3, y, z, 1:3) &
            -0.539557321821336_wp*F%F(nx-2, y, z, 1:3) &
            -0.023355117942411_wp*F%F(nx-1, y, z, 1:3) &
            +0.518940490135445_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.019148214561691_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.040805723142778_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.020859228219757_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.509225491419513_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.023355117942411_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.486668653838431_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-2 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.028539075417234_wp*F%F(nx-5, y, z, 1:3) &
            +0.336917827047784_wp*F%F(nx-4, y, z, 1:3) &
            -1.050818773634850_wp*F%F(nx-3, y, z, 1:3) &
            -0.083659887209816_wp*F%F(nx-2, y, z, 1:3) &
            +1.114800164219214_wp*F%F(nx-1, y, z, 1:3) &
            -0.288700255005099_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.008286103598608_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.021628503553831_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.291072632936714_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -1.223557424782510_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.083659887209816_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +1.181202828820238_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.362292531336697_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-3 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.019901112363994_wp*F%F(nx-6, y, z, 1:3) &
            -0.053449194883925_wp*F%F(nx-5, y, z, 1:3) &
            -0.406711133400168_wp*F%F(nx-4, y, z, 1:3) &
            -0.148466808677722_wp*F%F(nx-3, y, z, 1:3) &
            +0.621642489813528_wp*F%F(nx-2, y, z, 1:3) &
            -0.023200719757549_wp*F%F(nx-1, y, z, 1:3) &
            -0.009715745458156_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.004209850692383_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.071950175469823_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.224870941726773_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.789524116270268_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.148466808677722_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.533880621828011_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.077187815269725_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.027233884084927_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-4 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.027341648106850_wp*F%F(nx-7, y, z, 1:3) &
            -0.114624601678717_wp*F%F(nx-6, y, z, 1:3) &
            -0.114036250796460_wp*F%F(nx-5, y, z, 1:3) &
            -0.710898955238036_wp*F%F(nx-4, y, z, 1:3) &
            +1.084707737140850_wp*F%F(nx-3, y, z, 1:3) &
            -0.203172557092824_wp*F%F(nx-2, y, z, 1:3) &
            +0.062355051021897_wp*F%F(nx-1, y, z, 1:3) &
            -0.031672071463559_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.005783810176449_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            -0.098850573924765_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.526852526981992_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -1.519540438454323_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.710898955238036_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.558770408767943_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.235173110439205_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.032709740063860_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.018548681590012_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-5 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.024373032477341_wp*F%F(nx-8, y, z, 1:3) &
            -0.102179251539620_wp*F%F(nx-7, y, z, 1:3) &
            -0.095617281257259_wp*F%F(nx-6, y, z, 1:3) &
            -0.889009978410866_wp*F%F(nx-5, y, z, 1:3) &
            +1.354556547299028_wp*F%F(nx-4, y, z, 1:3) &
            -0.275401026117162_wp*F%F(nx-3, y, z, 1:3) &
            -0.013457829508641_wp*F%F(nx-2, y, z, 1:3) &
            -0.026083371270839_wp*F%F(nx-1, y, z, 1:3) &
            +0.022819158328019_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.005155833793284_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            -0.088117886648847_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.469649587351832_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -1.453007705379920_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.889009978410866_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.101654780772340_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.065459605421383_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.017757770912974_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.005476336634130_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.013038301268042_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if


!=================================================================================================
Jr_xU = 0.0_wp*Jr_xU


if ((y .ge. 7) .and. (y .le. ny-6 )) then 
!forward operator for stress
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
         +0.024761904761905_wp*F%F(x, y-3, z, 1:3) &
         -0.103809523809524_wp*F%F(x, y-2, z, 1:3) &
         -0.097142857142857_wp*F%F(x, y-1, z, 1:3) &
         -0.907142857142857_wp*F%F(x, y  , z, 1:3) &
         +1.476190476190476_wp*F%F(x, y+1, z, 1:3) &
         -0.477142857142857_wp*F%F(x, y+2, z, 1:3) &
         +0.089523809523810_wp*F%F(x, y+3, z, 1:3) &
         -0.005238095238095_wp*F%F(x, y+4, z, 1:3) &
          )
!backward operator for stress
Jr_xU(4:9) = (&
         +0.005238095238095_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
         -0.089523809523810_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
         +0.477142857142857_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
         -1.476190476190476_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
         +0.907142857142857_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.097142857142857_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
         +0.103809523809524_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
         -0.024761904761905_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
          )
end if





if  ( y .eq. 1 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.072885147772435_wp*F%F(x, 6, z, 1:3) &
          -0.090178034086616_wp*F%F(x, 5, z, 1:3) &
          -0.038005614651649_wp*F%F(x, 4, z, 1:3) &
          -0.573766429249709_wp*F%F(x, 3, z, 1:3) &
          +2.257836099938654_wp*F%F(x, 2, z, 1:3) &
          -1.628771169723114_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.041644766251343_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.052812574719352_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.106532278810429_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.720024622233964_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +2.117425940415952_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -1.515101405460425_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 2 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.019148214561691_wp*F%F(x, 6, z, 1:3) &
          +0.040805723142778_wp*F%F(x, 5, z, 1:3) &
          -0.020859228219757_wp*F%F(x, 4, z, 1:3) &
          +0.509225491419513_wp*F%F(x, 3, z, 1:3) &
          -0.023355117942411_wp*F%F(x, 2, z, 1:3) &
          -0.486668653838431_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.004020265164097_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.021405556971630_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.069397771764030_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.539557321821336_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.023355117942411_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.518940490135445_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 3 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.008286103598608_wp*F%F(x, 7, z, 1:3) &
          -0.021628503553831_wp*F%F(x, 6, z, 1:3) &
          -0.291072632936714_wp*F%F(x, 5, z, 1:3) &
          +1.223557424782510_wp*F%F(x, 4, z, 1:3) &
          -0.083659887209816_wp*F%F(x, 3, z, 1:3) &
          -1.181202828820238_wp*F%F(x, 2, z, 1:3) &
          +0.362292531336697_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.028539075417234_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.336917827047784_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +1.050818773634850_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.083659887209816_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -1.114800164219214_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.288700255005099_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 4 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.004209850692383_wp*F%F(x, 8, z, 1:3) &
          +0.071950175469823_wp*F%F(x, 7, z, 1:3) &
          -0.224870941726773_wp*F%F(x, 6, z, 1:3) &
          +0.789524116270268_wp*F%F(x, 5, z, 1:3) &
          -0.148466808677722_wp*F%F(x, 4, z, 1:3) &
          -0.533880621828011_wp*F%F(x, 3, z, 1:3) &
          +0.077187815269725_wp*F%F(x, 2, z, 1:3) &
          -0.027233884084927_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.019901112363994_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.053449194883925_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.406711133400168_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.148466808677722_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.621642489813528_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.023200719757549_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.009715745458156_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 5 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.005783810176449_wp*F%F(x, 9, z, 1:3) &
          +0.098850573924765_wp*F%F(x, 8, z, 1:3) &
          -0.526852526981992_wp*F%F(x, 7, z, 1:3) &
          +1.519540438454323_wp*F%F(x, 6, z, 1:3) &
          -0.710898955238036_wp*F%F(x, 5, z, 1:3) &
          -0.558770408767943_wp*F%F(x, 4, z, 1:3) &
          +0.235173110439205_wp*F%F(x, 3, z, 1:3) &
          -0.032709740063860_wp*F%F(x, 2, z, 1:3) &
          -0.018548681590012_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.027341648106850_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.114624601678717_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.114036250796460_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.710898955238036_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -1.084707737140850_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.203172557092824_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.062355051021897_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.031672071463559_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 6 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.005155833793284_wp*F%F(x, 10, z, 1:3) &
          +0.088117886648847_wp*F%F(x, 9, z, 1:3) &
          -0.469649587351832_wp*F%F(x, 8, z, 1:3) &
          +1.453007705379920_wp*F%F(x, 7, z, 1:3) &
          -0.889009978410866_wp*F%F(x, 6, z, 1:3) &
          -0.101654780772340_wp*F%F(x, 5, z, 1:3) &
          -0.065459605421383_wp*F%F(x, 4, z, 1:3) &
          -0.017757770912974_wp*F%F(x, 3, z, 1:3) &
          -0.005476336634130_wp*F%F(x, 2, z, 1:3) &
          +0.013038301268042_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.024373032477341_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.102179251539620_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.095617281257259_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.889009978410866_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -1.354556547299028_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.275401026117162_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.013457829508641_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.026083371270839_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.022819158328019_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. ny ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.041644766251343_wp*F%F(x, ny-5, z, 1:3) &
            -0.052812574719352_wp*F%F(x, ny-4, z, 1:3) &
            -0.106532278810429_wp*F%F(x, ny-3, z, 1:3) &
            +0.720024622233964_wp*F%F(x, ny-2, z, 1:3) &
            -2.117425940415952_wp*F%F(x, ny-1, z, 1:3) &
            +1.515101405460425_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.072885147772435_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.090178034086616_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.038005614651649_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.573766429249709_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -2.257836099938654_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +1.628771169723114_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-1 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.004020265164097_wp*F%F(x, ny-5, z, 1:3) &
            -0.021405556971630_wp*F%F(x, ny-4, z, 1:3) &
            +0.069397771764030_wp*F%F(x, ny-3, z, 1:3) &
            -0.539557321821336_wp*F%F(x, ny-2, z, 1:3) &
            -0.023355117942411_wp*F%F(x, ny-1, z, 1:3) &
            +0.518940490135445_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.019148214561691_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.040805723142778_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.020859228219757_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.509225491419513_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.023355117942411_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.486668653838431_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-2 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.028539075417234_wp*F%F(x, ny-5, z, 1:3) &
            +0.336917827047784_wp*F%F(x, ny-4, z, 1:3) &
            -1.050818773634850_wp*F%F(x, ny-3, z, 1:3) &
            -0.083659887209816_wp*F%F(x, ny-2, z, 1:3) &
            +1.114800164219214_wp*F%F(x, ny-1, z, 1:3) &
            -0.288700255005099_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.008286103598608_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.021628503553831_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.291072632936714_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -1.223557424782510_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.083659887209816_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +1.181202828820238_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.362292531336697_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-3 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.019901112363994_wp*F%F(x, ny-6, z, 1:3) &
            -0.053449194883925_wp*F%F(x, ny-5, z, 1:3) &
            -0.406711133400168_wp*F%F(x, ny-4, z, 1:3) &
            -0.148466808677722_wp*F%F(x, ny-3, z, 1:3) &
            +0.621642489813528_wp*F%F(x, ny-2, z, 1:3) &
            -0.023200719757549_wp*F%F(x, ny-1, z, 1:3) &
            -0.009715745458156_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.004209850692383_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.071950175469823_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.224870941726773_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.789524116270268_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.148466808677722_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.533880621828011_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.077187815269725_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.027233884084927_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-4 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.027341648106850_wp*F%F(x, ny-7, z, 1:3) &
            -0.114624601678717_wp*F%F(x, ny-6, z, 1:3) &
            -0.114036250796460_wp*F%F(x, ny-5, z, 1:3) &
            -0.710898955238036_wp*F%F(x, ny-4, z, 1:3) &
            +1.084707737140850_wp*F%F(x, ny-3, z, 1:3) &
            -0.203172557092824_wp*F%F(x, ny-2, z, 1:3) &
            +0.062355051021897_wp*F%F(x, ny-1, z, 1:3) &
            -0.031672071463559_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.005783810176449_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            -0.098850573924765_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.526852526981992_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -1.519540438454323_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.710898955238036_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.558770408767943_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.235173110439205_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.032709740063860_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.018548681590012_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-5 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.024373032477341_wp*F%F(x, ny-8, z, 1:3) &
            -0.102179251539620_wp*F%F(x, ny-7, z, 1:3) &
            -0.095617281257259_wp*F%F(x, ny-6, z, 1:3) &
            -0.889009978410866_wp*F%F(x, ny-5, z, 1:3) &
            +1.354556547299028_wp*F%F(x, ny-4, z, 1:3) &
            -0.275401026117162_wp*F%F(x, ny-3, z, 1:3) &
            -0.013457829508641_wp*F%F(x, ny-2, z, 1:3) &
            -0.026083371270839_wp*F%F(x, ny-1, z, 1:3) &
            +0.022819158328019_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.005155833793284_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            -0.088117886648847_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.469649587351832_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -1.453007705379920_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.889009978410866_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.101654780772340_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.065459605421383_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.017757770912974_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.005476336634130_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.013038301268042_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if


!=================================================================================================
Js_xU = 0.0_wp*Js_xU


if ((z .ge. 7) .and. (z .le. nz-6 )) then 
!forward operator for stress
Js_xU(1:3) = X_x(x, y, z, 3)*(&
         +0.024761904761905_wp*F%F(x, y, z-3, 1:3) &
         -0.103809523809524_wp*F%F(x, y, z-2, 1:3) &
         -0.097142857142857_wp*F%F(x, y, z-1, 1:3) &
         -0.907142857142857_wp*F%F(x, y  , z, 1:3) &
         +1.476190476190476_wp*F%F(x, y, z+1, 1:3) &
         -0.477142857142857_wp*F%F(x, y, z+2, 1:3) &
         +0.089523809523810_wp*F%F(x, y, z+3, 1:3) &
         -0.005238095238095_wp*F%F(x, y, z+4, 1:3) &
          )
!backward operator for stress
Js_xU(4:9) = (&
         +0.005238095238095_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
         -0.089523809523810_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
         +0.477142857142857_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
         -1.476190476190476_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
         +0.907142857142857_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.097142857142857_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
         +0.103809523809524_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
         -0.024761904761905_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
          )
end if





if  ( z .eq. 1 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.072885147772435_wp*F%F(x, y, 6, 1:3) &
          -0.090178034086616_wp*F%F(x, y, 5, 1:3) &
          -0.038005614651649_wp*F%F(x, y, 4, 1:3) &
          -0.573766429249709_wp*F%F(x, y, 3, 1:3) &
          +2.257836099938654_wp*F%F(x, y, 2, 1:3) &
          -1.628771169723114_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.041644766251343_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.052812574719352_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.106532278810429_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.720024622233964_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +2.117425940415952_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -1.515101405460425_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 2 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.019148214561691_wp*F%F(x, y, 6, 1:3) &
          +0.040805723142778_wp*F%F(x, y, 5, 1:3) &
          -0.020859228219757_wp*F%F(x, y, 4, 1:3) &
          +0.509225491419513_wp*F%F(x, y, 3, 1:3) &
          -0.023355117942411_wp*F%F(x, y, 2, 1:3) &
          -0.486668653838431_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.004020265164097_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.021405556971630_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.069397771764030_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.539557321821336_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.023355117942411_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.518940490135445_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 3 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.008286103598608_wp*F%F(x, y, 7, 1:3) &
          -0.021628503553831_wp*F%F(x, y, 6, 1:3) &
          -0.291072632936714_wp*F%F(x, y, 5, 1:3) &
          +1.223557424782510_wp*F%F(x, y, 4, 1:3) &
          -0.083659887209816_wp*F%F(x, y, 3, 1:3) &
          -1.181202828820238_wp*F%F(x, y, 2, 1:3) &
          +0.362292531336697_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.028539075417234_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.336917827047784_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +1.050818773634850_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.083659887209816_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -1.114800164219214_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.288700255005099_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 4 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.004209850692383_wp*F%F(x, y, 8, 1:3) &
          +0.071950175469823_wp*F%F(x, y, 7, 1:3) &
          -0.224870941726773_wp*F%F(x, y, 6, 1:3) &
          +0.789524116270268_wp*F%F(x, y, 5, 1:3) &
          -0.148466808677722_wp*F%F(x, y, 4, 1:3) &
          -0.533880621828011_wp*F%F(x, y, 3, 1:3) &
          +0.077187815269725_wp*F%F(x, y, 2, 1:3) &
          -0.027233884084927_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.019901112363994_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.053449194883925_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.406711133400168_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.148466808677722_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.621642489813528_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.023200719757549_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.009715745458156_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 5 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.005783810176449_wp*F%F(x, y, 9, 1:3) &
          +0.098850573924765_wp*F%F(x, y, 8, 1:3) &
          -0.526852526981992_wp*F%F(x, y, 7, 1:3) &
          +1.519540438454323_wp*F%F(x, y, 6, 1:3) &
          -0.710898955238036_wp*F%F(x, y, 5, 1:3) &
          -0.558770408767943_wp*F%F(x, y, 4, 1:3) &
          +0.235173110439205_wp*F%F(x, y, 3, 1:3) &
          -0.032709740063860_wp*F%F(x, y, 2, 1:3) &
          -0.018548681590012_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.027341648106850_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.114624601678717_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.114036250796460_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.710898955238036_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -1.084707737140850_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.203172557092824_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.062355051021897_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.031672071463559_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 6 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.005155833793284_wp*F%F(x, y, 10, 1:3) &
          +0.088117886648847_wp*F%F(x, y, 9, 1:3) &
          -0.469649587351832_wp*F%F(x, y, 8, 1:3) &
          +1.453007705379920_wp*F%F(x, y, 7, 1:3) &
          -0.889009978410866_wp*F%F(x, y, 6, 1:3) &
          -0.101654780772340_wp*F%F(x, y, 5, 1:3) &
          -0.065459605421383_wp*F%F(x, y, 4, 1:3) &
          -0.017757770912974_wp*F%F(x, y, 3, 1:3) &
          -0.005476336634130_wp*F%F(x, y, 2, 1:3) &
          +0.013038301268042_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.024373032477341_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.102179251539620_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.095617281257259_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.889009978410866_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -1.354556547299028_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.275401026117162_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.013457829508641_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.026083371270839_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.022819158328019_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. nz ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.041644766251343_wp*F%F(x, y,  nz-5, 1:3) &
            -0.052812574719352_wp*F%F(x, y,  nz-4, 1:3) &
            -0.106532278810429_wp*F%F(x, y,  nz-3, 1:3) &
            +0.720024622233964_wp*F%F(x, y,  nz-2, 1:3) &
            -2.117425940415952_wp*F%F(x, y,  nz-1, 1:3) &
            +1.515101405460425_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.072885147772435_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.090178034086616_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.038005614651649_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.573766429249709_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -2.257836099938654_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +1.628771169723114_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-1 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.004020265164097_wp*F%F(x, y,  nz-5, 1:3) &
            -0.021405556971630_wp*F%F(x, y,  nz-4, 1:3) &
            +0.069397771764030_wp*F%F(x, y,  nz-3, 1:3) &
            -0.539557321821336_wp*F%F(x, y,  nz-2, 1:3) &
            -0.023355117942411_wp*F%F(x, y,  nz-1, 1:3) &
            +0.518940490135445_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.019148214561691_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.040805723142778_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.020859228219757_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.509225491419513_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.023355117942411_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.486668653838431_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-2 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.028539075417234_wp*F%F(x, y,  nz-5, 1:3) &
            +0.336917827047784_wp*F%F(x, y,  nz-4, 1:3) &
            -1.050818773634850_wp*F%F(x, y,  nz-3, 1:3) &
            -0.083659887209816_wp*F%F(x, y,  nz-2, 1:3) &
            +1.114800164219214_wp*F%F(x, y,  nz-1, 1:3) &
            -0.288700255005099_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.008286103598608_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.021628503553831_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.291072632936714_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -1.223557424782510_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.083659887209816_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +1.181202828820238_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.362292531336697_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-3 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.019901112363994_wp*F%F(x, y,  nz-6, 1:3) &
            -0.053449194883925_wp*F%F(x, y,  nz-5, 1:3) &
            -0.406711133400168_wp*F%F(x, y,  nz-4, 1:3) &
            -0.148466808677722_wp*F%F(x, y,  nz-3, 1:3) &
            +0.621642489813528_wp*F%F(x, y,  nz-2, 1:3) &
            -0.023200719757549_wp*F%F(x, y,  nz-1, 1:3) &
            -0.009715745458156_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.004209850692383_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.071950175469823_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.224870941726773_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.789524116270268_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.148466808677722_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.533880621828011_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.077187815269725_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.027233884084927_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-4 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.027341648106850_wp*F%F(x, y,  nz-7, 1:3) &
            -0.114624601678717_wp*F%F(x, y,  nz-6, 1:3) &
            -0.114036250796460_wp*F%F(x, y,  nz-5, 1:3) &
            -0.710898955238036_wp*F%F(x, y,  nz-4, 1:3) &
            +1.084707737140850_wp*F%F(x, y,  nz-3, 1:3) &
            -0.203172557092824_wp*F%F(x, y,  nz-2, 1:3) &
            +0.062355051021897_wp*F%F(x, y,  nz-1, 1:3) &
            -0.031672071463559_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.005783810176449_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            -0.098850573924765_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.526852526981992_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -1.519540438454323_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.710898955238036_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.558770408767943_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.235173110439205_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.032709740063860_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.018548681590012_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-5 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.024373032477341_wp*F%F(x, y,  nz-8, 1:3) &
            -0.102179251539620_wp*F%F(x, y,  nz-7, 1:3) &
            -0.095617281257259_wp*F%F(x, y,  nz-6, 1:3) &
            -0.889009978410866_wp*F%F(x, y,  nz-5, 1:3) &
            +1.354556547299028_wp*F%F(x, y,  nz-4, 1:3) &
            -0.275401026117162_wp*F%F(x, y,  nz-3, 1:3) &
            -0.013457829508641_wp*F%F(x, y,  nz-2, 1:3) &
            -0.026083371270839_wp*F%F(x, y,  nz-1, 1:3) &
            +0.022819158328019_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.005155833793284_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            -0.088117886648847_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.469649587351832_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -1.453007705379920_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.889009978410866_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.101654780772340_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.065459605421383_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.017757770912974_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.005476336634130_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.013038301268042_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if


!=================================================================================================


Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)


    end subroutine JJU_x5_upwind_drp

subroutine JJU_x6_upwind_drp(x, y, z, F, G, X_x, Ju_x)


     !=================================================================================================
     !
     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     integer, intent(in) :: x, y, z                      
     type(block_fields), intent(in):: F
     type(block_grid_t), intent(in) :: G
     real(kind = wp), dimension(:), intent(out) :: Ju_x           
 
     real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   
     real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU           
     real(kind = wp) :: hx, hy, hz                      
     integer :: n, nx, ny, nz
 
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))
!=================================================================================================
Jq_xU = 0.0_wp*Jq_xU


if ((x .ge. 9) .and. (x .le. nx-8 )) then 
!forward operator for stress
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
         -0.005952380952381_wp*F%F(x-4, y, z, 1:3) &
         +0.047301587301587_wp*F%F(x-3, y, z, 1:3) &
         -0.126349206349206_wp*F%F(x-2, y, z, 1:3) &
         -0.106666666666667_wp*F%F(x-1, y, z, 1:3) &
         -0.888888888888889_wp*F%F(x  , y, z, 1:3) &
         +1.488888888888889_wp*F%F(x+1, y, z, 1:3) &
         -0.493333333333333_wp*F%F(x+2, y, z, 1:3) &
         +0.078730158730159_wp*F%F(x+3, y, z, 1:3) &
         +0.011031746031746_wp*F%F(x+4, y, z, 1:3) &
         -0.004761904761905_wp*F%F(x+5, y, z, 1:3) &
          )
!backward operator for stress
Jq_xU(4:9) = (&
         +0.004761904761905_wp*X_x(x-5, y, z, 1)*G%J(x-5,y,z) *F%F(x-5, y, z, 4:n) &
         -0.011031746031746_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
         -0.078730158730159_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
         +0.493333333333333_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
         -1.488888888888889_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
         +0.888888888888889_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.106666666666667_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
         +0.126349206349206_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
         -0.047301587301587_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
         +0.005952380952381_wp*X_x(x+4, y, z, 1)*G%J(x+4,y,z) *F%F(x+4, y, z, 4:n) &
          )
end if





if  ( x .eq. 1 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.033005239880522_wp*F%F(8, y, z, 1:3) &
          -0.025881634391799_wp*F%F(7, y, z, 1:3) &
          +0.263392722344631_wp*F%F(6, y, z, 1:3) &
          -0.030209714180198_wp*F%F(5, y, z, 1:3) &
          -0.506938949737935_wp*F%F(4, y, z, 1:3) &
          -0.350517535783371_wp*F%F(3, y, z, 1:3) &
          +2.412053651292632_wp*F%F(2, y, z, 1:3) &
          -1.728893299663438_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.044374156234105_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -0.174198378773702_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.220245640409051_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.139299657443443_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.495449593250587_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.370787168310084_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +2.304067463556378_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -1.667551777308605_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 2 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.008828095360976_wp*F%F(8, y, z, 1:3) &
          +0.029911851210588_wp*F%F(7, y, z, 1:3) &
          -0.170162903794152_wp*F%F(6, y, z, 1:3) &
          +0.094426023794218_wp*F%F(5, y, z, 1:3) &
          +0.250037914252055_wp*F%F(4, y, z, 1:3) &
          +0.250891381680726_wp*F%F(3, y, z, 1:3) &
          -0.020053857114091_wp*F%F(2, y, z, 1:3) &
          -0.443878505390320_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.011723708576681_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.065174528307485_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -0.148801997699767_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.046588172420165_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.241839854684496_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.251551333921227_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.020053857114091_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.464682040171017_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 3 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.086554962191340_wp*F%F(8, y, z, 1:3) &
          +0.357259827206167_wp*F%F(7, y, z, 1:3) &
          -0.022134128148434_wp*F%F(6, y, z, 1:3) &
          -1.484851853641141_wp*F%F(5, y, z, 1:3) &
          +2.378309161955782_wp*F%F(4, y, z, 1:3) &
          -0.045718284610534_wp*F%F(3, y, z, 1:3) &
          -1.531087089237169_wp*F%F(2, y, z, 1:3) &
          +0.434777328666669_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.156241518792227_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.505832529848511_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -0.010613520806507_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -1.646697927315869_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +2.378062811419621_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.045718284610534_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -1.527070237729393_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.411009578765331_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 4 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.002634349609551_wp*F%F(9, y, z, 1:3) &
          +0.079463252429367_wp*F%F(8, y, z, 1:3) &
          -0.299393382304440_wp*F%F(7, y, z, 1:3) &
          +0.407288103594466_wp*F%F(6, y, z, 1:3) &
          +0.281750824243924_wp*F%F(5, y, z, 1:3) &
          -0.012373610391183_wp*F%F(4, y, z, 1:3) &
          -0.330330927617320_wp*F%F(3, y, z, 1:3) &
          -0.204468804842354_wp*F%F(2, y, z, 1:3) &
          +0.080698894497091_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.061651661535115_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -0.263535772373310_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.389840903051706_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.258864496540571_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.012373610391183_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.330365147571788_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.211400033956727_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.082570282383251_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 5 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.011812293127050_wp*F%F(10, y, z, 1:3) &
          +0.027365145744332_wp*F%F(9, y, z, 1:3) &
          -0.517048981121307_wp*F%F(8, y, z, 1:3) &
          +1.165933921548919_wp*F%F(7, y, z, 1:3) &
          +0.122648484113833_wp*F%F(6, y, z, 1:3) &
          -0.373648890457135_wp*F%F(5, y, z, 1:3) &
          -1.160735576719516_wp*F%F(4, y, z, 1:3) &
          +1.025653483809176_wp*F%F(3, y, z, 1:3) &
          -0.176618285456005_wp*F%F(2, y, z, 1:3) &
          -0.101737008335247_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.014765366408812_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          -0.428167834093026_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +1.111936792339292_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -0.397762766470929_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.373648890457135_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -1.263356736209345_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.924846902011930_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.357974171524791_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.022063557080921_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 6 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.003705846074975_wp*F%F(11, y, z, 1:3) &
          +0.008585210073693_wp*F%F(10, y, z, 1:3) &
          +0.061269988439591_wp*F%F(9, y, z, 1:3) &
          -0.203098167192540_wp*F%F(8, y, z, 1:3) &
          +0.696367795879953_wp*F%F(7, y, z, 1:3) &
          -0.264391437780108_wp*F%F(6, y, z, 1:3) &
          +0.124789282744944_wp*F%F(5, y, z, 1:3) &
          -0.548404955515763_wp*F%F(4, y, z, 1:3) &
          +0.002073955135157_wp*F%F(3, y, z, 1:3) &
          +0.176979071835593_wp*F%F(2, y, z, 1:3) &
          -0.050464897545544_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.004632307593719_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
          -0.036811404344754_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.195432746208080_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.037422964670561_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.264391437780108_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.038478253000180_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.572948637727217_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.004325161232786_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.202384868750895_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.060351191163998_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 7 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.005172307293959_wp*F%F(12, y, z, 1:3) &
          +0.011982511897672_wp*F%F(11, y, z, 1:3) &
          +0.085515480593458_wp*F%F(10, y, z, 1:3) &
          -0.535851035654166_wp*F%F(9, y, z, 1:3) &
          +1.560836153489656_wp*F%F(8, y, z, 1:3) &
          -0.905179927543220_wp*F%F(7, y, z, 1:3) &
          -0.052231816759526_wp*F%F(6, y, z, 1:3) &
          -0.486889270320233_wp*F%F(5, y, z, 1:3) &
          +0.517428663501413_wp*F%F(4, y, z, 1:3) &
          -0.137956948397386_wp*F%F(3, y, z, 1:3) &
          -0.108190216650142_wp*F%F(2, y, z, 1:3) &
          +0.055708713136433_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.006465384117449_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
          -0.051378252453327_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
          +0.137238553533049_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.035940522255854_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.905179927543220_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -0.971931417829373_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.510533260717342_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.587831838812040_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.097436350250351_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.049653902328415_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.008276957317196_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 8 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.004715630209601_wp*F%F(13, y, z, 1:3) &
          +0.010924543318908_wp*F%F(12, y, z, 1:3) &
          +0.077965086132063_wp*F%F(11, y, z, 1:3) &
          -0.488539289714622_wp*F%F(10, y, z, 1:3) &
          +1.474420378868455_wp*F%F(9, y, z, 1:3) &
          -0.892828448398233_wp*F%F(8, y, z, 1:3) &
          -0.032767235755012_wp*F%F(7, y, z, 1:3) &
          -0.248685062282352_wp*F%F(6, y, z, 1:3) &
          +0.170930500243401_wp*F%F(5, y, z, 1:3) &
          -0.110359853738840_wp*F%F(4, y, z, 1:3) &
          +0.038849792028224_wp*F%F(3, y, z, 1:3) &
          +0.017743142086478_wp*F%F(2, y, z, 1:3) &
          -0.012937922578870_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.005894537762001_wp*X_x(12, y, z, 1)*G%J(12,y,z) *F%F(12, y, z, 4:n) &
          -0.046841926748699_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
          +0.125121388228069_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
          +0.105630116695053_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.892828448398233_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -1.423025682605699_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.258439188609325_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.206413079068906_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.142243577826732_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.021522078805545_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.013360802114642_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.009623151728641_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. nx ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.044374156234105_wp*F%F(nx-7, y, z, 1:3) &
            +0.174198378773702_wp*F%F(nx-6, y, z, 1:3) &
            -0.220245640409051_wp*F%F(nx-5, y, z, 1:3) &
            -0.139299657443443_wp*F%F(nx-4, y, z, 1:3) &
            +0.495449593250587_wp*F%F(nx-3, y, z, 1:3) &
            +0.370787168310084_wp*F%F(nx-2, y, z, 1:3) &
            -2.304067463556378_wp*F%F(nx-1, y, z, 1:3) &
            +1.667551777308605_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.033005239880522_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.025881634391799_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.263392722344631_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.030209714180198_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.506938949737935_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.350517535783371_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -2.412053651292632_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +1.728893299663438_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-1 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.011723708576681_wp*F%F(nx-7, y, z, 1:3) &
            -0.065174528307485_wp*F%F(nx-6, y, z, 1:3) &
            +0.148801997699767_wp*F%F(nx-5, y, z, 1:3) &
            -0.046588172420165_wp*F%F(nx-4, y, z, 1:3) &
            -0.241839854684496_wp*F%F(nx-3, y, z, 1:3) &
            -0.251551333921227_wp*F%F(nx-2, y, z, 1:3) &
            -0.020053857114091_wp*F%F(nx-1, y, z, 1:3) &
            +0.464682040171017_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.008828095360976_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.029911851210588_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.170162903794152_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.094426023794218_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -0.250037914252055_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.250891381680726_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.020053857114091_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.443878505390320_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-2 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.156241518792227_wp*F%F(nx-7, y, z, 1:3) &
            -0.505832529848511_wp*F%F(nx-6, y, z, 1:3) &
            +0.010613520806507_wp*F%F(nx-5, y, z, 1:3) &
            +1.646697927315869_wp*F%F(nx-4, y, z, 1:3) &
            -2.378062811419621_wp*F%F(nx-3, y, z, 1:3) &
            -0.045718284610534_wp*F%F(nx-2, y, z, 1:3) &
            +1.527070237729393_wp*F%F(nx-1, y, z, 1:3) &
            -0.411009578765331_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.086554962191340_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.357259827206167_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.022134128148434_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +1.484851853641141_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -2.378309161955782_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.045718284610534_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +1.531087089237169_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.434777328666669_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-3 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.061651661535115_wp*F%F(nx-7, y, z, 1:3) &
            +0.263535772373310_wp*F%F(nx-6, y, z, 1:3) &
            -0.389840903051706_wp*F%F(nx-5, y, z, 1:3) &
            -0.258864496540571_wp*F%F(nx-4, y, z, 1:3) &
            -0.012373610391183_wp*F%F(nx-3, y, z, 1:3) &
            +0.330365147571788_wp*F%F(nx-2, y, z, 1:3) &
            +0.211400033956727_wp*F%F(nx-1, y, z, 1:3) &
            -0.082570282383251_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.002634349609551_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            -0.079463252429367_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.299393382304440_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.407288103594466_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.281750824243924_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.012373610391183_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.330330927617320_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.204468804842354_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.080698894497091_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-4 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.014765366408812_wp*F%F(nx-8, y, z, 1:3) &
            +0.428167834093026_wp*F%F(nx-7, y, z, 1:3) &
            -1.111936792339292_wp*F%F(nx-6, y, z, 1:3) &
            +0.397762766470929_wp*F%F(nx-5, y, z, 1:3) &
            -0.373648890457135_wp*F%F(nx-4, y, z, 1:3) &
            +1.263356736209345_wp*F%F(nx-3, y, z, 1:3) &
            -0.924846902011930_wp*F%F(nx-2, y, z, 1:3) &
            +0.357974171524791_wp*F%F(nx-1, y, z, 1:3) &
            -0.022063557080921_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.011812293127050_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            -0.027365145744332_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.517048981121307_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -1.165933921548919_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.122648484113833_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.373648890457135_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +1.160735576719516_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -1.025653483809176_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.176618285456005_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.101737008335247_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-5 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.004632307593719_wp*F%F(nx-9, y, z, 1:3) &
            +0.036811404344754_wp*F%F(nx-8, y, z, 1:3) &
            -0.195432746208080_wp*F%F(nx-7, y, z, 1:3) &
            -0.037422964670561_wp*F%F(nx-6, y, z, 1:3) &
            -0.264391437780108_wp*F%F(nx-5, y, z, 1:3) &
            +0.038478253000180_wp*F%F(nx-4, y, z, 1:3) &
            +0.572948637727217_wp*F%F(nx-3, y, z, 1:3) &
            -0.004325161232786_wp*F%F(nx-2, y, z, 1:3) &
            -0.202384868750895_wp*F%F(nx-1, y, z, 1:3) &
            +0.060351191163998_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.003705846074975_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
            -0.008585210073693_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            -0.061269988439591_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.203098167192540_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.696367795879953_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.264391437780108_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.124789282744944_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.548404955515763_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.002073955135157_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.176979071835593_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.050464897545544_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-6 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.006465384117449_wp*F%F(nx-10, y, z, 1:3) &
            +0.051378252453327_wp*F%F(nx-9, y, z, 1:3) &
            -0.137238553533049_wp*F%F(nx-8, y, z, 1:3) &
            -0.035940522255854_wp*F%F(nx-7, y, z, 1:3) &
            -0.905179927543220_wp*F%F(nx-6, y, z, 1:3) &
            +0.971931417829373_wp*F%F(nx-5, y, z, 1:3) &
            +0.510533260717342_wp*F%F(nx-4, y, z, 1:3) &
            -0.587831838812040_wp*F%F(nx-3, y, z, 1:3) &
            +0.097436350250351_wp*F%F(nx-2, y, z, 1:3) &
            +0.049653902328415_wp*F%F(nx-1, y, z, 1:3) &
            -0.008276957317196_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.005172307293959_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
            -0.011982511897672_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
            -0.085515480593458_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            +0.535851035654166_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            -1.560836153489656_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.905179927543220_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.052231816759526_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.486889270320233_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -0.517428663501413_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.137956948397386_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.108190216650142_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.055708713136433_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-7 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.005894537762001_wp*F%F(nx-11, y, z, 1:3) &
            +0.046841926748699_wp*F%F(nx-10, y, z, 1:3) &
            -0.125121388228069_wp*F%F(nx-9, y, z, 1:3) &
            -0.105630116695053_wp*F%F(nx-8, y, z, 1:3) &
            -0.892828448398233_wp*F%F(nx-7, y, z, 1:3) &
            +1.423025682605699_wp*F%F(nx-6, y, z, 1:3) &
            -0.258439188609325_wp*F%F(nx-5, y, z, 1:3) &
            -0.206413079068906_wp*F%F(nx-4, y, z, 1:3) &
            +0.142243577826732_wp*F%F(nx-3, y, z, 1:3) &
            -0.021522078805545_wp*F%F(nx-2, y, z, 1:3) &
            +0.013360802114642_wp*F%F(nx-1, y, z, 1:3) &
            -0.009623151728641_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.004715630209601_wp*X_x(nx-12, y, z, 1)*G%J(nx-12,y,z) *F%F(nx-12, y, z, 4:n) &
            -0.010924543318908_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
            -0.077965086132063_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
            +0.488539289714622_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            -1.474420378868455_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.892828448398233_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.032767235755012_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.248685062282352_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.170930500243401_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.110359853738840_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.038849792028224_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.017743142086478_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.012937922578870_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if


!=================================================================================================
Jr_xU = 0.0_wp*Jr_xU


if ((y .ge. 9) .and. (y .le. ny-8 )) then 
!forward operator for stress
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
         -0.005952380952381_wp*F%F(x, y-4, z, 1:3) &
         +0.047301587301587_wp*F%F(x, y-3, z, 1:3) &
         -0.126349206349206_wp*F%F(x, y-2, z, 1:3) &
         -0.106666666666667_wp*F%F(x, y-1, z, 1:3) &
         -0.888888888888889_wp*F%F(x, y  , z, 1:3) &
         +1.488888888888889_wp*F%F(x, y+1, z, 1:3) &
         -0.493333333333333_wp*F%F(x, y+2, z, 1:3) &
         +0.078730158730159_wp*F%F(x, y+3, z, 1:3) &
         +0.011031746031746_wp*F%F(x, y+4, z, 1:3) &
         -0.004761904761905_wp*F%F(x, y+5, z, 1:3) &
          )
!backward operator for stress
Jr_xU(4:9) = (&
         +0.004761904761905_wp*X_x(x, y-5, z, 2)*G%J(x, y-5,z) *F%F(x, y-5, z, 4:n) &
         -0.011031746031746_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
         -0.078730158730159_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
         +0.493333333333333_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
         -1.488888888888889_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
         +0.888888888888889_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.106666666666667_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
         +0.126349206349206_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
         -0.047301587301587_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
         +0.005952380952381_wp*X_x(x, y+4, z, 2)*G%J(x, y+4,z) *F%F(x, y+4, z, 4:n) &
          )
end if





if  ( y .eq. 1 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.033005239880522_wp*F%F(x, 8, z, 1:3) &
          -0.025881634391799_wp*F%F(x, 7, z, 1:3) &
          +0.263392722344631_wp*F%F(x, 6, z, 1:3) &
          -0.030209714180198_wp*F%F(x, 5, z, 1:3) &
          -0.506938949737935_wp*F%F(x, 4, z, 1:3) &
          -0.350517535783371_wp*F%F(x, 3, z, 1:3) &
          +2.412053651292632_wp*F%F(x, 2, z, 1:3) &
          -1.728893299663438_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.044374156234105_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -0.174198378773702_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.220245640409051_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.139299657443443_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.495449593250587_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.370787168310084_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +2.304067463556378_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -1.667551777308605_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 2 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.008828095360976_wp*F%F(x, 8, z, 1:3) &
          +0.029911851210588_wp*F%F(x, 7, z, 1:3) &
          -0.170162903794152_wp*F%F(x, 6, z, 1:3) &
          +0.094426023794218_wp*F%F(x, 5, z, 1:3) &
          +0.250037914252055_wp*F%F(x, 4, z, 1:3) &
          +0.250891381680726_wp*F%F(x, 3, z, 1:3) &
          -0.020053857114091_wp*F%F(x, 2, z, 1:3) &
          -0.443878505390320_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.011723708576681_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.065174528307485_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -0.148801997699767_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.046588172420165_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.241839854684496_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.251551333921227_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.020053857114091_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.464682040171017_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 3 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.086554962191340_wp*F%F(x, 8, z, 1:3) &
          +0.357259827206167_wp*F%F(x, 7, z, 1:3) &
          -0.022134128148434_wp*F%F(x, 6, z, 1:3) &
          -1.484851853641141_wp*F%F(x, 5, z, 1:3) &
          +2.378309161955782_wp*F%F(x, 4, z, 1:3) &
          -0.045718284610534_wp*F%F(x, 3, z, 1:3) &
          -1.531087089237169_wp*F%F(x, 2, z, 1:3) &
          +0.434777328666669_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.156241518792227_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.505832529848511_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -0.010613520806507_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -1.646697927315869_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +2.378062811419621_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.045718284610534_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -1.527070237729393_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.411009578765331_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 4 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.002634349609551_wp*F%F(x, 9, z, 1:3) &
          +0.079463252429367_wp*F%F(x, 8, z, 1:3) &
          -0.299393382304440_wp*F%F(x, 7, z, 1:3) &
          +0.407288103594466_wp*F%F(x, 6, z, 1:3) &
          +0.281750824243924_wp*F%F(x, 5, z, 1:3) &
          -0.012373610391183_wp*F%F(x, 4, z, 1:3) &
          -0.330330927617320_wp*F%F(x, 3, z, 1:3) &
          -0.204468804842354_wp*F%F(x, 2, z, 1:3) &
          +0.080698894497091_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.061651661535115_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -0.263535772373310_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.389840903051706_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.258864496540571_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.012373610391183_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.330365147571788_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.211400033956727_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.082570282383251_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 5 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.011812293127050_wp*F%F(x, 10, z, 1:3) &
          +0.027365145744332_wp*F%F(x, 9, z, 1:3) &
          -0.517048981121307_wp*F%F(x, 8, z, 1:3) &
          +1.165933921548919_wp*F%F(x, 7, z, 1:3) &
          +0.122648484113833_wp*F%F(x, 6, z, 1:3) &
          -0.373648890457135_wp*F%F(x, 5, z, 1:3) &
          -1.160735576719516_wp*F%F(x, 4, z, 1:3) &
          +1.025653483809176_wp*F%F(x, 3, z, 1:3) &
          -0.176618285456005_wp*F%F(x, 2, z, 1:3) &
          -0.101737008335247_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.014765366408812_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          -0.428167834093026_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +1.111936792339292_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -0.397762766470929_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.373648890457135_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -1.263356736209345_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.924846902011930_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.357974171524791_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.022063557080921_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 6 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.003705846074975_wp*F%F(x, 11, z, 1:3) &
          +0.008585210073693_wp*F%F(x, 10, z, 1:3) &
          +0.061269988439591_wp*F%F(x, 9, z, 1:3) &
          -0.203098167192540_wp*F%F(x, 8, z, 1:3) &
          +0.696367795879953_wp*F%F(x, 7, z, 1:3) &
          -0.264391437780108_wp*F%F(x, 6, z, 1:3) &
          +0.124789282744944_wp*F%F(x, 5, z, 1:3) &
          -0.548404955515763_wp*F%F(x, 4, z, 1:3) &
          +0.002073955135157_wp*F%F(x, 3, z, 1:3) &
          +0.176979071835593_wp*F%F(x, 2, z, 1:3) &
          -0.050464897545544_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.004632307593719_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
          -0.036811404344754_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.195432746208080_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.037422964670561_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.264391437780108_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.038478253000180_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.572948637727217_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.004325161232786_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.202384868750895_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.060351191163998_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 7 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.005172307293959_wp*F%F(x, 12, z, 1:3) &
          +0.011982511897672_wp*F%F(x, 11, z, 1:3) &
          +0.085515480593458_wp*F%F(x, 10, z, 1:3) &
          -0.535851035654166_wp*F%F(x, 9, z, 1:3) &
          +1.560836153489656_wp*F%F(x, 8, z, 1:3) &
          -0.905179927543220_wp*F%F(x, 7, z, 1:3) &
          -0.052231816759526_wp*F%F(x, 6, z, 1:3) &
          -0.486889270320233_wp*F%F(x, 5, z, 1:3) &
          +0.517428663501413_wp*F%F(x, 4, z, 1:3) &
          -0.137956948397386_wp*F%F(x, 3, z, 1:3) &
          -0.108190216650142_wp*F%F(x, 2, z, 1:3) &
          +0.055708713136433_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.006465384117449_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
          -0.051378252453327_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
          +0.137238553533049_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.035940522255854_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.905179927543220_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -0.971931417829373_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.510533260717342_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.587831838812040_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.097436350250351_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.049653902328415_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.008276957317196_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 8 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.004715630209601_wp*F%F(x, 13, z, 1:3) &
          +0.010924543318908_wp*F%F(x, 12, z, 1:3) &
          +0.077965086132063_wp*F%F(x, 11, z, 1:3) &
          -0.488539289714622_wp*F%F(x, 10, z, 1:3) &
          +1.474420378868455_wp*F%F(x, 9, z, 1:3) &
          -0.892828448398233_wp*F%F(x, 8, z, 1:3) &
          -0.032767235755012_wp*F%F(x, 7, z, 1:3) &
          -0.248685062282352_wp*F%F(x, 6, z, 1:3) &
          +0.170930500243401_wp*F%F(x, 5, z, 1:3) &
          -0.110359853738840_wp*F%F(x, 4, z, 1:3) &
          +0.038849792028224_wp*F%F(x, 3, z, 1:3) &
          +0.017743142086478_wp*F%F(x, 2, z, 1:3) &
          -0.012937922578870_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.005894537762001_wp*X_x(x, 12, z, 2)*G%J(x,12,z) *F%F(x, 12, z, 4:n) &
          -0.046841926748699_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
          +0.125121388228069_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
          +0.105630116695053_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.892828448398233_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -1.423025682605699_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.258439188609325_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.206413079068906_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.142243577826732_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.021522078805545_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.013360802114642_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.009623151728641_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. ny ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.044374156234105_wp*F%F(x, ny-7, z, 1:3) &
            +0.174198378773702_wp*F%F(x, ny-6, z, 1:3) &
            -0.220245640409051_wp*F%F(x, ny-5, z, 1:3) &
            -0.139299657443443_wp*F%F(x, ny-4, z, 1:3) &
            +0.495449593250587_wp*F%F(x, ny-3, z, 1:3) &
            +0.370787168310084_wp*F%F(x, ny-2, z, 1:3) &
            -2.304067463556378_wp*F%F(x, ny-1, z, 1:3) &
            +1.667551777308605_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.033005239880522_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.025881634391799_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.263392722344631_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.030209714180198_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.506938949737935_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.350517535783371_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -2.412053651292632_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +1.728893299663438_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-1 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.011723708576681_wp*F%F(x, ny-7, z, 1:3) &
            -0.065174528307485_wp*F%F(x, ny-6, z, 1:3) &
            +0.148801997699767_wp*F%F(x, ny-5, z, 1:3) &
            -0.046588172420165_wp*F%F(x, ny-4, z, 1:3) &
            -0.241839854684496_wp*F%F(x, ny-3, z, 1:3) &
            -0.251551333921227_wp*F%F(x, ny-2, z, 1:3) &
            -0.020053857114091_wp*F%F(x, ny-1, z, 1:3) &
            +0.464682040171017_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.008828095360976_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.029911851210588_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.170162903794152_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.094426023794218_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -0.250037914252055_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.250891381680726_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.020053857114091_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.443878505390320_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-2 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.156241518792227_wp*F%F(x, ny-7, z, 1:3) &
            -0.505832529848511_wp*F%F(x, ny-6, z, 1:3) &
            +0.010613520806507_wp*F%F(x, ny-5, z, 1:3) &
            +1.646697927315869_wp*F%F(x, ny-4, z, 1:3) &
            -2.378062811419621_wp*F%F(x, ny-3, z, 1:3) &
            -0.045718284610534_wp*F%F(x, ny-2, z, 1:3) &
            +1.527070237729393_wp*F%F(x, ny-1, z, 1:3) &
            -0.411009578765331_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.086554962191340_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.357259827206167_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.022134128148434_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +1.484851853641141_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -2.378309161955782_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.045718284610534_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +1.531087089237169_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.434777328666669_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-3 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.061651661535115_wp*F%F(x, ny-7, z, 1:3) &
            +0.263535772373310_wp*F%F(x, ny-6, z, 1:3) &
            -0.389840903051706_wp*F%F(x, ny-5, z, 1:3) &
            -0.258864496540571_wp*F%F(x, ny-4, z, 1:3) &
            -0.012373610391183_wp*F%F(x, ny-3, z, 1:3) &
            +0.330365147571788_wp*F%F(x, ny-2, z, 1:3) &
            +0.211400033956727_wp*F%F(x, ny-1, z, 1:3) &
            -0.082570282383251_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.002634349609551_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            -0.079463252429367_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.299393382304440_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.407288103594466_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.281750824243924_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.012373610391183_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.330330927617320_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.204468804842354_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.080698894497091_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-4 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.014765366408812_wp*F%F(x, ny-8, z, 1:3) &
            +0.428167834093026_wp*F%F(x, ny-7, z, 1:3) &
            -1.111936792339292_wp*F%F(x, ny-6, z, 1:3) &
            +0.397762766470929_wp*F%F(x, ny-5, z, 1:3) &
            -0.373648890457135_wp*F%F(x, ny-4, z, 1:3) &
            +1.263356736209345_wp*F%F(x, ny-3, z, 1:3) &
            -0.924846902011930_wp*F%F(x, ny-2, z, 1:3) &
            +0.357974171524791_wp*F%F(x, ny-1, z, 1:3) &
            -0.022063557080921_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.011812293127050_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            -0.027365145744332_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.517048981121307_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -1.165933921548919_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.122648484113833_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.373648890457135_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +1.160735576719516_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -1.025653483809176_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.176618285456005_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.101737008335247_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-5 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.004632307593719_wp*F%F(x, ny-9, z, 1:3) &
            +0.036811404344754_wp*F%F(x, ny-8, z, 1:3) &
            -0.195432746208080_wp*F%F(x, ny-7, z, 1:3) &
            -0.037422964670561_wp*F%F(x, ny-6, z, 1:3) &
            -0.264391437780108_wp*F%F(x, ny-5, z, 1:3) &
            +0.038478253000180_wp*F%F(x, ny-4, z, 1:3) &
            +0.572948637727217_wp*F%F(x, ny-3, z, 1:3) &
            -0.004325161232786_wp*F%F(x, ny-2, z, 1:3) &
            -0.202384868750895_wp*F%F(x, ny-1, z, 1:3) &
            +0.060351191163998_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.003705846074975_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
            -0.008585210073693_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            -0.061269988439591_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.203098167192540_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.696367795879953_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.264391437780108_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.124789282744944_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.548404955515763_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.002073955135157_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.176979071835593_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.050464897545544_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-6 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.006465384117449_wp*F%F(x, ny-10, z, 1:3) &
            +0.051378252453327_wp*F%F(x, ny-9, z, 1:3) &
            -0.137238553533049_wp*F%F(x, ny-8, z, 1:3) &
            -0.035940522255854_wp*F%F(x, ny-7, z, 1:3) &
            -0.905179927543220_wp*F%F(x, ny-6, z, 1:3) &
            +0.971931417829373_wp*F%F(x, ny-5, z, 1:3) &
            +0.510533260717342_wp*F%F(x, ny-4, z, 1:3) &
            -0.587831838812040_wp*F%F(x, ny-3, z, 1:3) &
            +0.097436350250351_wp*F%F(x, ny-2, z, 1:3) &
            +0.049653902328415_wp*F%F(x, ny-1, z, 1:3) &
            -0.008276957317196_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.005172307293959_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
            -0.011982511897672_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
            -0.085515480593458_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            +0.535851035654166_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            -1.560836153489656_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.905179927543220_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.052231816759526_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.486889270320233_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -0.517428663501413_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.137956948397386_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.108190216650142_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.055708713136433_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-7 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.005894537762001_wp*F%F(x, ny-11, z, 1:3) &
            +0.046841926748699_wp*F%F(x, ny-10, z, 1:3) &
            -0.125121388228069_wp*F%F(x, ny-9, z, 1:3) &
            -0.105630116695053_wp*F%F(x, ny-8, z, 1:3) &
            -0.892828448398233_wp*F%F(x, ny-7, z, 1:3) &
            +1.423025682605699_wp*F%F(x, ny-6, z, 1:3) &
            -0.258439188609325_wp*F%F(x, ny-5, z, 1:3) &
            -0.206413079068906_wp*F%F(x, ny-4, z, 1:3) &
            +0.142243577826732_wp*F%F(x, ny-3, z, 1:3) &
            -0.021522078805545_wp*F%F(x, ny-2, z, 1:3) &
            +0.013360802114642_wp*F%F(x, ny-1, z, 1:3) &
            -0.009623151728641_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.004715630209601_wp*X_x(x, ny-12, z, 2)*G%J(x, ny-12,z) *F%F(x, ny-12, z, 4:n) &
            -0.010924543318908_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
            -0.077965086132063_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
            +0.488539289714622_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            -1.474420378868455_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.892828448398233_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.032767235755012_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.248685062282352_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.170930500243401_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.110359853738840_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.038849792028224_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.017743142086478_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.012937922578870_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if


!=================================================================================================
Js_xU = 0.0_wp*Js_xU


if ((z .ge. 9) .and. (z .le. nz-8 )) then 
!forward operator for stress
Js_xU(1:3) = X_x(x, y, z, 3)*(&
         -0.005952380952381_wp*F%F(x, y, z-4, 1:3) &
         +0.047301587301587_wp*F%F(x, y, z-3, 1:3) &
         -0.126349206349206_wp*F%F(x, y, z-2, 1:3) &
         -0.106666666666667_wp*F%F(x, y, z-1, 1:3) &
         -0.888888888888889_wp*F%F(x, y  , z, 1:3) &
         +1.488888888888889_wp*F%F(x, y, z+1, 1:3) &
         -0.493333333333333_wp*F%F(x, y, z+2, 1:3) &
         +0.078730158730159_wp*F%F(x, y, z+3, 1:3) &
         +0.011031746031746_wp*F%F(x, y, z+4, 1:3) &
         -0.004761904761905_wp*F%F(x, y, z+5, 1:3) &
          )
!backward operator for stress
Js_xU(4:9) = (&
         +0.004761904761905_wp*X_x(x, y, z-5, 3)*G%J(x, y, z-5) *F%F(x, y, z-5, 4:n) &
         -0.011031746031746_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
         -0.078730158730159_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
         +0.493333333333333_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
         -1.488888888888889_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
         +0.888888888888889_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.106666666666667_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
         +0.126349206349206_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
         -0.047301587301587_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
         +0.005952380952381_wp*X_x(x, y, z+4, 3)*G%J(x, y, z+4) *F%F(x, y, z+4, 4:n) &
          )
end if





if  ( z .eq. 1 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.033005239880522_wp*F%F(x, y, 8, 1:3) &
          -0.025881634391799_wp*F%F(x, y, 7, 1:3) &
          +0.263392722344631_wp*F%F(x, y, 6, 1:3) &
          -0.030209714180198_wp*F%F(x, y, 5, 1:3) &
          -0.506938949737935_wp*F%F(x, y, 4, 1:3) &
          -0.350517535783371_wp*F%F(x, y, 3, 1:3) &
          +2.412053651292632_wp*F%F(x, y, 2, 1:3) &
          -1.728893299663438_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.044374156234105_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -0.174198378773702_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.220245640409051_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.139299657443443_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.495449593250587_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.370787168310084_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +2.304067463556378_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -1.667551777308605_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 2 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.008828095360976_wp*F%F(x, y, 8, 1:3) &
          +0.029911851210588_wp*F%F(x, y, 7, 1:3) &
          -0.170162903794152_wp*F%F(x, y, 6, 1:3) &
          +0.094426023794218_wp*F%F(x, y, 5, 1:3) &
          +0.250037914252055_wp*F%F(x, y, 4, 1:3) &
          +0.250891381680726_wp*F%F(x, y, 3, 1:3) &
          -0.020053857114091_wp*F%F(x, y, 2, 1:3) &
          -0.443878505390320_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.011723708576681_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.065174528307485_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -0.148801997699767_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.046588172420165_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.241839854684496_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.251551333921227_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.020053857114091_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.464682040171017_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 3 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.086554962191340_wp*F%F(x, y, 8, 1:3) &
          +0.357259827206167_wp*F%F(x, y, 7, 1:3) &
          -0.022134128148434_wp*F%F(x, y, 6, 1:3) &
          -1.484851853641141_wp*F%F(x, y, 5, 1:3) &
          +2.378309161955782_wp*F%F(x, y, 4, 1:3) &
          -0.045718284610534_wp*F%F(x, y, 3, 1:3) &
          -1.531087089237169_wp*F%F(x, y, 2, 1:3) &
          +0.434777328666669_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.156241518792227_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.505832529848511_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -0.010613520806507_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -1.646697927315869_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +2.378062811419621_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.045718284610534_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -1.527070237729393_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.411009578765331_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 4 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.002634349609551_wp*F%F(x, y, 9, 1:3) &
          +0.079463252429367_wp*F%F(x, y, 8, 1:3) &
          -0.299393382304440_wp*F%F(x, y, 7, 1:3) &
          +0.407288103594466_wp*F%F(x, y, 6, 1:3) &
          +0.281750824243924_wp*F%F(x, y, 5, 1:3) &
          -0.012373610391183_wp*F%F(x, y, 4, 1:3) &
          -0.330330927617320_wp*F%F(x, y, 3, 1:3) &
          -0.204468804842354_wp*F%F(x, y, 2, 1:3) &
          +0.080698894497091_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.061651661535115_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -0.263535772373310_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.389840903051706_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.258864496540571_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.012373610391183_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.330365147571788_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.211400033956727_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.082570282383251_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 5 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.011812293127050_wp*F%F(x, y, 10, 1:3) &
          +0.027365145744332_wp*F%F(x, y, 9, 1:3) &
          -0.517048981121307_wp*F%F(x, y, 8, 1:3) &
          +1.165933921548919_wp*F%F(x, y, 7, 1:3) &
          +0.122648484113833_wp*F%F(x, y, 6, 1:3) &
          -0.373648890457135_wp*F%F(x, y, 5, 1:3) &
          -1.160735576719516_wp*F%F(x, y, 4, 1:3) &
          +1.025653483809176_wp*F%F(x, y, 3, 1:3) &
          -0.176618285456005_wp*F%F(x, y, 2, 1:3) &
          -0.101737008335247_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.014765366408812_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          -0.428167834093026_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +1.111936792339292_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -0.397762766470929_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.373648890457135_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -1.263356736209345_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.924846902011930_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.357974171524791_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.022063557080921_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 6 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.003705846074975_wp*F%F(x, y, 11, 1:3) &
          +0.008585210073693_wp*F%F(x, y, 10, 1:3) &
          +0.061269988439591_wp*F%F(x, y, 9, 1:3) &
          -0.203098167192540_wp*F%F(x, y, 8, 1:3) &
          +0.696367795879953_wp*F%F(x, y, 7, 1:3) &
          -0.264391437780108_wp*F%F(x, y, 6, 1:3) &
          +0.124789282744944_wp*F%F(x, y, 5, 1:3) &
          -0.548404955515763_wp*F%F(x, y, 4, 1:3) &
          +0.002073955135157_wp*F%F(x, y, 3, 1:3) &
          +0.176979071835593_wp*F%F(x, y, 2, 1:3) &
          -0.050464897545544_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.004632307593719_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
          -0.036811404344754_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.195432746208080_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.037422964670561_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.264391437780108_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.038478253000180_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.572948637727217_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.004325161232786_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.202384868750895_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.060351191163998_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 7 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.005172307293959_wp*F%F(x, y, 12, 1:3) &
          +0.011982511897672_wp*F%F(x, y, 11, 1:3) &
          +0.085515480593458_wp*F%F(x, y, 10, 1:3) &
          -0.535851035654166_wp*F%F(x, y, 9, 1:3) &
          +1.560836153489656_wp*F%F(x, y, 8, 1:3) &
          -0.905179927543220_wp*F%F(x, y, 7, 1:3) &
          -0.052231816759526_wp*F%F(x, y, 6, 1:3) &
          -0.486889270320233_wp*F%F(x, y, 5, 1:3) &
          +0.517428663501413_wp*F%F(x, y, 4, 1:3) &
          -0.137956948397386_wp*F%F(x, y, 3, 1:3) &
          -0.108190216650142_wp*F%F(x, y, 2, 1:3) &
          +0.055708713136433_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.006465384117449_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
          -0.051378252453327_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
          +0.137238553533049_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.035940522255854_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.905179927543220_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -0.971931417829373_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.510533260717342_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.587831838812040_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.097436350250351_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.049653902328415_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.008276957317196_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 8 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.004715630209601_wp*F%F(x, y, 13, 1:3) &
          +0.010924543318908_wp*F%F(x, y, 12, 1:3) &
          +0.077965086132063_wp*F%F(x, y, 11, 1:3) &
          -0.488539289714622_wp*F%F(x, y, 10, 1:3) &
          +1.474420378868455_wp*F%F(x, y, 9, 1:3) &
          -0.892828448398233_wp*F%F(x, y, 8, 1:3) &
          -0.032767235755012_wp*F%F(x, y, 7, 1:3) &
          -0.248685062282352_wp*F%F(x, y, 6, 1:3) &
          +0.170930500243401_wp*F%F(x, y, 5, 1:3) &
          -0.110359853738840_wp*F%F(x, y, 4, 1:3) &
          +0.038849792028224_wp*F%F(x, y, 3, 1:3) &
          +0.017743142086478_wp*F%F(x, y, 2, 1:3) &
          -0.012937922578870_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.005894537762001_wp*X_x(x, y, 12, 3)*G%J(x, y, 12) *F%F(x, y, 12, 4:n) &
          -0.046841926748699_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
          +0.125121388228069_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
          +0.105630116695053_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.892828448398233_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -1.423025682605699_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.258439188609325_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.206413079068906_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.142243577826732_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.021522078805545_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.013360802114642_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.009623151728641_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. nz ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.044374156234105_wp*F%F(x, y,  nz-7, 1:3) &
            +0.174198378773702_wp*F%F(x, y,  nz-6, 1:3) &
            -0.220245640409051_wp*F%F(x, y,  nz-5, 1:3) &
            -0.139299657443443_wp*F%F(x, y,  nz-4, 1:3) &
            +0.495449593250587_wp*F%F(x, y,  nz-3, 1:3) &
            +0.370787168310084_wp*F%F(x, y,  nz-2, 1:3) &
            -2.304067463556378_wp*F%F(x, y,  nz-1, 1:3) &
            +1.667551777308605_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.033005239880522_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.025881634391799_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.263392722344631_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.030209714180198_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.506938949737935_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.350517535783371_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -2.412053651292632_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +1.728893299663438_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-1 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.011723708576681_wp*F%F(x, y,  nz-7, 1:3) &
            -0.065174528307485_wp*F%F(x, y,  nz-6, 1:3) &
            +0.148801997699767_wp*F%F(x, y,  nz-5, 1:3) &
            -0.046588172420165_wp*F%F(x, y,  nz-4, 1:3) &
            -0.241839854684496_wp*F%F(x, y,  nz-3, 1:3) &
            -0.251551333921227_wp*F%F(x, y,  nz-2, 1:3) &
            -0.020053857114091_wp*F%F(x, y,  nz-1, 1:3) &
            +0.464682040171017_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.008828095360976_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.029911851210588_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.170162903794152_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.094426023794218_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -0.250037914252055_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.250891381680726_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.020053857114091_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.443878505390320_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-2 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.156241518792227_wp*F%F(x, y,  nz-7, 1:3) &
            -0.505832529848511_wp*F%F(x, y,  nz-6, 1:3) &
            +0.010613520806507_wp*F%F(x, y,  nz-5, 1:3) &
            +1.646697927315869_wp*F%F(x, y,  nz-4, 1:3) &
            -2.378062811419621_wp*F%F(x, y,  nz-3, 1:3) &
            -0.045718284610534_wp*F%F(x, y,  nz-2, 1:3) &
            +1.527070237729393_wp*F%F(x, y,  nz-1, 1:3) &
            -0.411009578765331_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.086554962191340_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.357259827206167_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.022134128148434_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +1.484851853641141_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -2.378309161955782_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.045718284610534_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +1.531087089237169_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.434777328666669_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-3 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.061651661535115_wp*F%F(x, y,  nz-7, 1:3) &
            +0.263535772373310_wp*F%F(x, y,  nz-6, 1:3) &
            -0.389840903051706_wp*F%F(x, y,  nz-5, 1:3) &
            -0.258864496540571_wp*F%F(x, y,  nz-4, 1:3) &
            -0.012373610391183_wp*F%F(x, y,  nz-3, 1:3) &
            +0.330365147571788_wp*F%F(x, y,  nz-2, 1:3) &
            +0.211400033956727_wp*F%F(x, y,  nz-1, 1:3) &
            -0.082570282383251_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.002634349609551_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            -0.079463252429367_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.299393382304440_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.407288103594466_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.281750824243924_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.012373610391183_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.330330927617320_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.204468804842354_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.080698894497091_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-4 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.014765366408812_wp*F%F(x, y,  nz-8, 1:3) &
            +0.428167834093026_wp*F%F(x, y,  nz-7, 1:3) &
            -1.111936792339292_wp*F%F(x, y,  nz-6, 1:3) &
            +0.397762766470929_wp*F%F(x, y,  nz-5, 1:3) &
            -0.373648890457135_wp*F%F(x, y,  nz-4, 1:3) &
            +1.263356736209345_wp*F%F(x, y,  nz-3, 1:3) &
            -0.924846902011930_wp*F%F(x, y,  nz-2, 1:3) &
            +0.357974171524791_wp*F%F(x, y,  nz-1, 1:3) &
            -0.022063557080921_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.011812293127050_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            -0.027365145744332_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.517048981121307_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -1.165933921548919_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.122648484113833_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.373648890457135_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +1.160735576719516_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -1.025653483809176_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.176618285456005_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.101737008335247_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-5 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.004632307593719_wp*F%F(x, y,  nz-9, 1:3) &
            +0.036811404344754_wp*F%F(x, y,  nz-8, 1:3) &
            -0.195432746208080_wp*F%F(x, y,  nz-7, 1:3) &
            -0.037422964670561_wp*F%F(x, y,  nz-6, 1:3) &
            -0.264391437780108_wp*F%F(x, y,  nz-5, 1:3) &
            +0.038478253000180_wp*F%F(x, y,  nz-4, 1:3) &
            +0.572948637727217_wp*F%F(x, y,  nz-3, 1:3) &
            -0.004325161232786_wp*F%F(x, y,  nz-2, 1:3) &
            -0.202384868750895_wp*F%F(x, y,  nz-1, 1:3) &
            +0.060351191163998_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.003705846074975_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
            -0.008585210073693_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            -0.061269988439591_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.203098167192540_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.696367795879953_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.264391437780108_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.124789282744944_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.548404955515763_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.002073955135157_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.176979071835593_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.050464897545544_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-6 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.006465384117449_wp*F%F(x, y,  nz-10, 1:3) &
            +0.051378252453327_wp*F%F(x, y,  nz-9, 1:3) &
            -0.137238553533049_wp*F%F(x, y,  nz-8, 1:3) &
            -0.035940522255854_wp*F%F(x, y,  nz-7, 1:3) &
            -0.905179927543220_wp*F%F(x, y,  nz-6, 1:3) &
            +0.971931417829373_wp*F%F(x, y,  nz-5, 1:3) &
            +0.510533260717342_wp*F%F(x, y,  nz-4, 1:3) &
            -0.587831838812040_wp*F%F(x, y,  nz-3, 1:3) &
            +0.097436350250351_wp*F%F(x, y,  nz-2, 1:3) &
            +0.049653902328415_wp*F%F(x, y,  nz-1, 1:3) &
            -0.008276957317196_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.005172307293959_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
            -0.011982511897672_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
            -0.085515480593458_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            +0.535851035654166_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            -1.560836153489656_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.905179927543220_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.052231816759526_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.486889270320233_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -0.517428663501413_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.137956948397386_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.108190216650142_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.055708713136433_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-7 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.005894537762001_wp*F%F(x, y,  nz-11, 1:3) &
            +0.046841926748699_wp*F%F(x, y,  nz-10, 1:3) &
            -0.125121388228069_wp*F%F(x, y,  nz-9, 1:3) &
            -0.105630116695053_wp*F%F(x, y,  nz-8, 1:3) &
            -0.892828448398233_wp*F%F(x, y,  nz-7, 1:3) &
            +1.423025682605699_wp*F%F(x, y,  nz-6, 1:3) &
            -0.258439188609325_wp*F%F(x, y,  nz-5, 1:3) &
            -0.206413079068906_wp*F%F(x, y,  nz-4, 1:3) &
            +0.142243577826732_wp*F%F(x, y,  nz-3, 1:3) &
            -0.021522078805545_wp*F%F(x, y,  nz-2, 1:3) &
            +0.013360802114642_wp*F%F(x, y,  nz-1, 1:3) &
            -0.009623151728641_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.004715630209601_wp*X_x(x, y, nz-12, 3)*G%J(x, y, nz-12) *F%F(x, y, nz-12, 4:n) &
            -0.010924543318908_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
            -0.077965086132063_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
            +0.488539289714622_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            -1.474420378868455_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.892828448398233_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.032767235755012_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.248685062282352_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.170930500243401_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.110359853738840_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.038849792028224_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.017743142086478_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.012937922578870_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if


!=================================================================================================


Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)

   end subroutine JJU_x6_upwind_drp


subroutine JJU_x7_upwind_drp(x, y, z, F, G, X_x, Ju_x)


     !=================================================================================================
     !
     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     integer, intent(in) :: x, y, z                      
     type(block_fields), intent(in):: F
     type(block_grid_t), intent(in) :: G
     real(kind = wp), dimension(:), intent(out) :: Ju_x           
 
     real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   
     real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU           
     real(kind = wp) :: hx, hy, hz                      
     integer :: n, nx, ny, nz
 
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))

!=================================================================================================
Jq_xU = 0.0_wp*Jq_xU


if ((x .ge. 9) .and. (x .le. nx-8 )) then 
!forward operator for stress
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
         -0.006094104308390_wp*F%F(x-4, y, z, 1:3) &
         +0.041318027210884_wp*F%F(x-3, y, z, 1:3) &
         -0.087346938775510_wp*F%F(x-2, y, z, 1:3) &
         -0.200238095238095_wp*F%F(x-1, y, z, 1:3) &
         -0.793571428571429_wp*F%F(x  , y, z, 1:3) &
         +1.487500000000000_wp*F%F(x+1, y, z, 1:3) &
         -0.587619047619048_wp*F%F(x+2, y, z, 1:3) &
         +0.173911564625850_wp*F%F(x+3, y, z, 1:3) &
         -0.029948979591837_wp*F%F(x+4, y, z, 1:3) &
         +0.002089002267574_wp*F%F(x+5, y, z, 1:3) &
          )
!backward operator for stress
Jq_xU(4:9) = (&
         -0.002089002267574_wp*X_x(x-5, y, z, 1)*G%J(x-5,y,z) *F%F(x-5, y, z, 4:n) &
         +0.029948979591837_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
         -0.173911564625850_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
         +0.587619047619048_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
         -1.487500000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
         +0.793571428571429_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.200238095238095_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
         +0.087346938775510_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
         -0.041318027210884_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
         +0.006094104308390_wp*X_x(x+4, y, z, 1)*G%J(x+4,y,z) *F%F(x+4, y, z, 4:n) &
          )
end if





if  ( x .eq. 1 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.031754582581050_wp*F%F(8, y, z, 1:3) &
          -0.028750185890774_wp*F%F(7, y, z, 1:3) &
          +0.259002022507736_wp*F%F(6, y, z, 1:3) &
          -0.007517675935586_wp*F%F(5, y, z, 1:3) &
          -0.540202079849458_wp*F%F(4, y, z, 1:3) &
          -0.326208907351811_wp*F%F(3, y, z, 1:3) &
          +2.402867838867655_wp*F%F(2, y, z, 1:3) &
          -1.727436429766712_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.046209577678680_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -0.179919863435158_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.225341012357188_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.143435528046729_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.512756852476076_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.347355914148918_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +2.288587348613403_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -1.663540836635847_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 2 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.008886213078768_wp*F%F(8, y, z, 1:3) &
          +0.030970563980613_wp*F%F(7, y, z, 1:3) &
          -0.169872853041846_wp*F%F(6, y, z, 1:3) &
          +0.083027816142139_wp*F%F(5, y, z, 1:3) &
          +0.269521861814115_wp*F%F(4, y, z, 1:3) &
          +0.240827113759967_wp*F%F(3, y, z, 1:3) &
          -0.020993687756657_wp*F%F(2, y, z, 1:3) &
          -0.442367027977099_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.014041443103383_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.072484217801267_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -0.153021829151466_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.036950731476631_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.257514851534530_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.243576386203318_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.020993687756657_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.464456602517554_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 3 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          -0.073807096767976_wp*F%F(8, y, z, 1:3) &
          +0.300906140733576_wp*F%F(7, y, z, 1:3) &
          +0.015796193741484_wp*F%F(6, y, z, 1:3) &
          -1.365074131779745_wp*F%F(5, y, z, 1:3) &
          +2.200793495245118_wp*F%F(4, y, z, 1:3) &
          -0.033540711347866_wp*F%F(3, y, z, 1:3) &
          -1.442770671653686_wp*F%F(2, y, z, 1:3) &
          +0.397696781829095_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          -0.133184444781063_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.428518218981964_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.018559043142540_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -1.488911107347006_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +2.194478518993876_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.033540711347866_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -1.426485966426382_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.373485026088204_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 4 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.001161857736926_wp*F%F(9, y, z, 1:3) &
          +0.059935579954567_wp*F%F(8, y, z, 1:3) &
          -0.265439846270311_wp*F%F(7, y, z, 1:3) &
          +0.390390908273344_wp*F%F(6, y, z, 1:3) &
          +0.270892441959372_wp*F%F(5, y, z, 1:3) &
          -0.008157923509094_wp*F%F(4, y, z, 1:3) &
          -0.314371465587571_wp*F%F(3, y, z, 1:3) &
          -0.218512451457299_wp*F%F(2, y, z, 1:3) &
          +0.084100898900065_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.065425315357690_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -0.272423859939952_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.394484245785201_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.259731028313028_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.008157923509094_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.315276121669675_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.228700917230169_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.088602385874783_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 5 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.005060951164579_wp*F%F(10, y, z, 1:3) &
          -0.072556322937503_wp*F%F(9, y, z, 1:3) &
          -0.257339176012441_wp*F%F(8, y, z, 1:3) &
          +0.845055327238168_wp*F%F(7, y, z, 1:3) &
          +0.254013637526521_wp*F%F(6, y, z, 1:3) &
          -0.332909622334215_wp*F%F(5, y, z, 1:3) &
          -1.131365750247396_wp*F%F(4, y, z, 1:3) &
          +0.929094197496254_wp*F%F(3, y, z, 1:3) &
          -0.136576550869173_wp*F%F(2, y, z, 1:3) &
          -0.102476691024794_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.014763968797618_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          -0.459869525614028_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +1.203157161060338_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -0.461281333687455_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.332909622334215_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -1.179983896511377_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.851818788059597_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.306885744929427_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.005370960490518_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 6 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.001633961439094_wp*F%F(11, y, z, 1:3) &
          -0.023425287063051_wp*F%F(10, y, z, 1:3) &
          +0.136028952587601_wp*F%F(9, y, z, 1:3) &
          -0.292434170559197_wp*F%F(8, y, z, 1:3) &
          +0.761005997054070_wp*F%F(7, y, z, 1:3) &
          -0.303849703479423_wp*F%F(6, y, z, 1:3) &
          +0.148927718784253_wp*F%F(5, y, z, 1:3) &
          -0.554777082819560_wp*F%F(4, y, z, 1:3) &
          -0.003739006462720_wp*F%F(3, y, z, 1:3) &
          +0.182606463709899_wp*F%F(2, y, z, 1:3) &
          -0.051977843190966_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.004766644632364_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
          -0.032317850607430_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.185498355711640_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.029442785989543_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.303849703479423_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.082009977023147_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.549020478169090_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.003182387692736_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          +0.202715397837640_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          -0.059742194158207_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 7 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.002262587257978_wp*F%F(12, y, z, 1:3) &
          -0.032437580689008_wp*F%F(11, y, z, 1:3) &
          +0.188362691723906_wp*F%F(10, y, z, 1:3) &
          -0.636447068692001_wp*F%F(9, y, z, 1:3) &
          +1.568974133710457_wp*F%F(8, y, z, 1:3) &
          -0.860712585963429_wp*F%F(7, y, z, 1:3) &
          -0.040770161905567_wp*F%F(6, y, z, 1:3) &
          -0.537892576599693_wp*F%F(5, y, z, 1:3) &
          +0.530514825248909_wp*F%F(4, y, z, 1:3) &
          -0.119545562429062_wp*F%F(3, y, z, 1:3) &
          -0.119775984081436_wp*F%F(2, y, z, 1:3) &
          +0.057467282418948_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.006600492000887_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
          -0.044751335766011_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
          +0.094605005348522_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.123439084374344_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          +0.860712585963429_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          -1.053784031240169_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          -0.377796851524237_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          +0.516914244182689_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          -0.083945074535717_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.051177068482763_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.009182949679026_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. 8 ) then 
!forward operator for velocity
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
          +0.002069675638270_wp*F%F(13, y, z, 1:3) &
          -0.029671903383935_wp*F%F(12, y, z, 1:3) &
          +0.172302603068781_wp*F%F(11, y, z, 1:3) &
          -0.582182626758509_wp*F%F(10, y, z, 1:3) &
          +1.473738233660367_wp*F%F(9, y, z, 1:3) &
          -0.801606505319775_wp*F%F(8, y, z, 1:3) &
          -0.112914480906342_wp*F%F(7, y, z, 1:3) &
          -0.234963579047712_wp*F%F(6, y, z, 1:3) &
          +0.188063611561311_wp*F%F(5, y, z, 1:3) &
          -0.116545405705346_wp*F%F(4, y, z, 1:3) &
          +0.033987140247251_wp*F%F(3, y, z, 1:3) &
          +0.021224378711220_wp*F%F(2, y, z, 1:3) &
          -0.013501141765580_wp*F%F(1, y, z, 1:3) &
         )
!backward operator for stress
Jq_xU(4:9) = (&
          +0.006037724046513_wp*X_x(12, y, z, 1)*G%J(12,y,z) *F%F(12, y, z, 4:n) &
          -0.040935769035361_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
          +0.086538839170864_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
          +0.198385570949719_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
          +0.801606505319775_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
          -1.435201020497983_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
          +0.370415031911393_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
          +0.105238838717334_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
          -0.106766263850637_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
          +0.018834723178215_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
          -0.013431977774914_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
          +0.009277797865081_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
          )
end if


if  ( x .eq. nx ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.046209577678680_wp*F%F(nx-7, y, z, 1:3) &
            +0.179919863435158_wp*F%F(nx-6, y, z, 1:3) &
            -0.225341012357188_wp*F%F(nx-5, y, z, 1:3) &
            -0.143435528046729_wp*F%F(nx-4, y, z, 1:3) &
            +0.512756852476076_wp*F%F(nx-3, y, z, 1:3) &
            +0.347355914148918_wp*F%F(nx-2, y, z, 1:3) &
            -2.288587348613403_wp*F%F(nx-1, y, z, 1:3) &
            +1.663540836635847_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.031754582581050_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.028750185890774_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.259002022507736_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.007517675935586_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.540202079849458_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.326208907351811_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -2.402867838867655_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +1.727436429766712_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-1 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.014041443103383_wp*F%F(nx-7, y, z, 1:3) &
            -0.072484217801267_wp*F%F(nx-6, y, z, 1:3) &
            +0.153021829151466_wp*F%F(nx-5, y, z, 1:3) &
            -0.036950731476631_wp*F%F(nx-4, y, z, 1:3) &
            -0.257514851534530_wp*F%F(nx-3, y, z, 1:3) &
            -0.243576386203318_wp*F%F(nx-2, y, z, 1:3) &
            -0.020993687756657_wp*F%F(nx-1, y, z, 1:3) &
            +0.464456602517554_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.008886213078768_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.030970563980613_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.169872853041846_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.083027816142139_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -0.269521861814115_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.240827113759967_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.020993687756657_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.442367027977099_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-2 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            +0.133184444781063_wp*F%F(nx-7, y, z, 1:3) &
            -0.428518218981964_wp*F%F(nx-6, y, z, 1:3) &
            -0.018559043142540_wp*F%F(nx-5, y, z, 1:3) &
            +1.488911107347006_wp*F%F(nx-4, y, z, 1:3) &
            -2.194478518993876_wp*F%F(nx-3, y, z, 1:3) &
            -0.033540711347866_wp*F%F(nx-2, y, z, 1:3) &
            +1.426485966426382_wp*F%F(nx-1, y, z, 1:3) &
            -0.373485026088204_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            +0.073807096767976_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.300906140733576_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.015796193741484_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +1.365074131779745_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -2.200793495245118_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.033540711347866_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +1.442770671653686_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.397696781829095_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-3 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.065425315357690_wp*F%F(nx-7, y, z, 1:3) &
            +0.272423859939952_wp*F%F(nx-6, y, z, 1:3) &
            -0.394484245785201_wp*F%F(nx-5, y, z, 1:3) &
            -0.259731028313028_wp*F%F(nx-4, y, z, 1:3) &
            -0.008157923509094_wp*F%F(nx-3, y, z, 1:3) &
            +0.315276121669675_wp*F%F(nx-2, y, z, 1:3) &
            +0.228700917230169_wp*F%F(nx-1, y, z, 1:3) &
            -0.088602385874783_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.001161857736926_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            -0.059935579954567_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.265439846270311_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.390390908273344_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.270892441959372_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.008157923509094_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.314371465587571_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.218512451457299_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.084100898900065_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-4 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.014763968797618_wp*F%F(nx-8, y, z, 1:3) &
            +0.459869525614028_wp*F%F(nx-7, y, z, 1:3) &
            -1.203157161060338_wp*F%F(nx-6, y, z, 1:3) &
            +0.461281333687455_wp*F%F(nx-5, y, z, 1:3) &
            -0.332909622334215_wp*F%F(nx-4, y, z, 1:3) &
            +1.179983896511377_wp*F%F(nx-3, y, z, 1:3) &
            -0.851818788059597_wp*F%F(nx-2, y, z, 1:3) &
            +0.306885744929427_wp*F%F(nx-1, y, z, 1:3) &
            -0.005370960490518_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.005060951164579_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            +0.072556322937503_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.257339176012441_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.845055327238168_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            -0.254013637526521_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.332909622334215_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +1.131365750247396_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.929094197496254_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.136576550869173_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.102476691024794_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-5 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.004766644632364_wp*F%F(nx-9, y, z, 1:3) &
            +0.032317850607430_wp*F%F(nx-8, y, z, 1:3) &
            -0.185498355711640_wp*F%F(nx-7, y, z, 1:3) &
            -0.029442785989543_wp*F%F(nx-6, y, z, 1:3) &
            -0.303849703479423_wp*F%F(nx-5, y, z, 1:3) &
            +0.082009977023147_wp*F%F(nx-4, y, z, 1:3) &
            +0.549020478169090_wp*F%F(nx-3, y, z, 1:3) &
            +0.003182387692736_wp*F%F(nx-2, y, z, 1:3) &
            -0.202715397837640_wp*F%F(nx-1, y, z, 1:3) &
            +0.059742194158207_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.001633961439094_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
            +0.023425287063051_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            -0.136028952587601_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.292434170559197_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            -0.761005997054070_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.303849703479423_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.148927718784253_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.554777082819560_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.003739006462720_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.182606463709899_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.051977843190966_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-6 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.006600492000887_wp*F%F(nx-10, y, z, 1:3) &
            +0.044751335766011_wp*F%F(nx-9, y, z, 1:3) &
            -0.094605005348522_wp*F%F(nx-8, y, z, 1:3) &
            -0.123439084374344_wp*F%F(nx-7, y, z, 1:3) &
            -0.860712585963429_wp*F%F(nx-6, y, z, 1:3) &
            +1.053784031240169_wp*F%F(nx-5, y, z, 1:3) &
            +0.377796851524237_wp*F%F(nx-4, y, z, 1:3) &
            -0.516914244182689_wp*F%F(nx-3, y, z, 1:3) &
            +0.083945074535717_wp*F%F(nx-2, y, z, 1:3) &
            +0.051177068482763_wp*F%F(nx-1, y, z, 1:3) &
            -0.009182949679026_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.002262587257978_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
            +0.032437580689008_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
            -0.188362691723906_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            +0.636447068692001_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            -1.568974133710457_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.860712585963429_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.040770161905567_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            +0.537892576599693_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            -0.530514825248909_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            +0.119545562429062_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            +0.119775984081436_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            -0.057467282418948_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if
if  ( x .eq. nx-7 ) then 
!forward operator
Jq_xU(1:3) = X_x(x, y, z, 1)*(&
            -0.006037724046513_wp*F%F(nx-11, y, z, 1:3) &
            +0.040935769035361_wp*F%F(nx-10, y, z, 1:3) &
            -0.086538839170864_wp*F%F(nx-9, y, z, 1:3) &
            -0.198385570949719_wp*F%F(nx-8, y, z, 1:3) &
            -0.801606505319775_wp*F%F(nx-7, y, z, 1:3) &
            +1.435201020497983_wp*F%F(nx-6, y, z, 1:3) &
            -0.370415031911393_wp*F%F(nx-5, y, z, 1:3) &
            -0.105238838717334_wp*F%F(nx-4, y, z, 1:3) &
            +0.106766263850637_wp*F%F(nx-3, y, z, 1:3) &
            -0.018834723178215_wp*F%F(nx-2, y, z, 1:3) &
            +0.013431977774914_wp*F%F(nx-1, y, z, 1:3) &
            -0.009277797865081_wp*F%F(nx  , y, z, 1:3) &
            )
!backward operator
Jq_xU(4:9) = (&
            -0.002069675638270_wp*X_x(nx-12, y, z, 1)*G%J(nx-12,y,z) *F%F(nx-12, y, z, 4:n) &
            +0.029671903383935_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
            -0.172302603068781_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
            +0.582182626758509_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
            -1.473738233660367_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
            +0.801606505319775_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
            +0.112914480906342_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
            +0.234963579047712_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
            -0.188063611561311_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
            +0.116545405705346_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
            -0.033987140247251_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
            -0.021224378711220_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
            +0.013501141765580_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
            )
end if


!=================================================================================================
Jr_xU = 0.0_wp*Jr_xU


if ((y .ge. 9) .and. (y .le. ny-8 )) then 
!forward operator for stress
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
         -0.006094104308390_wp*F%F(x, y-4, z, 1:3) &
         +0.041318027210884_wp*F%F(x, y-3, z, 1:3) &
         -0.087346938775510_wp*F%F(x, y-2, z, 1:3) &
         -0.200238095238095_wp*F%F(x, y-1, z, 1:3) &
         -0.793571428571429_wp*F%F(x, y  , z, 1:3) &
         +1.487500000000000_wp*F%F(x, y+1, z, 1:3) &
         -0.587619047619048_wp*F%F(x, y+2, z, 1:3) &
         +0.173911564625850_wp*F%F(x, y+3, z, 1:3) &
         -0.029948979591837_wp*F%F(x, y+4, z, 1:3) &
         +0.002089002267574_wp*F%F(x, y+5, z, 1:3) &
          )
!backward operator for stress
Jr_xU(4:9) = (&
         -0.002089002267574_wp*X_x(x, y-5, z, 2)*G%J(x, y-5,z) *F%F(x, y-5, z, 4:n) &
         +0.029948979591837_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
         -0.173911564625850_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
         +0.587619047619048_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
         -1.487500000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
         +0.793571428571429_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.200238095238095_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
         +0.087346938775510_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
         -0.041318027210884_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
         +0.006094104308390_wp*X_x(x, y+4, z, 2)*G%J(x, y+4,z) *F%F(x, y+4, z, 4:n) &
          )
end if





if  ( y .eq. 1 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.031754582581050_wp*F%F(x, 8, z, 1:3) &
          -0.028750185890774_wp*F%F(x, 7, z, 1:3) &
          +0.259002022507736_wp*F%F(x, 6, z, 1:3) &
          -0.007517675935586_wp*F%F(x, 5, z, 1:3) &
          -0.540202079849458_wp*F%F(x, 4, z, 1:3) &
          -0.326208907351811_wp*F%F(x, 3, z, 1:3) &
          +2.402867838867655_wp*F%F(x, 2, z, 1:3) &
          -1.727436429766712_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.046209577678680_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -0.179919863435158_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.225341012357188_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.143435528046729_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.512756852476076_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.347355914148918_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +2.288587348613403_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -1.663540836635847_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 2 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.008886213078768_wp*F%F(x, 8, z, 1:3) &
          +0.030970563980613_wp*F%F(x, 7, z, 1:3) &
          -0.169872853041846_wp*F%F(x, 6, z, 1:3) &
          +0.083027816142139_wp*F%F(x, 5, z, 1:3) &
          +0.269521861814115_wp*F%F(x, 4, z, 1:3) &
          +0.240827113759967_wp*F%F(x, 3, z, 1:3) &
          -0.020993687756657_wp*F%F(x, 2, z, 1:3) &
          -0.442367027977099_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.014041443103383_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.072484217801267_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -0.153021829151466_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.036950731476631_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.257514851534530_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.243576386203318_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.020993687756657_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.464456602517554_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 3 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          -0.073807096767976_wp*F%F(x, 8, z, 1:3) &
          +0.300906140733576_wp*F%F(x, 7, z, 1:3) &
          +0.015796193741484_wp*F%F(x, 6, z, 1:3) &
          -1.365074131779745_wp*F%F(x, 5, z, 1:3) &
          +2.200793495245118_wp*F%F(x, 4, z, 1:3) &
          -0.033540711347866_wp*F%F(x, 3, z, 1:3) &
          -1.442770671653686_wp*F%F(x, 2, z, 1:3) &
          +0.397696781829095_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          -0.133184444781063_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.428518218981964_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.018559043142540_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -1.488911107347006_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +2.194478518993876_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.033540711347866_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -1.426485966426382_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.373485026088204_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 4 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.001161857736926_wp*F%F(x, 9, z, 1:3) &
          +0.059935579954567_wp*F%F(x, 8, z, 1:3) &
          -0.265439846270311_wp*F%F(x, 7, z, 1:3) &
          +0.390390908273344_wp*F%F(x, 6, z, 1:3) &
          +0.270892441959372_wp*F%F(x, 5, z, 1:3) &
          -0.008157923509094_wp*F%F(x, 4, z, 1:3) &
          -0.314371465587571_wp*F%F(x, 3, z, 1:3) &
          -0.218512451457299_wp*F%F(x, 2, z, 1:3) &
          +0.084100898900065_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.065425315357690_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -0.272423859939952_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.394484245785201_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.259731028313028_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.008157923509094_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.315276121669675_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.228700917230169_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.088602385874783_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 5 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.005060951164579_wp*F%F(x, 10, z, 1:3) &
          -0.072556322937503_wp*F%F(x, 9, z, 1:3) &
          -0.257339176012441_wp*F%F(x, 8, z, 1:3) &
          +0.845055327238168_wp*F%F(x, 7, z, 1:3) &
          +0.254013637526521_wp*F%F(x, 6, z, 1:3) &
          -0.332909622334215_wp*F%F(x, 5, z, 1:3) &
          -1.131365750247396_wp*F%F(x, 4, z, 1:3) &
          +0.929094197496254_wp*F%F(x, 3, z, 1:3) &
          -0.136576550869173_wp*F%F(x, 2, z, 1:3) &
          -0.102476691024794_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.014763968797618_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          -0.459869525614028_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +1.203157161060338_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -0.461281333687455_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.332909622334215_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -1.179983896511377_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.851818788059597_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.306885744929427_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.005370960490518_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 6 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.001633961439094_wp*F%F(x, 11, z, 1:3) &
          -0.023425287063051_wp*F%F(x, 10, z, 1:3) &
          +0.136028952587601_wp*F%F(x, 9, z, 1:3) &
          -0.292434170559197_wp*F%F(x, 8, z, 1:3) &
          +0.761005997054070_wp*F%F(x, 7, z, 1:3) &
          -0.303849703479423_wp*F%F(x, 6, z, 1:3) &
          +0.148927718784253_wp*F%F(x, 5, z, 1:3) &
          -0.554777082819560_wp*F%F(x, 4, z, 1:3) &
          -0.003739006462720_wp*F%F(x, 3, z, 1:3) &
          +0.182606463709899_wp*F%F(x, 2, z, 1:3) &
          -0.051977843190966_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.004766644632364_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
          -0.032317850607430_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.185498355711640_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.029442785989543_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.303849703479423_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.082009977023147_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.549020478169090_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.003182387692736_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          +0.202715397837640_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          -0.059742194158207_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 7 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.002262587257978_wp*F%F(x, 12, z, 1:3) &
          -0.032437580689008_wp*F%F(x, 11, z, 1:3) &
          +0.188362691723906_wp*F%F(x, 10, z, 1:3) &
          -0.636447068692001_wp*F%F(x, 9, z, 1:3) &
          +1.568974133710457_wp*F%F(x, 8, z, 1:3) &
          -0.860712585963429_wp*F%F(x, 7, z, 1:3) &
          -0.040770161905567_wp*F%F(x, 6, z, 1:3) &
          -0.537892576599693_wp*F%F(x, 5, z, 1:3) &
          +0.530514825248909_wp*F%F(x, 4, z, 1:3) &
          -0.119545562429062_wp*F%F(x, 3, z, 1:3) &
          -0.119775984081436_wp*F%F(x, 2, z, 1:3) &
          +0.057467282418948_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.006600492000887_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
          -0.044751335766011_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
          +0.094605005348522_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.123439084374344_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          +0.860712585963429_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          -1.053784031240169_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          -0.377796851524237_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          +0.516914244182689_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          -0.083945074535717_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.051177068482763_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.009182949679026_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. 8 ) then 
!forward operator for velocity
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
          +0.002069675638270_wp*F%F(x, 13, z, 1:3) &
          -0.029671903383935_wp*F%F(x, 12, z, 1:3) &
          +0.172302603068781_wp*F%F(x, 11, z, 1:3) &
          -0.582182626758509_wp*F%F(x, 10, z, 1:3) &
          +1.473738233660367_wp*F%F(x, 9, z, 1:3) &
          -0.801606505319775_wp*F%F(x, 8, z, 1:3) &
          -0.112914480906342_wp*F%F(x, 7, z, 1:3) &
          -0.234963579047712_wp*F%F(x, 6, z, 1:3) &
          +0.188063611561311_wp*F%F(x, 5, z, 1:3) &
          -0.116545405705346_wp*F%F(x, 4, z, 1:3) &
          +0.033987140247251_wp*F%F(x, 3, z, 1:3) &
          +0.021224378711220_wp*F%F(x, 2, z, 1:3) &
          -0.013501141765580_wp*F%F(x, 1, z, 1:3) &
         )
!backward operator for stress
Jr_xU(4:9) = (&
          +0.006037724046513_wp*X_x(x, 12, z, 2)*G%J(x,12,z) *F%F(x, 12, z, 4:n) &
          -0.040935769035361_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
          +0.086538839170864_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
          +0.198385570949719_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
          +0.801606505319775_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
          -1.435201020497983_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
          +0.370415031911393_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
          +0.105238838717334_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
          -0.106766263850637_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
          +0.018834723178215_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
          -0.013431977774914_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
          +0.009277797865081_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
          )
end if


if  ( y .eq. ny ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.046209577678680_wp*F%F(x, ny-7, z, 1:3) &
            +0.179919863435158_wp*F%F(x, ny-6, z, 1:3) &
            -0.225341012357188_wp*F%F(x, ny-5, z, 1:3) &
            -0.143435528046729_wp*F%F(x, ny-4, z, 1:3) &
            +0.512756852476076_wp*F%F(x, ny-3, z, 1:3) &
            +0.347355914148918_wp*F%F(x, ny-2, z, 1:3) &
            -2.288587348613403_wp*F%F(x, ny-1, z, 1:3) &
            +1.663540836635847_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.031754582581050_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.028750185890774_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.259002022507736_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.007517675935586_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.540202079849458_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.326208907351811_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -2.402867838867655_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +1.727436429766712_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-1 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.014041443103383_wp*F%F(x, ny-7, z, 1:3) &
            -0.072484217801267_wp*F%F(x, ny-6, z, 1:3) &
            +0.153021829151466_wp*F%F(x, ny-5, z, 1:3) &
            -0.036950731476631_wp*F%F(x, ny-4, z, 1:3) &
            -0.257514851534530_wp*F%F(x, ny-3, z, 1:3) &
            -0.243576386203318_wp*F%F(x, ny-2, z, 1:3) &
            -0.020993687756657_wp*F%F(x, ny-1, z, 1:3) &
            +0.464456602517554_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.008886213078768_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.030970563980613_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.169872853041846_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.083027816142139_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -0.269521861814115_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.240827113759967_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.020993687756657_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.442367027977099_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-2 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            +0.133184444781063_wp*F%F(x, ny-7, z, 1:3) &
            -0.428518218981964_wp*F%F(x, ny-6, z, 1:3) &
            -0.018559043142540_wp*F%F(x, ny-5, z, 1:3) &
            +1.488911107347006_wp*F%F(x, ny-4, z, 1:3) &
            -2.194478518993876_wp*F%F(x, ny-3, z, 1:3) &
            -0.033540711347866_wp*F%F(x, ny-2, z, 1:3) &
            +1.426485966426382_wp*F%F(x, ny-1, z, 1:3) &
            -0.373485026088204_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            +0.073807096767976_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.300906140733576_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.015796193741484_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +1.365074131779745_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -2.200793495245118_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.033540711347866_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +1.442770671653686_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.397696781829095_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-3 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.065425315357690_wp*F%F(x, ny-7, z, 1:3) &
            +0.272423859939952_wp*F%F(x, ny-6, z, 1:3) &
            -0.394484245785201_wp*F%F(x, ny-5, z, 1:3) &
            -0.259731028313028_wp*F%F(x, ny-4, z, 1:3) &
            -0.008157923509094_wp*F%F(x, ny-3, z, 1:3) &
            +0.315276121669675_wp*F%F(x, ny-2, z, 1:3) &
            +0.228700917230169_wp*F%F(x, ny-1, z, 1:3) &
            -0.088602385874783_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.001161857736926_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            -0.059935579954567_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.265439846270311_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.390390908273344_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.270892441959372_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.008157923509094_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.314371465587571_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.218512451457299_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.084100898900065_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-4 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.014763968797618_wp*F%F(x, ny-8, z, 1:3) &
            +0.459869525614028_wp*F%F(x, ny-7, z, 1:3) &
            -1.203157161060338_wp*F%F(x, ny-6, z, 1:3) &
            +0.461281333687455_wp*F%F(x, ny-5, z, 1:3) &
            -0.332909622334215_wp*F%F(x, ny-4, z, 1:3) &
            +1.179983896511377_wp*F%F(x, ny-3, z, 1:3) &
            -0.851818788059597_wp*F%F(x, ny-2, z, 1:3) &
            +0.306885744929427_wp*F%F(x, ny-1, z, 1:3) &
            -0.005370960490518_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.005060951164579_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            +0.072556322937503_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.257339176012441_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.845055327238168_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            -0.254013637526521_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.332909622334215_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +1.131365750247396_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.929094197496254_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.136576550869173_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.102476691024794_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-5 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.004766644632364_wp*F%F(x, ny-9, z, 1:3) &
            +0.032317850607430_wp*F%F(x, ny-8, z, 1:3) &
            -0.185498355711640_wp*F%F(x, ny-7, z, 1:3) &
            -0.029442785989543_wp*F%F(x, ny-6, z, 1:3) &
            -0.303849703479423_wp*F%F(x, ny-5, z, 1:3) &
            +0.082009977023147_wp*F%F(x, ny-4, z, 1:3) &
            +0.549020478169090_wp*F%F(x, ny-3, z, 1:3) &
            +0.003182387692736_wp*F%F(x, ny-2, z, 1:3) &
            -0.202715397837640_wp*F%F(x, ny-1, z, 1:3) &
            +0.059742194158207_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.001633961439094_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
            +0.023425287063051_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            -0.136028952587601_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.292434170559197_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            -0.761005997054070_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.303849703479423_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.148927718784253_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.554777082819560_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.003739006462720_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.182606463709899_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.051977843190966_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-6 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.006600492000887_wp*F%F(x, ny-10, z, 1:3) &
            +0.044751335766011_wp*F%F(x, ny-9, z, 1:3) &
            -0.094605005348522_wp*F%F(x, ny-8, z, 1:3) &
            -0.123439084374344_wp*F%F(x, ny-7, z, 1:3) &
            -0.860712585963429_wp*F%F(x, ny-6, z, 1:3) &
            +1.053784031240169_wp*F%F(x, ny-5, z, 1:3) &
            +0.377796851524237_wp*F%F(x, ny-4, z, 1:3) &
            -0.516914244182689_wp*F%F(x, ny-3, z, 1:3) &
            +0.083945074535717_wp*F%F(x, ny-2, z, 1:3) &
            +0.051177068482763_wp*F%F(x, ny-1, z, 1:3) &
            -0.009182949679026_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.002262587257978_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
            +0.032437580689008_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
            -0.188362691723906_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            +0.636447068692001_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            -1.568974133710457_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.860712585963429_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.040770161905567_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            +0.537892576599693_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            -0.530514825248909_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            +0.119545562429062_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            +0.119775984081436_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            -0.057467282418948_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if
if  ( y .eq. ny-7 ) then 
!forward operator
Jr_xU(1:3) = X_x(x, y, z, 2)*(&
            -0.006037724046513_wp*F%F(x, ny-11, z, 1:3) &
            +0.040935769035361_wp*F%F(x, ny-10, z, 1:3) &
            -0.086538839170864_wp*F%F(x, ny-9, z, 1:3) &
            -0.198385570949719_wp*F%F(x, ny-8, z, 1:3) &
            -0.801606505319775_wp*F%F(x, ny-7, z, 1:3) &
            +1.435201020497983_wp*F%F(x, ny-6, z, 1:3) &
            -0.370415031911393_wp*F%F(x, ny-5, z, 1:3) &
            -0.105238838717334_wp*F%F(x, ny-4, z, 1:3) &
            +0.106766263850637_wp*F%F(x, ny-3, z, 1:3) &
            -0.018834723178215_wp*F%F(x, ny-2, z, 1:3) &
            +0.013431977774914_wp*F%F(x, ny-1, z, 1:3) &
            -0.009277797865081_wp*F%F(x, ny  , z, 1:3) &
            )
!backward operator
Jr_xU(4:9) = (&
            -0.002069675638270_wp*X_x(x, ny-12, z, 2)*G%J(x, ny-12,z) *F%F(x, ny-12, z, 4:n) &
            +0.029671903383935_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
            -0.172302603068781_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
            +0.582182626758509_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
            -1.473738233660367_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
            +0.801606505319775_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
            +0.112914480906342_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
            +0.234963579047712_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
            -0.188063611561311_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
            +0.116545405705346_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
            -0.033987140247251_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
            -0.021224378711220_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
            +0.013501141765580_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
            )
end if


!=================================================================================================
Js_xU = 0.0_wp*Js_xU


if ((z .ge. 9) .and. (z .le. nz-8 )) then 
!forward operator for stress
Js_xU(1:3) = X_x(x, y, z, 3)*(&
         -0.006094104308390_wp*F%F(x, y, z-4, 1:3) &
         +0.041318027210884_wp*F%F(x, y, z-3, 1:3) &
         -0.087346938775510_wp*F%F(x, y, z-2, 1:3) &
         -0.200238095238095_wp*F%F(x, y, z-1, 1:3) &
         -0.793571428571429_wp*F%F(x, y  , z, 1:3) &
         +1.487500000000000_wp*F%F(x, y, z+1, 1:3) &
         -0.587619047619048_wp*F%F(x, y, z+2, 1:3) &
         +0.173911564625850_wp*F%F(x, y, z+3, 1:3) &
         -0.029948979591837_wp*F%F(x, y, z+4, 1:3) &
         +0.002089002267574_wp*F%F(x, y, z+5, 1:3) &
          )
!backward operator for stress
Js_xU(4:9) = (&
         -0.002089002267574_wp*X_x(x, y, z-5, 3)*G%J(x, y, z-5) *F%F(x, y, z-5, 4:n) &
         +0.029948979591837_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
         -0.173911564625850_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
         +0.587619047619048_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
         -1.487500000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
         +0.793571428571429_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
         +0.200238095238095_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
         +0.087346938775510_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
         -0.041318027210884_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
         +0.006094104308390_wp*X_x(x, y, z+4, 3)*G%J(x, y, z+4) *F%F(x, y, z+4, 4:n) &
          )
end if





if  ( z .eq. 1 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.031754582581050_wp*F%F(x, y, 8, 1:3) &
          -0.028750185890774_wp*F%F(x, y, 7, 1:3) &
          +0.259002022507736_wp*F%F(x, y, 6, 1:3) &
          -0.007517675935586_wp*F%F(x, y, 5, 1:3) &
          -0.540202079849458_wp*F%F(x, y, 4, 1:3) &
          -0.326208907351811_wp*F%F(x, y, 3, 1:3) &
          +2.402867838867655_wp*F%F(x, y, 2, 1:3) &
          -1.727436429766712_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.046209577678680_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -0.179919863435158_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.225341012357188_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.143435528046729_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.512756852476076_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.347355914148918_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +2.288587348613403_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -1.663540836635847_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 2 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.008886213078768_wp*F%F(x, y, 8, 1:3) &
          +0.030970563980613_wp*F%F(x, y, 7, 1:3) &
          -0.169872853041846_wp*F%F(x, y, 6, 1:3) &
          +0.083027816142139_wp*F%F(x, y, 5, 1:3) &
          +0.269521861814115_wp*F%F(x, y, 4, 1:3) &
          +0.240827113759967_wp*F%F(x, y, 3, 1:3) &
          -0.020993687756657_wp*F%F(x, y, 2, 1:3) &
          -0.442367027977099_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.014041443103383_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.072484217801267_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -0.153021829151466_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.036950731476631_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.257514851534530_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.243576386203318_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.020993687756657_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.464456602517554_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 3 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          -0.073807096767976_wp*F%F(x, y, 8, 1:3) &
          +0.300906140733576_wp*F%F(x, y, 7, 1:3) &
          +0.015796193741484_wp*F%F(x, y, 6, 1:3) &
          -1.365074131779745_wp*F%F(x, y, 5, 1:3) &
          +2.200793495245118_wp*F%F(x, y, 4, 1:3) &
          -0.033540711347866_wp*F%F(x, y, 3, 1:3) &
          -1.442770671653686_wp*F%F(x, y, 2, 1:3) &
          +0.397696781829095_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          -0.133184444781063_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.428518218981964_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.018559043142540_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -1.488911107347006_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +2.194478518993876_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.033540711347866_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -1.426485966426382_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.373485026088204_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 4 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.001161857736926_wp*F%F(x, y, 9, 1:3) &
          +0.059935579954567_wp*F%F(x, y, 8, 1:3) &
          -0.265439846270311_wp*F%F(x, y, 7, 1:3) &
          +0.390390908273344_wp*F%F(x, y, 6, 1:3) &
          +0.270892441959372_wp*F%F(x, y, 5, 1:3) &
          -0.008157923509094_wp*F%F(x, y, 4, 1:3) &
          -0.314371465587571_wp*F%F(x, y, 3, 1:3) &
          -0.218512451457299_wp*F%F(x, y, 2, 1:3) &
          +0.084100898900065_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.065425315357690_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -0.272423859939952_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.394484245785201_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.259731028313028_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.008157923509094_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.315276121669675_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.228700917230169_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.088602385874783_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 5 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.005060951164579_wp*F%F(x, y, 10, 1:3) &
          -0.072556322937503_wp*F%F(x, y, 9, 1:3) &
          -0.257339176012441_wp*F%F(x, y, 8, 1:3) &
          +0.845055327238168_wp*F%F(x, y, 7, 1:3) &
          +0.254013637526521_wp*F%F(x, y, 6, 1:3) &
          -0.332909622334215_wp*F%F(x, y, 5, 1:3) &
          -1.131365750247396_wp*F%F(x, y, 4, 1:3) &
          +0.929094197496254_wp*F%F(x, y, 3, 1:3) &
          -0.136576550869173_wp*F%F(x, y, 2, 1:3) &
          -0.102476691024794_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.014763968797618_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          -0.459869525614028_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +1.203157161060338_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -0.461281333687455_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.332909622334215_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -1.179983896511377_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.851818788059597_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.306885744929427_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.005370960490518_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 6 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.001633961439094_wp*F%F(x, y, 11, 1:3) &
          -0.023425287063051_wp*F%F(x, y, 10, 1:3) &
          +0.136028952587601_wp*F%F(x, y, 9, 1:3) &
          -0.292434170559197_wp*F%F(x, y, 8, 1:3) &
          +0.761005997054070_wp*F%F(x, y, 7, 1:3) &
          -0.303849703479423_wp*F%F(x, y, 6, 1:3) &
          +0.148927718784253_wp*F%F(x, y, 5, 1:3) &
          -0.554777082819560_wp*F%F(x, y, 4, 1:3) &
          -0.003739006462720_wp*F%F(x, y, 3, 1:3) &
          +0.182606463709899_wp*F%F(x, y, 2, 1:3) &
          -0.051977843190966_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.004766644632364_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
          -0.032317850607430_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.185498355711640_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.029442785989543_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.303849703479423_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.082009977023147_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.549020478169090_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.003182387692736_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          +0.202715397837640_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          -0.059742194158207_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 7 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.002262587257978_wp*F%F(x, y, 12, 1:3) &
          -0.032437580689008_wp*F%F(x, y, 11, 1:3) &
          +0.188362691723906_wp*F%F(x, y, 10, 1:3) &
          -0.636447068692001_wp*F%F(x, y, 9, 1:3) &
          +1.568974133710457_wp*F%F(x, y, 8, 1:3) &
          -0.860712585963429_wp*F%F(x, y, 7, 1:3) &
          -0.040770161905567_wp*F%F(x, y, 6, 1:3) &
          -0.537892576599693_wp*F%F(x, y, 5, 1:3) &
          +0.530514825248909_wp*F%F(x, y, 4, 1:3) &
          -0.119545562429062_wp*F%F(x, y, 3, 1:3) &
          -0.119775984081436_wp*F%F(x, y, 2, 1:3) &
          +0.057467282418948_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.006600492000887_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
          -0.044751335766011_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
          +0.094605005348522_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.123439084374344_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          +0.860712585963429_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          -1.053784031240169_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          -0.377796851524237_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          +0.516914244182689_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          -0.083945074535717_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.051177068482763_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.009182949679026_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. 8 ) then 
!forward operator for velocity
Js_xU(1:3) = X_x(x, y, z, 3)*(&
          +0.002069675638270_wp*F%F(x, y, 13, 1:3) &
          -0.029671903383935_wp*F%F(x, y, 12, 1:3) &
          +0.172302603068781_wp*F%F(x, y, 11, 1:3) &
          -0.582182626758509_wp*F%F(x, y, 10, 1:3) &
          +1.473738233660367_wp*F%F(x, y, 9, 1:3) &
          -0.801606505319775_wp*F%F(x, y, 8, 1:3) &
          -0.112914480906342_wp*F%F(x, y, 7, 1:3) &
          -0.234963579047712_wp*F%F(x, y, 6, 1:3) &
          +0.188063611561311_wp*F%F(x, y, 5, 1:3) &
          -0.116545405705346_wp*F%F(x, y, 4, 1:3) &
          +0.033987140247251_wp*F%F(x, y, 3, 1:3) &
          +0.021224378711220_wp*F%F(x, y, 2, 1:3) &
          -0.013501141765580_wp*F%F(x, y, 1, 1:3) &
         )
!backward operator for stress
Js_xU(4:9) = (&
          +0.006037724046513_wp*X_x(x, y, 12, 3)*G%J(x, y, 12) *F%F(x, y, 12, 4:n) &
          -0.040935769035361_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
          +0.086538839170864_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
          +0.198385570949719_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
          +0.801606505319775_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
          -1.435201020497983_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
          +0.370415031911393_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
          +0.105238838717334_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
          -0.106766263850637_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
          +0.018834723178215_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
          -0.013431977774914_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
          +0.009277797865081_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
          )
end if


if  ( z .eq. nz ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.046209577678680_wp*F%F(x, y,  nz-7, 1:3) &
            +0.179919863435158_wp*F%F(x, y,  nz-6, 1:3) &
            -0.225341012357188_wp*F%F(x, y,  nz-5, 1:3) &
            -0.143435528046729_wp*F%F(x, y,  nz-4, 1:3) &
            +0.512756852476076_wp*F%F(x, y,  nz-3, 1:3) &
            +0.347355914148918_wp*F%F(x, y,  nz-2, 1:3) &
            -2.288587348613403_wp*F%F(x, y,  nz-1, 1:3) &
            +1.663540836635847_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.031754582581050_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.028750185890774_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.259002022507736_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.007517675935586_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.540202079849458_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.326208907351811_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -2.402867838867655_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +1.727436429766712_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-1 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.014041443103383_wp*F%F(x, y,  nz-7, 1:3) &
            -0.072484217801267_wp*F%F(x, y,  nz-6, 1:3) &
            +0.153021829151466_wp*F%F(x, y,  nz-5, 1:3) &
            -0.036950731476631_wp*F%F(x, y,  nz-4, 1:3) &
            -0.257514851534530_wp*F%F(x, y,  nz-3, 1:3) &
            -0.243576386203318_wp*F%F(x, y,  nz-2, 1:3) &
            -0.020993687756657_wp*F%F(x, y,  nz-1, 1:3) &
            +0.464456602517554_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.008886213078768_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.030970563980613_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.169872853041846_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.083027816142139_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -0.269521861814115_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.240827113759967_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.020993687756657_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.442367027977099_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-2 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            +0.133184444781063_wp*F%F(x, y,  nz-7, 1:3) &
            -0.428518218981964_wp*F%F(x, y,  nz-6, 1:3) &
            -0.018559043142540_wp*F%F(x, y,  nz-5, 1:3) &
            +1.488911107347006_wp*F%F(x, y,  nz-4, 1:3) &
            -2.194478518993876_wp*F%F(x, y,  nz-3, 1:3) &
            -0.033540711347866_wp*F%F(x, y,  nz-2, 1:3) &
            +1.426485966426382_wp*F%F(x, y,  nz-1, 1:3) &
            -0.373485026088204_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            +0.073807096767976_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.300906140733576_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.015796193741484_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +1.365074131779745_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -2.200793495245118_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.033540711347866_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +1.442770671653686_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.397696781829095_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-3 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.065425315357690_wp*F%F(x, y,  nz-7, 1:3) &
            +0.272423859939952_wp*F%F(x, y,  nz-6, 1:3) &
            -0.394484245785201_wp*F%F(x, y,  nz-5, 1:3) &
            -0.259731028313028_wp*F%F(x, y,  nz-4, 1:3) &
            -0.008157923509094_wp*F%F(x, y,  nz-3, 1:3) &
            +0.315276121669675_wp*F%F(x, y,  nz-2, 1:3) &
            +0.228700917230169_wp*F%F(x, y,  nz-1, 1:3) &
            -0.088602385874783_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.001161857736926_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            -0.059935579954567_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.265439846270311_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.390390908273344_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.270892441959372_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.008157923509094_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.314371465587571_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.218512451457299_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.084100898900065_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-4 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.014763968797618_wp*F%F(x, y,  nz-8, 1:3) &
            +0.459869525614028_wp*F%F(x, y,  nz-7, 1:3) &
            -1.203157161060338_wp*F%F(x, y,  nz-6, 1:3) &
            +0.461281333687455_wp*F%F(x, y,  nz-5, 1:3) &
            -0.332909622334215_wp*F%F(x, y,  nz-4, 1:3) &
            +1.179983896511377_wp*F%F(x, y,  nz-3, 1:3) &
            -0.851818788059597_wp*F%F(x, y,  nz-2, 1:3) &
            +0.306885744929427_wp*F%F(x, y,  nz-1, 1:3) &
            -0.005370960490518_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.005060951164579_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            +0.072556322937503_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.257339176012441_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.845055327238168_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            -0.254013637526521_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.332909622334215_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +1.131365750247396_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.929094197496254_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.136576550869173_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.102476691024794_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-5 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.004766644632364_wp*F%F(x, y,  nz-9, 1:3) &
            +0.032317850607430_wp*F%F(x, y,  nz-8, 1:3) &
            -0.185498355711640_wp*F%F(x, y,  nz-7, 1:3) &
            -0.029442785989543_wp*F%F(x, y,  nz-6, 1:3) &
            -0.303849703479423_wp*F%F(x, y,  nz-5, 1:3) &
            +0.082009977023147_wp*F%F(x, y,  nz-4, 1:3) &
            +0.549020478169090_wp*F%F(x, y,  nz-3, 1:3) &
            +0.003182387692736_wp*F%F(x, y,  nz-2, 1:3) &
            -0.202715397837640_wp*F%F(x, y,  nz-1, 1:3) &
            +0.059742194158207_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.001633961439094_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
            +0.023425287063051_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            -0.136028952587601_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.292434170559197_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            -0.761005997054070_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.303849703479423_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.148927718784253_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.554777082819560_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.003739006462720_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.182606463709899_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.051977843190966_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-6 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.006600492000887_wp*F%F(x, y,  nz-10, 1:3) &
            +0.044751335766011_wp*F%F(x, y,  nz-9, 1:3) &
            -0.094605005348522_wp*F%F(x, y,  nz-8, 1:3) &
            -0.123439084374344_wp*F%F(x, y,  nz-7, 1:3) &
            -0.860712585963429_wp*F%F(x, y,  nz-6, 1:3) &
            +1.053784031240169_wp*F%F(x, y,  nz-5, 1:3) &
            +0.377796851524237_wp*F%F(x, y,  nz-4, 1:3) &
            -0.516914244182689_wp*F%F(x, y,  nz-3, 1:3) &
            +0.083945074535717_wp*F%F(x, y,  nz-2, 1:3) &
            +0.051177068482763_wp*F%F(x, y,  nz-1, 1:3) &
            -0.009182949679026_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.002262587257978_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
            +0.032437580689008_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
            -0.188362691723906_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            +0.636447068692001_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            -1.568974133710457_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.860712585963429_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.040770161905567_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            +0.537892576599693_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            -0.530514825248909_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            +0.119545562429062_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            +0.119775984081436_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            -0.057467282418948_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if
if  ( z .eq. nz-7 ) then 
!forward operator
Js_xU(1:3) = X_x(x, y, z, 3)*(&
            -0.006037724046513_wp*F%F(x, y,  nz-11, 1:3) &
            +0.040935769035361_wp*F%F(x, y,  nz-10, 1:3) &
            -0.086538839170864_wp*F%F(x, y,  nz-9, 1:3) &
            -0.198385570949719_wp*F%F(x, y,  nz-8, 1:3) &
            -0.801606505319775_wp*F%F(x, y,  nz-7, 1:3) &
            +1.435201020497983_wp*F%F(x, y,  nz-6, 1:3) &
            -0.370415031911393_wp*F%F(x, y,  nz-5, 1:3) &
            -0.105238838717334_wp*F%F(x, y,  nz-4, 1:3) &
            +0.106766263850637_wp*F%F(x, y,  nz-3, 1:3) &
            -0.018834723178215_wp*F%F(x, y,  nz-2, 1:3) &
            +0.013431977774914_wp*F%F(x, y,  nz-1, 1:3) &
            -0.009277797865081_wp*F%F(x, y,  nz  , 1:3) &
            )
!backward operator
Js_xU(4:9) = (&
            -0.002069675638270_wp*X_x(x, y, nz-12, 3)*G%J(x, y, nz-12) *F%F(x, y, nz-12, 4:n) &
            +0.029671903383935_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
            -0.172302603068781_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
            +0.582182626758509_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
            -1.473738233660367_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
            +0.801606505319775_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
            +0.112914480906342_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
            +0.234963579047712_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
            -0.188063611561311_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
            +0.116545405705346_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
            -0.033987140247251_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
            -0.021224378711220_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
            +0.013501141765580_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
            )
end if


!=================================================================================================


Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)


    end subroutine JJU_x7_upwind_drp


   subroutine JJU_x66_upwind_drp(x, y, z, F, G, X_x, Ju_x)


     !=================================================================================================
     !
     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     integer, intent(in) :: x, y, z                      ! indices in the tranformed cordinate
     type(block_fields), intent(in):: F
     type(block_grid_t), intent(in) :: G
     real(kind = wp), dimension(:), intent(out) :: Ju_x            ! metric coefficients
 
     real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   ! the grid
     real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            ! work array
     real(kind = wp) :: hx, hy, hz                      ! spatial steps discertizing the unit cube
     integer :: n, nx, ny, nz
 
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))
 
     !=================================================================================================
 
     Jq_xU = 0.0_wp*Jq_xU

        if ((x .ge. 7) .and. (x .le. nx-6 )) then 
        !forward operator for stress
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.008495277654156_wp*F%F(x-3, y, z, 1:3) &
                 -0.026133610245760_wp*F%F(x-2, y, z, 1:3) &
                 -0.221599169262721_wp*F%F(x-1, y, z, 1:3) &
                 -0.880668051228799_wp*F%F(x  , y, z, 1:3) &
                 +1.630668051228799_wp*F%F(x+1, y, z, 1:3) &
                 -0.678400830737279_wp*F%F(x+2, y, z, 1:3) &
                 +0.192800276912426_wp*F%F(x+3, y, z, 1:3) &
                 -0.025161944320823_wp*F%F(x+4, y, z, 1:3) &
                  )
        !backward operator for stress
        Jq_xU(4:9) = (&
                 +0.025161944320823_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
                 -0.192800276912426_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
                 +0.678400830737279_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
                 -1.630668051228799_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
                 +0.880668051228799_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
                 +0.221599169262721_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
                 +0.026133610245760_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
                 -0.008495277654156_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
                  )
        end if





        if  ( x .eq. 1 ) then 
        !forward operator for velocity
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                  +0.054390864365907_wp*F%F(6, y, z, 1:3) &
                  +0.017030439198210_wp*F%F(5, y, z, 1:3) &
                  -0.278697067118579_wp*F%F(4, y, z, 1:3) &
                  -0.310000077492595_wp*F%F(3, y, z, 1:3) &
                  +2.116015277718552_wp*F%F(2, y, z, 1:3) &
                  -1.598739436671495_wp*F%F(1, y, z, 1:3) &
                 )
        !backward operator for stress
        Jq_xU(4:9) = (&
                  +0.051408483581847_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                  +0.048718235028848_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                  -0.375624442600533_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                  -0.179520918189965_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                  +2.033999806156899_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                  -1.578981163977096_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                  )
        end if


        if  ( x .eq. 2 ) then 
        !forward operator for velocity
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                  -0.044359060855502_wp*F%F(6, y, z, 1:3) &
                  +0.052483104066436_wp*F%F(5, y, z, 1:3) &
                  +0.066991525622609_wp*F%F(4, y, z, 1:3) &
                  +0.427717407288577_wp*F%F(3, y, z, 1:3) &
                  -0.044546503433215_wp*F%F(2, y, z, 1:3) &
                  -0.458286472688905_wp*F%F(1, y, z, 1:3) &
                 )
        !backward operator for stress
        Jq_xU(4:9) = (&
                  -0.029182641501289_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                  -0.026701720228470_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                  +0.231966629260103_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                  +0.256136848603400_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                  +0.044546503433215_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                  -0.476765619566959_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                  )
        end if


        if  ( x .eq. 3 ) then 
        !forward operator for velocity
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                  -0.040916037593142_wp*F%F(7, y, z, 1:3) &
                  +0.282728838280663_wp*F%F(6, y, z, 1:3) &
                  -0.796556930687224_wp*F%F(5, y, z, 1:3) &
                  +1.510593425138449_wp*F%F(4, y, z, 1:3) &
                  -0.465986510201496_wp*F%F(3, y, z, 1:3) &
                  -0.581727498107919_wp*F%F(2, y, z, 1:3) &
                  +0.091864713170670_wp*F%F(1, y, z, 1:3) &
                 )
        !backward operator for stress
        Jq_xU(4:9) = (&
                  -0.003546071518727_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                  +0.006151323429340_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                  +0.344188754803245_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                  +0.465986510201496_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                  -0.971414220936452_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                  +0.158633704021098_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                  )
        end if


        if  ( x .eq. 4 ) then 
        !forward operator for velocity
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                  -0.020079914191268_wp*F%F(8, y, z, 1:3) &
                  +0.153859851492096_wp*F%F(7, y, z, 1:3) &
                  -0.462529841351905_wp*F%F(6, y, z, 1:3) &
                  +1.140783761441963_wp*F%F(5, y, z, 1:3) &
                  -0.478903332063016_wp*F%F(4, y, z, 1:3) &
                  -0.168913733308496_wp*F%F(3, y, z, 1:3) &
                  -0.258548085815988_wp*F%F(2, y, z, 1:3) &
                  +0.094331293796614_wp*F%F(1, y, z, 1:3) &
                 )
        !backward operator for stress
        Jq_xU(4:9) = (&
                  -0.006779462038046_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
                  +0.065741918309672_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                  +0.208150014733629_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                  +0.478903332063016_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                  -0.741337337116856_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                  -0.074668200209940_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                  +0.069989734258523_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                  )
        end if


        if  ( x .eq. 5 ) then 
        !forward operator for velocity
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                  -0.027790990695773_wp*F%F(9, y, z, 1:3) &
                  +0.212945018616134_wp*F%F(8, y, z, 1:3) &
                  -0.749283558322730_wp*F%F(7, y, z, 1:3) &
                  +1.730295435855848_wp*F%F(6, y, z, 1:3) &
                  -0.898161593464487_wp*F%F(5, y, z, 1:3) &
                  -0.288083657513983_wp*F%F(4, y, z, 1:3) &
                  -0.004178101845818_wp*F%F(3, y, z, 1:3) &
                  +0.041190516001924_wp*F%F(2, y, z, 1:3) &
                  -0.016933068631114_wp*F%F(1, y, z, 1:3) &
                 )
        !backward operator for stress
        Jq_xU(4:9) = (&
                  -0.009382906950052_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
                  +0.028864181158919_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
                  +0.207067193117658_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                  +0.898161593464487_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                  -1.578866851627773_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                  +0.541037391487111_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                  -0.080961305840296_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                  -0.005919294810055_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                  )
        end if


        if  ( x .eq. 6 ) then 
        !forward operator for velocity
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                  -0.024785938309085_wp*F%F(10, y, z, 1:3) &
                  +0.189919177492629_wp*F%F(9, y, z, 1:3) &
                  -0.668263188452071_wp*F%F(8, y, z, 1:3) &
                  +1.606300260624373_wp*F%F(7, y, z, 1:3) &
                  -0.863705820254914_wp*F%F(6, y, z, 1:3) &
                  -0.184676923922340_wp*F%F(5, y, z, 1:3) &
                  -0.081149506717170_wp*F%F(4, y, z, 1:3) &
                  +0.002148123696062_wp*F%F(3, y, z, 1:3) &
                  +0.040149849982317_wp*F%F(2, y, z, 1:3) &
                  -0.015936034139799_wp*F%F(1, y, z, 1:3) &
                 )
        !backward operator for stress
        Jq_xU(4:9) = (&
                  -0.008368328980055_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
                  +0.025743084202322_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
                  +0.218287715315586_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
                  +0.863705820254914_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
                  -1.543197808206889_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
                  +0.570930533101826_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
                  -0.171270239154302_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
                  +0.061029761086781_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
                  -0.016860537620183_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
                  )
        end if


        if  ( x .eq. nx ) then 
        !forward operator
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    -0.051408483581847_wp*F%F(nx-5, y, z, 1:3) &
                    -0.048718235028848_wp*F%F(nx-4, y, z, 1:3) &
                    +0.375624442600533_wp*F%F(nx-3, y, z, 1:3) &
                    +0.179520918189965_wp*F%F(nx-2, y, z, 1:3) &
                    -2.033999806156899_wp*F%F(nx-1, y, z, 1:3) &
                    +1.578981163977096_wp*F%F(nx  , y, z, 1:3) &
                    )
        !backward operator
        Jq_xU(4:9) = (&
                    -0.054390864365907_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                    -0.017030439198210_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                    +0.278697067118579_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                    +0.310000077492595_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                    -2.116015277718552_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                    +1.598739436671495_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                    )
        end if
        if  ( x .eq. nx-1 ) then 
        !forward operator
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.029182641501289_wp*F%F(nx-5, y, z, 1:3) &
                    +0.026701720228470_wp*F%F(nx-4, y, z, 1:3) &
                    -0.231966629260103_wp*F%F(nx-3, y, z, 1:3) &
                    -0.256136848603400_wp*F%F(nx-2, y, z, 1:3) &
                    -0.044546503433215_wp*F%F(nx-1, y, z, 1:3) &
                    +0.476765619566959_wp*F%F(nx  , y, z, 1:3) &
                    )
        !backward operator
        Jq_xU(4:9) = (&
                    +0.044359060855502_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                    -0.052483104066436_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                    -0.066991525622609_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                    -0.427717407288577_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                    +0.044546503433215_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                    +0.458286472688905_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                    )
        end if
        if  ( x .eq. nx-2 ) then 
        !forward operator
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.003546071518727_wp*F%F(nx-5, y, z, 1:3) &
                    -0.006151323429340_wp*F%F(nx-4, y, z, 1:3) &
                    -0.344188754803245_wp*F%F(nx-3, y, z, 1:3) &
                    -0.465986510201496_wp*F%F(nx-2, y, z, 1:3) &
                    +0.971414220936452_wp*F%F(nx-1, y, z, 1:3) &
                    -0.158633704021098_wp*F%F(nx  , y, z, 1:3) &
                    )
        !backward operator
        Jq_xU(4:9) = (&
                    +0.040916037593142_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                    -0.282728838280663_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                    +0.796556930687224_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                    -1.510593425138449_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                    +0.465986510201496_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                    +0.581727498107919_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                    -0.091864713170670_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                    )
        end if
        if  ( x .eq. nx-3 ) then 
        !forward operator
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.006779462038046_wp*F%F(nx-6, y, z, 1:3) &
                    -0.065741918309672_wp*F%F(nx-5, y, z, 1:3) &
                    -0.208150014733629_wp*F%F(nx-4, y, z, 1:3) &
                    -0.478903332063016_wp*F%F(nx-3, y, z, 1:3) &
                    +0.741337337116856_wp*F%F(nx-2, y, z, 1:3) &
                    +0.074668200209940_wp*F%F(nx-1, y, z, 1:3) &
                    -0.069989734258523_wp*F%F(nx  , y, z, 1:3) &
                    )
        !backward operator
        Jq_xU(4:9) = (&
                    +0.020079914191268_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                    -0.153859851492096_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                    +0.462529841351905_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                    -1.140783761441963_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                    +0.478903332063016_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                    +0.168913733308496_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                    +0.258548085815988_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                    -0.094331293796614_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                    )
        end if
        if  ( x .eq. nx-4 ) then 
        !forward operator
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.009382906950052_wp*F%F(nx-7, y, z, 1:3) &
                    -0.028864181158919_wp*F%F(nx-6, y, z, 1:3) &
                    -0.207067193117658_wp*F%F(nx-5, y, z, 1:3) &
                    -0.898161593464487_wp*F%F(nx-4, y, z, 1:3) &
                    +1.578866851627773_wp*F%F(nx-3, y, z, 1:3) &
                    -0.541037391487111_wp*F%F(nx-2, y, z, 1:3) &
                    +0.080961305840296_wp*F%F(nx-1, y, z, 1:3) &
                    +0.005919294810055_wp*F%F(nx  , y, z, 1:3) &
                    )
        !backward operator
        Jq_xU(4:9) = (&
                    +0.027790990695773_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                    -0.212945018616134_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                    +0.749283558322730_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                    -1.730295435855848_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                    +0.898161593464487_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                    +0.288083657513983_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                    +0.004178101845818_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                    -0.041190516001924_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                    +0.016933068631114_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                    )
        end if
        if  ( x .eq. nx-5 ) then 
        !forward operator
        Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                    +0.008368328980055_wp*F%F(nx-8, y, z, 1:3) &
                    -0.025743084202322_wp*F%F(nx-7, y, z, 1:3) &
                    -0.218287715315586_wp*F%F(nx-6, y, z, 1:3) &
                    -0.863705820254914_wp*F%F(nx-5, y, z, 1:3) &
                    +1.543197808206889_wp*F%F(nx-4, y, z, 1:3) &
                    -0.570930533101826_wp*F%F(nx-3, y, z, 1:3) &
                    +0.171270239154302_wp*F%F(nx-2, y, z, 1:3) &
                    -0.061029761086781_wp*F%F(nx-1, y, z, 1:3) &
                    +0.016860537620183_wp*F%F(nx  , y, z, 1:3) &
                    )
        !backward operator
        Jq_xU(4:9) = (&
                    +0.024785938309085_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                    -0.189919177492629_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                    +0.668263188452071_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                    -1.606300260624373_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                    +0.863705820254914_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                    +0.184676923922340_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                    +0.081149506717170_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                    -0.002148123696062_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                    -0.040149849982317_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                    +0.015936034139799_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                    )
        end if
    
     !=================================================================================================
 
     Jr_xU = 0.0_wp*Jr_xU


        if ((y .ge. 7) .and. (y .le. ny-6 )) then 
        !forward operator for stress
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.008495277654156_wp*F%F(x, y-3, z, 1:3) &
                 -0.026133610245760_wp*F%F(x, y-2, z, 1:3) &
                 -0.221599169262721_wp*F%F(x, y-1, z, 1:3) &
                 -0.880668051228799_wp*F%F(x, y  , z, 1:3) &
                 +1.630668051228799_wp*F%F(x, y+1, z, 1:3) &
                 -0.678400830737279_wp*F%F(x, y+2, z, 1:3) &
                 +0.192800276912426_wp*F%F(x, y+3, z, 1:3) &
                 -0.025161944320823_wp*F%F(x, y+4, z, 1:3) &
                  )
        !backward operator for stress
        Jr_xU(4:9) = (&
                 +0.025161944320823_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
                 -0.192800276912426_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
                 +0.678400830737279_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
                 -1.630668051228799_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
                 +0.880668051228799_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
                 +0.221599169262721_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
                 +0.026133610245760_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
                 -0.008495277654156_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
                  )
        end if





        if  ( y .eq. 1 ) then 
        !forward operator for velocity
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                  +0.054390864365907_wp*F%F(x, 6, z, 1:3) &
                  +0.017030439198210_wp*F%F(x, 5, z, 1:3) &
                  -0.278697067118579_wp*F%F(x, 4, z, 1:3) &
                  -0.310000077492595_wp*F%F(x, 3, z, 1:3) &
                  +2.116015277718552_wp*F%F(x, 2, z, 1:3) &
                  -1.598739436671495_wp*F%F(x, 1, z, 1:3) &
                 )
        !backward operator for stress
        Jr_xU(4:9) = (&
                  +0.051408483581847_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
                  +0.048718235028848_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
                  -0.375624442600533_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
                  -0.179520918189965_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
                  +2.033999806156899_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
                  -1.578981163977096_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
                  )
        end if


        if  ( y .eq. 2 ) then 
        !forward operator for velocity
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                  -0.044359060855502_wp*F%F(x, 6, z, 1:3) &
                  +0.052483104066436_wp*F%F(x, 5, z, 1:3) &
                  +0.066991525622609_wp*F%F(x, 4, z, 1:3) &
                  +0.427717407288577_wp*F%F(x, 3, z, 1:3) &
                  -0.044546503433215_wp*F%F(x, 2, z, 1:3) &
                  -0.458286472688905_wp*F%F(x, 1, z, 1:3) &
                 )
        !backward operator for stress
        Jr_xU(4:9) = (&
                  -0.029182641501289_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
                  -0.026701720228470_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
                  +0.231966629260103_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
                  +0.256136848603400_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
                  +0.044546503433215_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
                  -0.476765619566959_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
                  )
        end if


        if  ( y .eq. 3 ) then 
        !forward operator for velocity
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                  -0.040916037593142_wp*F%F(x, 7, z, 1:3) &
                  +0.282728838280663_wp*F%F(x, 6, z, 1:3) &
                  -0.796556930687224_wp*F%F(x, 5, z, 1:3) &
                  +1.510593425138449_wp*F%F(x, 4, z, 1:3) &
                  -0.465986510201496_wp*F%F(x, 3, z, 1:3) &
                  -0.581727498107919_wp*F%F(x, 2, z, 1:3) &
                  +0.091864713170670_wp*F%F(x, 1, z, 1:3) &
                 )
        !backward operator for stress
        Jr_xU(4:9) = (&
                  -0.003546071518727_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
                  +0.006151323429340_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
                  +0.344188754803245_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
                  +0.465986510201496_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
                  -0.971414220936452_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
                  +0.158633704021098_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
                  )
        end if


        if  ( y .eq. 4 ) then 
        !forward operator for velocity
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                  -0.020079914191268_wp*F%F(x, 8, z, 1:3) &
                  +0.153859851492096_wp*F%F(x, 7, z, 1:3) &
                  -0.462529841351905_wp*F%F(x, 6, z, 1:3) &
                  +1.140783761441963_wp*F%F(x, 5, z, 1:3) &
                  -0.478903332063016_wp*F%F(x, 4, z, 1:3) &
                  -0.168913733308496_wp*F%F(x, 3, z, 1:3) &
                  -0.258548085815988_wp*F%F(x, 2, z, 1:3) &
                  +0.094331293796614_wp*F%F(x, 1, z, 1:3) &
                 )
        !backward operator for stress
        Jr_xU(4:9) = (&
                  -0.006779462038046_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
                  +0.065741918309672_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
                  +0.208150014733629_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
                  +0.478903332063016_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
                  -0.741337337116856_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
                  -0.074668200209940_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
                  +0.069989734258523_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
                  )
        end if


        if  ( y .eq. 5 ) then 
        !forward operator for velocity
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                  -0.027790990695773_wp*F%F(x, 9, z, 1:3) &
                  +0.212945018616134_wp*F%F(x, 8, z, 1:3) &
                  -0.749283558322730_wp*F%F(x, 7, z, 1:3) &
                  +1.730295435855848_wp*F%F(x, 6, z, 1:3) &
                  -0.898161593464487_wp*F%F(x, 5, z, 1:3) &
                  -0.288083657513983_wp*F%F(x, 4, z, 1:3) &
                  -0.004178101845818_wp*F%F(x, 3, z, 1:3) &
                  +0.041190516001924_wp*F%F(x, 2, z, 1:3) &
                  -0.016933068631114_wp*F%F(x, 1, z, 1:3) &
                 )
        !backward operator for stress
        Jr_xU(4:9) = (&
                  -0.009382906950052_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
                  +0.028864181158919_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
                  +0.207067193117658_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
                  +0.898161593464487_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
                  -1.578866851627773_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
                  +0.541037391487111_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
                  -0.080961305840296_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
                  -0.005919294810055_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
                  )
        end if


        if  ( y .eq. 6 ) then 
        !forward operator for velocity
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                  -0.024785938309085_wp*F%F(x, 10, z, 1:3) &
                  +0.189919177492629_wp*F%F(x, 9, z, 1:3) &
                  -0.668263188452071_wp*F%F(x, 8, z, 1:3) &
                  +1.606300260624373_wp*F%F(x, 7, z, 1:3) &
                  -0.863705820254914_wp*F%F(x, 6, z, 1:3) &
                  -0.184676923922340_wp*F%F(x, 5, z, 1:3) &
                  -0.081149506717170_wp*F%F(x, 4, z, 1:3) &
                  +0.002148123696062_wp*F%F(x, 3, z, 1:3) &
                  +0.040149849982317_wp*F%F(x, 2, z, 1:3) &
                  -0.015936034139799_wp*F%F(x, 1, z, 1:3) &
                 )
        !backward operator for stress
        Jr_xU(4:9) = (&
                  -0.008368328980055_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
                  +0.025743084202322_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
                  +0.218287715315586_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
                  +0.863705820254914_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
                  -1.543197808206889_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
                  +0.570930533101826_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
                  -0.171270239154302_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
                  +0.061029761086781_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
                  -0.016860537620183_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
                  )
        end if


        if  ( y .eq. ny ) then 
        !forward operator
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    -0.051408483581847_wp*F%F(x, ny-5, z, 1:3) &
                    -0.048718235028848_wp*F%F(x, ny-4, z, 1:3) &
                    +0.375624442600533_wp*F%F(x, ny-3, z, 1:3) &
                    +0.179520918189965_wp*F%F(x, ny-2, z, 1:3) &
                    -2.033999806156899_wp*F%F(x, ny-1, z, 1:3) &
                    +1.578981163977096_wp*F%F(x, ny  , z, 1:3) &
                    )
        !backward operator
        Jr_xU(4:9) = (&
                    -0.054390864365907_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                    -0.017030439198210_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                    +0.278697067118579_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                    +0.310000077492595_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                    -2.116015277718552_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                    +1.598739436671495_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                    )
        end if
        if  ( y .eq. ny-1 ) then 
        !forward operator
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.029182641501289_wp*F%F(x, ny-5, z, 1:3) &
                    +0.026701720228470_wp*F%F(x, ny-4, z, 1:3) &
                    -0.231966629260103_wp*F%F(x, ny-3, z, 1:3) &
                    -0.256136848603400_wp*F%F(x, ny-2, z, 1:3) &
                    -0.044546503433215_wp*F%F(x, ny-1, z, 1:3) &
                    +0.476765619566959_wp*F%F(x, ny  , z, 1:3) &
                    )
        !backward operator
        Jr_xU(4:9) = (&
                    +0.044359060855502_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                    -0.052483104066436_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                    -0.066991525622609_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                    -0.427717407288577_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                    +0.044546503433215_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                    +0.458286472688905_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                    )
        end if
        if  ( y .eq. ny-2 ) then 
        !forward operator
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.003546071518727_wp*F%F(x, ny-5, z, 1:3) &
                    -0.006151323429340_wp*F%F(x, ny-4, z, 1:3) &
                    -0.344188754803245_wp*F%F(x, ny-3, z, 1:3) &
                    -0.465986510201496_wp*F%F(x, ny-2, z, 1:3) &
                    +0.971414220936452_wp*F%F(x, ny-1, z, 1:3) &
                    -0.158633704021098_wp*F%F(x, ny  , z, 1:3) &
                    )
        !backward operator
        Jr_xU(4:9) = (&
                    +0.040916037593142_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                    -0.282728838280663_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                    +0.796556930687224_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                    -1.510593425138449_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                    +0.465986510201496_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                    +0.581727498107919_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                    -0.091864713170670_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                    )
        end if
        if  ( y .eq. ny-3 ) then 
        !forward operator
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.006779462038046_wp*F%F(x, ny-6, z, 1:3) &
                    -0.065741918309672_wp*F%F(x, ny-5, z, 1:3) &
                    -0.208150014733629_wp*F%F(x, ny-4, z, 1:3) &
                    -0.478903332063016_wp*F%F(x, ny-3, z, 1:3) &
                    +0.741337337116856_wp*F%F(x, ny-2, z, 1:3) &
                    +0.074668200209940_wp*F%F(x, ny-1, z, 1:3) &
                    -0.069989734258523_wp*F%F(x, ny  , z, 1:3) &
                    )
        !backward operator
        Jr_xU(4:9) = (&
                    +0.020079914191268_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                    -0.153859851492096_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                    +0.462529841351905_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                    -1.140783761441963_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                    +0.478903332063016_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                    +0.168913733308496_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                    +0.258548085815988_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                    -0.094331293796614_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                    )
        end if
        if  ( y .eq. ny-4 ) then 
        !forward operator
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.009382906950052_wp*F%F(x, ny-7, z, 1:3) &
                    -0.028864181158919_wp*F%F(x, ny-6, z, 1:3) &
                    -0.207067193117658_wp*F%F(x, ny-5, z, 1:3) &
                    -0.898161593464487_wp*F%F(x, ny-4, z, 1:3) &
                    +1.578866851627773_wp*F%F(x, ny-3, z, 1:3) &
                    -0.541037391487111_wp*F%F(x, ny-2, z, 1:3) &
                    +0.080961305840296_wp*F%F(x, ny-1, z, 1:3) &
                    +0.005919294810055_wp*F%F(x, ny  , z, 1:3) &
                    )
        !backward operator
        Jr_xU(4:9) = (&
                    +0.027790990695773_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                    -0.212945018616134_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                    +0.749283558322730_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                    -1.730295435855848_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                    +0.898161593464487_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                    +0.288083657513983_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                    +0.004178101845818_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                    -0.041190516001924_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                    +0.016933068631114_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                    )
        end if
        if  ( y .eq. ny-5 ) then 
        !forward operator
        Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                    +0.008368328980055_wp*F%F(x, ny-8, z, 1:3) &
                    -0.025743084202322_wp*F%F(x, ny-7, z, 1:3) &
                    -0.218287715315586_wp*F%F(x, ny-6, z, 1:3) &
                    -0.863705820254914_wp*F%F(x, ny-5, z, 1:3) &
                    +1.543197808206889_wp*F%F(x, ny-4, z, 1:3) &
                    -0.570930533101826_wp*F%F(x, ny-3, z, 1:3) &
                    +0.171270239154302_wp*F%F(x, ny-2, z, 1:3) &
                    -0.061029761086781_wp*F%F(x, ny-1, z, 1:3) &
                    +0.016860537620183_wp*F%F(x, ny  , z, 1:3) &
                    )
        !backward operator
        Jr_xU(4:9) = (&
                    +0.024785938309085_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                    -0.189919177492629_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                    +0.668263188452071_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                    -1.606300260624373_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                    +0.863705820254914_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                    +0.184676923922340_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                    +0.081149506717170_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                    -0.002148123696062_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                    -0.040149849982317_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                    +0.015936034139799_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                    )
        end if

 
    
     !=================================================================================================
 
     Js_xU = 0.0_wp*Js_xU


        if ((z .ge. 7) .and. (z .le. nz-6 )) then 
        !forward operator for stress
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.008495277654156_wp*F%F(x, y, z-3, 1:3) &
                 -0.026133610245760_wp*F%F(x, y, z-2, 1:3) &
                 -0.221599169262721_wp*F%F(x, y, z-1, 1:3) &
                 -0.880668051228799_wp*F%F(x, y  , z, 1:3) &
                 +1.630668051228799_wp*F%F(x, y, z+1, 1:3) &
                 -0.678400830737279_wp*F%F(x, y, z+2, 1:3) &
                 +0.192800276912426_wp*F%F(x, y, z+3, 1:3) &
                 -0.025161944320823_wp*F%F(x, y, z+4, 1:3) &
                  )
        !backward operator for stress
        Js_xU(4:9) = (&
                 +0.025161944320823_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
                 -0.192800276912426_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
                 +0.678400830737279_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
                 -1.630668051228799_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
                 +0.880668051228799_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
                 +0.221599169262721_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
                 +0.026133610245760_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
                 -0.008495277654156_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
                  )
        end if





        if  ( z .eq. 1 ) then 
        !forward operator for velocity
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                  +0.054390864365907_wp*F%F(x, y, 6, 1:3) &
                  +0.017030439198210_wp*F%F(x, y, 5, 1:3) &
                  -0.278697067118579_wp*F%F(x, y, 4, 1:3) &
                  -0.310000077492595_wp*F%F(x, y, 3, 1:3) &
                  +2.116015277718552_wp*F%F(x, y, 2, 1:3) &
                  -1.598739436671495_wp*F%F(x, y, 1, 1:3) &
                 )
        !backward operator for stress
        Js_xU(4:9) = (&
                  +0.051408483581847_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
                  +0.048718235028848_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
                  -0.375624442600533_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
                  -0.179520918189965_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
                  +2.033999806156899_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
                  -1.578981163977096_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
                  )
        end if


        if  ( z .eq. 2 ) then 
        !forward operator for velocity
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                  -0.044359060855502_wp*F%F(x, y, 6, 1:3) &
                  +0.052483104066436_wp*F%F(x, y, 5, 1:3) &
                  +0.066991525622609_wp*F%F(x, y, 4, 1:3) &
                  +0.427717407288577_wp*F%F(x, y, 3, 1:3) &
                  -0.044546503433215_wp*F%F(x, y, 2, 1:3) &
                  -0.458286472688905_wp*F%F(x, y, 1, 1:3) &
                 )
        !backward operator for stress
        Js_xU(4:9) = (&
                  -0.029182641501289_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
                  -0.026701720228470_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
                  +0.231966629260103_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
                  +0.256136848603400_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
                  +0.044546503433215_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
                  -0.476765619566959_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
                  )
        end if


        if  ( z .eq. 3 ) then 
        !forward operator for velocity
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                  -0.040916037593142_wp*F%F(x, y, 7, 1:3) &
                  +0.282728838280663_wp*F%F(x, y, 6, 1:3) &
                  -0.796556930687224_wp*F%F(x, y, 5, 1:3) &
                  +1.510593425138449_wp*F%F(x, y, 4, 1:3) &
                  -0.465986510201496_wp*F%F(x, y, 3, 1:3) &
                  -0.581727498107919_wp*F%F(x, y, 2, 1:3) &
                  +0.091864713170670_wp*F%F(x, y, 1, 1:3) &
                 )
        !backward operator for stress
        Js_xU(4:9) = (&
                  -0.003546071518727_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
                  +0.006151323429340_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
                  +0.344188754803245_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
                  +0.465986510201496_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
                  -0.971414220936452_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
                  +0.158633704021098_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
                  )
        end if


        if  ( z .eq. 4 ) then 
        !forward operator for velocity
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                  -0.020079914191268_wp*F%F(x, y, 8, 1:3) &
                  +0.153859851492096_wp*F%F(x, y, 7, 1:3) &
                  -0.462529841351905_wp*F%F(x, y, 6, 1:3) &
                  +1.140783761441963_wp*F%F(x, y, 5, 1:3) &
                  -0.478903332063016_wp*F%F(x, y, 4, 1:3) &
                  -0.168913733308496_wp*F%F(x, y, 3, 1:3) &
                  -0.258548085815988_wp*F%F(x, y, 2, 1:3) &
                  +0.094331293796614_wp*F%F(x, y, 1, 1:3) &
                 )
        !backward operator for stress
        Js_xU(4:9) = (&
                  -0.006779462038046_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
                  +0.065741918309672_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
                  +0.208150014733629_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
                  +0.478903332063016_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
                  -0.741337337116856_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
                  -0.074668200209940_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
                  +0.069989734258523_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
                  )
        end if


        if  ( z .eq. 5 ) then 
        !forward operator for velocity
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                  -0.027790990695773_wp*F%F(x, y, 9, 1:3) &
                  +0.212945018616134_wp*F%F(x, y, 8, 1:3) &
                  -0.749283558322730_wp*F%F(x, y, 7, 1:3) &
                  +1.730295435855848_wp*F%F(x, y, 6, 1:3) &
                  -0.898161593464487_wp*F%F(x, y, 5, 1:3) &
                  -0.288083657513983_wp*F%F(x, y, 4, 1:3) &
                  -0.004178101845818_wp*F%F(x, y, 3, 1:3) &
                  +0.041190516001924_wp*F%F(x, y, 2, 1:3) &
                  -0.016933068631114_wp*F%F(x, y, 1, 1:3) &
                 )
        !backward operator for stress
        Js_xU(4:9) = (&
                  -0.009382906950052_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
                  +0.028864181158919_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
                  +0.207067193117658_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
                  +0.898161593464487_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
                  -1.578866851627773_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
                  +0.541037391487111_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
                  -0.080961305840296_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
                  -0.005919294810055_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
                  )
        end if


        if  ( z .eq. 6 ) then 
        !forward operator for velocity
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                  -0.024785938309085_wp*F%F(x, y, 10, 1:3) &
                  +0.189919177492629_wp*F%F(x, y, 9, 1:3) &
                  -0.668263188452071_wp*F%F(x, y, 8, 1:3) &
                  +1.606300260624373_wp*F%F(x, y, 7, 1:3) &
                  -0.863705820254914_wp*F%F(x, y, 6, 1:3) &
                  -0.184676923922340_wp*F%F(x, y, 5, 1:3) &
                  -0.081149506717170_wp*F%F(x, y, 4, 1:3) &
                  +0.002148123696062_wp*F%F(x, y, 3, 1:3) &
                  +0.040149849982317_wp*F%F(x, y, 2, 1:3) &
                  -0.015936034139799_wp*F%F(x, y, 1, 1:3) &
                 )
        !backward operator for stress
        Js_xU(4:9) = (&
                  -0.008368328980055_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
                  +0.025743084202322_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
                  +0.218287715315586_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
                  +0.863705820254914_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
                  -1.543197808206889_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
                  +0.570930533101826_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
                  -0.171270239154302_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
                  +0.061029761086781_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
                  -0.016860537620183_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
                  )
        end if


        if  ( z .eq. nz ) then 
        !forward operator
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    -0.051408483581847_wp*F%F(x, y,  nz-5, 1:3) &
                    -0.048718235028848_wp*F%F(x, y,  nz-4, 1:3) &
                    +0.375624442600533_wp*F%F(x, y,  nz-3, 1:3) &
                    +0.179520918189965_wp*F%F(x, y,  nz-2, 1:3) &
                    -2.033999806156899_wp*F%F(x, y,  nz-1, 1:3) &
                    +1.578981163977096_wp*F%F(x, y,  nz  , 1:3) &
                    )
        !backward operator
        Js_xU(4:9) = (&
                    -0.054390864365907_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                    -0.017030439198210_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                    +0.278697067118579_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                    +0.310000077492595_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                    -2.116015277718552_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                    +1.598739436671495_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                    )
        end if
        if  ( z .eq. nz-1 ) then 
        !forward operator
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.029182641501289_wp*F%F(x, y,  nz-5, 1:3) &
                    +0.026701720228470_wp*F%F(x, y,  nz-4, 1:3) &
                    -0.231966629260103_wp*F%F(x, y,  nz-3, 1:3) &
                    -0.256136848603400_wp*F%F(x, y,  nz-2, 1:3) &
                    -0.044546503433215_wp*F%F(x, y,  nz-1, 1:3) &
                    +0.476765619566959_wp*F%F(x, y,  nz  , 1:3) &
                    )
        !backward operator
        Js_xU(4:9) = (&
                    +0.044359060855502_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                    -0.052483104066436_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                    -0.066991525622609_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                    -0.427717407288577_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                    +0.044546503433215_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                    +0.458286472688905_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                    )
        end if
        if  ( z .eq. nz-2 ) then 
        !forward operator
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.003546071518727_wp*F%F(x, y,  nz-5, 1:3) &
                    -0.006151323429340_wp*F%F(x, y,  nz-4, 1:3) &
                    -0.344188754803245_wp*F%F(x, y,  nz-3, 1:3) &
                    -0.465986510201496_wp*F%F(x, y,  nz-2, 1:3) &
                    +0.971414220936452_wp*F%F(x, y,  nz-1, 1:3) &
                    -0.158633704021098_wp*F%F(x, y,  nz  , 1:3) &
                    )
        !backward operator
        Js_xU(4:9) = (&
                    +0.040916037593142_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                    -0.282728838280663_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                    +0.796556930687224_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                    -1.510593425138449_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                    +0.465986510201496_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                    +0.581727498107919_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                    -0.091864713170670_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                    )
        end if
        if  ( z .eq. nz-3 ) then 
        !forward operator
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.006779462038046_wp*F%F(x, y,  nz-6, 1:3) &
                    -0.065741918309672_wp*F%F(x, y,  nz-5, 1:3) &
                    -0.208150014733629_wp*F%F(x, y,  nz-4, 1:3) &
                    -0.478903332063016_wp*F%F(x, y,  nz-3, 1:3) &
                    +0.741337337116856_wp*F%F(x, y,  nz-2, 1:3) &
                    +0.074668200209940_wp*F%F(x, y,  nz-1, 1:3) &
                    -0.069989734258523_wp*F%F(x, y,  nz  , 1:3) &
                    )
        !backward operator
        Js_xU(4:9) = (&
                    +0.020079914191268_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                    -0.153859851492096_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                    +0.462529841351905_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                    -1.140783761441963_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                    +0.478903332063016_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                    +0.168913733308496_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                    +0.258548085815988_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                    -0.094331293796614_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                    )
        end if
        if  ( z .eq. nz-4 ) then 
        !forward operator
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.009382906950052_wp*F%F(x, y,  nz-7, 1:3) &
                    -0.028864181158919_wp*F%F(x, y,  nz-6, 1:3) &
                    -0.207067193117658_wp*F%F(x, y,  nz-5, 1:3) &
                    -0.898161593464487_wp*F%F(x, y,  nz-4, 1:3) &
                    +1.578866851627773_wp*F%F(x, y,  nz-3, 1:3) &
                    -0.541037391487111_wp*F%F(x, y,  nz-2, 1:3) &
                    +0.080961305840296_wp*F%F(x, y,  nz-1, 1:3) &
                    +0.005919294810055_wp*F%F(x, y,  nz  , 1:3) &
                    )
        !backward operator
        Js_xU(4:9) = (&
                    +0.027790990695773_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                    -0.212945018616134_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                    +0.749283558322730_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                    -1.730295435855848_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                    +0.898161593464487_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                    +0.288083657513983_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                    +0.004178101845818_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                    -0.041190516001924_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                    +0.016933068631114_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                    )
        end if
        if  ( z .eq. nz-5 ) then 
        !forward operator
        Js_xU(1:3) = X_x(x, y, z, 3)*(&
                    +0.008368328980055_wp*F%F(x, y,  nz-8, 1:3) &
                    -0.025743084202322_wp*F%F(x, y,  nz-7, 1:3) &
                    -0.218287715315586_wp*F%F(x, y,  nz-6, 1:3) &
                    -0.863705820254914_wp*F%F(x, y,  nz-5, 1:3) &
                    +1.543197808206889_wp*F%F(x, y,  nz-4, 1:3) &
                    -0.570930533101826_wp*F%F(x, y,  nz-3, 1:3) &
                    +0.171270239154302_wp*F%F(x, y,  nz-2, 1:3) &
                    -0.061029761086781_wp*F%F(x, y,  nz-1, 1:3) &
                    +0.016860537620183_wp*F%F(x, y,  nz  , 1:3) &
                    )
        !backward operator
        Js_xU(4:9) = (&
                    +0.024785938309085_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                    -0.189919177492629_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                    +0.668263188452071_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                    -1.606300260624373_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                    +0.863705820254914_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                    +0.184676923922340_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                    +0.081149506717170_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                    -0.002148123696062_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                    -0.040149849982317_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                    +0.015936034139799_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                    )
        end if




   !=================================================================================================

 

   Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)


   end subroutine JJU_x66_upwind_drp


 subroutine JJU_x679_upwind_drp(x, y, z, F, G, X_x, Ju_x)


     !=================================================================================================
     !
     use datatypes, only: block_fields, block_grid_t
 
     implicit none
     
     integer, intent(in) :: x, y, z                      ! indices in the tranformed cordinate
     type(block_fields), intent(in):: F
     type(block_grid_t), intent(in) :: G
     real(kind = wp), dimension(:), intent(out) :: Ju_x            ! metric coefficients
 
     real(kind = wp), dimension(:,:,:,:), allocatable, intent(in) :: X_x   ! the grid
     real(kind = wp), dimension(:), allocatable, save :: Jq_xU, Jr_xU, Js_xU            ! work array
     real(kind = wp) :: hx, hy, hz                      ! spatial steps discertizing the unit cube
     integer :: n, nx, ny, nz
 
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     ! work arrays:
     if (.not. allocated(Jq_xU)) allocate(Jq_xU(n))
     if (.not. allocated(Jr_xU)) allocate(Jr_xU(n))
     if (.not. allocated(Js_xU)) allocate(Js_xU(n))
 
     !=================================================================================================
     Jq_xU = 0.0_wp*Jq_xU

          
     if ((x .ge. 9) .and. (x .le. nx-8 )) then 
     !forward operator for stress
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
              -0.006094104308390_wp*F%F(x-4, y, z, 1:3) &
              +0.041318027210884_wp*F%F(x-3, y, z, 1:3) &
              -0.087346938775510_wp*F%F(x-2, y, z, 1:3) &
              -0.200238095238095_wp*F%F(x-1, y, z, 1:3) &
              -0.793571428571429_wp*F%F(x  , y, z, 1:3) &
              +1.487500000000000_wp*F%F(x+1, y, z, 1:3) &
              -0.587619047619048_wp*F%F(x+2, y, z, 1:3) &
              +0.173911564625850_wp*F%F(x+3, y, z, 1:3) &
              -0.029948979591837_wp*F%F(x+4, y, z, 1:3) &
              +0.002089002267574_wp*F%F(x+5, y, z, 1:3) &
               )
     !backward operator for stress
     Jq_xU(4:9) = (&
              -0.002089002267574_wp*X_x(x-5, y, z, 1)*G%J(x-5,y,z) *F%F(x-5, y, z, 4:n) &
              +0.029948979591837_wp*X_x(x-4, y, z, 1)*G%J(x-4,y,z) *F%F(x-4, y, z, 4:n) &
              -0.173911564625850_wp*X_x(x-3, y, z, 1)*G%J(x-3,y,z) *F%F(x-3, y, z, 4:n) &
              +0.587619047619048_wp*X_x(x-2, y, z, 1)*G%J(x-2,y,z) *F%F(x-2, y, z, 4:n) &
              -1.487500000000000_wp*X_x(x-1, y, z, 1)*G%J(x-1,y,z) *F%F(x-1, y, z, 4:n) &
              +0.793571428571429_wp*X_x(x  , y, z, 1)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.200238095238095_wp*X_x(x+1, y, z, 1)*G%J(x+1,y,z) *F%F(x+1, y, z, 4:n) &
              +0.087346938775510_wp*X_x(x+2, y, z, 1)*G%J(x+2,y,z) *F%F(x+2, y, z, 4:n) &
              -0.041318027210884_wp*X_x(x+3, y, z, 1)*G%J(x+3,y,z) *F%F(x+3, y, z, 4:n) &
              +0.006094104308390_wp*X_x(x+4, y, z, 1)*G%J(x+4,y,z) *F%F(x+4, y, z, 4:n) &
               )
     end if





     if  ( x .eq. 1 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.033005239880522_wp*F%F(8, y, z, 1:3) &
               -0.025881634391799_wp*F%F(7, y, z, 1:3) &
               +0.263392722344631_wp*F%F(6, y, z, 1:3) &
               -0.030209714180198_wp*F%F(5, y, z, 1:3) &
               -0.506938949737935_wp*F%F(4, y, z, 1:3) &
               -0.350517535783371_wp*F%F(3, y, z, 1:3) &
               +2.412053651292632_wp*F%F(2, y, z, 1:3) &
               -1.728893299663438_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.044374156234105_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.174198378773702_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.220245640409051_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.139299657443443_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.495449593250587_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.370787168310084_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +2.304067463556378_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -1.667551777308605_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 2 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.008828095360976_wp*F%F(8, y, z, 1:3) &
               +0.029911851210588_wp*F%F(7, y, z, 1:3) &
               -0.170162903794152_wp*F%F(6, y, z, 1:3) &
               +0.094426023794218_wp*F%F(5, y, z, 1:3) &
               +0.250037914252055_wp*F%F(4, y, z, 1:3) &
               +0.250891381680726_wp*F%F(3, y, z, 1:3) &
               -0.020053857114091_wp*F%F(2, y, z, 1:3) &
               -0.443878505390320_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.011723708576681_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.065174528307485_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -0.148801997699767_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.046588172420165_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.241839854684496_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.251551333921227_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.020053857114091_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.464682040171017_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 3 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               -0.086554962191340_wp*F%F(8, y, z, 1:3) &
               +0.357259827206167_wp*F%F(7, y, z, 1:3) &
               -0.022134128148434_wp*F%F(6, y, z, 1:3) &
               -1.484851853641141_wp*F%F(5, y, z, 1:3) &
               +2.378309161955782_wp*F%F(4, y, z, 1:3) &
               -0.045718284610534_wp*F%F(3, y, z, 1:3) &
               -1.531087089237169_wp*F%F(2, y, z, 1:3) &
               +0.434777328666669_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               -0.156241518792227_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.505832529848511_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -0.010613520806507_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -1.646697927315869_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +2.378062811419621_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.045718284610534_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -1.527070237729393_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.411009578765331_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 4 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.001155664084666_wp*F%F(9, y, z, 1:3) &
               +0.079463252429367_wp*F%F(8, y, z, 1:3) &
               -0.299393382304440_wp*F%F(7, y, z, 1:3) &
               +0.407288103594466_wp*F%F(6, y, z, 1:3) &
               +0.281750824243924_wp*F%F(5, y, z, 1:3) &
               -0.012373610391183_wp*F%F(4, y, z, 1:3) &
               -0.330330927617320_wp*F%F(3, y, z, 1:3) &
               -0.204468804842354_wp*F%F(2, y, z, 1:3) &
               +0.080698894497091_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.061651661535115_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -0.263535772373310_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.389840903051706_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.258864496540571_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.012373610391183_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.330365147571788_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.211400033956727_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.082570282383251_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 5 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.005181940496807_wp*F%F(10, y, z, 1:3) &
               -0.074290886416910_wp*F%F(9, y, z, 1:3) &
               -0.517048981121307_wp*F%F(8, y, z, 1:3) &
               +1.165933921548919_wp*F%F(7, y, z, 1:3) &
               +0.122648484113833_wp*F%F(6, y, z, 1:3) &
               -0.373648890457135_wp*F%F(5, y, z, 1:3) &
               -1.160735576719516_wp*F%F(4, y, z, 1:3) &
               +1.025653483809176_wp*F%F(3, y, z, 1:3) &
               -0.176618285456005_wp*F%F(2, y, z, 1:3) &
               -0.101737008335247_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.015116922751879_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               -0.428167834093026_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +1.111936792339292_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -0.397762766470929_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.373648890457135_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -1.263356736209345_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.924846902011930_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.357974171524791_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.022063557080921_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 6 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.001625719379320_wp*F%F(11, y, z, 1:3) &
               -0.023307124778684_wp*F%F(10, y, z, 1:3) &
               +0.135342792723918_wp*F%F(9, y, z, 1:3) &
               -0.203098167192540_wp*F%F(8, y, z, 1:3) &
               +0.696367795879953_wp*F%F(7, y, z, 1:3) &
               -0.264391437780108_wp*F%F(6, y, z, 1:3) &
               +0.124789282744944_wp*F%F(5, y, z, 1:3) &
               -0.548404955515763_wp*F%F(4, y, z, 1:3) &
               +0.002073955135157_wp*F%F(3, y, z, 1:3) &
               +0.176979071835593_wp*F%F(2, y, z, 1:3) &
               -0.050464897545544_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.004742600631665_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               -0.032154832282687_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.195432746208080_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.037422964670561_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.264391437780108_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.038478253000180_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.572948637727217_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.004325161232786_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               +0.202384868750895_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               -0.060351191163998_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 7 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.002269041949790_wp*F%F(12, y, z, 1:3) &
               -0.032530118373793_wp*F%F(11, y, z, 1:3) &
               +0.188900051385807_wp*F%F(10, y, z, 1:3) &
               -0.638262720074556_wp*F%F(9, y, z, 1:3) &
               +1.560836153489656_wp*F%F(8, y, z, 1:3) &
               -0.905179927543220_wp*F%F(7, y, z, 1:3) &
               -0.052231816759526_wp*F%F(6, y, z, 1:3) &
               -0.486889270320233_wp*F%F(5, y, z, 1:3) &
               +0.517428663501413_wp*F%F(4, y, z, 1:3) &
               -0.137956948397386_wp*F%F(3, y, z, 1:3) &
               -0.108190216650142_wp*F%F(2, y, z, 1:3) &
               +0.055708713136433_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.006619321834531_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
               -0.044879002038120_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               +0.094874893792050_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.035940522255854_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               +0.905179927543220_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               -0.971931417829373_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               -0.510533260717342_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               +0.587831838812040_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               -0.097436350250351_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.049653902328415_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.008276957317196_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. 8 ) then 
     !forward operator for velocity
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
               +0.002068702062188_wp*F%F(13, y, z, 1:3) &
               -0.029657945711095_wp*F%F(12, y, z, 1:3) &
               +0.172221551869199_wp*F%F(11, y, z, 1:3) &
               -0.581908767864714_wp*F%F(10, y, z, 1:3) &
               +1.473044986723988_wp*F%F(9, y, z, 1:3) &
               -0.892828448398233_wp*F%F(8, y, z, 1:3) &
               -0.032767235755012_wp*F%F(7, y, z, 1:3) &
               -0.248685062282352_wp*F%F(6, y, z, 1:3) &
               +0.170930500243401_wp*F%F(5, y, z, 1:3) &
               -0.110359853738840_wp*F%F(4, y, z, 1:3) &
               +0.038849792028224_wp*F%F(3, y, z, 1:3) &
               +0.017743142086478_wp*F%F(2, y, z, 1:3) &
               -0.012937922578870_wp*F%F(1, y, z, 1:3) &
              )
     !backward operator for stress
     Jq_xU(4:9) = (&
               +0.006034883899191_wp*X_x(12, y, z, 1)*G%J(12,y,z) *F%F(12, y, z, 4:n) &
               -0.040916512836517_wp*X_x(11, y, z, 1)*G%J(11,y,z) *F%F(11, y, z, 4:n) &
               +0.086498131273245_wp*X_x(10, y, z, 1)*G%J(10,y,z) *F%F(10, y, z, 4:n) &
               +0.198292250313705_wp*X_x(9, y, z, 1)*G%J(9,y,z) *F%F(9, y, z, 4:n) &
               +0.892828448398233_wp*X_x(8, y, z, 1)*G%J(8,y,z) *F%F(8, y, z, 4:n) &
               -1.423025682605699_wp*X_x(7, y, z, 1)*G%J(7,y,z) *F%F(7, y, z, 4:n) &
               +0.258439188609325_wp*X_x(6, y, z, 1)*G%J(6,y,z) *F%F(6, y, z, 4:n) &
               +0.206413079068906_wp*X_x(5, y, z, 1)*G%J(5,y,z) *F%F(5, y, z, 4:n) &
               -0.142243577826732_wp*X_x(4, y, z, 1)*G%J(4,y,z) *F%F(4, y, z, 4:n) &
               +0.021522078805545_wp*X_x(3, y, z, 1)*G%J(3,y,z) *F%F(3, y, z, 4:n) &
               -0.013360802114642_wp*X_x(2, y, z, 1)*G%J(2,y,z) *F%F(2, y, z, 4:n) &
               +0.009623151728641_wp*X_x(1, y, z, 1)*G%J(1,y,z) *F%F(1, y, z, 4:n) &
               )
     end if


     if  ( x .eq. nx ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.044374156234105_wp*F%F(nx-7, y, z, 1:3) &
                 +0.174198378773702_wp*F%F(nx-6, y, z, 1:3) &
                 -0.220245640409051_wp*F%F(nx-5, y, z, 1:3) &
                 -0.139299657443443_wp*F%F(nx-4, y, z, 1:3) &
                 +0.495449593250587_wp*F%F(nx-3, y, z, 1:3) &
                 +0.370787168310084_wp*F%F(nx-2, y, z, 1:3) &
                 -2.304067463556378_wp*F%F(nx-1, y, z, 1:3) &
                 +1.667551777308605_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.033005239880522_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.025881634391799_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.263392722344631_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.030209714180198_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.506938949737935_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.350517535783371_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -2.412053651292632_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +1.728893299663438_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-1 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.011723708576681_wp*F%F(nx-7, y, z, 1:3) &
                 -0.065174528307485_wp*F%F(nx-6, y, z, 1:3) &
                 +0.148801997699767_wp*F%F(nx-5, y, z, 1:3) &
                 -0.046588172420165_wp*F%F(nx-4, y, z, 1:3) &
                 -0.241839854684496_wp*F%F(nx-3, y, z, 1:3) &
                 -0.251551333921227_wp*F%F(nx-2, y, z, 1:3) &
                 -0.020053857114091_wp*F%F(nx-1, y, z, 1:3) &
                 +0.464682040171017_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.008828095360976_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.029911851210588_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.170162903794152_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.094426023794218_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.250037914252055_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.250891381680726_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.020053857114091_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.443878505390320_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-2 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 +0.156241518792227_wp*F%F(nx-7, y, z, 1:3) &
                 -0.505832529848511_wp*F%F(nx-6, y, z, 1:3) &
                 +0.010613520806507_wp*F%F(nx-5, y, z, 1:3) &
                 +1.646697927315869_wp*F%F(nx-4, y, z, 1:3) &
                 -2.378062811419621_wp*F%F(nx-3, y, z, 1:3) &
                 -0.045718284610534_wp*F%F(nx-2, y, z, 1:3) &
                 +1.527070237729393_wp*F%F(nx-1, y, z, 1:3) &
                 -0.411009578765331_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 +0.086554962191340_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.357259827206167_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.022134128148434_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +1.484851853641141_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -2.378309161955782_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.045718284610534_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +1.531087089237169_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.434777328666669_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-3 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.061651661535115_wp*F%F(nx-7, y, z, 1:3) &
                 +0.263535772373310_wp*F%F(nx-6, y, z, 1:3) &
                 -0.389840903051706_wp*F%F(nx-5, y, z, 1:3) &
                 -0.258864496540571_wp*F%F(nx-4, y, z, 1:3) &
                 -0.012373610391183_wp*F%F(nx-3, y, z, 1:3) &
                 +0.330365147571788_wp*F%F(nx-2, y, z, 1:3) &
                 +0.211400033956727_wp*F%F(nx-1, y, z, 1:3) &
                 -0.082570282383251_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.001155664084666_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 -0.079463252429367_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.299393382304440_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.407288103594466_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.281750824243924_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.012373610391183_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.330330927617320_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.204468804842354_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.080698894497091_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-4 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.015116922751879_wp*F%F(nx-8, y, z, 1:3) &
                 +0.428167834093026_wp*F%F(nx-7, y, z, 1:3) &
                 -1.111936792339292_wp*F%F(nx-6, y, z, 1:3) &
                 +0.397762766470929_wp*F%F(nx-5, y, z, 1:3) &
                 -0.373648890457135_wp*F%F(nx-4, y, z, 1:3) &
                 +1.263356736209345_wp*F%F(nx-3, y, z, 1:3) &
                 -0.924846902011930_wp*F%F(nx-2, y, z, 1:3) &
                 +0.357974171524791_wp*F%F(nx-1, y, z, 1:3) &
                 -0.022063557080921_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.005181940496807_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 +0.074290886416910_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.517048981121307_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -1.165933921548919_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 -0.122648484113833_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.373648890457135_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +1.160735576719516_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -1.025653483809176_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.176618285456005_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.101737008335247_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-5 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.004742600631665_wp*F%F(nx-9, y, z, 1:3) &
                 +0.032154832282687_wp*F%F(nx-8, y, z, 1:3) &
                 -0.195432746208080_wp*F%F(nx-7, y, z, 1:3) &
                 -0.037422964670561_wp*F%F(nx-6, y, z, 1:3) &
                 -0.264391437780108_wp*F%F(nx-5, y, z, 1:3) &
                 +0.038478253000180_wp*F%F(nx-4, y, z, 1:3) &
                 +0.572948637727217_wp*F%F(nx-3, y, z, 1:3) &
                 -0.004325161232786_wp*F%F(nx-2, y, z, 1:3) &
                 -0.202384868750895_wp*F%F(nx-1, y, z, 1:3) &
                 +0.060351191163998_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.001625719379320_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 +0.023307124778684_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 -0.135342792723918_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.203098167192540_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 -0.696367795879953_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.264391437780108_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.124789282744944_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.548404955515763_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.002073955135157_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -0.176979071835593_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.050464897545544_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-6 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.006619321834531_wp*F%F(nx-10, y, z, 1:3) &
                 +0.044879002038120_wp*F%F(nx-9, y, z, 1:3) &
                 -0.094874893792050_wp*F%F(nx-8, y, z, 1:3) &
                 -0.035940522255854_wp*F%F(nx-7, y, z, 1:3) &
                 -0.905179927543220_wp*F%F(nx-6, y, z, 1:3) &
                 +0.971931417829373_wp*F%F(nx-5, y, z, 1:3) &
                 +0.510533260717342_wp*F%F(nx-4, y, z, 1:3) &
                 -0.587831838812040_wp*F%F(nx-3, y, z, 1:3) &
                 +0.097436350250351_wp*F%F(nx-2, y, z, 1:3) &
                 +0.049653902328415_wp*F%F(nx-1, y, z, 1:3) &
                 -0.008276957317196_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.002269041949790_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
                 +0.032530118373793_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 -0.188900051385807_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 +0.638262720074556_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 -1.560836153489656_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.905179927543220_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.052231816759526_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 +0.486889270320233_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 -0.517428663501413_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 +0.137956948397386_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 +0.108190216650142_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 -0.055708713136433_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if
     if  ( x .eq. nx-7 ) then 
     !forward operator
     Jq_xU(1:3) = X_x(x, y, z, 1)*(&
                 -0.006034883899191_wp*F%F(nx-11, y, z, 1:3) &
                 +0.040916512836517_wp*F%F(nx-10, y, z, 1:3) &
                 -0.086498131273245_wp*F%F(nx-9, y, z, 1:3) &
                 -0.198292250313705_wp*F%F(nx-8, y, z, 1:3) &
                 -0.892828448398233_wp*F%F(nx-7, y, z, 1:3) &
                 +1.423025682605699_wp*F%F(nx-6, y, z, 1:3) &
                 -0.258439188609325_wp*F%F(nx-5, y, z, 1:3) &
                 -0.206413079068906_wp*F%F(nx-4, y, z, 1:3) &
                 +0.142243577826732_wp*F%F(nx-3, y, z, 1:3) &
                 -0.021522078805545_wp*F%F(nx-2, y, z, 1:3) &
                 +0.013360802114642_wp*F%F(nx-1, y, z, 1:3) &
                 -0.009623151728641_wp*F%F(nx  , y, z, 1:3) &
                 )
     !backward operator
     Jq_xU(4:9) = (&
                 -0.002068702062188_wp*X_x(nx-12, y, z, 1)*G%J(nx-12,y,z) *F%F(nx-12, y, z, 4:n) &
                 +0.029657945711095_wp*X_x(nx-11, y, z, 1)*G%J(nx-11,y,z) *F%F(nx-11, y, z, 4:n) &
                 -0.172221551869199_wp*X_x(nx-10, y, z, 1)*G%J(nx-10,y,z) *F%F(nx-10, y, z, 4:n) &
                 +0.581908767864714_wp*X_x(nx-9, y, z, 1)*G%J(nx-9,y,z) *F%F(nx-9, y, z, 4:n) &
                 -1.473044986723988_wp*X_x(nx-8, y, z, 1)*G%J(nx-8,y,z) *F%F(nx-8, y, z, 4:n) &
                 +0.892828448398233_wp*X_x(nx-7, y, z, 1)*G%J(nx-7,y,z) *F%F(nx-7, y, z, 4:n) &
                 +0.032767235755012_wp*X_x(nx-6, y, z, 1)*G%J(nx-6,y,z) *F%F(nx-6, y, z, 4:n) &
                 +0.248685062282352_wp*X_x(nx-5, y, z, 1)*G%J(nx-5,y,z) *F%F(nx-5, y, z, 4:n) &
                 -0.170930500243401_wp*X_x(nx-4, y, z, 1)*G%J(nx-4,y,z) *F%F(nx-4, y, z, 4:n) &
                 +0.110359853738840_wp*X_x(nx-3, y, z, 1)*G%J(nx-3,y,z) *F%F(nx-3, y, z, 4:n) &
                 -0.038849792028224_wp*X_x(nx-2, y, z, 1)*G%J(nx-2,y,z) *F%F(nx-2, y, z, 4:n) &
                 -0.017743142086478_wp*X_x(nx-1, y, z, 1)*G%J(nx-1,y,z) *F%F(nx-1, y, z, 4:n) &
                 +0.012937922578870_wp*X_x(nx  , y, z, 1)*G%J(nx  ,y,z) *F%F(nx  , y, z, 4:n) &
                 )
     end if


     !=================================================================================================

     Jr_xU = 0.0_wp*Jr_xU

     if ((y .ge. 9) .and. (y .le. ny-8 )) then 
     !forward operator for stress
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
              -0.006094104308390_wp*F%F(x, y-4, z, 1:3) &
              +0.041318027210884_wp*F%F(x, y-3, z, 1:3) &
              -0.087346938775510_wp*F%F(x, y-2, z, 1:3) &
              -0.200238095238095_wp*F%F(x, y-1, z, 1:3) &
              -0.793571428571429_wp*F%F(x, y  , z, 1:3) &
              +1.487500000000000_wp*F%F(x, y+1, z, 1:3) &
              -0.587619047619048_wp*F%F(x, y+2, z, 1:3) &
              +0.173911564625850_wp*F%F(x, y+3, z, 1:3) &
              -0.029948979591837_wp*F%F(x, y+4, z, 1:3) &
              +0.002089002267574_wp*F%F(x, y+5, z, 1:3) &
               )
     !backward operator for stress
     Jr_xU(4:9) = (&
              -0.002089002267574_wp*X_x(x, y-5, z, 2)*G%J(x, y-5,z) *F%F(x, y-5, z, 4:n) &
              +0.029948979591837_wp*X_x(x, y-4, z, 2)*G%J(x, y-4,z) *F%F(x, y-4, z, 4:n) &
              -0.173911564625850_wp*X_x(x, y-3, z, 2)*G%J(x, y-3,z) *F%F(x, y-3, z, 4:n) &
              +0.587619047619048_wp*X_x(x, y-2, z, 2)*G%J(x, y-2,z) *F%F(x, y-2, z, 4:n) &
              -1.487500000000000_wp*X_x(x, y-1, z, 2)*G%J(x, y-1,z) *F%F(x, y-1, z, 4:n) &
              +0.793571428571429_wp*X_x(x  , y, z, 2)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.200238095238095_wp*X_x(x, y+1, z, 2)*G%J(x, y+1,z) *F%F(x, y+1, z, 4:n) &
              +0.087346938775510_wp*X_x(x, y+2, z, 2)*G%J(x, y+2,z) *F%F(x, y+2, z, 4:n) &
              -0.041318027210884_wp*X_x(x, y+3, z, 2)*G%J(x, y+3,z) *F%F(x, y+3, z, 4:n) &
              +0.006094104308390_wp*X_x(x, y+4, z, 2)*G%J(x, y+4,z) *F%F(x, y+4, z, 4:n) &
               )
     end if





     if  ( y .eq. 1 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.033005239880522_wp*F%F(x, 8, z, 1:3) &
               -0.025881634391799_wp*F%F(x, 7, z, 1:3) &
               +0.263392722344631_wp*F%F(x, 6, z, 1:3) &
               -0.030209714180198_wp*F%F(x, 5, z, 1:3) &
               -0.506938949737935_wp*F%F(x, 4, z, 1:3) &
               -0.350517535783371_wp*F%F(x, 3, z, 1:3) &
               +2.412053651292632_wp*F%F(x, 2, z, 1:3) &
               -1.728893299663438_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.044374156234105_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.174198378773702_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.220245640409051_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.139299657443443_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.495449593250587_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.370787168310084_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +2.304067463556378_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -1.667551777308605_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 2 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.008828095360976_wp*F%F(x, 8, z, 1:3) &
               +0.029911851210588_wp*F%F(x, 7, z, 1:3) &
               -0.170162903794152_wp*F%F(x, 6, z, 1:3) &
               +0.094426023794218_wp*F%F(x, 5, z, 1:3) &
               +0.250037914252055_wp*F%F(x, 4, z, 1:3) &
               +0.250891381680726_wp*F%F(x, 3, z, 1:3) &
               -0.020053857114091_wp*F%F(x, 2, z, 1:3) &
               -0.443878505390320_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.011723708576681_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.065174528307485_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -0.148801997699767_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.046588172420165_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.241839854684496_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.251551333921227_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.020053857114091_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.464682040171017_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 3 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               -0.086554962191340_wp*F%F(x, 8, z, 1:3) &
               +0.357259827206167_wp*F%F(x, 7, z, 1:3) &
               -0.022134128148434_wp*F%F(x, 6, z, 1:3) &
               -1.484851853641141_wp*F%F(x, 5, z, 1:3) &
               +2.378309161955782_wp*F%F(x, 4, z, 1:3) &
               -0.045718284610534_wp*F%F(x, 3, z, 1:3) &
               -1.531087089237169_wp*F%F(x, 2, z, 1:3) &
               +0.434777328666669_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               -0.156241518792227_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.505832529848511_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -0.010613520806507_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -1.646697927315869_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +2.378062811419621_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.045718284610534_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -1.527070237729393_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.411009578765331_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 4 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.001155664084666_wp*F%F(x, 9, z, 1:3) &
               +0.079463252429367_wp*F%F(x, 8, z, 1:3) &
               -0.299393382304440_wp*F%F(x, 7, z, 1:3) &
               +0.407288103594466_wp*F%F(x, 6, z, 1:3) &
               +0.281750824243924_wp*F%F(x, 5, z, 1:3) &
               -0.012373610391183_wp*F%F(x, 4, z, 1:3) &
               -0.330330927617320_wp*F%F(x, 3, z, 1:3) &
               -0.204468804842354_wp*F%F(x, 2, z, 1:3) &
               +0.080698894497091_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.061651661535115_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -0.263535772373310_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.389840903051706_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.258864496540571_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.012373610391183_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.330365147571788_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.211400033956727_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.082570282383251_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 5 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.005181940496807_wp*F%F(x, 10, z, 1:3) &
               -0.074290886416910_wp*F%F(x, 9, z, 1:3) &
               -0.517048981121307_wp*F%F(x, 8, z, 1:3) &
               +1.165933921548919_wp*F%F(x, 7, z, 1:3) &
               +0.122648484113833_wp*F%F(x, 6, z, 1:3) &
               -0.373648890457135_wp*F%F(x, 5, z, 1:3) &
               -1.160735576719516_wp*F%F(x, 4, z, 1:3) &
               +1.025653483809176_wp*F%F(x, 3, z, 1:3) &
               -0.176618285456005_wp*F%F(x, 2, z, 1:3) &
               -0.101737008335247_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.015116922751879_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               -0.428167834093026_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +1.111936792339292_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -0.397762766470929_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.373648890457135_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -1.263356736209345_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.924846902011930_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.357974171524791_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.022063557080921_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 6 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.001625719379320_wp*F%F(x, 11, z, 1:3) &
               -0.023307124778684_wp*F%F(x, 10, z, 1:3) &
               +0.135342792723918_wp*F%F(x, 9, z, 1:3) &
               -0.203098167192540_wp*F%F(x, 8, z, 1:3) &
               +0.696367795879953_wp*F%F(x, 7, z, 1:3) &
               -0.264391437780108_wp*F%F(x, 6, z, 1:3) &
               +0.124789282744944_wp*F%F(x, 5, z, 1:3) &
               -0.548404955515763_wp*F%F(x, 4, z, 1:3) &
               +0.002073955135157_wp*F%F(x, 3, z, 1:3) &
               +0.176979071835593_wp*F%F(x, 2, z, 1:3) &
               -0.050464897545544_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.004742600631665_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               -0.032154832282687_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.195432746208080_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.037422964670561_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.264391437780108_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.038478253000180_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.572948637727217_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.004325161232786_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               +0.202384868750895_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               -0.060351191163998_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 7 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.002269041949790_wp*F%F(x, 12, z, 1:3) &
               -0.032530118373793_wp*F%F(x, 11, z, 1:3) &
               +0.188900051385807_wp*F%F(x, 10, z, 1:3) &
               -0.638262720074556_wp*F%F(x, 9, z, 1:3) &
               +1.560836153489656_wp*F%F(x, 8, z, 1:3) &
               -0.905179927543220_wp*F%F(x, 7, z, 1:3) &
               -0.052231816759526_wp*F%F(x, 6, z, 1:3) &
               -0.486889270320233_wp*F%F(x, 5, z, 1:3) &
               +0.517428663501413_wp*F%F(x, 4, z, 1:3) &
               -0.137956948397386_wp*F%F(x, 3, z, 1:3) &
               -0.108190216650142_wp*F%F(x, 2, z, 1:3) &
               +0.055708713136433_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.006619321834531_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
               -0.044879002038120_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               +0.094874893792050_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.035940522255854_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               +0.905179927543220_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               -0.971931417829373_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               -0.510533260717342_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               +0.587831838812040_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               -0.097436350250351_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.049653902328415_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.008276957317196_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. 8 ) then 
     !forward operator for velocity
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
               +0.002068702062188_wp*F%F(x, 13, z, 1:3) &
               -0.029657945711095_wp*F%F(x, 12, z, 1:3) &
               +0.172221551869199_wp*F%F(x, 11, z, 1:3) &
               -0.581908767864714_wp*F%F(x, 10, z, 1:3) &
               +1.473044986723988_wp*F%F(x, 9, z, 1:3) &
               -0.892828448398233_wp*F%F(x, 8, z, 1:3) &
               -0.032767235755012_wp*F%F(x, 7, z, 1:3) &
               -0.248685062282352_wp*F%F(x, 6, z, 1:3) &
               +0.170930500243401_wp*F%F(x, 5, z, 1:3) &
               -0.110359853738840_wp*F%F(x, 4, z, 1:3) &
               +0.038849792028224_wp*F%F(x, 3, z, 1:3) &
               +0.017743142086478_wp*F%F(x, 2, z, 1:3) &
               -0.012937922578870_wp*F%F(x, 1, z, 1:3) &
              )
     !backward operator for stress
     Jr_xU(4:9) = (&
               +0.006034883899191_wp*X_x(x, 12, z, 2)*G%J(x,12,z) *F%F(x, 12, z, 4:n) &
               -0.040916512836517_wp*X_x(x, 11, z, 2)*G%J(x,11,z) *F%F(x, 11, z, 4:n) &
               +0.086498131273245_wp*X_x(x, 10, z, 2)*G%J(x,10,z) *F%F(x, 10, z, 4:n) &
               +0.198292250313705_wp*X_x(x, 9, z, 2)*G%J(x,9,z) *F%F(x, 9, z, 4:n) &
               +0.892828448398233_wp*X_x(x, 8, z, 2)*G%J(x,8,z) *F%F(x, 8, z, 4:n) &
               -1.423025682605699_wp*X_x(x, 7, z, 2)*G%J(x,7,z) *F%F(x, 7, z, 4:n) &
               +0.258439188609325_wp*X_x(x, 6, z, 2)*G%J(x,6,z) *F%F(x, 6, z, 4:n) &
               +0.206413079068906_wp*X_x(x, 5, z, 2)*G%J(x,5,z) *F%F(x, 5, z, 4:n) &
               -0.142243577826732_wp*X_x(x, 4, z, 2)*G%J(x,4,z) *F%F(x, 4, z, 4:n) &
               +0.021522078805545_wp*X_x(x, 3, z, 2)*G%J(x,3,z) *F%F(x, 3, z, 4:n) &
               -0.013360802114642_wp*X_x(x, 2, z, 2)*G%J(x,2,z) *F%F(x, 2, z, 4:n) &
               +0.009623151728641_wp*X_x(x, 1, z, 2)*G%J(x,1,z) *F%F(x, 1, z, 4:n) &
               )
     end if


     if  ( y .eq. ny ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.044374156234105_wp*F%F(x, ny-7, z, 1:3) &
                 +0.174198378773702_wp*F%F(x, ny-6, z, 1:3) &
                 -0.220245640409051_wp*F%F(x, ny-5, z, 1:3) &
                 -0.139299657443443_wp*F%F(x, ny-4, z, 1:3) &
                 +0.495449593250587_wp*F%F(x, ny-3, z, 1:3) &
                 +0.370787168310084_wp*F%F(x, ny-2, z, 1:3) &
                 -2.304067463556378_wp*F%F(x, ny-1, z, 1:3) &
                 +1.667551777308605_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.033005239880522_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.025881634391799_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.263392722344631_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.030209714180198_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.506938949737935_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.350517535783371_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -2.412053651292632_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +1.728893299663438_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-1 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.011723708576681_wp*F%F(x, ny-7, z, 1:3) &
                 -0.065174528307485_wp*F%F(x, ny-6, z, 1:3) &
                 +0.148801997699767_wp*F%F(x, ny-5, z, 1:3) &
                 -0.046588172420165_wp*F%F(x, ny-4, z, 1:3) &
                 -0.241839854684496_wp*F%F(x, ny-3, z, 1:3) &
                 -0.251551333921227_wp*F%F(x, ny-2, z, 1:3) &
                 -0.020053857114091_wp*F%F(x, ny-1, z, 1:3) &
                 +0.464682040171017_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.008828095360976_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.029911851210588_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.170162903794152_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.094426023794218_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.250037914252055_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.250891381680726_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.020053857114091_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.443878505390320_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-2 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 +0.156241518792227_wp*F%F(x, ny-7, z, 1:3) &
                 -0.505832529848511_wp*F%F(x, ny-6, z, 1:3) &
                 +0.010613520806507_wp*F%F(x, ny-5, z, 1:3) &
                 +1.646697927315869_wp*F%F(x, ny-4, z, 1:3) &
                 -2.378062811419621_wp*F%F(x, ny-3, z, 1:3) &
                 -0.045718284610534_wp*F%F(x, ny-2, z, 1:3) &
                 +1.527070237729393_wp*F%F(x, ny-1, z, 1:3) &
                 -0.411009578765331_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 +0.086554962191340_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.357259827206167_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.022134128148434_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +1.484851853641141_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -2.378309161955782_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.045718284610534_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +1.531087089237169_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.434777328666669_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-3 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.061651661535115_wp*F%F(x, ny-7, z, 1:3) &
                 +0.263535772373310_wp*F%F(x, ny-6, z, 1:3) &
                 -0.389840903051706_wp*F%F(x, ny-5, z, 1:3) &
                 -0.258864496540571_wp*F%F(x, ny-4, z, 1:3) &
                 -0.012373610391183_wp*F%F(x, ny-3, z, 1:3) &
                 +0.330365147571788_wp*F%F(x, ny-2, z, 1:3) &
                 +0.211400033956727_wp*F%F(x, ny-1, z, 1:3) &
                 -0.082570282383251_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.001155664084666_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 -0.079463252429367_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.299393382304440_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.407288103594466_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.281750824243924_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.012373610391183_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.330330927617320_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.204468804842354_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.080698894497091_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-4 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.015116922751879_wp*F%F(x, ny-8, z, 1:3) &
                 +0.428167834093026_wp*F%F(x, ny-7, z, 1:3) &
                 -1.111936792339292_wp*F%F(x, ny-6, z, 1:3) &
                 +0.397762766470929_wp*F%F(x, ny-5, z, 1:3) &
                 -0.373648890457135_wp*F%F(x, ny-4, z, 1:3) &
                 +1.263356736209345_wp*F%F(x, ny-3, z, 1:3) &
                 -0.924846902011930_wp*F%F(x, ny-2, z, 1:3) &
                 +0.357974171524791_wp*F%F(x, ny-1, z, 1:3) &
                 -0.022063557080921_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.005181940496807_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 +0.074290886416910_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.517048981121307_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -1.165933921548919_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 -0.122648484113833_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.373648890457135_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +1.160735576719516_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -1.025653483809176_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.176618285456005_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.101737008335247_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-5 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.004742600631665_wp*F%F(x, ny-9, z, 1:3) &
                 +0.032154832282687_wp*F%F(x, ny-8, z, 1:3) &
                 -0.195432746208080_wp*F%F(x, ny-7, z, 1:3) &
                 -0.037422964670561_wp*F%F(x, ny-6, z, 1:3) &
                 -0.264391437780108_wp*F%F(x, ny-5, z, 1:3) &
                 +0.038478253000180_wp*F%F(x, ny-4, z, 1:3) &
                 +0.572948637727217_wp*F%F(x, ny-3, z, 1:3) &
                 -0.004325161232786_wp*F%F(x, ny-2, z, 1:3) &
                 -0.202384868750895_wp*F%F(x, ny-1, z, 1:3) &
                 +0.060351191163998_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.001625719379320_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 +0.023307124778684_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 -0.135342792723918_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.203098167192540_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 -0.696367795879953_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.264391437780108_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.124789282744944_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.548404955515763_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.002073955135157_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -0.176979071835593_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.050464897545544_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-6 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.006619321834531_wp*F%F(x, ny-10, z, 1:3) &
                 +0.044879002038120_wp*F%F(x, ny-9, z, 1:3) &
                 -0.094874893792050_wp*F%F(x, ny-8, z, 1:3) &
                 -0.035940522255854_wp*F%F(x, ny-7, z, 1:3) &
                 -0.905179927543220_wp*F%F(x, ny-6, z, 1:3) &
                 +0.971931417829373_wp*F%F(x, ny-5, z, 1:3) &
                 +0.510533260717342_wp*F%F(x, ny-4, z, 1:3) &
                 -0.587831838812040_wp*F%F(x, ny-3, z, 1:3) &
                 +0.097436350250351_wp*F%F(x, ny-2, z, 1:3) &
                 +0.049653902328415_wp*F%F(x, ny-1, z, 1:3) &
                 -0.008276957317196_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.002269041949790_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
                 +0.032530118373793_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 -0.188900051385807_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 +0.638262720074556_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 -1.560836153489656_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.905179927543220_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.052231816759526_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 +0.486889270320233_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 -0.517428663501413_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 +0.137956948397386_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 +0.108190216650142_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 -0.055708713136433_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if
     if  ( y .eq. ny-7 ) then 
     !forward operator
     Jr_xU(1:3) = X_x(x, y, z, 2)*(&
                 -0.006034883899191_wp*F%F(x, ny-11, z, 1:3) &
                 +0.040916512836517_wp*F%F(x, ny-10, z, 1:3) &
                 -0.086498131273245_wp*F%F(x, ny-9, z, 1:3) &
                 -0.198292250313705_wp*F%F(x, ny-8, z, 1:3) &
                 -0.892828448398233_wp*F%F(x, ny-7, z, 1:3) &
                 +1.423025682605699_wp*F%F(x, ny-6, z, 1:3) &
                 -0.258439188609325_wp*F%F(x, ny-5, z, 1:3) &
                 -0.206413079068906_wp*F%F(x, ny-4, z, 1:3) &
                 +0.142243577826732_wp*F%F(x, ny-3, z, 1:3) &
                 -0.021522078805545_wp*F%F(x, ny-2, z, 1:3) &
                 +0.013360802114642_wp*F%F(x, ny-1, z, 1:3) &
                 -0.009623151728641_wp*F%F(x, ny  , z, 1:3) &
                 )
     !backward operator
     Jr_xU(4:9) = (&
                 -0.002068702062188_wp*X_x(x, ny-12, z, 2)*G%J(x, ny-12,z) *F%F(x, ny-12, z, 4:n) &
                 +0.029657945711095_wp*X_x(x, ny-11, z, 2)*G%J(x, ny-11,z) *F%F(x, ny-11, z, 4:n) &
                 -0.172221551869199_wp*X_x(x, ny-10, z, 2)*G%J(x, ny-10,z) *F%F(x, ny-10, z, 4:n) &
                 +0.581908767864714_wp*X_x(x, ny-9, z, 2)*G%J(x, ny-9,z) *F%F(x, ny-9, z, 4:n) &
                 -1.473044986723988_wp*X_x(x, ny-8, z, 2)*G%J(x, ny-8,z) *F%F(x, ny-8, z, 4:n) &
                 +0.892828448398233_wp*X_x(x, ny-7, z, 2)*G%J(x, ny-7,z) *F%F(x, ny-7, z, 4:n) &
                 +0.032767235755012_wp*X_x(x, ny-6, z, 2)*G%J(x, ny-6,z) *F%F(x, ny-6, z, 4:n) &
                 +0.248685062282352_wp*X_x(x, ny-5, z, 2)*G%J(x, ny-5,z) *F%F(x, ny-5, z, 4:n) &
                 -0.170930500243401_wp*X_x(x, ny-4, z, 2)*G%J(x, ny-4,z) *F%F(x, ny-4, z, 4:n) &
                 +0.110359853738840_wp*X_x(x, ny-3, z, 2)*G%J(x, ny-3,z) *F%F(x, ny-3, z, 4:n) &
                 -0.038849792028224_wp*X_x(x, ny-2, z, 2)*G%J(x, ny-2,z) *F%F(x, ny-2, z, 4:n) &
                 -0.017743142086478_wp*X_x(x, ny-1, z, 2)*G%J(x, ny-1,z) *F%F(x, ny-1, z, 4:n) &
                 +0.012937922578870_wp*X_x(x, ny  , z, 2)*G%J(x, ny  ,z) *F%F(x, ny  , z, 4:n) &
                 )
     end if


     !=================================================================================================
     Js_xU = 0.0_wp*Js_xU

      if ((z .ge. 9) .and. (z .le. nz-8 )) then 
     !forward operator for stress
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
              -0.006094104308390_wp*F%F(x, y, z-4, 1:3) &
              +0.041318027210884_wp*F%F(x, y, z-3, 1:3) &
              -0.087346938775510_wp*F%F(x, y, z-2, 1:3) &
              -0.200238095238095_wp*F%F(x, y, z-1, 1:3) &
              -0.793571428571429_wp*F%F(x, y  , z, 1:3) &
              +1.487500000000000_wp*F%F(x, y, z+1, 1:3) &
              -0.587619047619048_wp*F%F(x, y, z+2, 1:3) &
              +0.173911564625850_wp*F%F(x, y, z+3, 1:3) &
              -0.029948979591837_wp*F%F(x, y, z+4, 1:3) &
              +0.002089002267574_wp*F%F(x, y, z+5, 1:3) &
               )
     !backward operator for stress
     Js_xU(4:9) = (&
              -0.002089002267574_wp*X_x(x, y, z-5, 3)*G%J(x, y, z-5) *F%F(x, y, z-5, 4:n) &
              +0.029948979591837_wp*X_x(x, y, z-4, 3)*G%J(x, y, z-4) *F%F(x, y, z-4, 4:n) &
              -0.173911564625850_wp*X_x(x, y, z-3, 3)*G%J(x, y, z-3) *F%F(x, y, z-3, 4:n) &
              +0.587619047619048_wp*X_x(x, y, z-2, 3)*G%J(x, y, z-2) *F%F(x, y, z-2, 4:n) &
              -1.487500000000000_wp*X_x(x, y, z-1, 3)*G%J(x, y, z-1) *F%F(x, y, z-1, 4:n) &
              +0.793571428571429_wp*X_x(x  , y, z, 3)*G%J(x  ,y,z) *F%F(x  , y, z, 4:n) &
              +0.200238095238095_wp*X_x(x, y, z+1, 3)*G%J(x, y, z+1) *F%F(x, y, z+1, 4:n) &
              +0.087346938775510_wp*X_x(x, y, z+2, 3)*G%J(x, y, z+2) *F%F(x, y, z+2, 4:n) &
              -0.041318027210884_wp*X_x(x, y, z+3, 3)*G%J(x, y, z+3) *F%F(x, y, z+3, 4:n) &
              +0.006094104308390_wp*X_x(x, y, z+4, 3)*G%J(x, y, z+4) *F%F(x, y, z+4, 4:n) &
               )
     end if


     if  ( z .eq. 1 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.033005239880522_wp*F%F(x, y, 8, 1:3) &
               -0.025881634391799_wp*F%F(x, y, 7, 1:3) &
               +0.263392722344631_wp*F%F(x, y, 6, 1:3) &
               -0.030209714180198_wp*F%F(x, y, 5, 1:3) &
               -0.506938949737935_wp*F%F(x, y, 4, 1:3) &
               -0.350517535783371_wp*F%F(x, y, 3, 1:3) &
               +2.412053651292632_wp*F%F(x, y, 2, 1:3) &
               -1.728893299663438_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.044374156234105_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.174198378773702_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.220245640409051_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.139299657443443_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.495449593250587_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.370787168310084_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +2.304067463556378_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -1.667551777308605_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 2 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.008828095360976_wp*F%F(x, y, 8, 1:3) &
               +0.029911851210588_wp*F%F(x, y, 7, 1:3) &
               -0.170162903794152_wp*F%F(x, y, 6, 1:3) &
               +0.094426023794218_wp*F%F(x, y, 5, 1:3) &
               +0.250037914252055_wp*F%F(x, y, 4, 1:3) &
               +0.250891381680726_wp*F%F(x, y, 3, 1:3) &
               -0.020053857114091_wp*F%F(x, y, 2, 1:3) &
               -0.443878505390320_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.011723708576681_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.065174528307485_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -0.148801997699767_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.046588172420165_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.241839854684496_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.251551333921227_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.020053857114091_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.464682040171017_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 3 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               -0.086554962191340_wp*F%F(x, y, 8, 1:3) &
               +0.357259827206167_wp*F%F(x, y, 7, 1:3) &
               -0.022134128148434_wp*F%F(x, y, 6, 1:3) &
               -1.484851853641141_wp*F%F(x, y, 5, 1:3) &
               +2.378309161955782_wp*F%F(x, y, 4, 1:3) &
               -0.045718284610534_wp*F%F(x, y, 3, 1:3) &
               -1.531087089237169_wp*F%F(x, y, 2, 1:3) &
               +0.434777328666669_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               -0.156241518792227_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.505832529848511_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -0.010613520806507_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -1.646697927315869_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +2.378062811419621_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.045718284610534_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -1.527070237729393_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.411009578765331_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 4 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.001155664084666_wp*F%F(x, y, 9, 1:3) &
               +0.079463252429367_wp*F%F(x, y, 8, 1:3) &
               -0.299393382304440_wp*F%F(x, y, 7, 1:3) &
               +0.407288103594466_wp*F%F(x, y, 6, 1:3) &
               +0.281750824243924_wp*F%F(x, y, 5, 1:3) &
               -0.012373610391183_wp*F%F(x, y, 4, 1:3) &
               -0.330330927617320_wp*F%F(x, y, 3, 1:3) &
               -0.204468804842354_wp*F%F(x, y, 2, 1:3) &
               +0.080698894497091_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.061651661535115_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -0.263535772373310_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.389840903051706_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.258864496540571_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.012373610391183_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.330365147571788_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.211400033956727_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.082570282383251_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 5 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.005181940496807_wp*F%F(x, y, 10, 1:3) &
               -0.074290886416910_wp*F%F(x, y, 9, 1:3) &
               -0.517048981121307_wp*F%F(x, y, 8, 1:3) &
               +1.165933921548919_wp*F%F(x, y, 7, 1:3) &
               +0.122648484113833_wp*F%F(x, y, 6, 1:3) &
               -0.373648890457135_wp*F%F(x, y, 5, 1:3) &
               -1.160735576719516_wp*F%F(x, y, 4, 1:3) &
               +1.025653483809176_wp*F%F(x, y, 3, 1:3) &
               -0.176618285456005_wp*F%F(x, y, 2, 1:3) &
               -0.101737008335247_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.015116922751879_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               -0.428167834093026_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +1.111936792339292_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -0.397762766470929_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.373648890457135_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -1.263356736209345_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.924846902011930_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.357974171524791_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.022063557080921_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 6 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.001625719379320_wp*F%F(x, y, 11, 1:3) &
               -0.023307124778684_wp*F%F(x, y, 10, 1:3) &
               +0.135342792723918_wp*F%F(x, y, 9, 1:3) &
               -0.203098167192540_wp*F%F(x, y, 8, 1:3) &
               +0.696367795879953_wp*F%F(x, y, 7, 1:3) &
               -0.264391437780108_wp*F%F(x, y, 6, 1:3) &
               +0.124789282744944_wp*F%F(x, y, 5, 1:3) &
               -0.548404955515763_wp*F%F(x, y, 4, 1:3) &
               +0.002073955135157_wp*F%F(x, y, 3, 1:3) &
               +0.176979071835593_wp*F%F(x, y, 2, 1:3) &
               -0.050464897545544_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.004742600631665_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               -0.032154832282687_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.195432746208080_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.037422964670561_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.264391437780108_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.038478253000180_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.572948637727217_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.004325161232786_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               +0.202384868750895_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               -0.060351191163998_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 7 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.002269041949790_wp*F%F(x, y, 12, 1:3) &
               -0.032530118373793_wp*F%F(x, y, 11, 1:3) &
               +0.188900051385807_wp*F%F(x, y, 10, 1:3) &
               -0.638262720074556_wp*F%F(x, y, 9, 1:3) &
               +1.560836153489656_wp*F%F(x, y, 8, 1:3) &
               -0.905179927543220_wp*F%F(x, y, 7, 1:3) &
               -0.052231816759526_wp*F%F(x, y, 6, 1:3) &
               -0.486889270320233_wp*F%F(x, y, 5, 1:3) &
               +0.517428663501413_wp*F%F(x, y, 4, 1:3) &
               -0.137956948397386_wp*F%F(x, y, 3, 1:3) &
               -0.108190216650142_wp*F%F(x, y, 2, 1:3) &
               +0.055708713136433_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.006619321834531_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
               -0.044879002038120_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               +0.094874893792050_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.035940522255854_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               +0.905179927543220_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               -0.971931417829373_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               -0.510533260717342_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               +0.587831838812040_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               -0.097436350250351_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.049653902328415_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.008276957317196_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. 8 ) then 
     !forward operator for velocity
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
               +0.002068702062188_wp*F%F(x, y, 13, 1:3) &
               -0.029657945711095_wp*F%F(x, y, 12, 1:3) &
               +0.172221551869199_wp*F%F(x, y, 11, 1:3) &
               -0.581908767864714_wp*F%F(x, y, 10, 1:3) &
               +1.473044986723988_wp*F%F(x, y, 9, 1:3) &
               -0.892828448398233_wp*F%F(x, y, 8, 1:3) &
               -0.032767235755012_wp*F%F(x, y, 7, 1:3) &
               -0.248685062282352_wp*F%F(x, y, 6, 1:3) &
               +0.170930500243401_wp*F%F(x, y, 5, 1:3) &
               -0.110359853738840_wp*F%F(x, y, 4, 1:3) &
               +0.038849792028224_wp*F%F(x, y, 3, 1:3) &
               +0.017743142086478_wp*F%F(x, y, 2, 1:3) &
               -0.012937922578870_wp*F%F(x, y, 1, 1:3) &
              )
     !backward operator for stress
     Js_xU(4:9) = (&
               +0.006034883899191_wp*X_x(x, y, 12, 3)*G%J(x, y, 12) *F%F(x, y, 12, 4:n) &
               -0.040916512836517_wp*X_x(x, y, 11, 3)*G%J(x, y, 11) *F%F(x, y, 11, 4:n) &
               +0.086498131273245_wp*X_x(x, y, 10, 3)*G%J(x, y, 10) *F%F(x, y, 10, 4:n) &
               +0.198292250313705_wp*X_x(x, y, 9, 3)*G%J(x, y, 9) *F%F(x, y, 9, 4:n) &
               +0.892828448398233_wp*X_x(x, y, 8, 3)*G%J(x, y, 8) *F%F(x, y, 8, 4:n) &
               -1.423025682605699_wp*X_x(x, y, 7, 3)*G%J(x, y, 7) *F%F(x, y, 7, 4:n) &
               +0.258439188609325_wp*X_x(x, y, 6, 3)*G%J(x, y, 6) *F%F(x, y, 6, 4:n) &
               +0.206413079068906_wp*X_x(x, y, 5, 3)*G%J(x, y, 5) *F%F(x, y, 5, 4:n) &
               -0.142243577826732_wp*X_x(x, y, 4, 3)*G%J(x, y, 4) *F%F(x, y, 4, 4:n) &
               +0.021522078805545_wp*X_x(x, y, 3, 3)*G%J(x, y, 3) *F%F(x, y, 3, 4:n) &
               -0.013360802114642_wp*X_x(x, y, 2, 3)*G%J(x, y, 2) *F%F(x, y, 2, 4:n) &
               +0.009623151728641_wp*X_x(x, y, 1, 3)*G%J(x, y, 1) *F%F(x, y, 1, 4:n) &
               )
     end if


     if  ( z .eq. nz ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.044374156234105_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.174198378773702_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.220245640409051_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.139299657443443_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.495449593250587_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.370787168310084_wp*F%F(x, y,  nz-2, 1:3) &
                 -2.304067463556378_wp*F%F(x, y,  nz-1, 1:3) &
                 +1.667551777308605_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.033005239880522_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.025881634391799_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.263392722344631_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.030209714180198_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.506938949737935_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.350517535783371_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -2.412053651292632_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +1.728893299663438_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-1 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.011723708576681_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.065174528307485_wp*F%F(x, y,  nz-6, 1:3) &
                 +0.148801997699767_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.046588172420165_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.241839854684496_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.251551333921227_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.020053857114091_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.464682040171017_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.008828095360976_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.029911851210588_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.170162903794152_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.094426023794218_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.250037914252055_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.250891381680726_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.020053857114091_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.443878505390320_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-2 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 +0.156241518792227_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.505832529848511_wp*F%F(x, y,  nz-6, 1:3) &
                 +0.010613520806507_wp*F%F(x, y,  nz-5, 1:3) &
                 +1.646697927315869_wp*F%F(x, y,  nz-4, 1:3) &
                 -2.378062811419621_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.045718284610534_wp*F%F(x, y,  nz-2, 1:3) &
                 +1.527070237729393_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.411009578765331_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 +0.086554962191340_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.357259827206167_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.022134128148434_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +1.484851853641141_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -2.378309161955782_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.045718284610534_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +1.531087089237169_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.434777328666669_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-3 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.061651661535115_wp*F%F(x, y,  nz-7, 1:3) &
                 +0.263535772373310_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.389840903051706_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.258864496540571_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.012373610391183_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.330365147571788_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.211400033956727_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.082570282383251_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.001155664084666_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 -0.079463252429367_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.299393382304440_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.407288103594466_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.281750824243924_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.012373610391183_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.330330927617320_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.204468804842354_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.080698894497091_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-4 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.015116922751879_wp*F%F(x, y,  nz-8, 1:3) &
                 +0.428167834093026_wp*F%F(x, y,  nz-7, 1:3) &
                 -1.111936792339292_wp*F%F(x, y,  nz-6, 1:3) &
                 +0.397762766470929_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.373648890457135_wp*F%F(x, y,  nz-4, 1:3) &
                 +1.263356736209345_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.924846902011930_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.357974171524791_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.022063557080921_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.005181940496807_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 +0.074290886416910_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.517048981121307_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -1.165933921548919_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 -0.122648484113833_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.373648890457135_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +1.160735576719516_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -1.025653483809176_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.176618285456005_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.101737008335247_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-5 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.004742600631665_wp*F%F(x, y,  nz-9, 1:3) &
                 +0.032154832282687_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.195432746208080_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.037422964670561_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.264391437780108_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.038478253000180_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.572948637727217_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.004325161232786_wp*F%F(x, y,  nz-2, 1:3) &
                 -0.202384868750895_wp*F%F(x, y,  nz-1, 1:3) &
                 +0.060351191163998_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.001625719379320_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 +0.023307124778684_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 -0.135342792723918_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.203098167192540_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 -0.696367795879953_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.264391437780108_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.124789282744944_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.548404955515763_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.002073955135157_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -0.176979071835593_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.050464897545544_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-6 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.006619321834531_wp*F%F(x, y,  nz-10, 1:3) &
                 +0.044879002038120_wp*F%F(x, y,  nz-9, 1:3) &
                 -0.094874893792050_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.035940522255854_wp*F%F(x, y,  nz-7, 1:3) &
                 -0.905179927543220_wp*F%F(x, y,  nz-6, 1:3) &
                 +0.971931417829373_wp*F%F(x, y,  nz-5, 1:3) &
                 +0.510533260717342_wp*F%F(x, y,  nz-4, 1:3) &
                 -0.587831838812040_wp*F%F(x, y,  nz-3, 1:3) &
                 +0.097436350250351_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.049653902328415_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.008276957317196_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.002269041949790_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
                 +0.032530118373793_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 -0.188900051385807_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 +0.638262720074556_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 -1.560836153489656_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.905179927543220_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.052231816759526_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 +0.486889270320233_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 -0.517428663501413_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 +0.137956948397386_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 +0.108190216650142_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 -0.055708713136433_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if
     if  ( z .eq. nz-7 ) then 
     !forward operator
     Js_xU(1:3) = X_x(x, y, z, 3)*(&
                 -0.006034883899191_wp*F%F(x, y,  nz-11, 1:3) &
                 +0.040916512836517_wp*F%F(x, y,  nz-10, 1:3) &
                 -0.086498131273245_wp*F%F(x, y,  nz-9, 1:3) &
                 -0.198292250313705_wp*F%F(x, y,  nz-8, 1:3) &
                 -0.892828448398233_wp*F%F(x, y,  nz-7, 1:3) &
                 +1.423025682605699_wp*F%F(x, y,  nz-6, 1:3) &
                 -0.258439188609325_wp*F%F(x, y,  nz-5, 1:3) &
                 -0.206413079068906_wp*F%F(x, y,  nz-4, 1:3) &
                 +0.142243577826732_wp*F%F(x, y,  nz-3, 1:3) &
                 -0.021522078805545_wp*F%F(x, y,  nz-2, 1:3) &
                 +0.013360802114642_wp*F%F(x, y,  nz-1, 1:3) &
                 -0.009623151728641_wp*F%F(x, y,  nz  , 1:3) &
                 )
     !backward operator
     Js_xU(4:9) = (&
                 -0.002068702062188_wp*X_x(x, y, nz-12, 3)*G%J(x, y, nz-12) *F%F(x, y, nz-12, 4:n) &
                 +0.029657945711095_wp*X_x(x, y, nz-11, 3)*G%J(x, y, nz-11) *F%F(x, y, nz-11, 4:n) &
                 -0.172221551869199_wp*X_x(x, y, nz-10, 3)*G%J(x, y, nz-10) *F%F(x, y, nz-10, 4:n) &
                 +0.581908767864714_wp*X_x(x, y, nz-9, 3)*G%J(x, y, nz-9) *F%F(x, y, nz-9, 4:n) &
                 -1.473044986723988_wp*X_x(x, y, nz-8, 3)*G%J(x, y, nz-8) *F%F(x, y, nz-8, 4:n) &
                 +0.892828448398233_wp*X_x(x, y, nz-7, 3)*G%J(x, y, nz-7) *F%F(x, y, nz-7, 4:n) &
                 +0.032767235755012_wp*X_x(x, y, nz-6, 3)*G%J(x, y, nz-6) *F%F(x, y, nz-6, 4:n) &
                 +0.248685062282352_wp*X_x(x, y, nz-5, 3)*G%J(x, y, nz-5) *F%F(x, y, nz-5, 4:n) &
                 -0.170930500243401_wp*X_x(x, y, nz-4, 3)*G%J(x, y, nz-4) *F%F(x, y, nz-4, 4:n) &
                 +0.110359853738840_wp*X_x(x, y, nz-3, 3)*G%J(x, y, nz-3) *F%F(x, y, nz-3, 4:n) &
                 -0.038849792028224_wp*X_x(x, y, nz-2, 3)*G%J(x, y, nz-2) *F%F(x, y, nz-2, 4:n) &
                 -0.017743142086478_wp*X_x(x, y, nz-1, 3)*G%J(x, y, nz-1) *F%F(x, y, nz-1, 4:n) &
                 +0.012937922578870_wp*X_x(x, y, nz  , 3)*G%J(x, y ,nz  ) *F%F(x, y, nz  , 4:n) &
                 )
     end if


     !=================================================================================================

     Ju_x(1:n) = (1.0_wp/hx)*Jq_xU(1:n) + (1.0_wp/hy)*Jr_xU(1:n) + (1.0_wp/hz)*Js_xU(1:n)


     end subroutine JJU_x679_upwind_drp


!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================


  !> 6th order accurate summation-by-parts finite difference operation of the elastic wave equation  on a curvilinear grid
  !> Compute partial derivatives for displacements u1, u2, u3 in non-conservative form
  !> Compute partial derivatives for stress u4, u5, u6, u7, u8, u9 in conservative form
  !> Form the RHS for the interior

  subroutine JJU_x6_interior(F, G, M, type_of_mesh)
    use datatypes, only: block_type, block_fields, block_grid_t, block_material

    implicit none

    !=================================================================================================
    !
    !type(block_fields), intent(inout):: F
    type(block_type), intent(inout):: F
    type(block_grid_t), intent(in) :: G
     type(block_material), intent(inout) :: M

    character(len=64), intent(in) :: type_of_mesh

    integer :: mx, my, mz, px, py, pz, nx, ny, nz, n
    real(kind = wp) :: hx, hy, hz                           ! spatial steps discertizing the unit cube

     integer :: x,y,z,s, iz, fz, iy, fy, ix, fx
     integer :: i

    real(kind = wp),parameter :: c(1:3) = (/ 0.75_wp,-0.15_wp,1.0_wp/60.0_wp /) ! FD coefficients
    real(kind = wp),dimension(1:3) :: cx,cy,cz
    real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
    real(kind = wp) :: a1,a2,a3,a4
     real(kind = wp) :: tr


    mx = G%C%mq
    my = G%C%mr
    mz = G%C%ms
    px = G%C%pq
    py = G%C%pr
    pz = G%C%ps
    nx = G%C%nq
    ny = G%C%nr
    nz = G%C%ns

    n = size(F%F%F, 4)

    hx = G%hq
    hy = G%hr
    hz = G%hs

    cx = c/hx; cy = c/hy; cz = c/hz

!!$    iz = mz
!!$    fz = pz
!!$    if (mz == 1) iz = mz + 6
!!$    if (pz == nz) fz = pz - 6
!!$
!!$    iy = my
!!$    fy = py
!!$    if (my == 1) iy= my + 6
!!$    if (py == ny) fy = py - 6
!!$
!!$    ix = mx
!!$    fx = px
!!$    if (mx == 1 ) ix = mx + 6
!!$    if (px == nx) fx = px - 6
!!$
!!$    if ((mz == 1) .and. (F%PMLB(5)%pml .EQV. .TRUE.)) iz = mz + max(F%PMLB(5)%N_pml, 6)
!!$    if ((pz == nz) .and. (F%PMLB(6)%pml .EQV. .TRUE.)) fz = pz - max(F%PMLB(6)%N_pml, 6)
!!$
!!$    if ((my == 1) .and. (F%PMLB(3)%pml .EQV. .TRUE.)) iy = my + max(F%PMLB(3)%N_pml, 6)
!!$    if ((py == ny) .and. (F%PMLB(4)%pml .EQV. .TRUE.)) fy = py - max(F%PMLB(4)%N_pml, 6)
!!$
!!$    if ((mx == 1) .and. (F%PMLB(1)%pml .EQV. .TRUE.)) ix = mx + max(F%PMLB(1)%N_pml, 6)
!!$    if ((px == nx) .and. (F%PMLB(2)%pml .EQV. .TRUE.)) fx = px - max(F%PMLB(2)%N_pml, 6)


    ix = 6
    iy = 6
    iz = 6

    fx = 6
    fy = 6
    fz = 6

    if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
    if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)
    
    if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
    if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)
    
    if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
    if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)

    select case(type_of_mesh)
       
    case('curvilinear') ! locked or welded interface
       
       do z = mz, pz
          do y = my, py
             do x = mx, px


                 ! cycle if an interior point
             if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                  ((iy+1 > y) .or. (y > ny - fy)) .or. &
                  ((ix+1 > x) .or. (x > nx - fx))) cycle

                DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

                do s = 1,3

                   DFx(1:3) = DFx(1:3) &
                        + G%metricx(x, y, z, 1)*cx(s)*(F%F%F(x+s, y  , z  , 1:3) - F%F%F(x-s, y  , z  , 1:3)) &
                        + G%metricx(x, y, z, 2)*cy(s)*(F%F%F(x  , y+s, z  , 1:3) - F%F%F(x  , y-s, z  , 1:3)) &
                        + G%metricx(x, y, z, 3)*cz(s)*(F%F%F(x  , y  , z+s, 1:3) - F%F%F(x  , y  , z-s, 1:3))


                   DFx(4:9) = DFx(4:9) &
                   + cx(s)*( &
                        F%F%F(x+s, y  , z  , 4:9)*(G%J(x+s, y  , z  )*G%metricx(x+s, y  , z  , 1))- &
                        F%F%F(x-s, y  , z  , 4:9)*(G%J(x-s, y  , z  )*G%metricx(x-s, y  , z  , 1))) &
                   + cy(s)*( &
                        F%F%F(x  , y+s, z  , 4:9)*(G%J(x  , y+s, z  )*G%metricx(x  , y+s, z  , 2))- &
                        F%F%F(x  , y-s, z  , 4:9)*(G%J(x  , y-s, z  )*G%metricx(x  , y-s, z  , 2))) &
                   + cz(s)*( &
                        F%F%F(x  , y  , z+s, 4:9)*(G%J(x  , y  , z+s)*G%metricx(x  , y  , z+s, 3))- &
                        F%F%F(x  , y  , z-s, 4:9)*(G%J(x  , y  , z-s)*G%metricx(x  , y  , z-s, 3)))
                   !==========================================================

                   DFy(1:3) = DFy(1:3) &
                        + G%metricy(x, y, z, 1)*cx(s)*(F%F%F(x+s, y  , z  , 1:3) - F%F%F(x-s, y  , z  , 1:3)) &
                        + G%metricy(x, y, z, 2)*cy(s)*(F%F%F(x  , y+s, z  , 1:3) - F%F%F(x  , y-s, z  , 1:3)) &
                        + G%metricy(x, y, z, 3)*cz(s)*(F%F%F(x  , y  , z+s, 1:3) - F%F%F(x  , y  , z-s, 1:3))

                   DFy(4:9) = DFy(4:9) &
                   + cx(s)*( &
                        F%F%F(x+s, y  , z  , 4:9)*(G%J(x+s, y  , z  )*G%metricy(x+s, y  , z  , 1))- &
                        F%F%F(x-s, y  , z  , 4:9)*(G%J(x-s, y  , z  )*G%metricy(x-s, y  , z  , 1))) &
                   + cy(s)*( &
                        F%F%F(x  , y+s, z  , 4:9)*(G%J(x  , y+s, z  )*G%metricy(x  , y+s, z  , 2))- &
                        F%F%F(x  , y-s, z  , 4:9)*(G%J(x  , y-s, z  )*G%metricy(x  , y-s, z  , 2))) &
                   + cz(s)*( &
                        F%F%F(x  , y  , z+s, 4:9)*(G%J(x  , y  , z+s)*G%metricy(x  , y  , z+s, 3))- &
                        F%F%F(x  , y  , z-s, 4:9)*(G%J(x  , y  , z-s)*G%metricy(x  , y  , z-s, 3)))
                   !==========================================================

                   DFz(1:3) = DFz(1:3) &
                        + G%metricz(x, y, z, 1)*cx(s)*(F%F%F(x+s, y  , z  , 1:3) - F%F%F(x-s, y  , z  , 1:3)) &
                        + G%metricz(x, y, z, 2)*cy(s)*(F%F%F(x  , y+s, z  , 1:3) - F%F%F(x  , y-s, z  , 1:3)) &
                        + G%metricz(x, y, z, 3)*cz(s)*(F%F%F(x  , y  , z+s, 1:3) - F%F%F(x  , y  , z-s, 1:3))

                   DFz(4:9) = DFz(4:9) &
                   + cx(s)*( &
                        F%F%F(x+s, y  , z  , 4:9)*(G%J(x+s, y  , z  )*G%metricz(x+s, y  , z  , 1))- &
                        F%F%F(x-s, y  , z  , 4:9)*(G%J(x-s, y  , z  )*G%metricz(x-s, y  , z  , 1))) &
                   + cy(s)*( &
                        F%F%F(x  , y+s, z  , 4:9)*(G%J(x  , y+s, z  )*G%metricz(x  , y+s, z  , 2))- &
                        F%F%F(x  , y-s, z  , 4:9)*(G%J(x  , y-s, z  )*G%metricz(x  , y-s, z  , 2))) &
                   + cz(s)*( &
                        F%F%F(x  , y  , z+s, 4:9)*(G%J(x  , y  , z+s)*G%metricz(x  , y  , z+s, 3))- &
                        F%F%F(x  , y  , z-s, 4:9)*(G%J(x  , y  , z-s)*G%metricz(x  , y  , z-s, 3)))

                end do

                a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                a3 = M%M(x, y, z, 1) ! lambda
                a4 = M%M(x, y, z, 2) ! mu

                F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

                F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

                F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                        if (M%anelastic) then
                                              F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                              F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                              F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                              F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                              F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                              F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                              tr = DFx(1) + DFy(2) + DFz(3)
                                              do i = 1, 4
                                                       M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                     - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                            - M%eta4(x,y,z,i) ) / M%tau(i)

                                                       M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                     - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                            - M%eta5(x,y,z,i) ) / M%tau(i)

                                                       M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                     - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                            - M%eta6(x,y,z,i) ) / M%tau(i)

                                                       M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                       M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                       M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                              end do
                                        end if

             end do
          end do
       end do

    case('cartesian') ! carseian mesh

       do z = mz, pz
          do y = my, py
             do x = mx, px

                if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                  ((iy+1 > y) .or. (y > ny - fy)) .or. &
                  ((ix+1 > x) .or. (x > nx - fx))) cycle
                
                DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

                do s = 1,3

                   DFx(:) = DFx(:) &
                        &+G%metricx(x, y, z, 1)*cx(s)*(F%F%F(x+s, y  , z  , :) - F%F%F(x-s, y  , z  , :))
                   !==========================================================

                   DFy(:) = DFy(:) &
                        &+G%metricy(x, y, z, 2)*cy(s)*(F%F%F(x  , y+s, z , :) - F%F%F(x  , y-s, z  , :))
                   !==========================================================


                   DFz(:) = DFz(:) &
                        &+G%metricz(x, y, z, 3)*cz(s)*(F%F%F(x  , y  , z+s, :) - F%F%F(x  , y  , z-s, :))
                end do

                a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

                a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

                a3 = M%M(x, y, z, 1) ! lambda

                a4 = M%M(x, y, z, 2) ! mu

               ! Update time derivatives
                F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

                F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

                F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                        if (M%anelastic) then
                                              F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                              F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                              F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                              F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                              F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                              F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                              tr = DFx(1) + DFy(2) + DFz(3)
                                              do i = 1, 4
                                                       M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                     - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                            - M%eta4(x,y,z,i) ) / M%tau(i)

                                                       M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                     - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                            - M%eta5(x,y,z,i) ) / M%tau(i)

                                                       M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                     - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                            - M%eta6(x,y,z,i) ) / M%tau(i)

                                                       M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                       M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                       M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                              end do
                                        end if
               

             end do
          end do
       end do

    end select

  end subroutine JJU_x6_interior

  subroutine JJU_x2_interior_upwind(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:3) = (/-3.0_wp/2.0_wp, 2.0_wp, -1.0_wp/2.0_wp/)     ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:3) = (/1.0_wp/2.0_wp, -2.0_wp, 3.0_wp/2.0_wp /)        ! backward FD coefficients 
     

     real(kind = wp),dimension(1:3) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 2
     iy = 2
     iz = 2
 
     fx = 2
     fy = 2
     fz = 2
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 2)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 2)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 2)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 2)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 2)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 2)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
                 do s = 0,2
                    
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+1)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 2)*cfy(s+1)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 3)*cfz(s+1)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFx(4:9) =DFx(4:9) &
                         &+cbx(s+1)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricx(x+s-2, y, z, 1)*G%J(x+s-2,y,z)  &
                         &+cby(s+1)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricx(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                         &+cbz(s+1)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricx(x, y, z+s-2, 3)*G%J(x, y, z+s-2)! backwad difference for stress field
                    !==========================================================
                    
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 1)*cfx(s+1)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 2)*cfy(s+1)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 3)*cfz(s+1)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFy(4:9) =DFy(4:9) &
                         &+cbx(s+1)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricy(x+s-2, y, z, 1)*G%J(x+s-2,y,z)  &
                         &+cby(s+1)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricy(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                         &+cbz(s+1)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricy(x, y, z+s-2, 3)*G%J(x, y, z+s-2)
                    !==========================================================
                    
                    
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 1)*cfx(s+1)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 2)*cfy(s+1)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 3)*cfz(s+1)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFz(4:9) =DFz(4:9) &
                         &+cbx(s+1)*(F%F%F(x+s-2, y  , z  , 4:9) ) *G%metricz(x+s-2, y, z, 1)*G%J(x+s-2,y,z)   &
                         &+cby(s+1)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricz(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                         &+cbz(s+1)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricz(x, y, z+s-2, 3)*G%J(x, y, z+s-2)!
                    
                    
                 end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                 if (M%anelastic) then
                    F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                    F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                    F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                    F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                    F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                    F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                    tr = DFx(1) + DFy(2) + DFz(3)
                    do i = 1, 4
                       M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta4(x,y,z,i) ) / M%tau(i)
                       M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta5(x,y,z,i) ) / M%tau(i)
                       M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta6(x,y,z,i) ) / M%tau(i)

                       M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                       M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                       M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                    end do
                 end if

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = 0,2
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+1)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+1)*(F%F%F(x+s-2, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+1)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+1)*(F%F%F(x  , y+s-2, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+1)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+1)*(F%F%F(x  , y  , z+s-2, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
 
              end do
           end do
        end do
 
     end select
   end subroutine JJU_x2_interior_upwind


   subroutine JJU_x3_interior_upwind(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:4) = (/-1.0_wp/3.0_wp, -1.0_wp/2.0_wp,   1.0_wp,  -1.0_wp/6.0_wp /)     ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:4) = (/1.0_wp/6.0_wp,  -1.0_wp,   1.0_wp/2.0_wp,  1.0_wp/3.0_wp  /)        ! backward FD coefficients 
     

     real(kind = wp),dimension(1:4) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 2
     iy = 2
     iz = 2
 
     fx = 2
     fy = 2
     fz = 2
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 2)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 2)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 2)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 2)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 2)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 2)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
                 do s = -1,2
                    
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 2)*cfy(s+2)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 3)*cfz(s+2)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFx(4:9) =DFx(4:9) &
                         &+cbx(s+2)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                         &+cby(s+2)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+2)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
                    !==========================================================
                    
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 2)*cfy(s+2)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 3)*cfz(s+2)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFy(4:9) =DFy(4:9) &
                         &+cbx(s+2)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                         &+cby(s+2)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+2)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
                    !==========================================================
                    
                    
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 2)*cfy(s+2)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 3)*cfz(s+2)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFz(4:9) =DFz(4:9) &
                         &+cbx(s+2)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
                         &+cby(s+2)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+2)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
                    
                    
                 end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -1,2
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+2)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+2)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+2)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+2)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+2)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
 
              end do
           end do
        end do
 
     end select
   end subroutine JJU_x3_interior_upwind


subroutine JJU_x4_interior_upwind(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:5) = (/-1.0_wp/4.0_wp,   -5.0_wp/6.0_wp,    3.0_wp/2.0_wp,   &
                                            -1.0_wp/2.0_wp,    1.0_wp/12.0_wp /)     ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:5) = (/-1.0_wp/12.0_wp,   1.0_wp/2.0_wp,   -3.0_wp/2.0_wp,   &
                                            5.0_wp/6.0_wp,    1.0_wp/4.0_wp  /)       ! backward FD coefficients 
     

     real(kind = wp),dimension(1:5) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 4
     iy = 4
     iz = 4
 
     fx = 4
     fy = 4
     fz = 4
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 4)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 4)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 4)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 4)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 4)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 4)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
                 do s = -1,3
                    
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 2)*cfy(s+2)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 3)*cfz(s+2)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFx(4:9) =DFx(4:9) &
                         &+cbx(s+2)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricx(x+s-2, y, z, 1)*G%J(x+s-2,y,z)  &
                         &+cby(s+2)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricx(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                         &+cbz(s+2)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricx(x, y, z+s-2, 3)*G%J(x, y, z+s-2)! backwad difference for stress field
                    !==========================================================
                    
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 2)*cfy(s+2)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 3)*cfz(s+2)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFy(4:9) =DFy(4:9) &
                         &+cbx(s+2)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricy(x+s-2, y, z, 1)*G%J(x+s-2,y,z)  &
                         &+cby(s+2)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricy(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                         &+cbz(s+2)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricy(x, y, z+s-2, 3)*G%J(x, y, z+s-2)
                    !==========================================================
                    
                    
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 2)*cfy(s+2)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 3)*cfz(s+2)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFz(4:9) =DFz(4:9) &
                         &+cbx(s+2)*(F%F%F(x+s-2, y  , z  , 4:9) ) *G%metricz(x+s-2, y, z, 1)*G%J(x+s-2,y,z)   &
                         &+cby(s+2)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricz(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                         &+cbz(s+2)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricz(x, y, z+s-2, 3)*G%J(x, y, z+s-2)!
                    
                    
                 end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -1,3
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+2)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+2)*(F%F%F(x+s-2, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+2)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+2)*(F%F%F(x  , y+s-2, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+2)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+2)*(F%F%F(x  , y  , z+s-2, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
 
              end do
           end do
        end do
 
     end select
   end subroutine JJU_x4_interior_upwind


    subroutine JJU_x5_interior_upwind(F, G, M, type_of_mesh)
     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================
     !
     !type(block_fields), intent(inout):: F
     type(block_type), intent(inout):: F
     type(block_grid_t), intent(in) :: G
     type(block_material), intent(inout) :: M
 
     character(len=64), intent(in) :: type_of_mesh
 
     integer :: mx, my, mz, px, py, pz, nx, ny, nz, n
     real(kind = wp) :: hx, hy, hz                           ! spatial steps discertizing the unit cube
 
     integer :: x,y,z,s, iz, fz, iy, fy, ix, fx
     integer :: i
 
     real(kind = wp),parameter :: cf(1:6) = (/  0.05_wp,  -0.5_wp, -1.0_wp/3.00_wp, 1.0_wp, -0.25_wp, 1.0_wp/30.0_wp /) ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:6) = (/ -1.0_wp/30.0_wp, 0.25_wp, -1.0_wp, 1.0_wp/3.0_wp, 0.5_wp, -0.05_wp /) ! backward FD coefficients 
     real(kind = wp),dimension(1:6) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp) :: a1,a2,a3,a4
     real(kind = wp) :: tr
 
 
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
 !!$    iz = mz
 !!$    fz = pz
 !!$    if (mz == 1) iz = mz + 6
 !!$    if (pz == nz) fz = pz - 6
 !!$
 !!$    iy = my
 !!$    fy = py
 !!$    if (my == 1) iy= my + 6
 !!$    if (py == ny) fy = py - 6
 !!$
 !!$    ix = mx
 !!$    fx = px
 !!$    if (mx == 1 ) ix = mx + 6
 !!$    if (px == nx) fx = px - 6
 !!$
 !!$    if ((mz == 1) .and. (F%PMLB(5)%pml .EQV. .TRUE.)) iz = mz + max(F%PMLB(5)%N_pml, 6)
 !!$    if ((pz == nz) .and. (F%PMLB(6)%pml .EQV. .TRUE.)) fz = pz - max(F%PMLB(6)%N_pml, 6)
 !!$
 !!$    if ((my == 1) .and. (F%PMLB(3)%pml .EQV. .TRUE.)) iy = my + max(F%PMLB(3)%N_pml, 6)
 !!$    if ((py == ny) .and. (F%PMLB(4)%pml .EQV. .TRUE.)) fy = py - max(F%PMLB(4)%N_pml, 6)
 !!$
 !!$    if ((mx == 1) .and. (F%PMLB(1)%pml .EQV. .TRUE.)) ix = mx + max(F%PMLB(1)%N_pml, 6)
 !!$    if ((px == nx) .and. (F%PMLB(2)%pml .EQV. .TRUE.)) fx = px - max(F%PMLB(2)%N_pml, 6)
 
 
     ix = 4
     iy = 4
     iz = 4
 
     fx = 4
     fy = 4
     fz = 4
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 4)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 4)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 4)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 4)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 4)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 4)
 
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                      ((iy+1 > y) .or. (y > ny - fy)) .or. &
                      ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
                 do s = -2,3
                    
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                         &+G%metricx(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFx(4:9) =DFx(4:9) &
                         &+cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z) &
                         &+cby(s+3)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+3)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
                    !==========================================================
                    
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                         &+G%metricy(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFy(4:9) =DFy(4:9) &
                         &+cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z) &
                         &+cby(s+3)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+3)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
                    !==========================================================
                    
                    
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                         &+G%metricz(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFz(4:9) =DFz(4:9) &
                         &+cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z) &
                         &+cby(s+3)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+3)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
                    
                    
                 end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                 if (M%anelastic) then
                          F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                          F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                          F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                          F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                          F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                          F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                          tr = DFx(1) + DFy(2) + DFz(3)
                          do i = 1, 4
                                M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                     ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                     + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                 - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                     - M%eta4(x,y,z,i) ) / M%tau(i)

                                M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                     ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                     + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                 - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                     - M%eta5(x,y,z,i) ) / M%tau(i)

                                M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                     ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                     + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                 - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                     - M%eta6(x,y,z,i) ) / M%tau(i)

                                M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                     (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                     (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                     (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                          end do
                 end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                   ((iy+1 > y) .or. (y > ny - fy)) .or. &
                   ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -2,3
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+3)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+3)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+3)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+3)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                 if (M%anelastic) then
                          F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                          F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                          F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                          F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                          F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                          F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                          tr = DFx(1) + DFy(2) + DFz(3)
                          do i = 1, 4
                                M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                     ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                     + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                 - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                     - M%eta4(x,y,z,i) ) / M%tau(i)

                                M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                     ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                     + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                 - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                     - M%eta5(x,y,z,i) ) / M%tau(i)

                                M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                     ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                     + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                 - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                     - M%eta6(x,y,z,i) ) / M%tau(i)

                                M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                     (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                     (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                     (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                          end do
                 end if
 
              end do
           end do
        end do
 
     end select
 
   end subroutine JJU_x5_interior_upwind



  subroutine JJU_x6_interior_upwind(F, G, M, type_of_mesh)
    use datatypes, only: block_type, block_fields, block_grid_t, block_material

    implicit none

    !=================================================================================================
    !
    !type(block_fields), intent(inout):: F
    type(block_type), intent(inout):: F
    type(block_grid_t), intent(in) :: G
     type(block_material), intent(inout) :: M

    character(len=64), intent(in) :: type_of_mesh

    integer :: mx, my, mz, px, py, pz, nx, ny, nz, n
    real(kind = wp) :: hx, hy, hz                           ! spatial steps discertizing the unit cube

    integer :: x,y,z,s, iz, fz, iy, fy, ix, fx

     integer :: i

    real(kind=wp),parameter::cf(1:7)=(/1.0_wp/30.0_wp,-0.4_wp,-7.0_wp/12.0_wp,4.0_wp/3.0_wp,-0.5_wp,2.0_wp/15.0_wp,-1.0_wp/60.0_wp/) ! forward  FD coefficients 
    real(kind=wp),parameter::cb(1:7)=(/1.0_wp/60.0_wp,-2.0_wp/15.0_wp,0.5_wp,-4.0_wp/3.0_wp,7.0_wp/12.0_wp,0.4_wp,-1.0_wp/30.0_wp/) ! backward FD coefficients 
    real(kind=wp),dimension(1:7) :: cfx,cfy,cfz, cbx,cby,cbz
    real(kind=wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind=wp) :: a1,a2,a3,a4
     real(kind=wp) :: tr
     

    mx = G%C%mq
    my = G%C%mr
    mz = G%C%ms
    px = G%C%pq
    py = G%C%pr
    pz = G%C%ps
    nx = G%C%nq
    ny = G%C%nr
    nz = G%C%ns

    n = size(F%F%F, 4)

    hx = G%hq
    hy = G%hr
    hz = G%hs

    cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
    cbx = cb/hx; cby = cb/hy; cbz = cb/hz

!!$    iz = mz
!!$    fz = pz
!!$    if (mz == 1) iz = mz + 6
!!$    if (pz == nz) fz = pz - 6
!!$
!!$    iy = my
!!$    fy = py
!!$    if (my == 1) iy= my + 6
!!$    if (py == ny) fy = py - 6
!!$
!!$    ix = mx
!!$    fx = px
!!$    if (mx == 1 ) ix = mx + 6
!!$    if (px == nx) fx = px - 6
!!$
!!$    if ((mz == 1) .and. (F%PMLB(5)%pml .EQV. .TRUE.)) iz = mz + max(F%PMLB(5)%N_pml, 6)
!!$    if ((pz == nz) .and. (F%PMLB(6)%pml .EQV. .TRUE.)) fz = pz - max(F%PMLB(6)%N_pml, 6)
!!$
!!$    if ((my == 1) .and. (F%PMLB(3)%pml .EQV. .TRUE.)) iy = my + max(F%PMLB(3)%N_pml, 6)
!!$    if ((py == ny) .and. (F%PMLB(4)%pml .EQV. .TRUE.)) fy = py - max(F%PMLB(4)%N_pml, 6)
!!$
!!$    if ((mx == 1) .and. (F%PMLB(1)%pml .EQV. .TRUE.)) ix = mx + max(F%PMLB(1)%N_pml, 6)
!!$    if ((px == nx) .and. (F%PMLB(2)%pml .EQV. .TRUE.)) fx = px - max(F%PMLB(2)%N_pml, 6)


    ix = 6
    iy = 6
    iz = 6

    fx = 6
    fy = 6
    fz = 6

    if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
    if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)
    
    if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
    if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)
    
    if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
    if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)

    select case(type_of_mesh)

    case('curvilinear') ! locked or welded interface    

       do z = mz, pz
          do y = my, py
             do x = mx, px
                
                
                ! cycle if an interior point
                if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                
                DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                
                do s = -2,4
                   
                   DFx(1:3) = DFx(1:3) &
                        &+G%metricx(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                        &+G%metricx(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                        &+G%metricx(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                   
                   DFx(4:9) =DFx(4:9) &
                        &+cbx(s+3)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricx(x+s-2, y, z, 1)*G%J(x+s-2,y,z) &
                        &+cby(s+3)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricx(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                        &+cbz(s+3)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricx(x, y, z+s-2, 3)*G%J(x, y, z+s-2)! backwad difference for stress field
                   !==========================================================
                   
                   DFy(1:3) = DFy(1:3) &
                        &+G%metricy(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                        &+G%metricy(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                        &+G%metricy(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                   
                   DFy(4:9) =DFy(4:9) &
                        &+cbx(s+3)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricy(x+s-2, y, z, 1)*G%J(x+s-2,y,z) &
                        &+cby(s+3)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricy(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                        &+cbz(s+3)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricy(x, y, z+s-2, 3)*G%J(x, y, z+s-2)
                   !==========================================================
                   
                   
                   DFz(1:3) = DFz(1:3) &
                        &+G%metricz(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                        &+G%metricz(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                        &+G%metricz(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                   
                   DFz(4:9) =DFz(4:9) &
                        &+cbx(s+3)*(F%F%F(x+s-2, y  , z  , 4:9) ) *G%metricz(x+s-2, y, z, 1)*G%J(x+s-2,y,z) &
                        &+cby(s+3)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricz(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
                        &+cbz(s+3)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricz(x, y, z+s-2, 3)*G%J(x, y, z+s-2)!
                   
                   
                end do
                
                a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                a3 = M%M(x, y, z, 1) ! lambda
                a4 = M%M(x, y, z, 2) ! mu
                
                F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                
                F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                
                F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                if (M%anelastic) then
                         F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                         F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                         F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                         F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                         F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                         F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                         tr = DFx(1) + DFy(2) + DFz(3)
                         do i = 1, 4
                               M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                    - M%eta4(x,y,z,i) ) / M%tau(i)

                               M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                    - M%eta5(x,y,z,i) ) / M%tau(i)

                               M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                    - M%eta6(x,y,z,i) ) / M%tau(i)

                               M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                               M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                               M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                         end do
                end if
                
             end do
          end do
       end do

    case('cartesian') ! carteian mesh
       !print *, 'interior'
       
       do z = mz, pz
          do y = my, py
             do x = mx, px

                if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                  ((iy+1 > y) .or. (y > ny - fy)) .or. &
                  ((ix+1 > x) .or. (x > nx - fx))) cycle
                
                DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

                do s = -2,4

                   DFx(1:3) = DFx(1:3) &
                        &+G%metricx(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field

                   DFx(4:9) =DFx(4:9) &

                        &+G%metricx(x, y, z, 1)*cbx(s+3)*(F%F%F(x+s-2, y  , z  , 4:9) ) ! backwad difference for stress field
                   !==========================================================

                   DFy(1:3) = DFy(1:3) &
                        &+G%metricy(x, y, z, 2)*cfy(s+3)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field

                   DFy(4:9) = DFy(4:9) &
                   
                        &+G%metricy(x, y, z, 2)*cby(s+3)*(F%F%F(x  , y+s-2, z , 4:9) ) ! backward difference for velocity field
                   !==========================================================
 

                   DFz(1:3) = DFz(1:3) &
                        &+G%metricz(x, y, z, 3)*cfz(s+3)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field

                   DFz(4:9) = DFz(4:9) &

                        &+G%metricz(x, y, z, 3)*cbz(s+3)*(F%F%F(x  , y  , z+s-2, 4:9))   ! backward difference for velocity field
                   
                       
                end do

                a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

                a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

                a3 = M%M(x, y, z, 1) ! lambda

                a4 = M%M(x, y, z, 2) ! mu


                F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

                F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

                F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                if (M%anelastic) then
                         F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                         F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                         F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                         F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                         F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                         F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                         tr = DFx(1) + DFy(2) + DFz(3)
                         do i = 1, 4
                               M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                    - M%eta4(x,y,z,i) ) / M%tau(i)

                               M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                    - M%eta5(x,y,z,i) ) / M%tau(i)

                               M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                    - M%eta6(x,y,z,i) ) / M%tau(i)

                               M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                               M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                               M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                         end do
                end if

             end do
          end do
       end do

    end select

  end subroutine JJU_x6_interior_upwind


   subroutine JJU_x7_interior_upwind(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:8) = (/-1.0_wp/105.0_wp,  1.0_wp/10.0_wp, -3.0_wp/5.0_wp , -1.0_wp/4.0_wp,&
                                             1.0_wp       , -3.0_wp/10.0_wp,    1.0_wp/15.0_wp, -1.0_wp/140.0_wp/)     ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:8) = (/ 1.0_wp/140.0_wp, -1.0_wp/15.0_wp,  3.0_wp/10.0_wp, -1.0_wp       ,&
                                             1.0_wp/4.0_wp,  3.0_wp/5.0_wp ,   -1.0_wp/10.0_wp,  1.0_wp/105.0_wp/)        ! backward FD coefficients 
     

     real(kind = wp),dimension(1:8) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 6
     iy = 6
     iz = 6
 
     fx = 6
     fy = 6
     fz = 6
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
                 do s = -3,4
                    
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricx(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFx(4:9) =DFx(4:9) &
                         &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                         &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
                    !==========================================================
                    
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricy(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFy(4:9) =DFy(4:9) &
                         &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                         &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
                    !==========================================================
                    
                    
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                         &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
                    
                    DFz(4:9) =DFz(4:9) &
                         &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
                         &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                         &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
                    
                    
                 end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -3,4
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+4)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+4)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
 
              end do
           end do
        end do
 
     end select
 
   end subroutine JJU_x7_interior_upwind


   subroutine JJU_x8_interior_upwind(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:9) = (/-1.0_wp/168.0_wp,1.0_wp/14.0_wp,&
                                              -1.0_wp/2.0_wp,-9.0_wp/20.0_wp, &
                                             5.0_wp/4.0_wp,-1.0_wp/2.0_wp,    &
                                             1.0_wp/6.0_wp,-1.0_wp/28.0_wp,1.0_wp/280.0_wp/) ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:9) = (/-1.0_wp/280.0_wp,1.0_wp/28.0_wp,&
                                              -1.0_wp/6.0_wp,1.0_wp/2.0_wp,   &
                                              -5.0_wp/4.0_wp,9.0_wp/20.0_wp,  &
                                             1.0_wp/2.0_wp,-1.0_wp/14.0_wp,1.0_wp/168.0_wp/) ! backward FD coefficients 
     
     real(kind = wp),dimension(1:9) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 8
     iy = 8
     iz = 8
 
     fx = 8
     fy = 8
     fz = 8
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
       
       ! cycle if an interior point
       if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
            ((iy+1 > y)   .or. (y > ny - fy))    .or. &
            ((ix+1 > x)   .or. (x > nx - fx)))    cycle
       
       DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
       
       do s = -3,5
          
          DFx(1:3) = DFx(1:3) &
               &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricx(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricx(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field

          
          DFx(4:9) =DFx(4:9) &
               &+cbx(s+4)*(F%F%F(x+s-2,y,z,4:9))*G%metricx(x+s-2, y, z, 1)*G%J(x+s-2,y,z)  &
               &+cby(s+4)*(F%F%F(x,y+s-2,z,4:9))*G%metricx(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
               &+cbz(s+4)*(F%F%F(x,y,z+s-2,4:9))*G%metricx(x, y, z+s-2, 3)*G%J(x, y, z+s-2)! backwad difference for stress field
          !==========================================================
          
          DFy(1:3) = DFy(1:3) &
               &+G%metricy(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricy(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFy(4:9) =DFy(4:9) &
               &+cbx(s+4)*(F%F%F(x+s-2, y  , z  , 4:9) ) * G%metricy(x+s-2, y, z, 1)*G%J(x+s-2,y,z)  &
               &+cby(s+4)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricy(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
               &+cbz(s+4)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricy(x, y, z+s-2, 3)*G%J(x, y, z+s-2)
          !==========================================================
          
          
          DFz(1:3) = DFz(1:3) &
               &+G%metricz(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricz(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFz(4:9) =DFz(4:9) &
               &+cbx(s+4)*(F%F%F(x+s-2, y  , z  , 4:9) ) *G%metricz(x+s-2, y, z, 1)*G%J(x+s-2,y,z)   &
               &+cby(s+4)*(F%F%F(x, y+s-2  , z  , 4:9) ) * G%metricz(x, y+s-2, z, 2)* G%J(x,y+s-2,z) &
               &+cbz(s+4)*(F%F%F(x, y  , z+s-2  , 4:9) ) * G%metricz(x, y, z+s-2, 3)*G%J(x, y, z+s-2)!
          
          
       end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -3,5
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+4)*(F%F%F(x+s-2, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+4)*(F%F%F(x  , y+s-2, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+4)*(F%F%F(x  , y  , z+s-2, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
 
              end do
           end do
        end do
 
     end select
 
   end subroutine JJU_x8_interior_upwind
 

 subroutine JJU_x9_interior_upwind(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:10) =  (/  1.0_wp/504.0_wp, -1.0_wp/42.0_wp, 1.0_wp/7.0_wp,&
                                                 -2.0_wp/3.0_wp, -1.0_wp/5.0_wp,    1.0_wp, &
                                                 -1.0_wp/3.0_wp, 2.0_wp/21.0_wp, -1.0_wp/56.0_wp, &
                                                 1.0_wp/630.0_wp  /) ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:10) = (/-1.0_wp/630.0_wp, 1.0_wp/56.0_wp, -2.0_wp/21.0_wp, &
                                                1.0_wp/3.0_wp, -1.0_wp, 1.0_wp/5.0_wp, &
                                                2.0_wp/3.0_wp, -1.0_wp/7.0_wp, 1.0_wp/42.0_wp, &
                                                -1.0_wp/504.0_wp /)     ! backward FD coefficients 
     
     real(kind = wp),dimension(1:10) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 8
     iy = 8
     iz = 8
 
     fx = 8
     fy = 8
     fz = 8
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 8)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 8)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 8)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 8)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 8)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 8)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
       do s = -4,5
          
          DFx(1:3) = DFx(1:3) &
               &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricx(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricx(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFx(4:9) =DFx(4:9) &
               &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
               &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
               &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
          !==========================================================
          
          DFy(1:3) = DFy(1:3) &
               &+G%metricy(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricy(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFy(4:9) =DFy(4:9) &
               &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
               &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
               &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
          !==========================================================
          
          
          DFz(1:3) = DFz(1:3) &
               &+G%metricz(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricz(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFz(4:9) =DFz(4:9) &
               &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
               &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
               &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
          
          
       end do
       
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                                             F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                                             F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                                             F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -4,5
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+5)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+5)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                 if (M%anelastic) then
                    F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                    F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                    F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                    F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                    F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                    F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                    tr = DFx(1) + DFy(2) + DFz(3)
                    do i = 1, 4
                       M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta4(x,y,z,i) ) / M%tau(i)
                       M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta5(x,y,z,i) ) / M%tau(i)
                       M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta6(x,y,z,i) ) / M%tau(i)

                       M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                       M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                       M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                    end do
                 end if
 
              end do
           end do
        end do
 
     end select
 
   end subroutine JJU_x9_interior_upwind
  

!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================
!=============================================================================================


     subroutine JJU_x3_interior_upwind_drp(F, G, M, type_of_mesh)


use datatypes, only: block_type, block_fields, block_grid_t, block_material

implicit none

!=================================================================================================
!
!type(block_fields), intent(inout):: F
type(block_type), intent(inout):: F
type(block_grid_t), intent(in) :: G
type(block_material), intent(inout) :: M

character(len=64), intent(in) :: type_of_mesh

integer :: mx, my, mz, px, py, pz, nx, ny, nz, n
real(kind = wp) :: hx, hy, hz                           ! spatial steps discertizing the unit cube

integer :: x,y,z,s, iz, fz, iy, fy, ix, fx

real(kind = wp),parameter :: cf(1:6) = (/ -5.0_wp/48.0_wp, 29.0_wp/360.0_wp,-401.0_wp/360.0_wp,&
                                           7.0_wp/5.0_wp, -187.0_wp/720.0_wp, -1.0_wp/360.0_wp /) 
real(kind = wp),parameter :: cb(1:6) = (/ 1.0_wp/360.0_wp, 187.0_wp/720.0_wp,-7.0_wp/5.0_wp,&
                                          401.0_wp/360.0_wp, -29.0_wp/360.0_wp, 5.0_wp/48.0_wp /) 
real(kind = wp),dimension(1:6) :: cfx,cfy,cfz, cbx,cby,cbz
real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
real(kind = wp) :: a1,a2,a3,a4
integer :: i
real(kind = wp) :: tr


mx = G%C%mq
my = G%C%mr
mz = G%C%ms
px = G%C%pq
py = G%C%pr
pz = G%C%ps
nx = G%C%nq
ny = G%C%nr
nz = G%C%ns

n = size(F%F%F, 4)

hx = G%hq
hy = G%hr
hz = G%hs

cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
cbx = cb/hx; cby = cb/hy; cbz = cb/hz

ix = 4
iy = 4
iz = 4

fx = 4
fy = 4
fz = 4

if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 4)
if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 4)

if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 4)
if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 4)

if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 4)
if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 4)

select case(type_of_mesh)

case('curvilinear') ! locked or welded interface    

   do z = mz, pz
      do y = my, py
         do x = mx, px
            
            
            ! cycle if an interior point
            if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                 ((iy+1 > y) .or. (y > ny - fy)) .or. &
                 ((ix+1 > x) .or. (x > nx - fx))) cycle
            
            DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
            
            do s = -2,3
               
               DFx(1:3) = DFx(1:3) &
                    &+G%metricx(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                    &+G%metricx(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                    &+G%metricx(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
               
               DFx(4:9) =DFx(4:9) &
                    &+cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z) &
                    &+cby(s+3)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                    &+cbz(s+3)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
               !==========================================================
               
               DFy(1:3) = DFy(1:3) &
                    &+G%metricy(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                    &+G%metricy(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                    &+G%metricy(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
               
               DFy(4:9) =DFy(4:9) &
                    &+cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z) &
                    &+cby(s+3)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                    &+cbz(s+3)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
               !==========================================================
               
               
               DFz(1:3) = DFz(1:3) &
                    &+G%metricz(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) &
                    &+G%metricz(x, y, z, 2)*cfy(s+3)*(F%F%F(x, y+s  , z  , 1:3)  ) &
                    &+G%metricz(x, y, z, 3)*cfz(s+3)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
               
               DFz(4:9) =DFz(4:9) &
                    &+cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z) &
                    &+cby(s+3)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                    &+cbz(s+3)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
               
               
            end do
            
            a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
            a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
            a3 = M%M(x, y, z, 1) ! lambda
            a4 = M%M(x, y, z, 2) ! mu
            
            F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
            F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
            F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
            
            F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
            F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
            F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
            
            F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
            F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
            F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

            if (M%anelastic) then
               F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
               F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
               F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
               F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
               F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
               F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

               tr = DFx(1) + DFy(2) + DFz(3)
               do i = 1, 4
                  M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                       ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                       + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                       - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                       - M%eta4(x,y,z,i) ) / M%tau(i)

                  M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                       ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                       + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                       - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                       - M%eta5(x,y,z,i) ) / M%tau(i)

                  M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                       ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                       + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                       - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                       - M%eta6(x,y,z,i) ) / M%tau(i)

                  M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                       (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                  M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                       (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                  M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                       (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
               end do
            end if
            
         end do
      end do
   end do

case('cartesian') ! carteian mesh
   !print *, 'interior'
   
   do z = mz, pz
      do y = my, py
         do x = mx, px

            if (((iz+1 > z) .or. (z > nz - fz)) .or. &
              ((iy+1 > y) .or. (y > ny - fy)) .or. &
              ((ix+1 > x) .or. (x > nx - fx))) cycle
            
            DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

            do s = -2,3

               DFx(1:3) = DFx(1:3) &
                    &+G%metricx(x, y, z, 1)*cfx(s+3)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field

               DFx(4:9) =DFx(4:9) &

                    &+G%metricx(x, y, z, 1)*cbx(s+3)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
               !==========================================================

               DFy(1:3) = DFy(1:3) &
                    &+G%metricy(x, y, z, 2)*cfy(s+3)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field

               DFy(4:9) = DFy(4:9) &
               
                    &+G%metricy(x, y, z, 2)*cby(s+3)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
               !==========================================================


               DFz(1:3) = DFz(1:3) &
                    &+G%metricz(x, y, z, 3)*cfz(s+3)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field

               DFz(4:9) = DFz(4:9) &

                    &+G%metricz(x, y, z, 3)*cbz(s+3)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
               
                   
            end do

            a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

            a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

            a3 = M%M(x, y, z, 1) ! lambda

            a4 = M%M(x, y, z, 2) ! mu


            F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
            F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
            F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

            F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
            F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
            F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

            F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
            F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
            F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

            if (M%anelastic) then
               F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
               F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
               F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
               F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
               F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
               F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

               tr = DFx(1) + DFy(2) + DFz(3)
               do i = 1, 4
                  M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                       ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                       + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                       - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                       - M%eta4(x,y,z,i) ) / M%tau(i)

                  M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                       ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                       + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                       - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                       - M%eta5(x,y,z,i) ) / M%tau(i)

                  M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                       ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                       + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                       - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                       - M%eta6(x,y,z,i) ) / M%tau(i)

                  M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                       (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                  M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                       (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                  M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                       (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
               end do
            end if

         end do
      end do
   end do

end select
 
     end subroutine JJU_x3_interior_upwind_drp


     subroutine JJU_x4_interior_upwind_drp(F, G, M, type_of_mesh)


use datatypes, only: block_type, block_fields, block_grid_t, block_material

implicit none

!=================================================================================================

!input variables 
type(block_type)       , intent(inout) :: F
type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
character(len=64)      , intent(in)    :: type_of_mesh

integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    
integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
real(kind = wp)    :: hx, hy, hz                               

!stencil values
!forward  FD coefficients
real(kind = wp),parameter :: cf(1:8) = (/2.0_wp/65.0_wp, -443.0_wp/2860.0_wp, 57.0_wp/1430.0_wp, -889.0_wp/858.0_wp,&
                                       205.0_wp/143.0_wp, -873.0_wp/2860.0_wp, -133.0_wp/4290.0_wp, 3.0_wp/130.0_wp/)     
!backward  FD coefficients
real(kind = wp),parameter :: cb(1:8) = (/-3.0_wp/130.0_wp, 133.0_wp/4290.0_wp, 873.0_wp/2860.0_wp, -205.0_wp/143.0_wp,&
                                       889.0_wp/858.0_wp, -57.0_wp/1430.0_wp, 443.0_wp/2860.0_wp, -2.0_wp/65.0_wp/)         


real(kind = wp),dimension(1:8) :: cfx,cfy,cfz, cbx,cby,cbz
real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
real(kind = wp)                :: a1,a2,a3,a4
integer                         :: i
real(kind = wp)                 :: tr


!allocate constant values
!integers
mx = G%C%mq
my = G%C%mr
mz = G%C%ms
px = G%C%pq
py = G%C%pr
pz = G%C%ps
nx = G%C%nq
ny = G%C%nr
nz = G%C%ns

n = size(F%F%F, 4)

!spatial step sizes
hx = G%hq
hy = G%hr
hz = G%hs

cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
cbx = cb/hx; cby = cb/hy; cbz = cb/hz

!set default pml size
ix = 6
iy = 6
iz = 6

fx = 6
fy = 6
fz = 6

if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)

if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)

if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)


!two types of mesh
select case(type_of_mesh)

case('curvilinear') ! locked or welded interface    

do z = mz, pz
   do y = my, py
      do x = mx, px
         
         
         ! cycle if an interior point
         if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
              ((iy+1 > y)   .or. (y > ny - fy))    .or. &
              ((ix+1 > x)   .or. (x > nx - fx)))    cycle
         
         DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
         
         do s = -3,4
            
            DFx(1:3) = DFx(1:3) &
                 &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                 &+G%metricx(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                 &+G%metricx(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) ) 
            
            DFx(4:9) =DFx(4:9) &
                 &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                 &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                 &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
            !==========================================================
            
            DFy(1:3) = DFy(1:3) &
                 &+G%metricy(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                 &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                 &+G%metricy(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  
            
            DFy(4:9) =DFy(4:9) &
                 &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                 &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                 &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
            !==========================================================
            
            
            DFz(1:3) = DFz(1:3) &
                 &+G%metricz(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                 &+G%metricz(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                 &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  
            
            DFz(4:9) =DFz(4:9) &
                 &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
                 &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                 &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
            
            
         end do
         
         a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
         a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
         a3 = M%M(x, y, z, 1) ! lambda
         a4 = M%M(x, y, z, 2) ! mu
         
         F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
         F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
         F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
         
         F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
         F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
         F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
         
         F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
         F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
         F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

         if (M%anelastic) then
            F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
            F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
            F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
            F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
            F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
            F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

            tr = DFx(1) + DFy(2) + DFz(3)
            do i = 1, 4
               M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta4(x,y,z,i) ) / M%tau(i)
               M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta5(x,y,z,i) ) / M%tau(i)
               M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta6(x,y,z,i) ) / M%tau(i)

               M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
               M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
               M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
            end do
         end if
         
      end do
   end do
end do

case('cartesian') ! carteian mesh
!print *, 'interior'

do z = mz, pz
   do y = my, py
      do x = mx, px

         if (((iz+1 > z) .or. (z > nz - fz)) .or. &
             ((iy+1 > y) .or. (y > ny - fy)) .or. &
             ((ix+1 > x) .or. (x > nx - fx))) cycle
         
         DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

         do s = -3,4

            DFx(1:3) = DFx(1:3) &
                 &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) 

            DFx(4:9) =DFx(4:9) &

                 &+G%metricx(x, y, z, 1)*cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) 
            !==========================================================

            DFy(1:3) = DFy(1:3) &
                 &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x  , y+s, z , 1:3) )  

            DFy(4:9) = DFy(4:9) &
            
                 &+G%metricy(x, y, z, 2)*cby(s+4)*(F%F%F(x  , y+s-1, z , 4:9) ) 
            !==========================================================


            DFz(1:3) = DFz(1:3) &
                 &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x  , y  , z+s, 1:3))   

            DFz(4:9) = DFz(4:9) &

                 &+G%metricz(x, y, z, 3)*cbz(s+4)*(F%F%F(x  , y  , z+s-1, 4:9))  

                
         end do

         a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

         a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

         a3 = M%M(x, y, z, 1) ! lambda

         a4 = M%M(x, y, z, 2) ! mu


         F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
         F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
         F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

         F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
         F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
         F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

         F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
         F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
         F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

         if (M%anelastic) then
            F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
            F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
            F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
            F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
            F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
            F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

            tr = DFx(1) + DFy(2) + DFz(3)
            do i = 1, 4
               M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta4(x,y,z,i) ) / M%tau(i)
               M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta5(x,y,z,i) ) / M%tau(i)
               M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta6(x,y,z,i) ) / M%tau(i)

               M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
               M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
               M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
            end do
         end if

      end do
   end do
end do

end select
 
   end subroutine JJU_x4_interior_upwind_drp



    subroutine JJU_x5_interior_upwind_drp(F, G, M, type_of_mesh)


use datatypes, only: block_type, block_fields, block_grid_t, block_material

implicit none

!=================================================================================================

!input variables 
type(block_type)       , intent(inout) :: F
type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
character(len=64)      , intent(in)    :: type_of_mesh

integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    
integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
real(kind = wp)    :: hx, hy, hz                               

!stencil values
!forward  FD coefficients
real(kind = wp),parameter :: cf(1:8) = (/13.0_wp/525.0_wp, -109.0_wp/1050.0_wp, -17.0_wp/175.0_wp, -127.0_wp/140.0_wp,&
                                         31.0_wp/21.0_wp, -167.0_wp/350.0_wp, 47.0_wp/525.0_wp, -11.0_wp/2100.0_wp/)     
!backward  FD coefficients
real(kind = wp),parameter :: cb(1:8) = (/11.0_wp/2100.0_wp, -47.0_wp/525.0_wp, 167.0_wp/350.0_wp, -31.0_wp/21.0_wp,&
                                         127.0_wp/140.0_wp, 17.0_wp/175.0_wp, 109.0_wp/1050.0_wp, -13.0_wp/525.0_wp/)         


real(kind = wp),dimension(1:8) :: cfx,cfy,cfz, cbx,cby,cbz
real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
real(kind = wp)                :: a1,a2,a3,a4
integer                         :: i
real(kind = wp)                 :: tr


!allocate constant values
!integers
mx = G%C%mq
my = G%C%mr
mz = G%C%ms
px = G%C%pq
py = G%C%pr
pz = G%C%ps
nx = G%C%nq
ny = G%C%nr
nz = G%C%ns

n = size(F%F%F, 4)

!spatial step sizes
hx = G%hq
hy = G%hr
hz = G%hs

cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
cbx = cb/hx; cby = cb/hy; cbz = cb/hz

!set default pml size
ix = 6
iy = 6
iz = 6

fx = 6
fy = 6
fz = 6

if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)

if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)

if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)


!two types of mesh
select case(type_of_mesh)

case('curvilinear') ! locked or welded interface    

do z = mz, pz
   do y = my, py
      do x = mx, px
         
         
         ! cycle if an interior point
         if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
              ((iy+1 > y)   .or. (y > ny - fy))    .or. &
              ((ix+1 > x)   .or. (x > nx - fx)))    cycle
         
         DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
         
         do s = -3,4
            
            DFx(1:3) = DFx(1:3) &
                 &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                 &+G%metricx(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                 &+G%metricx(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) ) 
            
            DFx(4:9) =DFx(4:9) &
                 &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                 &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                 &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
            !==========================================================
            
            DFy(1:3) = DFy(1:3) &
                 &+G%metricy(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                 &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                 &+G%metricy(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  
            
            DFy(4:9) =DFy(4:9) &
                 &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
                 &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                 &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
            !==========================================================
            
            
            DFz(1:3) = DFz(1:3) &
                 &+G%metricz(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
                 &+G%metricz(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
                 &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  
            
            DFz(4:9) =DFz(4:9) &
                 &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
                 &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
                 &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
            
            
         end do
         
         a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
         a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
         a3 = M%M(x, y, z, 1) ! lambda
         a4 = M%M(x, y, z, 2) ! mu
         
         F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
         F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
         F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
         
         F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
         F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
         F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
         
         F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
         F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
         F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

         if (M%anelastic) then
            F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
            F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
            F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
            F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
            F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
            F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

            tr = DFx(1) + DFy(2) + DFz(3)
            do i = 1, 4
               M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta4(x,y,z,i) ) / M%tau(i)
               M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta5(x,y,z,i) ) / M%tau(i)
               M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta6(x,y,z,i) ) / M%tau(i)

               M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
               M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
               M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
            end do
         end if
         
      end do
   end do
end do

case('cartesian') ! carteian mesh
!print *, 'interior'

do z = mz, pz
   do y = my, py
      do x = mx, px

         if (((iz+1 > z) .or. (z > nz - fz)) .or. &
             ((iy+1 > y) .or. (y > ny - fy)) .or. &
             ((ix+1 > x) .or. (x > nx - fx))) cycle
         
         DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

         do s = -3,4

            DFx(1:3) = DFx(1:3) &
                 &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) 

            DFx(4:9) =DFx(4:9) &

                 &+G%metricx(x, y, z, 1)*cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) 
            !==========================================================

            DFy(1:3) = DFy(1:3) &
                 &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x  , y+s, z , 1:3) )  

            DFy(4:9) = DFy(4:9) &
            
                 &+G%metricy(x, y, z, 2)*cby(s+4)*(F%F%F(x  , y+s-1, z , 4:9) ) 
            !==========================================================


            DFz(1:3) = DFz(1:3) &
                 &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x  , y  , z+s, 1:3))   

            DFz(4:9) = DFz(4:9) &

                 &+G%metricz(x, y, z, 3)*cbz(s+4)*(F%F%F(x  , y  , z+s-1, 4:9))  

                
         end do

         a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

         a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

         a3 = M%M(x, y, z, 1) ! lambda

         a4 = M%M(x, y, z, 2) ! mu


         F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
         F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
         F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

         F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
         F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
         F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

         F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
         F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
         F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

         if (M%anelastic) then
            F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
            F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
            F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
            F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
            F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
            F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

            tr = DFx(1) + DFy(2) + DFz(3)
            do i = 1, 4
               M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta4(x,y,z,i) ) / M%tau(i)
               M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta5(x,y,z,i) ) / M%tau(i)
               M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                    ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                    + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                    - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                    - M%eta6(x,y,z,i) ) / M%tau(i)

               M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
               M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
               M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                    (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
            end do
         end if

      end do
   end do
end do

end select
 
   end subroutine JJU_x5_interior_upwind_drp




  subroutine JJU_x6_interior_upwind_drp(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material

     implicit none

     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh

     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube

     !stencil values
     real(kind = wp),parameter :: cf(1:10) =  (/  -1.0_wp/168.0_wp, 149.0_wp/3150.0_wp, -199.0_wp/1575.0_wp,&
                                                  -8.0_wp/75.0_wp, -8.0_wp/9.0_wp, 67.0_wp/45.0_wp,&
                                                  -37.0_wp/75.0_wp, 124.0_wp/1575.0_wp, 139.0_wp/12600.0_wp,&
                                                  -1.0_wp/210.0_wp  /) ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:10) = (/   1.0_wp/210.0_wp, -139.0_wp/12600.0_wp, -124.0_wp/1575.0_wp,&
                                                  37.0_wp/75.0_wp, -67.0_wp/45.0_wp, 8.0_wp/9.0_wp,&
                                                  8.0_wp/75.0_wp, 199.0_wp/1575.0_wp, -149.0_wp/3150.0_wp,&
                                                  1.0_wp/168.0_wp /)     ! backward FD coefficients 


     real(kind = wp),dimension(1:10) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr


     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n = size(F%F%F, 4)

     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs

     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz

     !set default pml size
     ix = 8
     iy = 8
     iz = 8

     fx = 8
     fy = 8
     fz = 8

     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 8)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 8)

     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 8)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 8)

     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 8)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 8)


     !two types of mesh
     select case(type_of_mesh)

     case('curvilinear') ! locked or welded interface    

        do z = mz, pz
           do y = my, py
              do x = mx, px
                 

                 !cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
  
  do s = -4,5
     
     DFx(1:3) = DFx(1:3) &
          &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricx(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricx(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFx(4:9) =DFx(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
     !==========================================================
     
     DFy(1:3) = DFy(1:3) &
          &+G%metricy(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricy(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFy(4:9) =DFy(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
     !==========================================================
     
     
     DFz(1:3) = DFz(1:3) &
          &+G%metricz(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricz(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFz(4:9) =DFz(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
     
     
  end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                                             F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                                             F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                                             F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do

     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px


                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

                 do s = -4,5

                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field

                    DFx(4:9) =DFx(4:9) &

                         &+G%metricx(x, y, z, 1)*cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================

                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field

                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+5)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================


                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field

                    DFz(4:9) = DFz(4:9) &

                         &+G%metricz(x, y, z, 3)*cbz(s+5)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do

                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

                 a3 = M%M(x, y, z, 1) ! lambda

                 a4 = M%M(x, y, z, 2) ! mu


                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                 if (M%anelastic) then
                    F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                    F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                    F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                    F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                    F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                    F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                    tr = DFx(1) + DFy(2) + DFz(3)
                    do i = 1, 4
                       M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta4(x,y,z,i) ) / M%tau(i)
                       M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta5(x,y,z,i) ) / M%tau(i)
                       M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta6(x,y,z,i) ) / M%tau(i)

                       M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                       M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                       M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                    end do
                 end if

              end do
           end do
        end do

     end select

     end subroutine JJU_x6_interior_upwind_drp

  subroutine JJU_x7_interior_upwind_drp(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material

     implicit none

     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh

     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube

     !stencil values
     real(kind = wp),parameter :: cf(1:10) =  (/ -43.0_wp/7056.0_wp, 4859.0_wp/117600.0_wp,&
                                                -107.0_wp/1225.0_wp, -841.0_wp/4200.0_wp, &
                                                -1111.0_wp/1400.0_wp, 119.0_wp/80.0_wp,   &
                                                -617.0_wp/1050.0_wp, 5113.0_wp/29400.0_wp,&
                                                -587.0_wp/19600.0_wp, 737.0_wp/352800.0_wp /) ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:10) = (/ -737.0_wp/352800.0_wp, 587.0_wp/19600.0_wp,&
                                                -5113.0_wp/29400.0_wp, 617.0_wp/1050.0_wp, &
                                                -119.0_wp/80.0_wp, 1111.0_wp/1400.0_wp,    &
                                                841.0_wp/4200.0_wp, 107.0_wp/1225.0_wp,    &
                                                -4859.0_wp/117600.0_wp, 43.0_wp/7056.0_wp /)     ! backward FD coefficients 


     real(kind = wp),dimension(1:10) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr


     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n = size(F%F%F, 4)

     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs

     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz

     !set default pml size
     ix = 8
     iy = 8
     iz = 8

     fx = 8
     fy = 8
     fz = 8

     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 8)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 8)

     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 8)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 8)

     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 8)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 8)


     !two types of mesh
     select case(type_of_mesh)

     case('curvilinear') ! locked or welded interface    

        do z = mz, pz
           do y = my, py
              do x = mx, px
                 

                 !cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
  
  do s = -4,5
     
     DFx(1:3) = DFx(1:3) &
          &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricx(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricx(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFx(4:9) =DFx(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
     !==========================================================
     
     DFy(1:3) = DFy(1:3) &
          &+G%metricy(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricy(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFy(4:9) =DFy(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
     !==========================================================
     
     
     DFz(1:3) = DFz(1:3) &
          &+G%metricz(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricz(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFz(4:9) =DFz(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
     
     
  end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do

     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px


                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

                 do s = -4,5

                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field

                    DFx(4:9) =DFx(4:9) &

                         &+G%metricx(x, y, z, 1)*cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================

                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field

                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+5)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================


                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field

                    DFz(4:9) = DFz(4:9) &

                         &+G%metricz(x, y, z, 3)*cbz(s+5)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do

                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

                 a3 = M%M(x, y, z, 1) ! lambda

                 a4 = M%M(x, y, z, 2) ! mu


                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if

              end do
           end do
        end do

     end select

     end subroutine JJU_x7_interior_upwind_drp    


   subroutine JJU_x66_interior_upwind_drp(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material
 
     implicit none
 
     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh
 
     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube
 
     !stencil values
     real(kind = wp),parameter :: cf(1:8) = (/1.0_wp/118.0_wp ,  -1.0_wp/38.0_wp ,&
                                            -39.0_wp/176.0_wp , -59.0_wp/67.0_wp ,&
                                             106.0_wp/65.0_wp , -19.0_wp/28.0_wp ,&
                                              16.0_wp/83.0_wp , -1.0_wp/40.0_wp /)  ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:8) = (/ 1.0_wp/40.0_wp , -16.0_wp/83.0_wp ,&
                                               19.0_wp/28.0_wp ,-106.0_wp/65.0_wp,&
                                             59.0_wp/67.0_wp ,  39.0_wp/176.0_wp ,&
                                               1.0_wp/38.0_wp ,  -1.0_wp/118.0_wp/) ! backward FD coefficients 
     

     real(kind = wp),dimension(1:8) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr
 
 
     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns
 
     n = size(F%F%F, 4)
 
     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs
 
     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz
 
     !set default pml size
     ix = 6
     iy = 6
     iz = 6
 
     fx = 6
     fy = 6
     fz = 6
 
     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 6)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 6)
     
     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 6)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 6)
     
     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 6)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 6)
 

     !two types of mesh
     select case(type_of_mesh)
 
     case('curvilinear') ! locked or welded interface    
 
        do z = mz, pz
           do y = my, py
              do x = mx, px
                 
                 
                 ! cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
                 
                 do s = -3,4
          
          DFx(1:3) = DFx(1:3) &
               &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricx(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricx(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFx(4:9) =DFx(4:9) &
               &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
               &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
               &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
          !==========================================================
          
          DFy(1:3) = DFy(1:3) &
               &+G%metricy(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricy(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFy(4:9) =DFy(4:9) &
               &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
               &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
               &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
          !==========================================================
          
          
          DFz(1:3) = DFz(1:3) &
               &+G%metricz(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) &
               &+G%metricz(x, y, z, 2)*cfy(s+4)*(F%F%F(x, y+s  , z  , 1:3) ) &
               &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
          
          DFz(4:9) =DFz(4:9) &
               &+cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
               &+cby(s+4)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
               &+cbz(s+4)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
          
                    
       end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                                             F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                                             F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                                             F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do
 
     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
              do x = mx, px
 
                 if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                     ((iy+1 > y) .or. (y > ny - fy)) .or. &
                     ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
 
                 do s = -3,4
 
                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+4)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field
 
                    DFx(4:9) =DFx(4:9) &
 
                         &+G%metricx(x, y, z, 1)*cbx(s+4)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================
 
                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+4)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field
 
                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+4)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================
  
 
                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+4)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field
 
                    DFz(4:9) = DFz(4:9) &
 
                         &+G%metricz(x, y, z, 3)*cbz(s+4)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do
 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)
 
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
 
                 a3 = M%M(x, y, z, 1) ! lambda
 
                 a4 = M%M(x, y, z, 2) ! mu
 
 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
 
                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))
 
              end do
           end do
        end do
 
     end select
 
   end subroutine JJU_x66_interior_upwind_drp
 

  subroutine JJU_x679_interior_upwind_drp(F, G, M, type_of_mesh)

     use datatypes, only: block_type, block_fields, block_grid_t, block_material

     implicit none

     !=================================================================================================

     !input variables 
     type(block_type)       , intent(inout) :: F
     type(block_grid_t)     , intent(in)    :: G
     type(block_material)   , intent(inout) :: M
     character(len=64)      , intent(in)    :: type_of_mesh

     integer            :: mx, my, mz, px, py, pz, nx, ny, nz, n    ! integer values for spatial directions
     integer            :: x , y , z , s , iz, fz, iy, fy, ix, fx
     integer            :: i
     real(kind = wp)    :: hx, hy, hz                               ! spatial steps discertizing the unit cube

     !stencil values
     real(kind = wp),parameter :: cf(1:10) =  (/  -1.0_wp/168.0_wp, 149.0_wp/3150.0_wp, -199.0_wp/1575.0_wp,&
                                                  -8.0_wp/75.0_wp, -8.0_wp/9.0_wp, 67.0_wp/45.0_wp,&
                                                  -37.0_wp/75.0_wp, 124.0_wp/1575.0_wp, 139.0_wp/12600.0_wp,&
                                                  -1.0_wp/210.0_wp  /) ! forward  FD coefficients 
     real(kind = wp),parameter :: cb(1:10) = (/   1.0_wp/210.0_wp, -139.0_wp/12600.0_wp, -124.0_wp/1575.0_wp,&
                                                  37.0_wp/75.0_wp, -67.0_wp/45.0_wp, 8.0_wp/9.0_wp,&
                                                  8.0_wp/75.0_wp, 199.0_wp/1575.0_wp, -149.0_wp/3150.0_wp,&
                                                  1.0_wp/168.0_wp /)     ! backward FD coefficients 


     real(kind = wp),dimension(1:10) :: cfx,cfy,cfz, cbx,cby,cbz
     real(kind = wp),dimension(1:9) :: DFx,DFy,DFz
     real(kind = wp)                :: a1,a2,a3,a4
     real(kind = wp)                :: tr


     !allocate constant values
     !integers
     mx = G%C%mq
     my = G%C%mr
     mz = G%C%ms
     px = G%C%pq
     py = G%C%pr
     pz = G%C%ps
     nx = G%C%nq
     ny = G%C%nr
     nz = G%C%ns

     n = size(F%F%F, 4)

     !spatial step sizes
     hx = G%hq
     hy = G%hr
     hz = G%hs

     cfx = cf/hx; cfy = cf/hy; cfz = cf/hz
     cbx = cb/hx; cby = cb/hy; cbz = cb/hz

     !set default pml size
     ix = 8
     iy = 8
     iz = 8

     fx = 8
     fy = 8
     fz = 8

     if (F%PMLB(5)%pml .EQV. .TRUE.) iz = max(F%PMLB(5)%N_pml, 8)
     if (F%PMLB(6)%pml .EQV. .TRUE.) fz = max(F%PMLB(6)%N_pml, 8)

     if (F%PMLB(3)%pml .EQV. .TRUE.) iy = max(F%PMLB(3)%N_pml, 8)
     if (F%PMLB(4)%pml .EQV. .TRUE.) fy = max(F%PMLB(4)%N_pml, 8)

     if (F%PMLB(1)%pml .EQV. .TRUE.) ix = max(F%PMLB(1)%N_pml, 8)
     if (F%PMLB(2)%pml .EQV. .TRUE.) fx = max(F%PMLB(2)%N_pml, 8)


     !two types of mesh
     select case(type_of_mesh)

     case('curvilinear') ! locked or welded interface    

        do z = mz, pz
           do y = my, py
              do x = mx, px
                 

                 !cycle if an interior point
                 if ( ((iz+1 > z)   .or. (z > nz - fz))    .or. &
                      ((iy+1 > y)   .or. (y > ny - fy))    .or. &
                      ((ix+1 > x)   .or. (x > nx - fx)))    cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp
  
  do s = -4,5
     
     DFx(1:3) = DFx(1:3) &
          &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricx(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricx(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFx(4:9) =DFx(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricx(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricx(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricx(x, y, z+s-1, 3)*G%J(x, y, z+s-1)! backwad difference for stress field
     !==========================================================
     
     DFy(1:3) = DFy(1:3) &
          &+G%metricy(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricy(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFy(4:9) =DFy(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) * G%metricy(x+s-1, y, z, 1)*G%J(x+s-1,y,z)  &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricy(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricy(x, y, z+s-1, 3)*G%J(x, y, z+s-1)
     !==========================================================
     
     
     DFz(1:3) = DFz(1:3) &
          &+G%metricz(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) &
          &+G%metricz(x, y, z, 2)*cfy(s+5)*(F%F%F(x, y+s  , z  , 1:3) ) &
          &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x, y  , z+s  , 1:3) )  ! forward difference for velocity field
     
     DFz(4:9) =DFz(4:9) &
          &+cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) *G%metricz(x+s-1, y, z, 1)*G%J(x+s-1,y,z)   &
          &+cby(s+5)*(F%F%F(x, y+s-1  , z  , 4:9) ) * G%metricz(x, y+s-1, z, 2)* G%J(x,y+s-1,z) &
          &+cbz(s+5)*(F%F%F(x, y  , z+s-1  , 4:9) ) * G%metricz(x, y, z+s-1, 3)*G%J(x, y, z+s-1)!
     
     
  end do
                 
                 a1 = 1.0_wp/(M%M(x, y, z, 3)*G%J(x,y,z)) ! 1/(rho*J)
                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)
                 a3 = M%M(x, y, z, 1) ! lambda
                 a4 = M%M(x, y, z, 2) ! mu
                 
                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))
                 
                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))
                 
                                             F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                                             F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                                             F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                                         if (M%anelastic) then
                                                  F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                                                  F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                                                  F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                                                  F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                                                  F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                                                  F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                                                  tr = DFx(1) + DFy(2) + DFz(3)
                                                  do i = 1, 4
                                                        M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta4(x,y,z,i) ) / M%tau(i)

                                                        M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta5(x,y,z,i) ) / M%tau(i)

                                                        M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                                                             ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                                                             + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                                                                                                         - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                                                             - M%eta6(x,y,z,i) ) / M%tau(i)

                                                        M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                                                        M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                                                        M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                                                             (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                                                  end do
                                         end if
                 
              end do
           end do
        end do

     case('cartesian') ! carteian mesh
        !print *, 'interior'
        
        do z = mz, pz
           do y = my, py
                 do x = mx, px

                      if (((iz+1 > z) .or. (z > nz - fz)) .or. &
                           ((iy+1 > y) .or. (y > ny - fy)) .or. &
                           ((ix+1 > x) .or. (x > nx - fx))) cycle
                 
                 DFx = 0.0_wp; DFy = 0.0_wp; DFz = 0.0_wp

                 do s = -4,5

                    DFx(1:3) = DFx(1:3) &
                         &+G%metricx(x, y, z, 1)*cfx(s+5)*(F%F%F(x+s, y  , z  , 1:3) ) ! forward difference for velocity field

                    DFx(4:9) =DFx(4:9) &

                         &+G%metricx(x, y, z, 1)*cbx(s+5)*(F%F%F(x+s-1, y  , z  , 4:9) ) ! backwad difference for stress field
                    !==========================================================

                    DFy(1:3) = DFy(1:3) &
                         &+G%metricy(x, y, z, 2)*cfy(s+5)*(F%F%F(x  , y+s, z , 1:3) )  ! forward difference for velocity field

                    DFy(4:9) = DFy(4:9) &
                    
                         &+G%metricy(x, y, z, 2)*cby(s+5)*(F%F%F(x  , y+s-1, z , 4:9) ) ! backward difference for velocity field
                    !==========================================================


                    DFz(1:3) = DFz(1:3) &
                         &+G%metricz(x, y, z, 3)*cfz(s+5)*(F%F%F(x  , y  , z+s, 1:3))   ! forward difference for velocity field

                    DFz(4:9) = DFz(4:9) &

                         &+G%metricz(x, y, z, 3)*cbz(s+5)*(F%F%F(x  , y  , z+s-1, 4:9))   ! backward difference for velocity field
                    
                        
                 end do

                 a1 = 1.0_wp/(M%M(x, y, z, 3)) ! 1/(rho*J)

                 a2 = (2.0_wp*M%M(x, y, z, 2) + M%M(x, y, z, 1)) ! (lambda+2*mu)

                 a3 = M%M(x, y, z, 1) ! lambda

                 a4 = M%M(x, y, z, 2) ! mu


                 F%F%DF(x, y, z, 1) = F%F%DF(x,y,z,1) + a1*(DFx(4) + DFy(7) + DFz(8))
                 F%F%DF(x, y, z, 2) = F%F%DF(x,y,z,2) + a1*(DFx(7) + DFy(5) + DFz(9))
                 F%F%DF(x, y, z, 3) = F%F%DF(x,y,z,3) + a1*(DFx(8) + DFy(9) + DFz(6))

                 F%F%DF(x, y, z, 4) = F%F%DF(x,y,z,4) + a2*DFx(1) + a3*(DFy(2) + DFz(3))
                 F%F%DF(x, y, z, 5) = F%F%DF(x,y,z,5) + a2*DFy(2) + a3*(DFx(1) + DFz(3))
                 F%F%DF(x, y, z, 6) = F%F%DF(x,y,z,6) + a2*DFz(3) + a3*(DFx(1) + DFy(2))

                 F%F%DF(x, y, z, 7) = F%F%DF(x,y,z,7) + a4*(DFy(1) + DFx(2))
                 F%F%DF(x, y, z, 8) = F%F%DF(x,y,z,8) + a4*(DFz(1) + DFx(3))
                 F%F%DF(x, y, z, 9) = F%F%DF(x,y,z,9) + a4*(DFz(2) + DFy(3))

                 if (M%anelastic) then
                    F%F%DF(x, y, z, 4) = F%F%DF(x, y, z, 4) - (M%eta4(x,y,z,1) + M%eta4(x,y,z,2) + M%eta4(x,y,z,3) + M%eta4(x,y,z,4))
                    F%F%DF(x, y, z, 5) = F%F%DF(x, y, z, 5) - (M%eta5(x,y,z,1) + M%eta5(x,y,z,2) + M%eta5(x,y,z,3) + M%eta5(x,y,z,4))
                    F%F%DF(x, y, z, 6) = F%F%DF(x, y, z, 6) - (M%eta6(x,y,z,1) + M%eta6(x,y,z,2) + M%eta6(x,y,z,3) + M%eta6(x,y,z,4))
                    F%F%DF(x, y, z, 7) = F%F%DF(x, y, z, 7) - (M%eta7(x,y,z,1) + M%eta7(x,y,z,2) + M%eta7(x,y,z,3) + M%eta7(x,y,z,4))
                    F%F%DF(x, y, z, 8) = F%F%DF(x, y, z, 8) - (M%eta8(x,y,z,1) + M%eta8(x,y,z,2) + M%eta8(x,y,z,3) + M%eta8(x,y,z,4))
                    F%F%DF(x, y, z, 9) = F%F%DF(x, y, z, 9) - (M%eta9(x,y,z,1) + M%eta9(x,y,z,2) + M%eta9(x,y,z,3) + M%eta9(x,y,z,4))

                    tr = DFx(1) + DFy(2) + DFz(3)
                    do i = 1, 4
                       M%Deta4(x,y,z,i) = M%Deta4(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFx(1) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta4(x,y,z,i) ) / M%tau(i)
                       M%Deta5(x,y,z,i) = M%Deta5(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFy(2) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta5(x,y,z,i) ) / M%tau(i)
                       M%Deta6(x,y,z,i) = M%Deta6(x,y,z,i) + ( &
                            ( (M%weight(i)*2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z))*DFz(3) &
                            + (M%weight(i) * ( (M%M(x,y,z,1)+2.0_wp*M%M(x,y,z,2))*M%Qp_inv(x,y,z) &
                            - 2.0_wp*M%M(x,y,z,2)*M%Qs_inv(x,y,z) ) * tr ) ) &
                            - M%eta6(x,y,z,i) ) / M%tau(i)

                       M%Deta7(x,y,z,i) = M%Deta7(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFy(1) + DFx(2)) - M%eta7(x,y,z,i)) / M%tau(i) )
                       M%Deta8(x,y,z,i) = M%Deta8(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(1) + DFx(3)) - M%eta8(x,y,z,i)) / M%tau(i) )
                       M%Deta9(x,y,z,i) = M%Deta9(x,y,z,i) + ( &
                            (M%weight(i)*M%M(x,y,z,2)*M%Qs_inv(x,y,z)*(DFz(2) + DFy(3)) - M%eta9(x,y,z,i)) / M%tau(i) )
                    end do
                 end if

              end do
           end do
        end do

     end select

     end subroutine JJU_x679_interior_upwind_drp
       




end module  JU_xJU_yJU_z6
